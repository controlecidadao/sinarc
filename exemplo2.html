<html>
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
        
            <script src="./pyvis/templates/lib/bindings/utils.js"></script>
            <link rel="stylesheet" href="./pyvis/templates/lib/vis-9.1.2/vis-network.css" />
            <script src="./pyvis/templates/lib/vis-9.1.2/vis-network.min.js" ></script>
            
        
<center>
<h1></h1>
</center>

<!-- <link rel="stylesheet" href="../node_modules/vis/dist/vis.min.css" type="text/css" />
<script type="text/javascript" src="../node_modules/vis/dist/vis.js"> </script>-->
        <link href="./pyvis/templates/lib/vis-9.1.2/bootstrap.min.css" rel="stylesheet" />
        <script src="./pyvis/templates/lib/vis-9.1.2/bootstrap.bundle.min.js" ></script>


        <center>
          <h1></h1>
        </center>
        <style type="text/css">

             #mynetwork {
                 width: 100%;
                 height: 800px;
                 background-color: #ffffff;
                 border: 1px solid lightgray;
                 position: relative;
                 float: left;
             }

             

             

             
        </style>
    </head>


    <body>
        <div class="card" style="width: 100%">
            
            
            <div id="mynetwork" class="card-body"></div>
        </div>

        
        

        <script type="text/javascript">

              // initialize global variables.
              var edges;
              var nodes;
              var allNodes;
              var allEdges;
              var nodeColors;
              var originalNodes;
              var network;
              var container;
              var options, data;
              var filter = {
                  item : '',
                  property : '',
                  value : []
              };

              

              

              // This method is responsible for drawing the graph, returns the drawn network
              function drawGraph() {
                  var container = document.getElementById('mynetwork');

                  

                  // parsing and collecting nodes and edges from the python
                  nodes = new vis.DataSet([
  {
    "font": {
      "color": "#777777"
    },
    "id": "PF_***125258**-MARTHA DELIA URIBE DE LUNA",
    "image": "images\\pf_mulher.png",
    "label": "MARTHA DELIA URIBE DE LUNA",
    "shape": "image",
    "size": 20,
    "title": "MARTHA DELIA URIBE DE LUNA (PF_***125258**)\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 1):\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Administrador)",
    "value": 1,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "algoritmos": "Betweenness Centrality: CHOCOLATES GAROTO LTDA.\nCloseness Centrality:      CHOCOLATES GAROTO LTDA.\nEigenvector Centrality:   CHOCOLATES GAROTO LTDA.\nDegree Centrality:          CHOCOLATES GAROTO LTDA.\nPagerank (Bidirecional): CHOCOLATES GAROTO LTDA.\n\n#####  BETWEENNESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 55.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.0\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.0\n#####  CLOSENESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 1.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.524\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.524\n#####  EIGENVECTOR CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 0.706\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.213\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.213\n#####  PAGERANK (ARESTAS BIDIRECIONAIS)  #####\n1) CHOCOLATES GAROTO LTDA.: 0.466\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.049\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.049",
    "camadas_solicitadas": 1,
    "color": {
      "border": "red",
      "background": "transparent",
      "hover": {
        "background": "transparent",
        "border": "red"
      },
      "highlight": {
        "background": "rgba(0, 255, 0, 0.3)",
        "border": "red"
      }
    },
    "borderWidth": 4,
    "shapeProperties": {
      "useBorderWithImage": true,
      "borderDashes": [
        15,
        5
      ]
    },
    "borderWidthSelected": 4,
    "id": "PJ_28053619000183",
    "image": "images\\pj_brasil_ativa.png",
    "label": "CHOCOLATES GAROTO LTDA.",
    "shape": "image",
    "size": 20,
    "title": "CHOCOLATES GAROTO LTDA. (PJ_28053619000183)\nPRACA MEYERFREUND, 01 - GLORIA - VILA VELHA - ES\n\nN√ì - Dist√¢ncia Alvo: 0\n GRAFO - N√≥s: 20, Arestas: 26, Camadas Solicitadas: 1, Conectado: Sim\nMensagem: \n N√≥s Adjacentes (Grau 14):\n--> EM_atendimento.fiscalizacao@br.nestle.com\n--> EN_MEYERFREUND 1-VILA VELHA-ES\n--> PJ_CONSORCIO NINHO DOS VENTOS CUMARU II - Ativa - (Sociedade Consorciada)\n--> PJ_CONSORCIO NINHO DOS VENTOS CUMARU III - Ativa - (Sociedade Consorciada)\n--> PJ_CONSORCIO NINHO DOS VENTOS CUMARU IV - Ativa - (Sociedade Consorciada)\n--> TE_11 55084400\n<-- PF_GUSTAVO CHIARINI BASTOS (Administrador)\n<-- PF_LUIZ MARCELO DE CARVALHO LIMA MELCHIOR (Administrador)\n<-- PF_MARCELO MAIA DO NASCIMENTO (Administrador)\n<-- PF_MARCO ANTONIO COSTA GUIMARAES (Administrador)\n<-- PF_MARTHA DELIA URIBE DE LUNA (Administrador)\n<-- PF_MASSIMO GIULIANI (Administrador)\n<-- PJ_NESTLE BRASIL LTDA. - Ativa - (S√≥cio)\n<-- PJ_NESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA. - Ativa - (S√≥cio)",
    "value": 14,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "algoritmos": "Betweenness Centrality: CHOCOLATES GAROTO LTDA.\nCloseness Centrality:      CHOCOLATES GAROTO LTDA.\nEigenvector Centrality:   CHOCOLATES GAROTO LTDA.\nDegree Centrality:          CHOCOLATES GAROTO LTDA.\nPagerank (Bidirecional): CHOCOLATES GAROTO LTDA.\n\n#####  BETWEENNESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 55.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.0\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.0\n#####  CLOSENESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 1.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.524\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.524\n#####  EIGENVECTOR CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 0.706\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.213\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.213\n#####  PAGERANK (ARESTAS BIDIRECIONAIS)  #####\n1) CHOCOLATES GAROTO LTDA.: 0.466\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.049\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.049",
    "camadas_solicitadas": 1,
    "font": {
      "color": "#777777"
    },
    "id": "PJ_58154254000144",
    "image": "images\\pj_brasil_ativa.png",
    "label": "CONSORCIO NINHO DOS VENTOS CUMARU II",
    "shape": "image",
    "size": 20,
    "title": "CONSORCIO NINHO DOS VENTOS CUMARU II (PJ_58154254000144)\nFAZENDA SAO JOSE DO CUMARU, ESTRADA MUNICIPAL DE SAO MIGUEL DO GOSTO, S/N - ZONA RURAL - SAO MIGUEL DO GOSTOSO - RN\n\nN√ì - Dist√¢ncia Alvo: 1\n GRAFO - N√≥s: 20, Arestas: 26, Camadas Solicitadas: 1, Conectado: Sim\nMensagem: \n N√≥s Adjacentes (Grau 3):\n--> EM_fiscpro@enel.com\n--> TE_21 22065600\n<-- PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Sociedade Consorciada)",
    "value": 3,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "algoritmos": "Betweenness Centrality: CHOCOLATES GAROTO LTDA.\nCloseness Centrality:      CHOCOLATES GAROTO LTDA.\nEigenvector Centrality:   CHOCOLATES GAROTO LTDA.\nDegree Centrality:          CHOCOLATES GAROTO LTDA.\nPagerank (Bidirecional): CHOCOLATES GAROTO LTDA.\n\n#####  BETWEENNESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 55.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.0\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.0\n#####  CLOSENESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 1.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.524\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.524\n#####  EIGENVECTOR CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 0.706\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.213\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.213\n#####  PAGERANK (ARESTAS BIDIRECIONAIS)  #####\n1) CHOCOLATES GAROTO LTDA.: 0.466\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.049\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.049",
    "camadas_solicitadas": 1,
    "font": {
      "color": "#777777"
    },
    "id": "PJ_58154627000187",
    "image": "images\\pj_brasil_ativa.png",
    "label": "CONSORCIO NINHO DOS VENTOS CUMARU IV",
    "shape": "image",
    "size": 20,
    "title": "CONSORCIO NINHO DOS VENTOS CUMARU IV (PJ_58154627000187)\nFAZENDA SAO JOSE DO CUMARU, ESTRADA MUNICIPAL DE SAO MIGUEL DO GOSTO, S/N - ZONA RURAL - SAO MIGUEL DO GOSTOSO - RN\n\nN√ì - Dist√¢ncia Alvo: 1\n GRAFO - N√≥s: 20, Arestas: 26, Camadas Solicitadas: 1, Conectado: Sim\nMensagem: \n N√≥s Adjacentes (Grau 2):\n--> EM_fiscpro@enel.com\n<-- PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Sociedade Consorciada)",
    "value": 2,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "algoritmos": "Betweenness Centrality: CHOCOLATES GAROTO LTDA.\nCloseness Centrality:      CHOCOLATES GAROTO LTDA.\nEigenvector Centrality:   CHOCOLATES GAROTO LTDA.\nDegree Centrality:          CHOCOLATES GAROTO LTDA.\nPagerank (Bidirecional): CHOCOLATES GAROTO LTDA.\n\n#####  BETWEENNESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 55.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.0\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.0\n#####  CLOSENESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 1.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.524\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.524\n#####  EIGENVECTOR CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 0.706\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.213\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.213\n#####  PAGERANK (ARESTAS BIDIRECIONAIS)  #####\n1) CHOCOLATES GAROTO LTDA.: 0.466\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.049\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.049",
    "camadas_solicitadas": 1,
    "font": {
      "color": "#777777"
    },
    "id": "PJ_58214699000172",
    "image": "images\\pj_brasil_ativa.png",
    "label": "CONSORCIO NINHO DOS VENTOS CUMARU III",
    "shape": "image",
    "size": 20,
    "title": "CONSORCIO NINHO DOS VENTOS CUMARU III (PJ_58214699000172)\nFAZENDA TIMBAUBA, S/N - ZONA RURAL - PEDRA GRANDE - RN\n\nN√ì - Dist√¢ncia Alvo: 1\n GRAFO - N√≥s: 20, Arestas: 26, Camadas Solicitadas: 1, Conectado: Sim\nMensagem: \n N√≥s Adjacentes (Grau 3):\n--> EM_fiscpro@enel.com\n--> TE_21 22065600\n<-- PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Sociedade Consorciada)",
    "value": 3,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "EM_atendimento.fiscalizacao@br.nestle.com",
    "image": "images\\email.png",
    "label": "atendimento.fiscalizacao@br.nestle.com",
    "shape": "image",
    "size": 15,
    "title": "atendimento.fiscalizacao@br.nestle.com\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 3):\n<-- PJ_CHOCOLATES GAROTO LTDA.\n<-- PJ_NESTLE BRASIL LTDA.\n<-- PJ_NESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA.",
    "value": 3,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "TE_11 55084400",
    "image": "images\\telefone.png",
    "label": "11 55084400",
    "shape": "image",
    "size": 15,
    "title": "11 55084400\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 3):\n<-- PJ_CHOCOLATES GAROTO LTDA.\n<-- PJ_NESTLE BRASIL LTDA.\n<-- PJ_NESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA.",
    "value": 3,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "EN_MEYERFREUND 1-VILA VELHA-ES",
    "image": "images\\endereco.png",
    "label": "VILA VELHA - ES",
    "shape": "image",
    "size": 15,
    "title": "ES - VILA VELHA - GLORIA - PRACA MEYERFREUND, 01\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 1):\n<-- PJ_CHOCOLATES GAROTO LTDA.",
    "value": 1,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "PF_***151678**-GUSTAVO CHIARINI BASTOS",
    "image": "images\\pf_homem.png",
    "label": "GUSTAVO CHIARINI BASTOS",
    "shape": "image",
    "size": 20,
    "title": "GUSTAVO CHIARINI BASTOS (PF_***151678**)\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 1):\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Administrador)",
    "value": 1,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "PF_***278958**-MASSIMO GIULIANI",
    "image": "images\\pf_homem.png",
    "label": "MASSIMO GIULIANI",
    "shape": "image",
    "size": 20,
    "title": "MASSIMO GIULIANI (PF_***278958**)\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 1):\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Administrador)",
    "value": 1,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "PF_***615987**-LUIZ MARCELO DE CARVALHO LIMA MELCHIOR",
    "image": "images\\pf_homem.png",
    "label": "LUIZ MARCELO DE CARVALHO LIMA MELCHIOR",
    "shape": "image",
    "size": 20,
    "title": "LUIZ MARCELO DE CARVALHO LIMA MELCHIOR (PF_***615987**)\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 1):\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Administrador)",
    "value": 1,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "PF_***812401**-MARCELO MAIA DO NASCIMENTO",
    "image": "images\\pf_homem.png",
    "label": "MARCELO MAIA DO NASCIMENTO",
    "shape": "image",
    "size": 20,
    "title": "MARCELO MAIA DO NASCIMENTO (PF_***812401**)\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 1):\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Administrador)",
    "value": 1,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "PF_***861998**-MARCO ANTONIO COSTA GUIMARAES",
    "image": "images\\pf_homem.png",
    "label": "MARCO ANTONIO COSTA GUIMARAES",
    "shape": "image",
    "size": 20,
    "title": "MARCO ANTONIO COSTA GUIMARAES (PF_***861998**)\n\nN√ì - Dist√¢ncia Alvo: 1\nN√≥s Adjacentes (Grau 1):\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (Administrador)",
    "value": 1,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "algoritmos": "Betweenness Centrality: CHOCOLATES GAROTO LTDA.\nCloseness Centrality:      CHOCOLATES GAROTO LTDA.\nEigenvector Centrality:   CHOCOLATES GAROTO LTDA.\nDegree Centrality:          CHOCOLATES GAROTO LTDA.\nPagerank (Bidirecional): CHOCOLATES GAROTO LTDA.\n\n#####  BETWEENNESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 55.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.0\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.0\n#####  CLOSENESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 1.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.524\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.524\n#####  EIGENVECTOR CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 0.706\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.213\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.213\n#####  PAGERANK (ARESTAS BIDIRECIONAIS)  #####\n1) CHOCOLATES GAROTO LTDA.: 0.466\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.049\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.049",
    "camadas_solicitadas": 1,
    "font": {
      "color": "#777777"
    },
    "id": "PJ_08334818000152",
    "image": "images\\pj_brasil_ativa.png",
    "label": "NESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA.",
    "shape": "image",
    "size": 20,
    "title": "NESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA. (PJ_08334818000152)\nNESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA.\nAVENIDA DEPUTADO LUIS EDUARDO MAGALHAES, S/N - KM 529-SUBAE - FEIRA DE SANTANA - BA\n\nN√ì - Dist√¢ncia Alvo: 1\n GRAFO - N√≥s: 20, Arestas: 26, Camadas Solicitadas: 1, Conectado: Sim\nMensagem: \n N√≥s Adjacentes (Grau 5):\n--> EM_atendimento.fiscalizacao@br.nestle.com\n--> EN_DEPUTADO EDUARDO KM LUIS MAGALHAES 529-FEIRA DE SANTANA-BA\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (S√≥cio)\n--> TE_11 55084400\n--> TE_71 33139467",
    "value": 5,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "EN_DEPUTADO EDUARDO KM LUIS MAGALHAES 529-FEIRA DE SANTANA-BA",
    "image": "images\\endereco.png",
    "label": "FEIRA DE SANTANA - BA",
    "shape": "image",
    "size": 15,
    "title": "BA - FEIRA DE SANTANA - KM 529-SUBAE - AVENIDA DEPUTADO LUIS EDUARDO MAGALHAES, S/N\n\nN√ì - Dist√¢ncia Alvo: 2\nN√≥s Adjacentes (Grau 1):\n<-- PJ_NESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA.",
    "value": 1,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "TE_71 33139467",
    "image": "images\\telefone.png",
    "label": "71 33139467",
    "shape": "image",
    "size": 15,
    "title": "71 33139467\n\nN√ì - Dist√¢ncia Alvo: 2\nN√≥s Adjacentes (Grau 1):\n<-- PJ_NESTLE NORDESTE ALIMENTOS E BEBIDAS LTDA.",
    "value": 1,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "algoritmos": "Betweenness Centrality: CHOCOLATES GAROTO LTDA.\nCloseness Centrality:      CHOCOLATES GAROTO LTDA.\nEigenvector Centrality:   CHOCOLATES GAROTO LTDA.\nDegree Centrality:          CHOCOLATES GAROTO LTDA.\nPagerank (Bidirecional): CHOCOLATES GAROTO LTDA.\n\n#####  BETWEENNESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 55.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.0\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.0\n#####  CLOSENESS CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 1.0\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.524\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.524\n#####  EIGENVECTOR CENTRALITY  #####\n1) CHOCOLATES GAROTO LTDA.: 0.706\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.213\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.213\n#####  PAGERANK (ARESTAS BIDIRECIONAIS)  #####\n1) CHOCOLATES GAROTO LTDA.: 0.466\n2) PF_***125258**-MARTHA DELIA URIBE DE LUNA: 0.049\n3) PF_***151678**-GUSTAVO CHIARINI BASTOS: 0.049",
    "camadas_solicitadas": 1,
    "font": {
      "color": "#777777"
    },
    "id": "PJ_60409075000152",
    "image": "images\\pj_brasil_ativa.png",
    "label": "NESTLE BRASIL LTDA.",
    "shape": "image",
    "size": 20,
    "title": "NESTLE BRASIL LTDA. (PJ_60409075000152)\nRUA DR RUBENS GOMES BUENO, 691 - EDIF TORRE SIGMA ANDAR 19 AO 28-VARZEA DE BAIXO - SAO PAULO - SP\n\nN√ì - Dist√¢ncia Alvo: 1\n GRAFO - N√≥s: 20, Arestas: 26, Camadas Solicitadas: 1, Conectado: Sim\nMensagem: \n N√≥s Adjacentes (Grau 4):\n--> EM_atendimento.fiscalizacao@br.nestle.com\n--> PJ_CHOCOLATES GAROTO LTDA. - Ativa - (S√≥cio)\n--> TE_11 55084400\n--> TE_16 39657153",
    "value": 4,
    "z_ancestor": "true",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "TE_16 39657153",
    "image": "images\\telefone.png",
    "label": "16 39657153",
    "shape": "image",
    "size": 15,
    "title": "16 39657153\n\nN√ì - Dist√¢ncia Alvo: 2\nN√≥s Adjacentes (Grau 1):\n<-- PJ_NESTLE BRASIL LTDA.",
    "value": 1,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "EM_fiscpro@enel.com",
    "image": "images\\email.png",
    "label": "fiscpro@enel.com",
    "shape": "image",
    "size": 15,
    "title": "fiscpro@enel.com\n\nN√ì - Dist√¢ncia Alvo: 2\nN√≥s Adjacentes (Grau 3):\n<-- PJ_CONSORCIO NINHO DOS VENTOS CUMARU II\n<-- PJ_CONSORCIO NINHO DOS VENTOS CUMARU III\n<-- PJ_CONSORCIO NINHO DOS VENTOS CUMARU IV",
    "value": 3,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  },
  {
    "font": {
      "color": "#777777"
    },
    "id": "TE_21 22065600",
    "image": "images\\telefone.png",
    "label": "21 22065600",
    "shape": "image",
    "size": 15,
    "title": "21 22065600\n\nN√ì - Dist√¢ncia Alvo: 2\nN√≥s Adjacentes (Grau 2):\n<-- PJ_CONSORCIO NINHO DOS VENTOS CUMARU II\n<-- PJ_CONSORCIO NINHO DOS VENTOS CUMARU III",
    "value": 2,
    "z_ancestor": "false",
    "z_group": 1,
    "z_group_total": 1
  }
]);
                  edges = new vis.DataSet([
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PF_***125258**-MARTHA DELIA URIBE DE LUNA",
    "label": "Administrador",
    "title": "Administrador",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "3d5edac7-58b1-4973-b6e3-7a9cb8a42f4f"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_28053619000183",
    "label": "Sociedade Consorciada",
    "title": "Sociedade Consorciada",
    "to": "PJ_58154254000144",
    "width": 1,
    "id": "7407143f-f807-4c2f-be4f-3d8e32ef6590"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_28053619000183",
    "label": "Sociedade Consorciada",
    "title": "Sociedade Consorciada",
    "to": "PJ_58154627000187",
    "width": 1,
    "id": "3831d0c2-bec3-4a19-b644-470e31f07fc6"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_28053619000183",
    "label": "Sociedade Consorciada",
    "title": "Sociedade Consorciada",
    "to": "PJ_58214699000172",
    "width": 1,
    "id": "309999e0-0535-47b3-9e24-244a39026c3b"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_28053619000183",
    "label": "",
    "to": "EM_atendimento.fiscalizacao@br.nestle.com",
    "width": 1,
    "id": "41c33ed8-869b-441b-837b-0e9be5350b0b"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_28053619000183",
    "label": "",
    "to": "TE_11 55084400",
    "width": 1,
    "id": "7325a246-5692-4681-ae71-fd454e904573"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_28053619000183",
    "label": "",
    "to": "EN_MEYERFREUND 1-VILA VELHA-ES",
    "width": 1,
    "id": "ba64be3f-bd73-4280-9dcf-2b2676f5bbb5"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PF_***151678**-GUSTAVO CHIARINI BASTOS",
    "label": "Administrador",
    "title": "Administrador",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "ece1e19a-7c48-485b-8b15-71d2ee078f65"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PF_***278958**-MASSIMO GIULIANI",
    "label": "Administrador",
    "title": "Administrador",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "952ed7c0-c0b9-47c0-99d2-6fef0ab3189d"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PF_***615987**-LUIZ MARCELO DE CARVALHO LIMA MELCHIOR",
    "label": "Administrador",
    "title": "Administrador",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "df61fa31-af5b-4a1a-9ced-a2f80a16dadd"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PF_***812401**-MARCELO MAIA DO NASCIMENTO",
    "label": "Administrador",
    "title": "Administrador",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "93c53a4c-98e4-4445-8f3b-3b5020741920"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PF_***861998**-MARCO ANTONIO COSTA GUIMARAES",
    "label": "Administrador",
    "title": "Administrador",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "748bf817-c001-4027-bcf5-e28bf1e709fb"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_08334818000152",
    "label": "S√≥cio",
    "title": "S√≥cio",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "d9d63e62-067c-4d9b-8685-1aa3f519f436"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_08334818000152",
    "label": "",
    "to": "EM_atendimento.fiscalizacao@br.nestle.com",
    "width": 1,
    "id": "e770dce0-96e7-4463-87e2-4c5ca193b2e0"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_08334818000152",
    "label": "",
    "to": "EN_DEPUTADO EDUARDO KM LUIS MAGALHAES 529-FEIRA DE SANTANA-BA",
    "width": 1,
    "id": "6a749d0f-a4d6-49c1-8975-6df01002bfb3"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_08334818000152",
    "label": "",
    "to": "TE_11 55084400",
    "width": 1,
    "id": "f4e419bb-4661-43b4-9814-2a5fe85edaf2"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_08334818000152",
    "label": "",
    "to": "TE_71 33139467",
    "width": 1,
    "id": "3bf08ec8-25e4-400a-a410-e8add0d1c416"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_60409075000152",
    "label": "S√≥cio",
    "title": "S√≥cio",
    "to": "PJ_28053619000183",
    "width": 1,
    "id": "81ce6ad6-11d8-4913-81eb-cea9cabc3baa"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_60409075000152",
    "label": "",
    "to": "EM_atendimento.fiscalizacao@br.nestle.com",
    "width": 1,
    "id": "3946ab40-98ba-411f-b095-44553a80b354"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_60409075000152",
    "label": "",
    "to": "TE_11 55084400",
    "width": 1,
    "id": "09153c59-259e-4623-acc6-923afed8d7bb"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_60409075000152",
    "label": "",
    "to": "TE_16 39657153",
    "width": 1,
    "id": "085319fe-d61b-4684-9eb7-fc98e5913cea"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_58154254000144",
    "label": "",
    "to": "EM_fiscpro@enel.com",
    "width": 1,
    "id": "7945aa25-0889-4259-b61f-e4c7f80c7bbc"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_58154254000144",
    "label": "",
    "to": "TE_21 22065600",
    "width": 1,
    "id": "7b9d808f-1992-4aee-b059-4d1b2cb01249"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_58154627000187",
    "label": "",
    "to": "EM_fiscpro@enel.com",
    "width": 1,
    "id": "106b47b6-bbf0-469c-95fd-d3e17e2a5511"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_58214699000172",
    "label": "",
    "to": "EM_fiscpro@enel.com",
    "width": 1,
    "id": "363f111c-4611-406d-bd2a-2780982ec2ac"
  },
  {
    "arrowStrikethrough": false,
    "arrows": "to",
    "from": "PJ_58214699000172",
    "label": "",
    "to": "TE_21 22065600",
    "width": 1,
    "id": "bba184c5-33eb-4260-8bc9-11f152e879ae"
  }
]);

                  nodeColors = {};
                  allNodes = nodes.get({ returnType: "Object" });
                  for (nodeId in allNodes) {
                    nodeColors[nodeId] = allNodes[nodeId].color;
                  }
                  allEdges = edges.get({ returnType: "Object" });
                  // adding nodes and edges to the graph
                  data = {nodes: nodes, edges: edges};

                  var options = {"autoResize": true, "height": "100%", "width": "100%", "configure": {"enabled": false, "showButton": true, "filter": true}, "nodes": {"color": {"border": "transparent", "background": "transparent", "highlight": {"border": "transparent", "background": "rgba(0,255,0,0.3)"}, "hover": {"border": "transparent", "background": "transparent"}}, "shapeProperties": {"useBorderWithImage": true, "interpolation": true}, "scaling": {"min": 20, "max": 100, "label": {"enabled": true, "min": 15, "max": 40, "maxVisible": 30, "drawThreshold": 8}}, "font": {"color": "#777777", "strokeWidth": 4, "strokeColor": "#ffffff", "bold": {"color": "#ff0000"}}}, "edges": {"hoverWidth": 4, "smooth": {"enabled": false}, "scaling": {"label": {"enabled": true, "min": 30, "max": 40, "maxVisible": 30, "drawThreshold": 8}}, "font": {"align": "top", "color": "#777777", "size": 15}, "selectionWidth": 4, "color": {"color": "#2B7CE9", "highlight": "#FF0000", "inherit": false, "hover": "#FF0000"}, "arrowStrikethrough": false}, "interaction": {"hover": true, "multiselect": true, "navigationButtons": false, "hideEdgesOnDrag": true, "hideEdgesOnZoom": true, "tooltipDelay": 9999999999}, "physics": {"enabled": true, "barnesHut": {"gravitationalConstant": -10000, "springLength": 200, "avoidOverlap": 0}}, "layout": {"improvedLayout": false}};

                  


                  

                  network = new vis.Network(container, data, options);

                  

                  

                  


                  

                  return network;

              }
              drawGraph();
        



        

        
        // ===============================================================
        // WRAPPER GLOBAL PARA INTERCEPTAR TODAS AS DELE√á√ïES DE N√ìS
        // ===============================================================
        // Colocar logo ap√≥s a cria√ß√£o do network (depois de: var network = new vis.Network(...))

        (function() {
            // Guardar refer√™ncia original
            const deleteSelectedOriginal = network.deleteSelected.bind(network);
            
            // Sobrescrever com wrapper
            network.deleteSelected = function() {
                // Capturar n√≥s que ser√£o deletados ANTES da dele√ß√£o
                const nodosADeletar = network.getSelectedNodes();
                
                if (nodosADeletar.length > 0) {
                    console.log(`üîÑ Interceptando dele√ß√£o de ${nodosADeletar.length} n√≥s...`);
                    
                    // Identificar n√≥s adjacentes que precisar√£o ser recalculados
                    let nosParaAtualizar = new Set();
                    nodosADeletar.forEach(nodeId => {
                        try {
                            let vizinhos = network.getConnectedNodes(nodeId);
                            vizinhos.forEach(v => nosParaAtualizar.add(v));
                        } catch (e) {}
                    });
                    
                    // Executar dele√ß√£o original
                    deleteSelectedOriginal();
                    




                    // Recalcular tamanhos ap√≥s a dele√ß√£o (pequeno delay)
                    setTimeout(() => {
                        let atualizacoes = [];
                        nosParaAtualizar.forEach(nodeId => {
                            try {
                                
                                if (!nodes.get(nodeId)) return;
                                let arestas = network.getConnectedEdges(nodeId);

                                atualizacoes.push({
                                    id: nodeId,
                                    value: arestas.length
                                });
                            } catch (e) {}
                        });
                        
                        if (atualizacoes.length > 0) {
                            nodes.update(atualizacoes);
                            console.log(`‚úì ${atualizacoes.length} n√≥s adjacentes redimensionados`);

                            setTimeout(() => {

                                network.fit({
                                    animation: {
                                        duration: 500,
                                        easingFunction: 'easeInOutQuad'
                                    }
                                });

                                network.once("animationFinished", function () {

                                    // For√ßa reativa√ß√£o da f√≠sica (especialmente para grafos pequenos)
                                    network.setOptions({
                                        physics: { enabled: false }
                                    });

                                    requestAnimationFrame(() => {
                                        network.setOptions({
                                            physics: { enabled: true }
                                        });
                                    });

                                    const ids = nodes.getIds();
                                    if (ids.length === 0) return;

                                    // Escolhe um n√≥ qualquer
                                    const id = ids[0];
                                    const pos = network.getPositions([id])[id];

                                    if (!pos) return;

                                    // Micro deslocamento impercept√≠vel
                                    nodes.update({
                                        id: id,
                                        x: pos.x + 0.001,
                                        y: pos.y
                                    });

                                    // Agora sim: f√≠sica volta SEMPRE
                                    network.setOptions({
                                        physics: { enabled: true }
                                    });
                                });
                            }, 100);
                        }
                    }, 50);






                } else {
                    // Se n√£o h√° n√≥s selecionados, apenas executar original
                    deleteSelectedOriginal();
                }
            };
            
            //console.log("‚úì Wrapper de dele√ß√£o instalado - rec√°lculo autom√°tico ativado");
        })();


        // ===============================================================
        // HANDLER PARA nodes.remove() - USADO PELO BOT√ÉO OTIMIZA√á√ÉO
        // ===============================================================

        (function() {
            // Guardar refer√™ncia original do DataSet
            const nodesDataSet = nodes;
            const removeOriginal = nodesDataSet.remove.bind(nodesDataSet);
            
            // Sobrescrever com wrapper
            nodesDataSet.remove = function(ids) {
                // Normalizar ids para array
                const nodosADeletar = Array.isArray(ids) ? ids : [ids];
                
                if (nodosADeletar.length > 0) {
                    console.log(`üîÑ Interceptando nodes.remove() de ${nodosADeletar.length} n√≥s...`);
                    
                    // Identificar n√≥s adjacentes
                    let nosParaAtualizar = new Set();
                    nodosADeletar.forEach(nodeId => {
                        try {
                            let vizinhos = network.getConnectedNodes(nodeId);
                            vizinhos.forEach(v => nosParaAtualizar.add(v));
                        } catch (e) {}
                    });
                    
                    // Executar remo√ß√£o original
                    removeOriginal(ids);
                    
                    // Recalcular tamanhos ap√≥s remo√ß√£o
                    setTimeout(() => {
                        let atualizacoes = [];
                        nosParaAtualizar.forEach(nodeId => {
                            try {

                                //let arestas = network.getConnectedEdges(nodeId);
                                if (!nodes.get(nodeId)) return;
                                let arestas = network.getConnectedEdges(nodeId);

                                atualizacoes.push({
                                    id: nodeId,
                                    value: arestas.length
                                });
                            } catch (e) {}
                        });
                        
                        
                        if (atualizacoes.length > 0) {
                            nodesDataSet.update(atualizacoes);
                            console.log(`‚úì ${atualizacoes.length} n√≥s adjacentes redimensionados (via remove)`);

                            // ‚Üê ADICIONAR ESTAS LINHAS:
                            //network.physics.physicsEnabled = true;
                            //network.startSimulation();

                            
                            setTimeout(() => {

                                //network.fit({
                                //    animation: {
                                //        duration: 500,
                                //        easingFunction: 'easeInOutQuad'
                                //    }
                                //});
                                
                                network.once("animationFinished", function () {

                                    // For√ßa reativa√ß√£o da f√≠sica (especialmente para grafos pequenos)
                                    network.setOptions({
                                        physics: { enabled: false }
                                    });

                                    requestAnimationFrame(() => {
                                        network.setOptions({
                                            physics: { enabled: true }
                                        });
                                    });

                                    const ids = nodes.getIds();
                                    if (ids.length === 0) return;

                                    // Escolhe um n√≥ qualquer
                                    const id = ids[0];
                                    const pos = network.getPositions([id])[id];

                                    if (!pos) return;

                                    // Micro deslocamento impercept√≠vel
                                    nodes.update({
                                        id: id,
                                        x: pos.x + 0.001,
                                        y: pos.y
                                    });

                                    // Agora sim: f√≠sica volta SEMPRE
                                    network.setOptions({
                                        physics: { enabled: true }
                                    });
                                });
                            }, 100);                            
                        }
                    }, 50);

                } else {
                    removeOriginal(ids);
                }
            };
            
            //console.log("‚úì Wrapper de nodes.remove() instalado");
        })();
        









        // ####################################
        // CRIA FUN√á√ÉO DE MENSAGENS TEMPOR√ÅRIAS
        // ####################################

        // As mensagens s√£o exibidas na tela pelo tempo definido no par√¢metro da fun√ß√£o
        // 178, 255, 178, 1

        var timerId;
        function tempAlert(msg, duration) {

            let divRemover = document.getElementById("el-id");

            // verifica se a div existe
            if (divRemover) {

                // Cancela o temporizador anterior
                clearTimeout(timerId);
                
                // Remova a div usando o m√©todo remove()
                divRemover.remove();
            }


            var el = document.createElement("div");
            el.id = "el-id";
            el.setAttribute("style","position:absolute;top:30px;right:21px;max-width:calc(100% - 86px);width:fit-content;border:5px solid rgba(245, 245, 245, 1);border-radius: 5px;background-color:rgba(245, 245, 245, 1);height: auto;");
            el.innerHTML = msg;
            timerId = setTimeout(function(){
                el.parentNode.removeChild(el);
            }, duration);
            document.body.appendChild(el);
        }



        // #################################################
        // CRIA FUN√á√ÉO QUE AVISA QUANDO CAPSLOCK FOI ATIVADA
        // #################################################

        // EXIBE AVISO DE CAPSLOCK ATIVADA
        function capsLockAtivada(msg, duration) {
            var el = document.createElement("div");
            el.setAttribute("style","position:absolute;top:30px;left:61px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
            el.innerHTML = msg;
            setTimeout(function(){
            el.parentNode.removeChild(el);
            },duration);
            document.body.appendChild(el);
        }

        // EXIBE AVISO DE CAPSLOCK DESATIVADA
        function capsLockDesativada(msg, duration) {
            var el = document.createElement("div");
            el.setAttribute("style","position:absolute;top:30px;left:61px;border:5px solid rgba(178, 255, 178, 1);border-radius: 5px;background-color:rgba(178, 255, 178, 1);");
            el.innerHTML = msg;
            setTimeout(function(){
            el.parentNode.removeChild(el);
            },duration);
            document.body.appendChild(el);
        }



        var el_2 = ''
        var toggle_caps = 0;
        document.addEventListener('keydown', (event) => {

            if(event.code === "CapsLock"){

                let isCapsLockOn = event.getModifierState("CapsLock");

                if(isCapsLockOn) {

                    el_2 = document.createElement("div");
                    el_2.setAttribute("style","position:absolute;top:30px;left:61px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
                    el_2.innerHTML = "Tecla CapsLock Ativada";
                    document.body.appendChild(el_2);
                    //console.log("Caps Lock turned on");

                    toggle_caps = 1;

                } else if (!isCapsLockOn && toggle_caps == 1) {

                    el_2.style.display = "none";
                    capsLockDesativada("Tecla CapsLock Desativada", 3000);
                    //console.log("Caps Lock turned off");

                }
            }
        });


        // EXIBE AVISO NO CARREGAMENTO DA P√ÅGINA DE QUE A TECLA CAPSLOCK EST√Å ATIVADA
        //document.addEventListener("DOMContentLoaded", function(event) {
        //    if (event.getModifierState("CapsLock")) {
        //        //el_2 = document.createElement("div");
        //        //el_2.setAttribute("style","position:absolute;top:30px;left:61px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
        //        //el_2.innerHTML = "Tecla CapsLock Ativada";
        //        //document.body.appendChild(el_2);
        //    }
        //});



        //setInterval(function() {
        //    var capsLockOn = navigator.getKeyboardState ? navigator.getKeyboardState()[0].shiftKey : false; // verifica se Caps Lock est√° ativado
            
        //    if (capsLockOn) {
        //        var div = document.createElement('div'); // cria um novo elemento de div
        //        div.textContent = 'A tecla Caps Lock est√° ativada!'; // define o conte√∫do da div
        //        div.style.color = 'red'; // define a cor da fonte da div
        //        div.style.fontSize = '20px'; // define o tamanho da fonte da div
        //        div.style.fontWeight = 'bold'; // define o peso da fonte da div
        //        div.style.marginTop = '10px'; // define a margem superior da div
                
        //        var container = document.getElementById('visualization'); // obt√©m o elemento do cont√™iner da biblioteca vis.js
        //        container.appendChild(div); // adiciona a div ao cont√™iner
        //        console.log('oi')
        //    }
        //}, 2000); // verifica o estado da tecla Caps Lock a cada segundo




        // ##########################
        // ACUMULA N√ìS - TECLAS + E -
        // ##########################

        // OS ITENS DO ARRAY SALVO NO 'localStorage' S√ÉO ABERTOS PELA TECLA 'y'

        // localStorage: https://codetheweb.blog/javascript-localstorage/
        
        // CRIA ARRAY VAZIO SE ELE AINDA N√ÉO EXISTIR E SALVA EM 'localStorage'
        if (localStorage.getItem("nos_acum") == null) {
            var empty_array = new Array();
            localStorage.setItem('nos_acum', JSON.stringify(empty_array));
        }
        
        document.addEventListener('keydown', (event) => {

                // INCLUI N√ìS SELECIONADOS NO ARRAY 'nos_acum' E SALVA EESSE ARRAY NO 'localStorage'
                if (event.key == '+') {
                    
                    let s = network.getSelectedNodes();

                    let nos_acum = []

                    if (s.length > 0) {
                    
                        for (let i=0; i<s.length; i++) {
                            nos_acum.push(s[i]);
                        }

                        // RESTAURA O ARRAY
                        let temp = JSON.parse(localStorage.getItem("nos_acum"));

                        // ADICIONA ITENS AO ARRAY
                        temp = temp.concat(nos_acum)

                        // ELIMINA DUPLICIDADES DO ARRAY
                        temp = [...new Set(temp)];

                        // GRAVA NOVO ARRAY NO 'localStorage' (SUBSTITUI O ANTERIOR)
                        localStorage.setItem('nos_acum', JSON.stringify(temp));

                        // EXIBE NOVO ARRAY
                        tempAlert(`Tecla (${event.key}) - Adiciona item √† lista de n√≥s-alvos (${temp.length}): ${temp.join(' ||| ')}`, 3000);
                    
                    
                    // EXIBE ARRAY SE NENHUM N√ì ESTIVER SELECIONADO
                    } else {

                        // RESTAURA O ARRAY
                        let temp = JSON.parse(localStorage.getItem("nos_acum"));

                        tempAlert(`Tecla (${event.key}) - Lista de n√≥s-alvos (${temp.length}): ${temp.join(' ||| ')}`, 3000);
                    }
                    
                // EXCLUI √öLTIMO ITEM DO ARRAY 'nos_acum' SALVO NO 'localStorage'
                } else if (event.key == '-') {

                    // RESTAURA O ARRAY
                    let temp = JSON.parse(localStorage.getItem("nos_acum"));

                    // EXCLUI √öLTIMO ITEM DO ARRAY
                    temp.pop();

                    // GRAVA NOVO ARRAY NO 'localStorage' (SUBSTITUI O ANTERIOR)
                    localStorage.setItem('nos_acum', JSON.stringify(temp));

                    tempAlert(`Tecla (${event.key}) - Remove √∫ltimo item da lista de n√≥s-alvos (${temp.length}): ${temp.join(' ||| ')}`, 3000);
                }            
        });



        // ###########################################
        // ATIVA E DESATIVA O MODO DE CAPTURA - TECLA |
        // ###########################################

        var toggle_ponto_e_virgula = true

        document.addEventListener('keydown', (event) => {

            if (event.key == '|' && toggle_ponto_e_virgula == true) {

                async function capturaDesativa(param) {
                    await navigator.clipboard.writeText(param)
                }

                let no_unico = network.getSelectedNodes();
                let idno = ''
                if (no_unico.length == 1) {
                    idno = no_unico[0]
                }

                let temp = "AAAdesativaAAA" + idno;
                
                setTimeout(() => {capturaDesativa(temp)}, 0)

                toggle_ponto_e_virgula = false

                el_1 = document.createElement("div");
                el_1.setAttribute("style","position:absolute;top:30px;left:61px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
                el_1.innerHTML = `Tecla ${event.key} - Modo de captura desativado`;
                document.body.appendChild(el_1);
            
            } else if (event.key == '|' && toggle_ponto_e_virgula == false) {

                async function capturaAtiva(param) {
                    await navigator.clipboard.writeText(param)
                }

                let temp = "AAAativaAAA";
                
                setTimeout(() => {capturaAtiva(temp)}, 0)

                el = document.createElement("div");
                el.setAttribute("style","position:absolute;top:30px;left:61px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
                el.innerHTML = `Tecla ${event.key} - Modo de captura ativado`;

                toggle_ponto_e_virgula = true

                el_1.style.display = "none";

                // Exibe informa√ß√µes na tela
                capsLockDesativada(`Tecla ${event.key} - Modo de captura ativado`, 3000);
            }
        });



        // ########################################################
        // ABRE P√ÅGINA COM PESQUISA AVAN√áADA - TECLA 1 A 9
        // ########################################################

        document.addEventListener('keydown', (event) => {

            // TECLA 1 - VALIDAR DADOS DO CNPJ NO SITE DA RECEITA FEDERAL
            if (event.key == '1') {
                let sel = network.getSelectedNodes();
                if (sel.length == 1 && sel[0].slice(0, 3) == 'PJ_') {
                    let cnpj = sel[0].slice(3);
                    let link_consulta_cnpj = "https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj=" + cnpj;
                    window.open(link_consulta_cnpj, target="_blank", windowFeature='left=50,top=100,width=800,height=600');
                    
                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Validar CNPJ no site da Receita Federal`, 3000);
                }
            }



            // TECLA 2 - VALIDAR CEIS, CEPIM, CNEP e Acordo de Leni√™ncia
            if (event.key == '2') {

                let sel = network.getSelectedNodes();
                if (sel.length == 1 && sel[0].slice(0, 3) == 'PJ_') {
                    let cnpj = sel[0].slice(3);
                    let link_consulta_cnpj = `https://portaldatransparencia.gov.br/sancoes/consulta?paginacaoSimples=true&tamanhoPagina=&offset=&direcaoOrdenacao=asc&cpfCnpj=${cnpj}&colunasSelecionadas=linkDetalhamento%2Ccadastro%2CcpfCnpj%2CnomeSancionado%2CufSancionado%2Corgao%2CcategoriaSancao%2CdataPublicacao%2CvalorMulta%2Cquantidade`;
                    window.open(link_consulta_cnpj, target="_blank", windowFeature='left=50,top=100,width=800,height=600');
                    
                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Validar CNPJ no site da Receita Federal`, 3000);
                }
            }



            // TECLA 3 - VALIDAR D√çVIDAS COM A UNI√ÉO
            // Ainda n√£o implementado



            // TECLA 4 - ABRE ARQUIVOS EXCEL COM N√ìS E ARESTAS
            if (event.key == '4') {
                
                async function copyOperation(param) {
                    await navigator.clipboard.writeText(param)
                };

                setTimeout(() => {copyOperation('***ABRE-EXCEL***')}, 0)

                tempAlert(`Tecla ${event.key} - Abre arquivos Excel de n√≥s e de arestas`, 3000);
            }



            // TECLA 5 - ABRE SITE REDE CNPJ
            if (event.key == "5") {

                window.open("https://www.redecnpj.com.br/rede/", "_blank", "left=50,top=100,width=600,height=600");

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Abre site Rede CNPJ`, 3000);

            }
            


            // TECLA 6 - EXIBE P√ÅGINA DA RECEITA FEDERAL E DA PGFN CONTENDO BASES DE DADOS
            if (event.key == '6') {

                let link_pep = "https://portaldatransparencia.gov.br/download-de-dados/pep";
                window.open(url=link_pep, target="_blank", windowFeature='left=200,top=140,width=600,height=500');
                
                let link_cnpj = "https://dados.gov.br/dados/conjuntos-dados/cadastro-nacional-da-pessoa-juridica---cnpj";
                window.open(url=link_cnpj, target="_blank", windowFeature='left=150,top=110,width=600,height=500');

                let link_cgu = "https://portaldatransparencia.gov.br/sancoes";
                window.open(url=link_cgu, target="_blank", windowFeature='left=100,top=80,width=600,height=500');

                let link_pgfn = "https://www.gov.br/pgfn/pt-br/assuntos/divida-ativa-da-uniao/transparencia-fiscal-1/copy_of_dados-abertos"
                window.open(url=link_pgfn, target="_blank", windowFeature='left=50,top=50,width=600,height=500');

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Bases de dados da Receita Federal e da PGFN`, 3000);
            }



            // TECLA 7 - EXIBE ARQUIVO JSON DA EMPRESA
            if (event.key == '7') {
                let sel = network.getSelectedNodes();
                if (sel.length == 1) {
                    if (sel[0].slice(0, 3) == 'PJ_') {
                        let parametro = sel[0].slice(3);
                        let link = "http://jsonviewer.stack.hu/#http://publica.cnpj.ws/cnpj/" + parametro;
                        window.open(link, target="_blank", windowFeature='left=50,top=100,width=600,height=600');
                    }

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Dados da empresa no formato JSON`, 3000);

                }
            }



            // TECLA 8 - PESQUISA POR FORNECEDORES PJ - UNI√ÉO
            if (event.key == '8') {

                let sel = network.getSelectedNodes();

                if (sel.length == 1) {

                    // PESSOA JUR√çDICA
                    if (sel[0].slice(0, 3) == 'PJ_') {
                        let parametro = nodes.get(sel[0]);
                        parametro = parametro.id.slice(3)

                        let link_fornecedores_uniao = "https://compras.dados.gov.br/fornecedores/doc/fornecedor_pj/" + parametro;
                        window.open(url=link_fornecedores_uniao, target="_blank", windowFeature='left=50,top=50,width=600,height=500');
                    }

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Pesquisa n√≥ selecionado entre fornecedores da Uni√£o`, 3000);
                }
            }



            // TECLA 9 - BAIXA ARQUIVOS JSON DO VIS.JS (nodes.json e edges.json)
            if (event.key == '9') {

                function salvarGrafoJSON() {
                    // Captura os dados atuais
                    const nodesAtuais = network.body.data.nodes.get({returnType: "Object"});
                    const edgesAtuais = network.body.data.edges.get({returnType: "Object"});
                    
                    // Converte para arrays
                    const nodesArray = Object.values(nodesAtuais);
                    const edgesArray = Object.values(edgesAtuais);
                    
                    // Fun√ß√£o auxiliar para fazer download
                    function downloadJSON(data, filename) {
                        const json = JSON.stringify(data, null, 2);
                        const blob = new Blob([json], {type: 'application/json;charset=utf-8'});
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        link.click();
                        URL.revokeObjectURL(url);
                    }
                    
                    // Salva os dois arquivos
                    downloadJSON(nodesArray, `nodes.json`);
                    setTimeout(() => {
                        downloadJSON(edgesArray, `edges.json`);
                    }, 200);
                }
                
                // Chama a fun√ß√£o (FORA da defini√ß√£o)
                salvarGrafoJSON();
                
                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Baixa arquivos JSON com n√≥s e arestas`, 3000);
            }



            //  TECLA 0 - N√ÉO ATRIBUIR ATALHO PARA A TECLA 0, POIS IMPEDE AJUSTAR O ZOOM DO NAVEGADOR AO VALOR PADR√ÉO (100%) POR MEIO DE CTRL + 0

        });



        // ################################
        // SELECIONA TODOS OS N√ìS - TECLA A
        // ################################

        document.addEventListener('keydown', (event) => {
            if (event.key == "A") {
                network.selectNodes(nodes.getIds());
                
                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Seleciona todos os n√≥s (${network.getSelectedNodes().length})`, 3000);
            }

        })



        // ###############################################################################################
        // SELECIONA N√ìS ADJACENTES AOS N√ìS SELECIONADOS DE FORMA ACUMULATIVA, CAMADA POR CAMADA - TECLA a
        // ###############################################################################################

        var sel_anterior = [];
        document.addEventListener('keydown', (event) => {

            if (event.key == "a" && network.getSelectedNodes().length > 0) {

                // Desseleciona todos os n√≥s quando a sele√ß√£o alcan√ßa todos os n√≥s
                if (network.getSelectedNodes().length > 0 && network.getSelectedNodes().length == nodes.getIds().length) {
                    tempAlert(`Tecla ${event.key} - Desseleciona todos os n√≥s (${nodes.getIds().length})`, 3000);
                }

                // Exibe mensagem informativa
                //if (network.getSelectedNodes().length > 0 && network.getSelectedNodes().length == nodes.getIds().length) {
                //    tempAlert(`Tecla ${event.key} - Desseleciona todos os n√≥s (${nodes.getIds().length})`, 3000);
                //}


                // DESATIVA A F√çSICA NO IN√çCIO DA SELE√á√ÉO
                //network.physics.physicsEnabled = false;
                //network.physics.stopSimulation();

                // VERIFICA SE TODOS OS N√ìS FORAM SELECIONADOS
                if ([...new Set(sel_anterior)].length == nodes.getIds().length) {
                    network.unselectAll();
                    sel_anterior = [];
                }

                let sel = network.getSelectedNodes();

                // IMPEDE QUE DOIS OU MAIS N√ìS SEJAM SELECIONADOS NO IN√çCIO DO SCRIPT
                if (sel.length > 1 && sel_anterior.length == 0) {
                    for (let i=0; i<sel.length; i++) {
                        nodes.update({id: sel[i], font: {color: '#777777'}})
                    }
                    network.unselectAll();
                    network.physics.physicsEnabled = true;
                    network.physics.startSimulation();
                    return;
                }

                for (let i=0; i<sel.length; i++) {
                    if (!(sel[i] in sel_anterior)) {
                        let temp_a = network.getConnectedNodes(sel[i]);
                        sel_anterior = sel_anterior.concat(temp_a);
                    }
                }
                
                if (sel.length == 1) {
                    sel_anterior = sel_anterior.concat(sel);
                    network.selectNodes(sel_anterior);
                    nodes.update({id: sel[0], font: {color: '#777777'}});
                } else {
                    network.selectNodes(sel_anterior);
                }

                // REATIVA A F√çSICA AP√ìS A √öLTIMA CAMADA SER SELECIONADA E TODA A REDEE SER DESSELECIONADA
                //if (network.getSelectedNodes().length == 0) {
                //    network.physics.physicsEnabled = true;
                //    network.physics.startSimulation();
                //}


                if (network.getSelectedNodes().length > 0) {
                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes (${network.getSelectedNodes().length}/${nodes.getIds().length})`, 3000);
                }
            
            } else if (event.key == "a" && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione um n√≥ para selecionar seus n√≥s adjacentes`, 3000);
            }
        });
        


        // ######################################################
        // AJUSTE AUTOM√ÅTICO DA ALTURA DA √ÅREA DO GRAFO - TECLA b
        // ######################################################
        
        document.addEventListener('keydown', (event) => {
            if (event.key == 'b') {
                    // EXTRAI DIMENS√ïES DA √ÅREA DO GRAFO
                    //let box = document.querySelector('#mynetwork');
                    //let width = box.offsetWidth;
                    //let height = box.offsetHeight;
                    
                    // EXTRAI DIMENS√ïES DA JANELA DO NAVEGADOR
                    //var w = window.innerWidth;
                    var h = window.innerHeight;
                    
                    // AJUSTA ALTURA DA √ÅREA DO GRAFO √Ä ALTURA DA JANELA
                    document.querySelector('#mynetwork').style.height = h - 20;

                    // ENQUADRA GRAFO. FUNCIONA APENAS AP√ìS A ALTURA TER SIDO AJUSTADA ()
                    //network.fit();

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Ajusta altura da janela de visualiza√ß√£o`, 3000);

            }
        });


        // ##############################################
        // CENTRALIZA N√ìS SELECIONADOS - TECLA c (CENTER)
        // ##############################################

        /* var toggle_c = true;

        document.addEventListener('keydown', (event) => {
            
            // S√ì FUNCIONA NO LAYOUT BARNES-HUT E COM APENAS UM N√ì SELECIONADO
            if (event.key == 'c' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 1 && toggle_c == true) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)
                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                // PARTE PRINCIPAL
                //network.fit({nodes: con_nodes, maxZoomLevel: 1, animation: false});

                let ss = network.getSelectedNodes();

                // PARTE PRINCIPAL
                for (let i=0; i<ss.length; i++) {
                    p = network.getPosition(ss[i]);
                    network.moveTo({
                        position: {x: p['x'], y: p['y']},
                        scale: 1,
                        offset: {x:0, y:0}
                    });
                }
            
                toggle_c = false;

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Centraliza n√≥ selecionado`, 3000);

                

            // EXIBE N√ìS CONECTADOS AOS N√ìS SELECIONADOS
            } else if (event.key == 'c' && network.physics.options.solver == 'barnesHut') {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)
                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                let sel_nodes = network.getSelectedNodes();

                // EXTRAI NOS CONECTADOS AO N√ì SELECIONADO
                let con_nodes = []
                let temp = []
                if (sel_nodes.length > 0) {
                    for (var i=0; i<sel_nodes.length; i++) {
                        temp = network.getConnectedNodes(sel_nodes[i]);
                        temp2 = temp.concat(sel_nodes);
                        con_nodes = con_nodes.concat(temp2)
                    }
                }

                // PARTE PRINCIPAL
                network.fit({nodes: con_nodes, maxZoomLevel: 1, animation: false});
                toggle_c = true

                // Exibe informa√ß√µes na tela
                if (network.getSelectedNodes().length == 0) {                  
                    tempAlert(`Tecla ${event.key} - Enquadra todos os n√≥s`, 3000);
                } else {
                    tempAlert(`Tecla ${event.key} - Enquadra n√≥s adjacentes aos n√≥s selecionados`, 3000);
                }
            }
        }); */



        // NOVA FUN√á√ÉO

        var toggle_c = 0;

        document.addEventListener('keydown', (event) => {
            
            // 1) UM N√ì SELECIONADO (S√ì FUNCIONA NO LAYOUT BARNES-HUT)
            if (event.key == 'c' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 1 && toggle_c == 0) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)
                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                let ss = network.getSelectedNodes();

                // PARTE PRINCIPAL
                for (let i=0; i<ss.length; i++) {
                    p = network.getPosition(ss[i]);

                    network.moveTo({
                        position: {x: p['x'], y: p['y']},
                        scale: 1,
                        offset: {x:0, y:0}
                    });                    
                }
            
                toggle_c = 1;

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Centraliza n√≥ selecionado`, 3000);

                

            // 2) UM N√ì SELECIONADO - EXIBE N√ìS CONECTADOS AO N√ì √öNICO SELECIONADO
            } else if (event.key == 'c' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 1 && toggle_c == 1) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)
                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                let sel_nodes = network.getSelectedNodes();

                // EXTRAI NOS CONECTADOS AO N√ì SELECIONADO
                let con_nodes = []
                let temp = []
                if (sel_nodes.length > 0) {
                    for (var i=0; i<sel_nodes.length; i++) {
                        temp = network.getConnectedNodes(sel_nodes[i]);
                        temp2 = temp.concat(sel_nodes);
                        con_nodes = con_nodes.concat(temp2)
                    }
                }                

                setTimeout(() => {
                    network.fit({
                        nodes: con_nodes,
                        animation: {
                            duration: 500,
                            easingFunction: 'easeInOutQuad'
                        }
                    });
                    setTimeout(() => {
                        network.startSimulation();
                        network.physics.physicsEnabled = true;
                    }, 600);
                }, 100);

                toggle_c = 2

                tempAlert(`Tecla ${event.key} - Enquadra n√≥s adjacentes ao n√≥ selecionado`, 3000);



            // 3) UM N√ì SELECIONADO - ENQUADRA TODOS OS N√ìS
            } else if (event.key == 'c' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 1 && toggle_c == 2) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)

                setTimeout(() => {
                    network.fit({
                        animation: {
                            duration: 500,
                            easingFunction: 'easeInOutQuad'
                        }
                    });
                    setTimeout(() => {
                        network.startSimulation();
                        network.physics.physicsEnabled = true;
                    }, 600);
                }, 100);
  
                tempAlert(`Tecla ${event.key} - Enquadra todos os n√≥s (sem n√≥s selecionados)`, 3000);

                toggle_c = 0

                
            // ============================================
                
            
            // 4) DOIS OU MAIS N√ìS SELECIONADOS - EXIBE N√ìS CONECTADOS AOS N√ìS SELECIONADOS
            } else if (event.key == 'c' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length > 1 && toggle_c == 0) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)
                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                let sel_nodes = network.getSelectedNodes();

                // EXTRAI NOS CONECTADOS AO N√ì SELECIONADO
                let con_nodes = []
                let temp = []
                if (sel_nodes.length > 0) {
                    for (var i=0; i<sel_nodes.length; i++) {
                        temp = network.getConnectedNodes(sel_nodes[i]);
                        temp2 = temp.concat(sel_nodes);
                        con_nodes = con_nodes.concat(temp2)
                    }
                }                

                setTimeout(() => {
                    network.fit({
                        nodes: con_nodes,
                        animation: {
                            duration: 500,
                            easingFunction: 'easeInOutQuad'
                        }
                    });
                    setTimeout(() => {
                        network.startSimulation();
                        network.physics.physicsEnabled = true;
                    }, 600);
                }, 100);

                toggle_c = 1

                tempAlert(`Tecla ${event.key} - Enquadra n√≥s adjacentes aos n√≥s selecionados`, 3000);



            // 5) MAIS DE UM N√ì SELECIONADOS - ENQUADRA TODOS OS N√ìS
            } else if (event.key == 'c' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length > 1 && toggle_c == 1) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)
                setTimeout(() => {
                    network.fit({
                        animation: {
                            duration: 500,
                            easingFunction: 'easeInOutQuad'
                        }
                    });
                    setTimeout(() => {
                        network.startSimulation();
                        network.physics.physicsEnabled = true;
                    }, 600);
                }, 100);
  
                tempAlert(`Tecla ${event.key} - Enquadra todos os n√≥s (sem n√≥s selecionados)`, 3000);

                toggle_c = 0

                
            // ============================================

            // && network.physics.options.solver == 'barnesHut' 
            // 6) NENHUM N√ì SELECIONADO - ENQUADRA TODOS OS N√ìS
            } else if (event.key == 'c' && network.getSelectedNodes().length == 0) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHORA DESEMPENHO)
                network.physics.stopSimulation();
                
                setTimeout(() => {
                    network.fit({
                        animation: {
                            duration: 500,
                            easingFunction: 'easeInOutQuad'
                        }
                    });
                    setTimeout(() => {
                        network.startSimulation();
                    }, 600);
                }, 100);

                toggle_c = 0
  
                tempAlert(`Tecla ${event.key} - Enquadra todos os n√≥s (sem n√≥s selecionados)`, 3000);
            }
        });




        // ##########################################
        // GERA QR CODE PARA A URL DO GRAFO - TECLA C
        // ##########################################

        // document.addEventListener('keydown', (event) => {
        //     if (event.key == 'C') {
        //         // Verificar se √© uma URL v√°lida (http ou https)
        //         const urlAtual = window.location.href;
        //         const isURL = urlAtual.startsWith('http://') || urlAtual.startsWith('https://');
                
        //         if (!isURL) {
        //             // Exibir mensagem se n√£o for URL
        //             tempAlert(`Tecla ${event.key} - Funcionalidade dispon√≠vel apenas para vers√£o web do SINARC`, 3000);
        //             return;
        //         }

        //         tempAlert(`Tecla ${event.key} - Exibe QR Code para compartilhamento da URL do grafo`, 3000);
                
        //         // Criar overlay de fundo
        //         const overlay = document.createElement('div');
        //         overlay.style.cssText = `
        //             position: fixed;
        //             top: 0;
        //             left: 0;
        //             width: 100%;
        //             height: 100%;
        //             background-color: rgba(0, 0, 0, 0.5);
        //             display: flex;
        //             justify-content: center;
        //             align-items: center;
        //             z-index: 9999;
        //             cursor: pointer;
        //         `;
                
        //         // Criar container do QR Code
        //         const container = document.createElement('div');
        //         container.style.cssText = `
        //             background-color: white;
        //             padding: 30px;
        //             border-radius: 10px;
        //             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        //             text-align: center;
        //         `;
                
        //         // Adicionar t√≠tulo
        //         const titulo = document.createElement('h2');
        //         titulo.textContent = 'Escaneie o QR Code';
        //         titulo.style.marginBottom = '20px';
        //         titulo.style.color = '#333';
        //         container.appendChild(titulo);
                
        //         // Criar imagem do QR Code usando API p√∫blica
        //         const urlEncoded = encodeURIComponent(urlAtual);
        //         const qrCodeImg = document.createElement('img');
        //         qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${urlEncoded}`;
        //         qrCodeImg.alt = 'QR Code da p√°gina';
        //         qrCodeImg.style.cssText = `
        //             width: 300px;
        //             height: 300px;
        //             display: block;
        //             margin: 0 auto;
        //         `;
        //         container.appendChild(qrCodeImg);
                
        //         // Adicionar URL abaixo do QR Code
        //         const urlText = document.createElement('p');
        //         urlText.textContent = urlAtual;
        //         urlText.style.cssText = `
        //             margin-top: 15px;
        //             font-size: 12px;
        //             color: #666;
        //             word-break: break-all;
        //             max-width: 300px;
        //         `;
        //         container.appendChild(urlText);
                
        //         // Adicionar instru√ß√£o para fechar
        //         const instrucao = document.createElement('p');
        //         instrucao.textContent = 'Clique em qualquer lugar para fechar';
        //         instrucao.style.cssText = `
        //             margin-top: 10px;
        //             font-size: 14px;
        //             color: #999;
        //         `;
        //         container.appendChild(instrucao);
                
        //         // Adicionar container ao overlay
        //         overlay.appendChild(container);
                
        //         // Fechar ao clicar no overlay
        //         overlay.addEventListener('click', function(e) {
        //             if (e.target === overlay) {
        //                 document.body.removeChild(overlay);
        //             }
        //         });
                
        //         // Prevenir fechamento ao clicar no container
        //         container.addEventListener('click', function(e) {
        //             e.stopPropagation();
        //         });
                
        //         // Adicionar ao body
        //         document.body.appendChild(overlay);
        //     }
        // });



        // #####################################################################
        // SELECIONA N√ìS √öNICOS (EN, EM E TE) PARA SIMPLIFICAR O GRAFO - TECLA √ß
        // #####################################################################

        var toggle_√ß = 0;
        document.addEventListener("keypress", function(event) {

            // if (event.key === "√ß" && network.getSelectedNodes().length == 0 && toggle_√ß == 0) {
            if (event.key === "√ß" && toggle_√ß == 0) {


            
                // TRECHO INCLU√çDO PARA DESSELECIONAR TODOS OS N√ìS ANTES DE APLICAR A NOVA SELE√á√ÉO
                network.unselectAll();

                // Obt√©m todos os n√≥s
                let allNodeIds = nodes.getIds();

                // Cria array de atualiza√ß√µes
                let updatedNodes = [];
                for (let i = 0; i < allNodeIds.length; i++) {
                    updatedNodes.push({
                        id: allNodeIds[i],
                        font: {
                            color: "#777777",
                            bold: false  // Remove negrito que causa cor vermelha
                        }
                    });
                }

                // Atualiza todos os n√≥s de uma vez
                nodes.update(updatedNodes);

                network.redraw();

                


                let nod = nodes.getIds();
                let nodToSelect = [];
                for (var i = 0; i < nod.length; i++) {
                    if ((nod[i].slice(0, 3) == "TE_") || (nod[i].slice(0, 3) == "EN_") || (nod[i].slice(0, 3) == "EM_")) {
                        if (network.body.nodes[nod[i]].edges.length == 1) {
                            nodToSelect.push(nod[i]);
                            //console.log(nod[i]);
                        }
                    }
                }
                network.selectNodes(nodToSelect);

                let percentual = (nodToSelect.length / nod.length) * 100;
                percentual = percentual.toFixed(1);

                tempAlert(`Tecla ${event.key} - Seleciona n√≥s EN, EM e TE com aresta √∫nica (${nodToSelect.length}) ${percentual}%`, 3000);

                toggle_√ß = 1;
            
            } else if (event.key === "√ß" && toggle_√ß == 1) {
                let nod = nodes.getIds();
                let nodToSelect = [];
                for (var i = 0; i < nod.length; i++) {
                    if ((nod[i].slice(0, 3) == "TE_") || (nod[i].slice(0, 3) == "EN_") || (nod[i].slice(0, 3) == "EM_")) {
                        nodToSelect.push(nod[i]);
                    }
                }
                network.selectNodes(nodToSelect);

                let percentual = (nodToSelect.length / nod.length) * 100;
                percentual = percentual.toFixed(1);

                tempAlert(`Tecla ${event.key} - Seleciona todos os n√≥s EN, EM e TE (${nodToSelect.length}) ${percentual}%`, 3000);

                toggle_√ß = 2;



            //} else if (event.key === "√ß" && toggle_√ß == 2) {

            //    let nod = nodes.getIds();
            //    let nodToSelect = [];
            //    for (var i = 0; i < nod.length; i++) {
            //        if (network.body.nodes[nod[i]].edges.length == 1) {
            //            nodToSelect.push(nod[i]);
            //        }
            //    }
            //    network.selectNodes(nodToSelect);

            //    let percentual = (nodToSelect.length / nod.length) * 100;
            //    percentual = percentual.toFixed(1);

            //    tempAlert(`Tecla ${event.key} - Seleciona todos os n√≥s com apenas uma aresta (${nodToSelect.length}) ${percentual}%`, 3000);

            //    toggle_√ß = 3;
            //}




            } else if (event.key === "√ß" && toggle_√ß == 2) {
                network.unselectAll();

                tempAlert(`Tecla ${event.key} - Desseleciona todos os n√≥s (${nodes.getIds().length})`, 3000);

                toggle_√ß = 0;
            }
        });



        // ######################################################################
        // ALTERNA ENTRE A SELE√á√ÉO DE N√ìS COM BASE NO N√öMERO DE ARESTAS - TECLA √á
        // ######################################################################

        var count_√á = 0;

        document.addEventListener("keypress", function(event) {
            
            if (event.key === "√á") {

                network.unselectAll();
                
                let nod = nodes.getIds();
                
                let num_arestas = [];
                for (var i = 0; i < nod.length; i++) {
                    let temp = network.body.nodes[nod[i]].edges.length;
                    temp = parseInt(temp);
                    num_arestas.push(temp);
                }

                num_arestas = [...new Set(num_arestas)];

                num_arestas.sort((a, b) => a - b); // Ordem CRESCENTE (menor ‚Üí maior)
                //num_arestas.sort((a, b) => b - a);  // Ordem DECRESCENTE (maior ‚Üí menor)
                
                //console.log(num_arestas);

                let nodToSelect = [];
                for (var i = 0; i < nod.length; i++) {
                    if (network.body.nodes[nod[i]].edges.length == num_arestas[count_√á]) {
                        nodToSelect.push(nod[i]);
                    }
                }
                
                network.selectNodes(nodToSelect);
            
                let percentual = (nodToSelect.length / nod.length) * 100;
                percentual = percentual.toFixed(1);


                if (num_arestas.length == count_√á) {
                    tempAlert(`Tecla ${event.key} - Desseleciona todos os n√≥s`, 3000);
                    count_√á = 0;
                
                } else {
                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s com ${num_arestas[count_√á]} arestas (${nodToSelect.length}) ${percentual}%`, 3000);
                    count_√á += 1;
                }
            }
        });



        // #####################################################
        // ABRE P√ÅGINA COM DETALHES DA PESSOA JUR√çDICA - TECLA d
        // #####################################################

        document.addEventListener('keydown', (event) => {
            if (event.key == 'd' && network.getSelectedNodes().length == 1) {
                var sel = network.getSelectedNodes();
                for (var i=0; i<sel.length; i++) {
                    if (sel.length > 0) {
                        for (var i=0; i<sel.length; i++) {

                            // PARA CONSULTA DE CNPJ
                            if (sel[i].slice(0, 3) == "PJ_") {
                                var cnpj = sel[i].slice(3);
                                //var link = "http://cnpj.info/" + cnpj;
                                //window.open(link, 'popup','left=50,top=100,width=600,height=600');

                                consultarCNPJ(cnpj);

                            // PARA CONSULTA DE ENDERE√áO
                            } else if (sel[i].slice(0, 3) == "EN_") {
                                var endereco = sel[i].slice(3).replace();
                                endereco = endereco.replaceAll(' ', '+');
                                var link = "https://maps.google.com/maps?q=" + endereco;
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');

                            // PARA CONSULTA DE E-MAIL
                            } else if (sel[i].slice(0, 3) == "EM_") {
                                var email = sel[i].slice(3).replace();
                                email = email.replaceAll(' ', '+').replace('@', '%40');
                                var link = "https://maps.google.com/search?q=" + '"' + email + '"';
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');
                            
                            // PARA CONSULTA DE PESSOA F√çSICA
                            } else if (sel[i].slice(0, 3) == "PF_") {
                                var nome_socio = sel[i].slice(15);
                                nome_socio = nome_socio.replaceAll(' ', '+');
                                //var link = "http://www.consultasocio.com/q/sa/" + nome_socio;
                                var link = "https://www.diretoriobrasil.net/buscar-socio/?termo=" + nome_socio + "&acao=Buscar"
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');
                            }

                            // Exibe informa√ß√µes na tela
                            tempAlert(`Tecla ${event.key} - Exibe detalhes do n√≥ selecionado (exceto TE)`, 3000);

                        }
                    }
                }

            } else if (event.key == 'd' && network.getSelectedNodes().length != 1) {
                tempAlert(`Tecla ${event.key} - Selecione um n√≥ para exibir detalhes (exceto TE)`, 3000);
            }
        });


        // -----------------------------------------
        // FUN√á√ÉO ADICIONAL PARA TECLA d (APENAS PJ)
        // -----------------------------------------

        /*async function consultarCNPJ(cnpj) {
            const cnpjLimpo = cnpj.replace(/\D/g, '');
            
            if (cnpjLimpo.length !== 14) {
                throw new Error('CNPJ inv√°lido! Deve conter 14 d√≠gitos.');
            }
            
            const response = await fetch('https://minhareceita.org/' + cnpjLimpo);
            
            if (!response.ok) {
                throw new Error('Erro ao consultar CNPJ. Verifique se o CNPJ est√° correto.');
            }
            
            const dados = await response.json();
            const html = gerarHTML(dados);
            
            // MODIFICADO AQUI:
            const novaJanela = window.open('', 'popup', 'left=50,top=50,width=1100,height=500,scrollbars=yes,resizable=yes');
            novaJanela.document.write(html);
            novaJanela.document.close();
        }*/

        

        async function consultarCNPJ(cnpj) {
            const cnpjLimpo = cnpj.replace(/\D/g, '');

            if (cnpjLimpo.length !== 14) {
                alert('CNPJ inv√°lido! Deve conter 14 d√≠gitos.');
                return;
            }

            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            let novaJanela = null;

            // üì± MOBILE ‚Üí abre imediatamente
            if (isMobile) {
                novaJanela = window.open('', '_blank');
                if (!novaJanela) {
                    alert('Pop-up bloqueado pelo navegador.');
                    return;
                }
                novaJanela.document.write(
                    '<p style="font-family:sans-serif;padding:20px">Carregando dados do CNPJ...</p>'
                );
            }

            try {
                const response = await fetch('https://minhareceita.org/' + cnpjLimpo);

                if (!response.ok) {
                    throw new Error('Erro ao consultar CNPJ.');
                }

                const dados = await response.json();
                const html = gerarHTML(dados);

                // üíª DESKTOP ‚Üí abre ap√≥s o fetch
                if (!isMobile) {
                    novaJanela = window.open(
                        '',
                        'popup',
                        'left=50,top=50,width=1100,height=500,scrollbars=yes,resizable=yes'
                    );
                }

                if (!novaJanela) {
                    alert('N√£o foi poss√≠vel abrir a nova janela.');
                    return;
                }

                novaJanela.document.open();
                novaJanela.document.write(html);
                novaJanela.document.close();

                } catch (error) {
                    if (novaJanela) {
                        novaJanela.document.write(
                            '<p style="font-family:sans-serif;padding:20px;color:red">Erro ao carregar dados.</p>'
                        );
                    }
                    console.error(error);
                    alert(error.message);
                }
            }



        // ##########################################################
        // ABRE P√ÅGINA COM DETALHES DA PESSOA JUR√çDICA - DUPLO CLIQUE
        // ##########################################################

        document.addEventListener('dblclick', () => {
            if (network.getSelectedNodes().length === 1) {
                const sel = network.getSelectedNodes()[0];
                if (sel.startsWith('PJ_')) {
                    consultarCNPJ(sel.slice(3));
                }
            }
        });







        function formatarCNPJ(cnpj) {
            if (!cnpj) return '<span style="color: #bbb; font-style: italic;">-</span>';
            return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }

        function formatarData(data) {
            if (!data) return '<span style="color: #bbb; font-style: italic;">-</span>';
            const partes = data.split('-');
            return partes[2] + '/' + partes[1] + '/' + partes[0];
        }

        function formatarMoeda(valor) {
            if (!valor) return '<span style="color: #bbb; font-style: italic;">-</span>';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }
        
        function formatarTelefone(tel) {
            if (!tel) return '<span style="color: #bbb; font-style: italic;">-</span>';
            const ddd = tel.substring(0, 2);
            const numero = tel.substring(2);
            if (numero.length === 9) {
                return '(' + ddd + ') ' + numero.substring(0, 5) + '-' + numero.substring(5);
            } else if (numero.length === 8) {
                return '(' + ddd + ') ' + numero.substring(0, 4) + '-' + numero.substring(4);
            }
            return '(' + ddd + ') ' + numero;
        }
        
        function formatarFaixaEtaria(faixa) {
            if (!faixa) return '<span style="color: #bbb; font-style: italic;">-</span>';
            const match = faixa.match(/\d+\s+a\s+\d+/);
            return match ? match[0] : faixa;
        }


        // DEFINE TEXTO DE PESQUISA GLOBALMENTE
        // PROMPT ORIGINAL


        /*
        const textoPesquisa = `Realize uma pesquisa profunda e detalhada sobre o hist√≥rico de conformidade e integridade relacionado ao alvo a seguir. 
            O objetivo √© identificar riscos reputacionais por meio de uma an√°lise forense com foco no controle externo da Administra√ß√£o P√∫blica e na produ√ß√£o de insights para a defesa do interesse p√∫blico. 
            Utilize intelig√™ncia com fontes abertas (OSINT) para coletar dados relevantes dispon√≠veis na internet, incluindo not√≠cias, registros p√∫blicos, listas de san√ß√µes, portais de transpar√™ncia, redes sociais e outras fontes confi√°veis. 
            Concentre-se em aspectos que possam indicar envolvimento em pr√°ticas il√≠citas, m√° conduta empresarial ou qualquer outro fator que possa comprometer a integridade e a reputa√ß√£o das pessoas ou entidades vinculadas ao alvo investigado.
            Por favor, forne√ßa as informa√ß√µes estruturadas da seguinte forma: 
            1. Identifica√ß√£o de V√≠nculos: Identifique pessoas f√≠sicas, pessoas jur√≠dicas, endere√ßos, telefones e e-mails associados ao alvo. Descreva o tipo de v√≠nculo encontrado (propriet√°rio, s√≥cio, usu√°rio, sede, contato, etc.).
            2. Not√≠cias e Irregularidades: Liste men√ß√µes em investiga√ß√µes, processos judiciais e administrativos p√∫blicos, inqu√©ritos ou not√≠cias sobre fraudes, corrup√ß√£o e irregularidades envolvendo a Administra√ß√£o P√∫blica e o interesse coletivo. 
            3. Rede de Liga√ß√µes: Identifique s√≥cios, empresas coligadas, parceiros de neg√≥cios ou outras entidades frequentemente citadas em conjunto com o alvo ou seus v√≠nculos. 
            4. Presen√ßa em Listas: Verifique se o alvo ou entidades vinculadas constam em portais de transpar√™ncia, listas de san√ß√µes ou registros de empresas e pessoas suspensas ou impedidas de contratar com a Administra√ß√£o P√∫blica (CEIS, CNEP, CEPIM, CEAF, CNIA, Acordo de Leni√™ncia, PEP).
            5. Atividades Comerciais: Descreva o setor de atua√ß√£o, principais atividades comerciais e qualquer hist√≥rico de contratos com o setor p√∫blico relacionados ao alvo ou entidades vinculadas. 
            6. Reputa√ß√£o Online: Analise avalia√ß√µes, coment√°rios, reclama√ß√µes e discuss√µes em redes sociais, f√≥runs, sites de reclama√ß√£o (Reclame Aqui, Procon) e sites especializados que mencionem o alvo.
            7. An√°lise de Padr√µes Suspeitos: Verifique se o alvo apresenta caracter√≠sticas t√≠picas de uso irregular, como: endere√ßos compartilhados por muitas empresas (endere√ßo de fachada), telefones associados a fraudes ou golpes, e-mails vinculados a vazamentos de dados ou atividades maliciosas.
            8. Hist√≥rico Financeiro: Investigue fal√™ncias, recupera√ß√µes judiciais ou outras quest√µes financeiras relevantes relacionadas a pessoas ou empresas vinculadas ao alvo. 
            9. Conformidade Legal: Verifique o cumprimento de obriga√ß√µes legais, fiscais e regulat√≥rias das entidades associadas ao alvo. 
            10. Outras Informa√ß√µes Relevantes: Inclua quaisquer outras informa√ß√µes que possam impactar a avalia√ß√£o de risco reputacional do alvo e seus v√≠nculos.
            11. Insights para Pesquisa: Forne√ßa 5 insights ou pontos de aten√ß√£o que possam guiar uma investiga√ß√£o mais aprofundada sobre o alvo. 
            12. Prompts para Aprofundamento: Ao final de cada resposta, apresente 6 novas sugest√µes de prompts para IA (de 1 a 6), distintas das sugest√µes j√° apresentadas na conversa, sendo a sexta op√ß√£o para gerar novos prompts contendo sugest√µes de outros temas ainda n√£o explorados, visando aprofundar ainda mais a investiga√ß√£o por meio de dados p√∫blicos dispon√≠veis na internet, de modo que o usu√°rio precise apenas digitar o n√∫mero do prompt desejado para a IA realizar a pesquisa correspondente. Pe√ßa para o usu√°rio digitar um n√∫mero.
        `;
        */

        
        const textoPesquisa = `
            Com o objetivo auxiliar o cidad√£o no controle social da Administra√ß√£o P√∫blica perante os Tribunais de Contas (art. 74, ¬ß 2¬∫, CF), realize "Due Diligence" e An√°lise Forense completas, incluindo conformidade e integridade legal, fiscal e regulat√≥ria sobre a entidade a seguir. Realize uma pesquisa profunda (deep research) usando OSINT a partir de dados p√∫blicos de CNPJ disponibilizados pela Receita Federal, coletando e cruzando informa√ß√µes dispon√≠veis em bases e sites governamentais, sites de not√≠cias, redes sociais e demais fontes p√∫blicas l√≠citas, a fim de identificar v√≠nculos, presen√ßa digital, san√ß√µes, contratos p√∫blicos, not√≠cias de irregularidades, processos, rede de relacionamentos, situa√ß√£o financeira da pessoa jur√≠dica, entre outras informa√ß√µes relevantes.
            Os achados dessa auditoria devem ser submetidos a uma an√°lise jur√≠dica rigorosa, √† luz da legisla√ß√£o aplic√°vel ‚Äî especialmente as Leis n¬∫ 14.133/2021, 8.429/1992, 12.846/2013 e LC n¬∫ 101/2000 ‚Äî, apontando padr√µes e anomalias que configurem ind√≠cios de irregularidades e estruturando sua resposta nos seguintes t√≥picos: 1. identifica√ß√£o de v√≠nculos, 2. presen√ßa digital, 3. san√ß√µes e impedimentos (CEIS, CNEP, CEPIM, CEAF, CNIA, TCU Inid√¥neos, Acordos de Leni√™ncia, PEP), 4. licita√ß√µes e contratos, 5. not√≠cias e men√ß√µes p√∫blicas, 6. processos judiciais e administrativos, 7. rede de relacionamentos, 8. padr√µes e anomalias identificados, 9. an√°lise de irregularidades, 10. reputa√ß√£o e hist√≥rico comercial, 11. situa√ß√£o financeira, 12. an√°lise jur√≠dica consolidada (informa√ß√µes sobre fato e autoria, elementos de convic√ß√£o e ind√≠cios de prova), 13. 5 pontos de aten√ß√£o e 14. 5 insights para aprofundamento). Finalize sempre com 5 novos prompts numerados. Pe√ßa para o usu√°rio escolher um n√∫mero. Respostas subsequentes devem manter o mesmo padr√£o de detalhamento e rigor t√©cnico.    
        
        `;    
        

        
        // PROMPT REDUZIDO
        /*
        const textoPesquisa = `
            Voc√™ √© um agente de pesquisa OSINT e an√°lise jur√≠dica para apoio ao controle social da Administra√ß√£o P√∫blica (art. 74, ¬ß2¬∫, CF). Sua fun√ß√£o √© pesquisar fontes abertas, analisar dados √† luz da legisla√ß√£o e produzir relat√≥rios que subsidiem den√∫ncias aos Tribunais de Contas, observando os requisitos de admissibilidade: clareza, informa√ß√µes sobre fato e autoria, elementos de convic√ß√£o e ind√≠cios de prova.
            Realize pesquisa profunda sobre a entidade informada, utilizando como par√¢metros os dados da base p√∫blica de CNPJ/RFB (raz√£o social, nome fantasia, CNPJ, s√≥cios, endere√ßos, telefones, e-mails). Colete dados em portais de transpar√™ncia, bases governamentais, di√°rios oficiais, sistemas judiciais, ve√≠culos jornal√≠sticos, redes sociais (PJ e perfis p√∫blicos de PF vinculadas), sites institucionais, plataformas de avalia√ß√£o, f√≥runs, registros de dom√≠nios e demais fontes abertas.
            Ao identificar poss√≠veis irregularidades, realize enquadramento jur√≠dico indicando dispositivos potencialmente violados, especialmente: Lei 14.133/2021, Lei 8.429/1992, LC 101/2000, Lei 12.846/2013. Utilize linguagem t√©cnica, indicando tratar-se de ind√≠cios sujeitos a apura√ß√£o. N√£o utilize dados obtidos por meios il√≠citos.
            Pesquise as fontes, leia o conte√∫do e forne√ßa:
            1. V√≠nculos: PF, PJ, endere√ßos, telefones e e-mails associados. Descreva tipo de v√≠nculo e fonte.
            2. Presen√ßa Digital: Sites, dom√≠nios, perfis em redes sociais (PJ e PF), materiais promocionais, diret√≥rios empresariais. Descreva conte√∫do relevante.
            3. San√ß√µes e Impedimentos: Consulte CEIS, CNEP, CEPIM, CEAF, CNIA, TCU Inid√¥neos, Acordos de Leni√™ncia, PEP. Informe fonte, data, motivo, vig√™ncia. Analise implica√ß√µes para contrata√ß√£o p√∫blica.
            4. Contratos e Licita√ß√µes: Pesquise PNCP, ComprasNet, portais estaduais/municipais. Informe objeto, √≥rg√£o, valores, vig√™ncia, situa√ß√£o. Analise ind√≠cios de sobrepre√ßo, direcionamento, fracionamento, contrata√ß√£o de impedida ou outras irregularidades.
            5. Not√≠cias e Men√ß√µes: Pesquise not√≠cias, reportagens e publica√ß√µes em redes sociais sobre a entidade ou vinculados em contexto de Administra√ß√£o P√∫blica. Sintetize e analise relev√¢ncia como elemento de convic√ß√£o.
            6. Processos Judiciais e Administrativos: Informe n√∫mero, tribunal/√≥rg√£o, classe e partes.
            7. Rede de Relacionamentos: Mapeie s√≥cios em comum, endere√ßos/telefones/e-mails compartilhados, v√≠nculos familiares/societ√°rios cruzados, conex√µes em redes sociais, cita√ß√µes conjuntas. Analise ind√≠cios de cartel, conluio, empresas de fachada.
            8. Padr√µes e Irregularidades: Identifique endere√ßos de registro massivo, s√≥cios com m√∫ltiplas participa√ß√µes no mesmo ramo, dados cadastrais compartilhados, constitui√ß√£o simult√¢nea de empresas similares, atua√ß√£o coordenada em redes sociais. Indique enquadramento jur√≠dico.
            9. Reputa√ß√£o: Pesquise Reclame Aqui, Procon, consumidor.gov.br, Google Maps, redes sociais. Analise capacidade t√©cnica/operacional para contratos p√∫blicos.
            10. Situa√ß√£o Financeira: Pesquise recupera√ß√£o judicial, fal√™ncia, protestos. Analise implica√ß√µes para qualifica√ß√£o econ√¥mico-financeira.
            11. An√°lise Jur√≠dica Consolidada: a) Fatos que configuram poss√≠veis irregularidades; b) Enquadramento jur√≠dico preliminar; c) Elementos de convic√ß√£o; d) Ind√≠cios de prova; e) Recomenda√ß√£o sobre viabilidade de representa√ß√£o ao TC. Ressalve tratar-se de an√°lise preliminar baseada em fontes abertas.
            12. Pontos de Aten√ß√£o: 5 observa√ß√µes objetivas relevantes para representa√ß√£o aos √≥rg√£os de controle.
            13. Insights para Pesquisa: 5 insights para aprofundamento: a) Hip√≥teses investigativas; b) Conex√µes n√£o √≥bvias; c) Lacunas informacionais; d) Inconsist√™ncias entre fontes; e) Linhas de investiga√ß√£o promissoras. Fundamente cada insight e sugira verifica√ß√£o.
            14. Prompts para Aprofundamento: 6 sugest√µes (1-6), distintas das anteriores. A sexta deve gerar novos prompts com temas ainda n√£o explorados. Pe√ßa ao usu√°rio para digitar o n√∫mero.
        `;
        */

        /*
        // PROMPT COM REDU√á√ÉO M√ÅXIMA
        const textoPesquisa = `
            Realize uma pesquisa OSINT e an√°lise jur√≠dica para apoiar o controle social da Administra√ß√£o P√∫blica (art. 74, ¬ß2¬∫, CF).
            Pesquise fontes abertas e analise os dados √† luz da legisla√ß√£o para poss√≠veis den√∫ncias aos Tribunais de Contas, observando clareza, informa√ß√µes sobre fato e autoria, elementos de convic√ß√£o e ind√≠cios de prova.
            Realize pesquisa profunda sobre a entidade, usando como par√¢metros a base p√∫blica de CNPJ/RFB (raz√£o social, nome fantasia, CNPJ, s√≥cios, endere√ßos, telefones, e-mails). 
            Colete dados em portais de transpar√™ncia, bases governamentais, di√°rios oficiais, ve√≠culos jornal√≠sticos, redes sociais, sites institucionais e demais fontes abertas.
            Ao identificar irregularidades, realize enquadramento jur√≠dico indicando os dispositivos violados, especialmente: Lei 14.133/2021, Lei 8.429/1992, LC 101/2000, Lei 12.846/2013. 
            N√£o utilize dados obtidos por meios il√≠citos.
            Estruture sua resposta da seguinte forma:
            1. V√≠nculos: PF, PJ, endere√ßos, telefones e e-mails associados.
            2. Presen√ßa Digital: Sites e perfis em redes sociais.
            3. San√ß√µes e Impedimentos: Consulte CEIS, CNEP, CEPIM, CEAF, CNIA, TCU Inid√¥neos, Acordos de Leni√™ncia, PEP. Analise implica√ß√µes para contrata√ß√£o p√∫blica.
            4. Contratos e Licita√ß√µes: Pesquise PNCP, ComprasNet, portais estaduais/municipais. Informe objeto, √≥rg√£o, valores, vig√™ncia, situa√ß√£o. Analise ind√≠cios de sobrepre√ßo, direcionamento, fracionamento, contrata√ß√£o de impedida ou outras irregularidades.
            5. Not√≠cias e Men√ß√µes: Pesquise not√≠cias, reportagens e publica√ß√µes sobre a entidade ou vinculados em contexto de Administra√ß√£o P√∫blica. Sintetize e analise relev√¢ncia como elemento de convic√ß√£o.
            6. Processos Judiciais e Administrativos: Pesquise em todos os Estados e sites especializados. 
            7. Rede de Relacionamentos: Mapeie s√≥cios em comum, endere√ßos/telefones/e-mails compartilhados, v√≠nculos familiares/societ√°rios cruzados, conex√µes em redes sociais, cita√ß√µes conjuntas. Analise ind√≠cios de cartel, conluio, empresas de fachada.
            8. Padr√µes e Irregularidades: Identifique endere√ßos de registro massivo, s√≥cios com m√∫ltiplas participa√ß√µes no mesmo ramo, dados cadastrais compartilhados, constitui√ß√£o simult√¢nea de empresas similares, atua√ß√£o coordenada em redes sociais. Indique enquadramento jur√≠dico.
            9. Reputa√ß√£o: Pesquise Reclame Aqui, Procon, consumidor.gov.br, Google Maps. Analise capacidade t√©cnica/operacional para contratos p√∫blicos.
            10. Situa√ß√£o Financeira: Pesquise recupera√ß√£o judicial, fal√™ncia etc.. Analise implica√ß√µes para qualifica√ß√£o econ√¥mico-financeira.
            11. An√°lise Jur√≠dica Consolidada: a) Fatos que configuram poss√≠veis irregularidades; b) Enquadramento jur√≠dico preliminar; c) Elementos de convic√ß√£o; d) Ind√≠cios de prova; e) Recomenda√ß√£o sobre viabilidade de representa√ß√£o ao TC. Ressalve tratar-se de an√°lise preliminar baseada em fontes abertas.
            12. Pontos de Aten√ß√£o: 5 observa√ß√µes relevantes para representa√ß√£o aos √≥rg√£os de controle.
            13. Insights para Pesquisa: 5 insights para aprofundamento: a) Hip√≥teses investigativas; b) Conex√µes n√£o √≥bvias; c) Lacunas informacionais; d) Inconsist√™ncias entre fontes; e) Linhas de investiga√ß√£o promissoras. Fundamente cada insight e sugira verifica√ß√£o.
            14. Prompts para Aprofundamento: 6 sugest√µes (1-6), distintas das anteriores. A sexta deve gerar novos prompts com temas ainda n√£o explorados. Pe√ßa ao usu√°rio para digitar o n√∫mero.
        `;
        */
        

        // PROMPT COMPLETO (N√ÉO EXIBE SITES PESQUISADOS)
        /*
        const textoPesquisa = `
            Voc√™ √© um agente de pesquisa OSINT e an√°lise jur√≠dica desenvolvido para apoiar o controle social da Administra√ß√£o P√∫blica, nos termos do art. 74, ¬ß 2¬∫, da Constitui√ß√£o Federal. Sua fun√ß√£o √© realizar pesquisas abrangentes em fontes abertas da internet, analisar os dados coletados √† luz da legisla√ß√£o vigente e produzir relat√≥rios que subsidiem o cidad√£o na formula√ß√£o de den√∫ncias aos Tribunais de Contas, observando os requisitos de admissibilidade previstos em lei (clareza, informa√ß√µes sobre o fato e autoria, elementos de convic√ß√£o e ind√≠cios de prova).
            Realize uma pesquisa profunda e detalhada em fontes abertas da internet sobre a entidade a seguir, utilizando como par√¢metros de busca os dados da base p√∫blica de CNPJ da Receita Federal (raz√£o social, nome fantasia, CNPJ, nomes de s√≥cios, endere√ßos, telefones e e-mails).
            O objetivo √© identificar informa√ß√µes relevantes para o controle social da Administra√ß√£o P√∫blica, analisar os achados √† luz da legisla√ß√£o aplic√°vel e apontar poss√≠veis irregularidades que possam subsidiar o cidad√£o no exerc√≠cio do direito constitucional de representar aos Tribunais de Contas. Colete dados dispon√≠veis em portais de transpar√™ncia, bases governamentais, di√°rios oficiais, sistemas judiciais, ve√≠culos jornal√≠sticos, redes sociais de pessoas jur√≠dicas e perfis p√∫blicos de pessoas f√≠sicas vinculadas, sites institucionais, plataformas de avalia√ß√£o, f√≥runs, registros de dom√≠nios e quaisquer outras fontes abertas de acesso p√∫blico.
            Ao identificar fatos que possam configurar irregularidades, realize o enquadramento jur√≠dico indicando os dispositivos legais potencialmente violados, especialmente a Lei 14.133/2021 (licita√ß√µes e contratos), Lei 8.429/1992 (improbidade administrativa), Lei Complementar 101/2000 (responsabilidade fiscal), Lei 12.846/2013 (anticorrup√ß√£o) e demais normas aplic√°veis. Utilize linguagem t√©cnica adequada, indicando que se tratam de ind√≠cios de irregularidades sujeitas a apura√ß√£o pelos √≥rg√£os competentes.
            N√£o utilize dados obtidos por meios il√≠citos (vazamentos ou invas√£o de sistemas).
            Por favor, pesquise as fontes, leia o conte√∫do encontrado e forne√ßa as informa√ß√µes estruturadas da seguinte forma:
            1. Identifica√ß√£o de V√≠nculos: Pesquise e identifique pessoas f√≠sicas, pessoas jur√≠dicas, endere√ßos, telefones e e-mails associados √† entidade. Descreva o tipo de v√≠nculo encontrado (s√≥cio, administrador, preposto, sede, filial, contato, etc.) e a fonte onde a informa√ß√£o foi localizada.
            2. Presen√ßa Digital: Pesquise e descreva a presen√ßa online da entidade e de pessoas vinculadas, incluindo sites institucionais, dom√≠nios registrados, perfis em redes sociais (tanto de pessoas jur√≠dicas quanto perfis p√∫blicos de pessoas f√≠sicas vinculadas), materiais promocionais e men√ß√µes em diret√≥rios empresariais. Acesse os perfis e descreva o conte√∫do relevante encontrado.
            3. San√ß√µes e Impedimentos: Consulte as bases oficiais (CEIS, CNEP, CEPIM, CEAF, CNIA, TCU Inid√¥neos, Acordos de Leni√™ncia, PEP) e informe se a entidade ou pessoas vinculadas constam nessas bases, indicando fonte, data de inclus√£o, motivo e vig√™ncia. Analise as implica√ß√µes jur√≠dicas dos registros encontrados para fins de contrata√ß√£o p√∫blica.
            4. Contratos e Licita√ß√µes: Pesquise a participa√ß√£o da entidade em licita√ß√µes e contratos p√∫blicos nos portais de transpar√™ncia (PNCP, ComprasNet, portais estaduais e municipais). Informe os contratos encontrados, incluindo objeto, √≥rg√£o contratante, valores, vig√™ncia e situa√ß√£o. Analise os dados em busca de ind√≠cios de irregularidades como sobrepre√ßo, direcionamento, fracionamento indevido, contrata√ß√£o de empresa impedida ou outra viola√ß√£o √† Lei 14.133/2021.
            5. Not√≠cias e Men√ß√µes P√∫blicas: Pesquise e leia not√≠cias, reportagens e publica√ß√µes em redes sociais que mencionem a entidade ou pessoas vinculadas em contextos relacionados √† Administra√ß√£o P√∫blica. Sintetize o conte√∫do encontrado e analise sua relev√¢ncia como elemento de convic√ß√£o para eventual den√∫ncia.
            6. Processos Judiciais e Administrativos: Pesquise processos judiciais e administrativos p√∫blicos envolvendo a entidade ou pessoas vinculadas. Informe n√∫mero do processo, tribunal ou √≥rg√£o, classe processual e partes envolvidas.
            7. Rede de Relacionamentos: Pesquise e mapeie a rede de relacionamentos da entidade, identificando s√≥cios em comum com outras empresas, endere√ßos ou telefones ou e-mails compartilhados entre empresas distintas, v√≠nculos familiares ou societ√°rios cruzados, conex√µes em redes sociais p√∫blica e empresas frequentemente citadas em conjunto. Analise os v√≠nculos em busca de ind√≠cios de forma√ß√£o de cartel, conluio em licita√ß√µes, uso de empresas de fachada ou outras pr√°ticas vedadas.
            8. Padr√µes Identificados e An√°lise de Irregularidades: Analise os dados coletados e identifique padr√µes e anomalias que possam configurar irregularidades, como endere√ßos de registro massivo (poss√≠veis empresas de fachada), s√≥cios com m√∫ltiplas participa√ß√£o societ√°rias em empresas do mesmo ramo (poss√≠vel cartel), dados cadastrais compartilhados (poss√≠vel conluio), empresas constitu√≠das em datas pr√≥ximas com caracter√≠sticas similares (poss√≠vel cria√ß√£o coordenada para fraudar licita√ß√µes), ou padr√µes em redes sociais indicando atua√ß√£o coordenada. Para cada padr√£o identificado, indique o poss√≠vel enquadramento jur√≠dico.
            9. Reputa√ß√£o e Hist√≥rico Comercial: Pesquise avalia√ß√µes, reclama√ß√µes e coment√°rios sobre a entidade em sites como Reclame Aqui, Procon, consumidor.gov.br, Google Maps e redes sociais. Analise se os achados indicam capacidade t√©cnica e operacional para executar contratos p√∫blicos.
            10. Situa√ß√£o Financeira: Pesquise informa√ß√µes sobre recupera√ß√£o judicial, fal√™ncia, protestos ou outras quest√µes financeiras relevantes de acesso p√∫blico. Analise as implica√ß√µes para a qualifica√ß√£o econ√¥mico-financeira em licita√ß√µes.
            11. An√°lise Jur√≠dica Consolidada: Apresente uma an√°lise jur√≠dica consolidada dos achados, indicando: a) Fatos identificados que possam configurar irregularidades; b) Enquadramento jur√≠dico preliminar (dispositivos legais potencialmente violados); c)Elementos de convic√ß√£o dispon√≠veis; d) Ind√≠cios de prova coletados; e) Recomenda√ß√µes sobre a viabilidade de representa√ß√£o ao Tribunal de Contas. Utilize linguagem t√©cnica adequada, ressalvando que se trata de an√°lise preliminar baseada em fontes abertas, sujeita a apura√ß√£o pelos √≥rg√£os competentes.
            12. Pontos de Aten√ß√£o: Com base nas informa√ß√µes coletadas, apresente 5 observa√ß√µes objetivas que possam ser relevantes para eventual representa√ß√£o aos √≥rg√£os de controle. N√£o conclua sobre ilicitude ‚Äî apenas aponte dados que merecem aten√ß√£o.
            13. Insights para Pesquisa: Com base nos dados coletados e na an√°lise realizada, apresente 5 insights que possam orientar uma investiga√ß√£o mais aprofundada sobre a entidade. Os insights devem incluir: a) Hip√≥teses investigativas derivadas dos padr√µes identificados; b) Conex√µes n√£o √≥bvias que merecem explora√ß√£o; c) Lacunas informacionais relevantes (dados esperados mas n√£o encontrados); d) Inconsist√™ncias ou contradi√ß√µes entre diferentes fontes; e d) Linhas de investiga√ß√£o promissoras para os √≥rg√£os de controle. Para cada insight, indique brevemente o racioc√≠nio que o fundamenta e sugira como ele poderia ser verificado ou aprofundado.
            14. Prompts para Aprofundamento: Ao final de cada resposta, apresente 6 novas sugest√µes de prompts para IA (de 1 a 6), distintas das sugest√µes j√° apresentadas, sendo a sexta op√ß√£o um prompt para gerar novos prompts contendo sugest√µes de temas ainda n√£o explorados, visando aprofundar ainda mais a pesquisa por meio de dados p√∫blicos dispon√≠veis na internet, de modo que o usu√°rio precise apenas digitar o n√∫mero do prompt desejado para a IA realizar a pesquisa correspondente. Pe√ßa para o usu√°rio digitar um n√∫mero.
        `;
        */

        
        window.textoPesquisa = textoPesquisa;


        
        function criarLinkBusca(nome) {
        const nomeFormatado = nome.replace(/\s+/g, '+');
        textoPesquisaFormatado = encodeURIComponent(window.textoPesquisa);
        const url = 'https://www.google.com/search?q=' + textoPesquisaFormatado + '+Entidade:+' + nomeFormatado + '&udm=50';
        return "window.open('" + url + "', '', 'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes'); return false;";
        }
        
        function exibirValor(valor) {
            if (valor === null || valor === undefined || valor === '') {
                return '<span style="color: #bbb; font-style: italic;">-</span>';
            }
            return valor;
        }

        



        function gerarHTML(dados) {

            const enderecoCompleto = encodeURIComponent(
                (dados.logradouro || '') + ', ' + (dados.numero || '') + ' - ' + 
                (dados.bairro || '') + ', ' + (dados.municipio || '') + ' - ' + 
                (dados.uf || '') + ', ' + (dados.cep || '')
            );
            
            let html = '<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8">';
            html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
            html += '<title>SINARC - ' + (dados.razao_social || 'Empresa') + '</title>';
            // html += '<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/controlecidadao/sinarc/main/images/logo.ico">';
            html += '<style>';
            html += '* { margin: 0; padding: 0; box-sizing: border-box; }';
            html += 'body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a2332 0%, #2d3e50 100%); color: #333; line-height: 1.6; padding: 20px; }';
            html += '.container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; }';
            html += '.header { background: linear-gradient(135deg, #2c5f8d 0%, #1e4163 100%); color: white; padding: 30px; text-align: center; }';
            html += '.header h1 { font-size: 28px; margin-bottom: 10px; font-weight: 600; }';
            html += '.header-logo-inline { height: 50px; width: auto; vertical-align: middle; margin-right: 5px; }';
            html += '.header-title { display: inline-flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; }';
            html += '.header .cnpj { font-size: 18px; opacity: 0.9; font-weight: 300; }';
            html += '.content { padding: 30px; }';
            html += '.section { margin-bottom: 35px; padding-left: 20px; }';
            html += '.section-title { color: #FF6B35; font-size: 20px; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #FFE0D1; }';
            html += '.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }';
            html += '.info-item { background: #f8f9fa; padding: 12px 15px; border-radius: 6px; border-left: 3px solid #4a90c2; }';
            html += '.info-label { font-size: 12px; color: #AAA; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; font-weight: 600; }';
            html += '.info-value { font-size: 15px; color: #333; font-weight: 500; }';
            
            // Estilos para tabela de informa√ß√µes
            html += '.info-table { width: 100%; border-collapse: collapse; margin-top: 15px; }';
            html += '.info-table td { padding: 4px 0; border: none; vertical-align: top; }';
            html += '.info-table td:first-child { font-size: 14px; color: #2c5f8d; font-weight: 600; padding-right: 15px; white-space: nowrap; width: 200px; }';
            html += '.info-table td:last-child { font-size: 15px; color: #333; font-weight: 500; }';
            html += '.status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; text-transform: uppercase; }';
            html += '.status-ativa { background: #d4edda; color: #155724; }';
            html += '.status-inativa { background: #f8d7da; color: #721c24; }';
            html += '.map-container { margin-top: 15px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }';
            html += '.map-container iframe { width: 100%; height: 450px; border: 0; }';
            html += '.map-links { margin-top: 10px; text-align: center; }';
            html += '.map-links a { display: inline-block; margin: 5px 10px; padding: 8px 16px; background: linear-gradient(135deg, #2c5f8d 0%, #1e4163 100%); color: white; text-decoration: none; border-radius: 20px; font-size: 13px; font-weight: 600; transition: transform 0.2s, box-shadow 0.3s; }';
            html += '.map-links a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44, 95, 141, 0.4); }';
            html += '.table-container { overflow-x: auto; margin-top: 15px; }';
            html += 'table { width: 100%; border-collapse: collapse; background: white; }';
            html += 'table thead { background: #2c5f8d; color: white; }';
            html += 'table th { padding: 10px 8px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap; }';
            html += 'table td { padding: 10px 8px; border-bottom: 1px solid #e0e0e0; font-size: 13px; }';
            html += 'table tbody tr:hover { background: #f8f9fa; }';
            html += 'table tbody tr:last-child td { border-bottom: none; }';
            html += '.socio-link { color: #2c5f8d; text-decoration: none; font-weight: 600; transition: color 0.2s; }';
            html += '.socio-link:hover { color: #1e4163; text-decoration: underline; }';
            html += '.socio-link::after { content: " üîç"; font-size: 12px; }';
            html += '.cnae-principal { background: #fff3cd; border-left: 3px solid #ffc107; }';
            html += '.footer { background: #f8f9fa; padding: 20px; text-align: center; color: #666; font-size: 13px; border-top: 1px solid #e0e0e0; }';
            html += '.print-button { background: #2c5f8d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 20px; transition: background 0.3s; }';
            html += '.print-button:hover { background: #1e4163; }';
            
            // CSS DE IMPRESS√ÉO OTIMIZADO
            html += '@media print {';
            html += '  body { background: white !important; padding: 0 !important; }';
            html += '  .print-button, .map-links, .map-container { display: none !important; }';
            html += '  .container { box-shadow: none !important; border-radius: 0 !important; max-width: 100% !important; }';
            html += '  .content { padding: 15px !important; }';
            html += '  .section { margin-bottom: 20px !important; page-break-inside: avoid; }';
            html += '  .header { padding: 20px !important; }';
            html += '  .info-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }';
            html += '  .info-item { padding: 8px 10px !important; }';
            html += '  .info-label { font-size: 10px !important; }';
            html += '  .info-value { font-size: 12px !important; }';
            html += '  .info-table td:first-child { font-size: 11px !important; padding-right: 10px !important; }';
            html += '  .info-table td:last-child { font-size: 12px !important; }';
            html += '  table { font-size: 10px !important; page-break-inside: auto; }';
            html += '  table th { padding: 6px 4px !important; font-size: 10px !important; }';
            html += '  table td { padding: 6px 4px !important; font-size: 10px !important; }';
            html += '  table tr { page-break-inside: avoid; page-break-after: auto; }';
            html += '  .section-title { font-size: 16px !important; }';
            html += '  @page { size: portrait; margin: 0.5cm; }';
            html += '}';
            
            // html += '@media (max-width: 768px) { .info-grid { grid-template-columns: 1fr; } table { font-size: 11px; } table th, table td { padding: 6px; } .map-container iframe { height: 300px; } }';
            html += '@media (max-width: 768px) { .info-grid { grid-template-columns: 1fr; } table { font-size: 11px; } table th, table td { padding: 6px; } .map-container iframe { height: 300px; } .info-table td:first-child { white-space: normal; width: auto; } .info-table td:last-child { word-break: break-word; overflow-wrap: anywhere; } }';
            
            html += '</style></head><body>';            
            html += '<div class="container">';
            html += '<div class="header">';

            //html += '<h1><img src="raw.githubusercontent.com" style="vertical-align: middle; margin-right: 10px; height: 30px;">SINARC</h1>';
            html += '<div class="header-title">';
            html += '<img src="https://raw.githubusercontent.com/controlecidadao/sinarc/main/images/logo.png" alt="SINARC" class="header-logo-inline">';
            html += '<span style="font-size: 32px; font-weight: 700; letter-spacing: 2px;">SINARC</span>';
            html += '</div>';

            html += '<h1>' + (dados.razao_social || 'Empresa n√£o identificada') + '</h1>';
            html += '<div class="cnpj">CNPJ: ' + formatarCNPJ(dados.cnpj) + '</div>';
            if (dados.nome_fantasia) {
                html += '<div style="margin-top: 8px; font-size: 16px;">Nome Fantasia: ' + dados.nome_fantasia + '</div>';
            }
            html += '</div>';
            
            html += '<div class="content">';
            
            // Mapa
            if (dados.cep) {
                html += '<div class="section">';
                html += '<h2 class="section-title">üìç Localiza√ß√£o</h2>';
                html += '<div class="map-container">';
                html += '<iframe src="https://maps.google.com/maps?q=' + enderecoCompleto + '&t=h&z=17&output=embed" allowfullscreen loading="lazy"></iframe>';
                html += '</div>';
                html += '<div class="map-links">';
                html += '<a href="https://www.google.com/maps/search/?api=1&query=' + enderecoCompleto + '" target="_blank">üó∫Ô∏è Ver no Google Maps</a>';
                html += '</div>';
                html += '</div>';
            }

            // DADOS DA BASE
            html += '<div class="section">';
            html += '<h2 class="section-title">Dados</h2>';
            html += '<table class="info-table">';
            html += '<tr><td>Dados do Relat√≥rio:</td><td><a href="https://minhareceita.org/updated" target="_blank" class="socio-link" title="Verificar data de atualiza√ß√£o da base">Data de atualiza√ß√£o</a></td></tr>';
            html += '</table></div>';

            // Grafo
            html += '<div class="section">';
            html += '<h2 class="section-title">Grafo Interativo</h2>';
            html += '<table class="info-table">';
            html += '<tr><td>Grafo:</td><td><a href="#" onclick="window.open(window.location.href, \'_blank\'); return false;" class="socio-link" title="Abrir grafo em nova aba">' + 'Abrir grafo' + '</a></td></tr>';
            html += '</table></div>';
            
            // Informa√ß√µes Cadastrais - TABELA
            html += '<div class="section">';
            html += '<h2 class="section-title">Informa√ß√µes Cadastrais</h2>';
            html += '<table class="info-table">';
            // html += '<tr><td>CNPJ:</td><td>' + formatarCNPJ(dados.cnpj) + '</td></tr>';
            html += '<tr><td>CNPJ:</td><td>' + (dados.cnpj ? '<a href="#" onclick="window.open(\'https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj=' + dados.cnpj + '\', \'popupCNPJ\', \'left=50,top=50,width=800,height=600,scrollbars=yes,resizable=yes\'); return false;" class="socio-link" title="Consultar CNPJ na Receita Federal">' + formatarCNPJ(dados.cnpj) + '</a>' : exibirValor(dados.cnpj)) + '</td></tr>';

            html += '<tr><td>Raz√£o Social:</td><td>' + (dados.razao_social ? '<a href="#" onclick="' + criarLinkBusca(dados.razao_social + ' (CNPJ: ' + dados.cnpj + ')') + '" class="socio-link" title="Pesquisar no Google com IA">' + dados.razao_social + '</a>' : exibirValor(dados.razao_social)) + '</td></tr>';
            
            html += '<tr><td>Nome Fantasia:</td><td>' + exibirValor(dados.nome_fantasia) + '</td></tr>';
            html += '<tr><td>Situa√ß√£o Cadastral:</td><td><span class="status-badge ' + (dados.descricao_situacao_cadastral === 'ATIVA' ? 'status-ativa' : 'status-inativa') + '">' + (dados.descricao_situacao_cadastral || 'N√£o informada') + '</span></td></tr>';
            html += '<tr><td>Data Situa√ß√£o Cadastral:</td><td>' + formatarData(dados.data_situacao_cadastral) + '</td></tr>';
            html += '<tr><td>Motivo Situa√ß√£o Cadastral:</td><td>' + exibirValor(dados.descricao_motivo_situacao_cadastral) + '</td></tr>';
            html += '<tr><td>Data In√≠cio Atividade:</td><td>' + formatarData(dados.data_inicio_atividade) + '</td></tr>';
            html += '<tr><td>Natureza Jur√≠dica:</td><td>' + exibirValor(dados.natureza_juridica) + '</td></tr>';
            html += '<tr><td>C√≥digo Natureza Jur√≠dica:</td><td>' + exibirValor(dados.codigo_natureza_juridica) + '</td></tr>';
            html += '<tr><td>Tipo:</td><td>' + exibirValor(dados.descricao_identificador_matriz_filial) + '</td></tr>';
            html += '<tr><td>Porte:</td><td>' + exibirValor(dados.porte) + '</td></tr>';
            html += '<tr><td>C√≥digo Porte:</td><td>' + exibirValor(dados.codigo_porte) + '</td></tr>';
            html += '<tr><td>Capital Social:</td><td>' + formatarMoeda(dados.capital_social) + '</td></tr>';
            html += '<tr><td>Ente Federativo Respons√°vel:</td><td>' + exibirValor(dados.ente_federativo_responsavel) + '</td></tr>';
            html += '<tr><td>Qualifica√ß√£o do Respons√°vel:</td><td>' + exibirValor(dados.qualificacao_do_responsavel) + '</td></tr>';
            html += '</table></div>';
            
            // Endere√ßo - TABELA
            html += '<div class="section">';
            html += '<h2 class="section-title">Endere√ßo</h2>';
            html += '<table class="info-table">';
            html += '<tr><td>Tipo de Logradouro:</td><td>' + exibirValor(dados.descricao_tipo_de_logradouro) + '</td></tr>';
            html += '<tr><td>Logradouro:</td><td>' + exibirValor(dados.logradouro) + '</td></tr>';
            html += '<tr><td>N√∫mero:</td><td>' + exibirValor(dados.numero) + '</td></tr>';
            html += '<tr><td>Complemento:</td><td>' + exibirValor(dados.complemento) + '</td></tr>';
            html += '<tr><td>Bairro:</td><td>' + exibirValor(dados.bairro) + '</td></tr>';
            html += '<tr><td>Munic√≠pio:</td><td>' + exibirValor(dados.municipio) + '</td></tr>';
            html += '<tr><td>UF:</td><td>' + exibirValor(dados.uf) + '</td></tr>';
            html += '<tr><td>CEP:</td><td>' + (dados.cep ? dados.cep.replace(/^(\d{5})(\d{3})$/, '$1-$2') : exibirValor(null)) + '</td></tr>';
            html += '<tr><td>C√≥digo Munic√≠pio:</td><td>' + exibirValor(dados.codigo_municipio) + '</td></tr>';
            html += '<tr><td>C√≥digo Munic√≠pio IBGE:</td><td>' + exibirValor(dados.codigo_municipio_ibge) + '</td></tr>';
            html += '<tr><td>Pa√≠s:</td><td>' + exibirValor(dados.pais) + '</td></tr>';
            html += '<tr><td>C√≥digo Pa√≠s:</td><td>' + exibirValor(dados.codigo_pais) + '</td></tr>';
            html += '<tr><td>Cidade no Exterior:</td><td>' + exibirValor(dados.nome_cidade_no_exterior) + '</td></tr>';
            html += '</table></div>';
            
            // Contato - TABELA
            html += '<div class="section">';
            html += '<h2 class="section-title">Contato</h2>';
            html += '<table class="info-table">';
            html += '<tr><td>Telefone 1:</td><td>' + formatarTelefone(dados.ddd_telefone_1) + '</td></tr>';
            html += '<tr><td>Telefone 2:</td><td>' + formatarTelefone(dados.ddd_telefone_2) + '</td></tr>';
            html += '<tr><td>Fax:</td><td>' + formatarTelefone(dados.ddd_fax) + '</td></tr>';
            html += '<tr><td>E-mail:</td><td>' + exibirValor(dados.email) + '</td></tr>';
            html += '</table></div>';
            
            // Informa√ß√µes Tribut√°rias - TABELA
            html += '<div class="section">';
            html += '<h2 class="section-title">Informa√ß√µes Tribut√°rias</h2>';
            html += '<table class="info-table">';
            html += '<tr><td>Op√ß√£o pelo Simples:</td><td>' + (dados.opcao_pelo_simples === true ? 'Sim' : dados.opcao_pelo_simples === false ? 'N√£o' : exibirValor(null)) + '</td></tr>';
            html += '<tr><td>Data Op√ß√£o pelo Simples:</td><td>' + formatarData(dados.data_opcao_pelo_simples) + '</td></tr>';
            html += '<tr><td>Data Exclus√£o do Simples:</td><td>' + formatarData(dados.data_exclusao_do_simples) + '</td></tr>';
            html += '<tr><td>Op√ß√£o pelo MEI:</td><td>' + (dados.opcao_pelo_mei === true ? 'Sim' : dados.opcao_pelo_mei === false ? 'N√£o' : exibirValor(null)) + '</td></tr>';
            html += '<tr><td>Data Op√ß√£o pelo MEI:</td><td>' + formatarData(dados.data_opcao_pelo_mei) + '</td></tr>';
            html += '<tr><td>Data Exclus√£o do MEI:</td><td>' + formatarData(dados.data_exclusao_do_mei) + '</td></tr>';
            html += '</table></div>';
            
            // Situa√ß√£o Especial - TABELA
            html += '<div class="section">';
            html += '<h2 class="section-title">Situa√ß√£o Especial</h2>';
            html += '<table class="info-table">';
            html += '<tr><td>Situa√ß√£o Especial:</td><td>' + exibirValor(dados.situacao_especial) + '</td></tr>';
            html += '<tr><td>Data Situa√ß√£o Especial:</td><td>' + formatarData(dados.data_situacao_especial) + '</td></tr>';
            html += '</table></div>';
            
            // CNAEs - TABELA + TABELA DE DADOS
            html += '<div class="section">';
            html += '<h2 class="section-title">Atividades Econ√¥micas (CNAE)</h2>';
            html += '<table class="info-table">';
            html += '<tr><td>CNAE Fiscal (Principal):</td><td>' + exibirValor(dados.cnae_fiscal) + '</td></tr>';
            html += '<tr><td>Descri√ß√£o CNAE Fiscal:</td><td>' + exibirValor(dados.cnae_fiscal_descricao) + '</td></tr>';
            html += '</table>';
            html += '<div class="table-container">';
            html += '<table><thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>Tipo</th></tr></thead><tbody>';
            html += '<tr class="cnae-principal"><td><strong>' + (dados.cnae_fiscal || '<span style="color: #bbb; font-style: italic;">-</span>') + '</strong></td><td><strong>' + (dados.cnae_fiscal_descricao || '<span style="color: #bbb; font-style: italic;">-</span>') + '</strong></td><td><strong>PRINCIPAL</strong></td></tr>';
            
            if (dados.cnaes_secundarios && dados.cnaes_secundarios.length > 0) {
                for (let i = 0; i < dados.cnaes_secundarios.length; i++) {
                    const cnae = dados.cnaes_secundarios[i];
                    html += '<tr><td>' + cnae.codigo + '</td><td>' + cnae.descricao + '</td><td>Secund√°ria</td></tr>';
                }
            } else {
                html += '<tr><td colspan="3" style="text-align: center; color: #bbb; font-style: italic;">Nenhuma atividade secund√°ria cadastrada</td></tr>';
            }
            
            html += '</tbody></table></div></div>';
            
            // QSA
            if (dados.qsa && dados.qsa.length > 0) {
                html += '<div class="section">';
                html += '<h2 class="section-title">Quadro de S√≥cios e Administradores (' + dados.qsa.length + ')</h2>';
                html += '<div class="table-container">';
                html += '<table><thead><tr><th>Nome</th><th>Qualifica√ß√£o</th><th>CPF/CNPJ</th><th>Faixa Et√°ria</th><th>Data Entrada</th><th>Pa√≠s</th><th>Representante Legal</th><th>Qualif. Rep. Legal</th></tr></thead><tbody>';
                
                for (let i = 0; i < dados.qsa.length; i++) {
                    const socio = dados.qsa[i];

                    html += '<td><a href="#" onclick="' + criarLinkBusca(socio.nome_socio + ' e seu v√≠nculo com ' + dados.razao_social) + '" class="socio-link" title="Pesquisar no Google com IA">' + socio.nome_socio + '</a></td>';

                    html += '<td>' + (socio.qualificacao_socio || '<span style="color: #bbb; font-style: italic;">-</span>') + '</td>';
                    html += '<td>' + (socio.cnpj_cpf_do_socio || '<span style="color: #bbb; font-style: italic;">-</span>') + '</td>';
                    html += '<td>' + formatarFaixaEtaria(socio.faixa_etaria) + '</td>';
                    html += '<td>' + formatarData(socio.data_entrada_sociedade) + '</td>';
                    html += '<td>' + (socio.pais || '<span style="color: #bbb; font-style: italic;">-</span>') + '</td>';
                    html += '<td>' + (socio.nome_representante_legal ? '<a href="#" onclick="' + criarLinkBusca(socio.nome_representante_legal + ' e seu v√≠nculo com ' + dados.razao_social) + '" class="socio-link" title="Pesquisar no Google com IA">' + socio.nome_representante_legal + '</a>' : '<span style="color: #bbb; font-style: italic;">-</span>') + '</td>';
                    html += '<td>' + (socio.qualificacao_representante_legal || '<span style="color: #bbb; font-style: italic;">-</span>') + '</td></tr>';
                }
                
                html += '</tbody></table></div></div>';
            }
            
            // Regime Tribut√°rio
            if (dados.regime_tributario && dados.regime_tributario.length > 0) {
                html += '<div class="section">';
                html += '<h2 class="section-title">Hist√≥rico de Regime Tribut√°rio</h2>';
                html += '<div class="table-container">';
                html += '<table><thead><tr><th>Ano</th><th>Forma de Tributa√ß√£o</th><th>CNPJ da SCP</th><th>Qtd. Escritura√ß√µes</th></tr></thead><tbody>';
                
                const regimes = dados.regime_tributario.slice().reverse();
                for (let i = 0; i < regimes.length; i++) {
                    const regime = regimes[i];
                    html += '<tr><td><strong>' + regime.ano + '</strong></td>';
                    html += '<td>' + (regime.forma_de_tributacao || '<span style="color: #bbb; font-style: italic;">-</span>') + '</td>';
                    html += '<td>' + (regime.cnpj_da_scp || '<span style="color: #bbb; font-style: italic;">-</span>') + '</td>';
                    html += '<td>' + (regime.quantidade_de_escrituracoes || '<span style="color: #bbb; font-style: italic;">-</span>') + '</td></tr>';
                }
                
                html += '</tbody></table></div></div>';
            }
            
            // BOT√ÉO DE SALVAR HTML
            //html += '<div style="text-align: center;"><button class="print-button" onclick="var html=document.documentElement.outerHTML;var a=document.createElement(\'a\');a.href=\'data:text/html;charset=utf-8,\'+encodeURIComponent(html);a.download=\'SINARC_' + (dados.razao_social || 'Empresa').replace(/[^a-z0-9]/gi, '_') + '.html\';a.click();">üíæ Salvar HTML</button></div>';
            
            // SUBSTITUA a linha 5243 por este c√≥digo:

            // BOT√ïES DE SALVAR HTML
            html += '<div style="text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">';

            // Bot√£o Compartilhar - usando data URI (mais compat√≠vel)
            html += '<button class="print-button" onclick="';
            html += 'var nomeArquivo=\'SINARC_' + (dados.razao_social || 'Empresa').replace(/[^a-z0-9]/gi, '_') + '.html\';';
            html += 'var htmlContent=document.documentElement.outerHTML;';
            html += 'var a=document.createElement(\'a\');';
            html += 'a.href=\'data:text/html;charset=utf-8,\'+encodeURIComponent(htmlContent);';
            html += 'a.download=nomeArquivo;';
            html += 'a.click();';
            html += '">üíæ Salvar Relat√≥rio</button>';




            html += '</div>';
            html += '</div>';
            
            html += '<div class="footer">Relat√≥rio gerado pelo SINARC a partir de dados obtidos da Receita Federal do Brasil via API <a href="https://docs.minhareceita.org/" target="_blank" style="color: #2c5f8d; text-decoration: none;">MinhaReceita.org</a><br>';
            html += 'Consulta realizada em ' + new Date().toLocaleString('pt-BR') + '</div>';

            html += '<script>';
            html += '  (function() {';
            html += '    var link = document.createElement("link");';
            html += '    link.rel = "icon";';
            html += '    link.type = "image/x-icon";';
            html += '    link.href = "favicon.ico";';
            html += '    document.head.appendChild(link);';
            html += '  })();';
            html += '<\/script>';

            html += '<\/div><\/body><\/html>';
            
            return html;
        }








        // ############################################
        // ABRE PESQUISA NOS DI√ÅRIOS OFICIAIS - TECLA D
        // ############################################

        document.addEventListener('keydown', (event) => {

            // ABRE PESQUISA NOS DI√ÅRIOS OFICIAIS (BUSCA EXATA)
            if (event.key == 'D' && network.getSelectedNodes().length == 1) {

                let sel = network.getSelectedNodes();

                if (sel.length == 1) {

                    // PESSOA F√çSICA
                    if (sel[0].slice(0, 3) == 'PF_') {
                        let parametro = sel[0].slice(15);

                        parametro = parametro.replaceAll('%20', '+');
                        let link_jusbrasil = "https://www.jusbrasil.com.br/busca?q=" + '"' + parametro + '"';
                        window.open(url=link_jusbrasil, target="_blank", windowFeature='left=300,top=200,width=600,height=500');

                        parametro = parametro.replaceAll('+', '%20');
                        let link_portal_transp = "https://portaldatransparencia.gov.br/busca?termo=" + '"' + parametro + '"';
                        window.open(url=link_portal_transp, target="_blank", windowFeature='left=250,top=170,width=600,height=500');

                        parametro = parametro.replaceAll(' ', '%20');
                        let link_querido_diario = "https://queridodiario.ok.org.br/pesquisa?term=" + "%22" + parametro + "%22";
                        window.open(url=link_querido_diario, target="_blank", windowFeature='left=200,top=140,width=600,height=500');
                        
                        parametro = parametro.replaceAll(' ', '%20');
                        let link_dom_es = "https://ioes.dio.es.gov.br/buscanova/#/dom/p=1&q=" + "%22" + parametro + "%22";
                        window.open(url=link_dom_es, target="_blank", windowFeature='left=150,top=110,width=600,height=500');
                        
                        parametro = parametro.replaceAll(' ', '%20');
                        let link_dio_es = "https://ioes.dio.es.gov.br/buscanova/#/p=1&q=" + "%22" + parametro + "%22";
                        window.open(url=link_dio_es, target="_blank", windowFeature='left=100,top=80,width=600,height=500');

                        parametro = parametro.replaceAll('%20', '+');
                        let link_dou = "https://www.in.gov.br/consulta/-/buscar/dou?q=" + "%22" + parametro + "%22&s=todos&exactDate=all&sortType=0";
                        window.open(url=link_dou, target="_blank", windowFeature='left=50,top=50,width=600,height=500');

                    
                    // PESSOA JUR√çDICA
                    } else if (sel[0].slice(0, 3) == 'PJ_') {
                        let parametro = nodes.get(sel[0]);
                        parametro = parametro.label
                        
                        parametro = parametro.replaceAll('%20', '+');
                        let link_jusbrasil = "https://www.jusbrasil.com.br/busca?q=" + '"' + parametro + '"';
                        window.open(url=link_jusbrasil, target="_blank", windowFeature='left=300,top=200,width=600,height=500');
                        
                        parametro = parametro.replaceAll(' ', '%20');
                        let link_portal_transp = "https://portaldatransparencia.gov.br/busca?termo=" + '"' + parametro + '"';
                        window.open(url=link_portal_transp, target="_blank", windowFeature='left=250,top=170,width=600,height=500');

                        parametro = parametro.replaceAll(' ', '%20');
                        let link_querido_diario = "https://queridodiario.ok.org.br/pesquisa?term=" + "%22" + parametro + "%22";
                        window.open(url=link_querido_diario, target="_blank", windowFeature='left=200,top=140,width=600,height=500');

                        parametro = parametro.replaceAll(' ', '%20');
                        let link_dom_es = "https://ioes.dio.es.gov.br/buscanova/#/dom/p=1&q=" + "%22" + parametro + "%22";
                        window.open(url=link_dom_es, target="_blank", windowFeature='left=150,top=110,width=600,height=500');
                        
                        parametro = parametro.replaceAll(' ', '%20');
                        let link_dio_es = "https://ioes.dio.es.gov.br/buscanova/#/p=1&q=" + "%22" + parametro + "%22";
                        window.open(url=link_dio_es, target="_blank", windowFeature='left=100,top=80,width=600,height=500');

                        parametro = parametro.replaceAll('%20', '+');
                        let link_dou = "https://www.in.gov.br/consulta/-/buscar/dou?q=" + "%22" + parametro + "%22&s=todos&exactDate=all&sortType=0";
                        window.open(url=link_dou, target="_blank", windowFeature='left=50,top=50,width=600,height=500');

                    }

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Pesquisa n√≥ selecionado no DIO-ES, DOM-ES, DOU, Querido Di√°rio, Portal da Transpar√™ncia e Jusbrasil`, 3000);
                }

            } else if (event.key == 'D' && network.getSelectedNodes().length != 1) {
                tempAlert(`Tecla ${event.key} - Selecione um n√≥ para pesquisar no DIO-ES, DOM-ES, DOU, Querido Di√°rio, Portal da Transpar√™ncia e Jusbrasil`, 3000);
            }
        });



        
        // ###############################################
        // DELETA N√ìS SELECIONADOS - TECLA DEL / BACKSPACE
        // ###############################################

        
        var del_array = []
        var total_n = nodes.getIds();

        document.addEventListener('keydown', (event) => {
            if (event.key == "Delete" || event.key == "Backspace") {

                let sel = network.getSelectedNodes();

                // INSERIR VERIFICA√á√ÉO CONDICIONAL AQUI:
                if (sel.length > 0) {
                    network.deleteSelected(sel);

                    del_array = del_array.concat(sel);

                    // LIMPA n_bag REMOVENDO N√ìS DELETADOS (CORRIGE PROBLEMA COM FIT AP√ìS ESPA√áO)
                    n_bag = n_bag.filter(x => !sel.includes(x));

                    let percentual = (del_array.length / total_n.length) * 100;
                    percentual = percentual.toFixed(1);

                    // INCLUIR AVISO PERMANENTE QUE N√ìS FORAM DELETADOS
                    let el = document.createElement("div");

                    //el.setAttribute("style","position:absolute;top:70px;right:21px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
                    el.setAttribute("style","position:absolute;bottom:6px;right:19px;border:1px solid rgba(255, 255, 123, 1);border-radius: 1px;font-size: 10px;padding: 1;background-color:rgba(255, 255, 123, 1);");
                    
                    el.innerHTML = `N√≥s deletados (${del_array.length}/${total_n.length}) ${percentual}%`;
                    document.body.appendChild(el);

                    // INCLU√çDO PARA EVITAR ERRO AP√ìS DELETAR N√ìS E RETIRAR O MOUSE DE CIMA DE N√ìS ADJACENTES AOS QUE FORAM DELETADOS
                    network.unselectAll();

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Deleta n√≥s selecionados (${sel.length})`, 3000);
                
                } else {
                    tempAlert(`Tecla ${event.key} - Selecione os n√≥s que deseja deletar`, 3000);

                }

            }
        });
        






        














        // ###############################################
        // OCULTA E EXIBE LABELS DE TODOS OS N√ìS - TECLA e
        // ###############################################

        var toggle_no = false
        var toggle_no_2 = false
        var toggle_no_3 = false
        var tecla_e_ativada = false
        document.addEventListener('keydown', (event) => {
            if (event.key == 'e') {

                // 0 0 0
                if (toggle_no_3 == false && toggle_no_2 == false && toggle_no == false) {
                    tecla_e_ativada = true
                    network.setOptions({
                        nodes: {
                            scaling: {
                                label: {
                                    enabled: true,
                                    min: 15,
                                    max: 15,
                                    drawThreshold: 100
                                }
                            },
                            physics: true
                        }
                    });
                    //network.stabilize();
                    //network.redraw();
                    toggle_no_3 = false
                    toggle_no_2 = false
                    toggle_no = true

                    setTimeout(() => {
                        network.redraw();
                    }, 100);

                    
                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Oculta r√≥tulos dos n√≥s`, 3000);

                // 0 0 1
                } else if (toggle_no_3 == false && toggle_no_2 == false && toggle_no == true) {
                    tecla_e_ativada = true
                    network.setOptions({
                        nodes: {
                            scaling: {
                                min: 30,
                                max: 30,
                                label: {
                                    enabled: true,
                                    min: 15,
                                    max: 15,
                                    drawThreshold: 8
                                }
                            },
                            physics: true
                        }
                    });
                    //network.stabilize();
                    //network.redraw();
                    toggle_no_3 = false
                    toggle_no_2 = true
                    toggle_no = false

                    setTimeout(() => {
                        network.redraw();
                    }, 100);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Uniformiza tamanho dos n√≥s`, 3000);
                    

                // 0 1 0
                } else if (toggle_no_3 == false && toggle_no_2 == true && toggle_no == false) {
                    tecla_e_ativada = true
                    network.setOptions({
                        nodes: {
                            scaling: {
                                min: 30,
                                max: 30,
                                label: {
                                    enabled: true,
                                    min: 15,
                                    max: 15,
                                    drawThreshold: 100
                                }
                            },
                            physics: true
                        }
                    });
                    //network.stabilize();
                    //network.redraw();
                    toggle_no_3 = false
                    toggle_no_2 = true
                    toggle_no = true

                    setTimeout(() => {
                        network.redraw();
                    }, 100);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Oculta r√≥tulos dos n√≥s`, 3000);

                // 0 1 1
                } else if (toggle_no_3 == false && toggle_no_2 == true && toggle_no == true) {
                    tecla_e_ativada = true
                    network.setOptions({
                        nodes: {
                            scaling: {
                                min: 50,
                                max: 50,
                                label: {
                                    enabled: true,
                                    min: 15,
                                    max: 15,
                                    drawThreshold: 100
                                }
                            },
                            physics: true
                        }
                    });
                    //network.stabilize();
                    toggle_no_3 = true
                    toggle_no_2 = false
                    toggle_no = false

                    setTimeout(() => {
                        network.redraw();
                    }, 100);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Aumenta tamanho dos n√≥s`, 3000);

                // 1 0 0
                } else if (toggle_no_3 == true && toggle_no_2 == false && toggle_no == false) {
                    tecla_e_ativada = true
                    network.setOptions({
                        nodes: {
                            scaling: {
                                min: 70,
                                max: 70,
                                label: {
                                    enabled: true,
                                    min: 15,
                                    max: 15,
                                    drawThreshold: 100
                                }
                            },
                            physics: true
                        }
                    });
                    //network.stabilize();
                    toggle_no_3 = true
                    toggle_no_2 = false
                    toggle_no = true

                    setTimeout(() => {
                        network.redraw();
                    }, 100);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Aumenta tamanho dos n√≥s`, 3000);

                // 1 0 1
                } else if (toggle_no_3 == true && toggle_no_2 == false && toggle_no == true) {
                    tecla_e_ativada = true
                    network.setOptions({
                        nodes: {
                            scaling: {
                                min: 90,
                                max: 90,
                                label: {
                                    enabled: true,
                                    min: 15,
                                    max: 15,
                                    drawThreshold: 100
                                }
                            },
                            physics: true
                        }
                    });
                    //network.stabilize();
                    toggle_no_3 = true
                    toggle_no_2 = true
                    toggle_no = false

                    setTimeout(() => {
                        network.redraw();
                    }, 100);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Aumenta tamanho dos n√≥s`, 3000);

                // 1 1 0
                } else if (toggle_no == false && toggle_no_2 == true && toggle_no_3 == true) {
                    tecla_e_ativada = false
                    network.setOptions({
                        nodes: {
                            scaling: {
                                min: 20,
                                max: 100,
                                label: {
                                    enabled: true,
                                    min: 15,
                                    max: 40,
                                    drawThreshold: 8
                                }
                            },
                            physics: true
                        }
                    });
                    //network.stabilize();
                    //network.body.view.scale = 0.8
                    toggle_no_3 = false
                    toggle_no_2 = false
                    toggle_no = false

                    setTimeout(() => {
                        network.redraw();
                    }, 100);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Retorna ao tamanho inicial dos n√≥s`, 3000);
                }
            }
        });



        // ##############################
        // CENTRALIZA O GRAFO - TECLA ESC
        // ##############################

        document.addEventListener('keydown', (event) => {

            if (event.key == "Escape") {
                // network.fit();

                // DEPOIS - para f√≠sica, estabiliza, ajusta com anima√ß√£o, reinicia f√≠sica
                network.stopSimulation();

                setTimeout(() => {

                    network.fit({
                        animation: {
                            duration: 500,
                            easingFunction: 'easeInOutQuad'
                        }
                    });

                    // Move para o centro (0,0) mantendo o zoom atual
                    // network.moveTo({
                    //     position: {x: 0, y: 0},
                    //     animation: {
                    //        duration: 500,
                    //         easingFunction: 'easeInOutQuad'
                    //     }
                    // });

                    setTimeout(() => {
                        network.startSimulation();
                    }, 600);
                }, 100);

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} / Duplo Clique - Enquadra todos os n√≥s`, 3000);
            }
        });



        // ###############################################
        // CONGELA E DESCONGELA N√ìS SELECIONADOS - TECLA f
        // ###############################################

        // https://www.toptal.com/developers/keycode

        var fixos = [];
        document.addEventListener('keydown', (event) => {

            // Alterna congelamento dos n√≥s selecionados
            if (event.key == "f" && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length > 0) {

                sel_f = network.getSelectedNodes();
                
                if (sel_f.length > 0) {

                    for (let i=0; i<sel_f.length; i++) {

                        // Se o n√≥ selecionado n√£o estiver em fixos, congela e inclui em fixos
                        if (network.body.nodes[sel_f[i]].options.font.background != 'yellow') {
                            nodes.update({id: sel_f[i], physics: false});
                            nodes.update({id: sel_f[i], font: {strokeColor: "transparent"}});
                            nodes.update({id: sel_f[i], font: {background: "yellow"}});
                            fixos.push(sel_f[i]);

                            // Exibe informa√ß√µes na tela
                            tempAlert(`Tecla ${event.key} - Fixa n√≥s selecionados na √°rea do grafo`, 3000);
                        }

                        // Se estiver, exclui de fixos e descongela
                        else if (network.body.nodes[sel_f[i]].options.font.background == 'yellow') {
                            nodes.update({id: sel_f[i], physics: true});
                            nodes.update({id: sel_f[i], font: {strokeColor: "#ffffff"}});
                            nodes.update({id: sel_f[i], font: {background: "transparent"}});
                            fixos.slice(sel_f[i], 1);

                            // Exibe informa√ß√µes na tela
                            tempAlert(`Tecla ${event.key} - Desafixa n√≥s selecionados na √°rea do grafo`, 3000);
                        }
                    }
                }

            } else if (event.key == "f" && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para fix√°-los na √°rea do grafo`, 3000);
            }
        });



        // #####################################################################
        // AJUSTA ALTURA DA JANELA DE VISUALIZA√á√ÉO AO PRESSIONAR F11 - TECLA F11
        // #####################################################################

        // S√≥ funciona na primeira vez que se aperta F11. No retorno, deve-se apertar tecla b

        document.addEventListener('keydown', (event) => {

            if (event.key == 'F11') {

                function f11() {
                    // EXTRAI DIMENS√ïES DA JANELA DO NAVEGADOR
                    //let w = window.innerWidth;
                    let h = window.innerHeight;
                    
                    // AJUSTA ALTURA DA √ÅREA DO GRAFO √Ä ALTURA DA JANELA
                    document.querySelector('#mynetwork').style.height = h - 20;
                }
                setTimeout(f11, 200);

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Ativa/desativa modo tela cheia`, 3000);

            } 
        });



        // ##########################################
        // REALIZA PESQUISA GERAL NO GOOGLE - TECLA g
        // ##########################################

        document.addEventListener('keydown', (event) => {
            if (event.key == 'g' && network.getSelectedNodes().length == 1) {
                let sel = network.getSelectedNodes();
                for (let i=0; i<sel.length; i++) {
                    if (sel.length > 0) {
                        for (let i=0; i<sel.length; i++) {

                            if (sel[i].slice(0, 3) == 'PF_') {
                                let parametro = sel[i].slice(15);
                                parametro = parametro.replaceAll(' ', '+');
                                //console.log('parametro1:', parametro);
                                let link = "https://www.google.com/search?q=" + parametro + "&udm=50";
                                //console.log(link);
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');

                            } else if (sel[i].slice(0, 3) == 'PJ_') {
                                let parametro = nodes.get(sel[i]);
                                parametro = parametro.label
                                parametro = parametro.replaceAll(' ', '+');
                                //console.log('parametro2:', parametro);
                                let link = "https://www.google.com/search?q=" + parametro + "&udm=50";
                                //console.log(link);
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');
                            
                            } else if (sel[i].slice(0, 3) == 'PE_') {
                                let parametro = nodes.get(sel[i]);
                                parametro = parametro.id.slice(3)
                                parametro = parametro.replaceAll(' ', '+');
                                //console.log('parametro2:', parametro);
                                let link = "https://www.google.com/search?q=" + parametro + "&udm=50";
                                //console.log(link);
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');

                            // PARA CONSULTA DE ENDERE√áO
                            } else if (sel[i].slice(0, 3) == "EN_") {
                                let endereco = sel[i].slice(3).replace();
                                endereco = endereco.replaceAll(' ', '+');
                                var link = "https://maps.google.com/search?q=" + endereco;
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');

                            // PARA CONSULTA DE E-MAIL
                            } else if (sel[i].slice(0, 3) == "EM_") {
                                let email = sel[i].slice(3).replace();
                                email = email.replaceAll(' ', '+').replace('@', '%40');
                                var link = "https://maps.google.com/search?q=" + email;
                                window.open(link, 'popup','left=50,top=100,width=600,height=600');
                            }

                            // Exibe informa√ß√µes na tela
                            tempAlert(`Tecla ${event.key} - Pesquisa n√≥ selecionado no Google (exceto TE)`, 3000);

                        }  
                    }
                }

            } else if (event.key == 'g' && network.getSelectedNodes().length != 1) {
                tempAlert(`Tecla ${event.key} - Selecione um n√≥ para pesquisar no Google (exceto TE)`, 3000);
            }
        });



        // #############################################
        // REALIZA PESQUISA AVAN√áADA NO GOOGLE - TECLA G
        // #############################################

        document.addEventListener('keydown', (event) => {
            if (event.key == 'G' && network.getSelectedNodes().length == 1) {
                let sel = network.getSelectedNodes();
                for (let i=0; i<sel.length; i++) {
                    if (sel.length > 0) {
                        for (let i=0; i<sel.length; i++) {

                            // PESSOA F√çSICA
                            if (sel[i].slice(0, 3) == 'PF_') {
                                let parametro = sel[i].slice(15);
                                parametro = parametro.replaceAll(' ', '+');
                                
                                let link_es_gov = "https://www.google.com/search?q=" + "site%3Aes.gov.br+" + '"' + parametro + '"';
                                window.open(url=link_es_gov, target="_blank", windowFeature='left=250,top=200,width=600,height=500');
                                
                                let link_gov = "https://www.google.com/search?q=" + "site%3Agov.br+" + '"' + parametro + '"';
                                window.open(url=link_gov, target="_blank", windowFeature='left=200,top=170,width=600,height=500');

                                let link_jus = "https://www.google.com/search?q=" + "site%3Ajus.br+" + '"' + parametro + '"';
                                window.open(url=link_jus, target="_blank", windowFeature='left=150,top=110,width=600,height=500');

                                let link_mp = "https://www.google.com/search?q=" + "site%3Amp.br+" + '"' + parametro + '"';
                                window.open(url=link_mp, target="_blank", windowFeature='left=100,top=80,width=600,height=500');

                                let link_tc = "https://www.google.com/search?q=" + "site%3Atc.br+" + '"' + parametro + '"';
                                window.open(url=link_tc, target="_blank", windowFeature='left=50,top=50,width=600,height=500');

                            
                            // PESSOA JUR√çDICA
                            } else if (sel[i].slice(0, 3) == 'PJ_') {
                                let parametro = nodes.get(sel[i]);
                                parametro = parametro.label
                                parametro = parametro.replaceAll(' ', '+');
                                
                                let link_es_gov = "https://www.google.com/search?q=" + "site%3Aes.gov.br+" + parametro;
                                window.open(url=link_es_gov, target="_blank", windowFeature='left=250,top=170,width=600,height=500');

                                let link_gov = "https://www.google.com/search?q=" + "site%3Agov.br+" + parametro;
                                window.open(url=link_gov, target="_blank", windowFeature='left=200,top=140,width=600,height=500');
                                
                                let link_jus = "https://www.google.com/search?q=" + "site%3Ajus.br+" + parametro;
                                window.open(url=link_jus, target="_blank", windowFeature='left=150,top=110,width=600,height=500');

                                let link_mp = "https://www.google.com/search?q=" + "site%3Amp.br+" + parametro;
                                window.open(url=link_mp, target="_blank", windowFeature='left=100,top=80,width=600,height=500');

                                let link_tc = "https://www.google.com/search?q=" + "site%3Atc.br+" + parametro;
                                window.open(url=link_tc, target="_blank", windowFeature='left=50,top=50,width=600,height=500');

                            }

                            // Exibe informa√ß√µes na tela
                            tempAlert(`Tecla ${event.key} - Pesquisa n√≥ selecionado (apenas PF e PJ) no Google nos dom√≠nios TC.br, MP.br, JUS.br, GOV.br e ES.GOV.br`, 3000);
                        }
                    }
                }

            } else if (event.key == 'G' && network.getSelectedNodes().length != 1) {
                tempAlert(`Tecla ${event.key} - Selecione um n√≥ (apenas PF e PJ) para pesquisar no Google nos dom√≠nios TC.br, MP.br, JUS.br, GOV.br e ES.GOV.br`, 3000);
            }
        });



        // #####################################################
        // ABRE ARQUIVO HTML CONTENDO MANUAL DO SINARC - TECLA h
        // #####################################################

        document.addEventListener('keydown', (event) => {
            if (event.key == 'h') {

                // O nome 'popup_help' faz com que essa janela seja exclusiva, n√£o sendo usada por outros popups do programa.
                window.open('help.html', 'popup_help','left=50,top=100,width=600,height=600');

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Abre manual do SINARC`, 3000);
            }
        });



        // ########################################
        // ALTERNA ENTRE N√ìS SELECIONADOS - TECLA i
        // ########################################

        var counter = 0 // Deve iniciar com valor zero para funcionar
        document.addEventListener('keydown', (event) => {
            if (event.key == "i" && network.getSelectedNodes().length > 0) {
                
                let s = network.getSelectedNodes();
                console.log('s:', s);
                console.log('counter antes:', counter);
                
                //console.log('counter:', counter);
                console.log('s:', s[counter]);
                //network.fit({nodes: network.getConnectedNodes(s[counter]), maxZoomLevel: 0.7, minZoomLevel: 0.7});


                //if (s.length > 0 ) {
                //    network.setOptions({physics: {enabled: false}});
                //    let p = '';
                //    let num = 0;
                //    num = 700 + nodes.length / 10;
                //    console.log(num + 'ms');
                //    for (let i=0; i<s.length; i++) {
                //        esconde();
                //        p = network.getPosition(s[i]);
                //        network.moveTo({
                //            position: {x: p['x'], y: p['y']},
                //            scale: 1,
                //            offset: {x:0, y:0},
                //            animation: {
                //                duration: 500,
                //                easingFunction: 'linear'
                //            }
                //       });
                //        setTimeout(exibe, num);
                //        network.releaseNode();
                //    }
                //    network.setOptions({physics: {enabled: true}});

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Centraliza e alterna entre n√≥s selecionados (${counter + 1}/${s.length})`, 3000);

                network.fit({nodes: [s[counter]], maxZoomLevel: 1, minZoomLevel: 1});
                if (counter == s.length - 1) {
                    counter = 0;
                } else if (counter < s.length) {
                    counter = counter + 1;
                }

                console.log('counter depois:', counter);

            } else if (event.key == "i" && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione pelo menos um n√≥ para centraliz√°-los na tela de forma alternada`, 3000);
            }
        });



        // ################################
        // ALTERNA SELE√á√ÉO DE N√ìS - TECLA I
        // ################################

        var se_1 = [];
        var se_2 = [];
        var toggle_I = true

        document.addEventListener('keydown', (event) => {

            
            if (event.key == "I" && network.getSelectedNodes().length > 0 && toggle_I == true) {

                // EXTRAI N√ìS SELECIONADOS
                se_1 = network.getSelectedNodes();

                // EXTRAI N√ìS N√ÉO SELECIONADOS
                se_2 = nodes.getIds().filter(x => !se_1.includes(x));

                // SELECIONA N√ìS QUE N√ÉO ESTAVAM SELECIONADOS
                network.selectNodes(se_2);

                // COR CINZA PARA OS R√ìTULOS DOS N√ìS SELECIONADOS
                for (let i=0; i<se_1.length; i++) {
                    nodes.update({id: se_1[i], font: {color: '#777777'}});
                }

                network.redraw();

                toggle_I = false

                tempAlert(`Tecla ${event.key} - Inverte sele√ß√£o de n√≥s (${se_2.length}/${nodes.getIds().length})`, 3000);

                
            } else if (event.key == "I" && network.getSelectedNodes().length > 0  && toggle_I == false) {
                
                network.unselectAll();

                // SELECIONA N√ìS QUE N√ÉO ESTAVAM SELECIONADOS
                network.selectNodes(se_1);
                network.redraw();

                toggle_I = true

                tempAlert(`Tecla ${event.key} - Inverte sele√ß√£o de n√≥s (${se_1.length}/${nodes.getIds().length})`, 3000);

            } else if (event.key == "I" && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione pelo menos um n√≥ para inverter a sele√ß√£o`, 3000);
            }

            // RETORNA COR CINZA PARA OS R√ìTULOS DOS N√ìS SELECIONADOS
            //for (let i=0; i<no_sel_pv.length; i++) {
            //    nodes.update({id: no_sel_pv[i], font: {color: '#777777'}});
            //}

        });



        // ###################################################
        // SELECIONA N√ìS COMUNS AOS N√ìS SELECIONADOS - TECLA j
        // ###################################################

        document.addEventListener('keydown', (event) => {
            if (event.key == "j" && network.getSelectedNodes().length >= 2) {
                let sel = network.getSelectedNodes();
                if (sel.length >= 2) {
                    let caixa = [];
                    for (let i=0; i<sel.length; i++) {
                        let temp = network.getConnectedNodes(sel[i]);
                        for (let k=0; k<temp.length; k++) {
                            caixa.push(temp[k]);
                        }    
                    }
                    let counts = {};
                    for (const num of caixa) {
                    counts[num] = counts[num] ? counts[num] + 1 : 1;
                    }
                    let comum = [];
                    for (const v in counts) {
                        if (counts[v] == sel.length) {
                            if (!(v in comum)) {
                                comum.push(v);
                            }
                        }
                    }
                    //console.log(comum);
                    network.unselectAll();
                    network.selectNodes(comum);

                    //network.fit({nodes: comum});

                    for (let i=0; i<sel.length; i++) {
                        nodes.update({id: sel[i], font: {color: '#777777'}});
                    }

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes comuns (${comum.length})`, 3000);

                }

            } else if (event.key == "j" && network.getSelectedNodes().length < 2) {
                tempAlert(`Tecla ${event.key} - Selecione pelo menos dois n√≥s`, 3000);
            }
        });



        // ###############################################################n
        // SELECIONA N√ìS QUE N√ÉO S√ÉO COMUNS AOS N√ìS SELECIONADOS - TECLA J
        // ###############################################################

        document.addEventListener('keydown', (event) => {
            if (event.key == "J" && network.getSelectedNodes().length >= 2) {

                let sel = network.getSelectedNodes();
                //console.log('sel:', sel)

                if (sel.length >= 2) {

                    let caixa = [];
                    for (let i=0; i<sel.length; i++) {
                        let temp = network.getConnectedNodes(sel[i]);
                        for (let k=0; k<temp.length; k++) {
                            caixa.push(temp[k]);
                        }    
                    }
                    let counts = {};
                    for (const num of caixa) {
                        counts[num] = counts[num] ? counts[num] + 1 : 1;
                    }
                    //console.log(counts);
                    
                    let comum = [];
                    for (const v in counts) {
                        if (counts[v] == sel.length) {
                            if (!(v in comum)) {
                                comum.push(v);
                            }
                        }
                    }
                    //console.log(comum);

                    let diff = caixa
                        .filter(x => !comum.includes(x))
                        .concat(comum.filter(x => !caixa.includes(x)));


                    let diff2 = diff.filter(x => !sel.includes(x));
                    console.log('diff2:', diff2);

                    //network.fit({nodes: diff2});


                    //diff = [...new Set(diff)];
                    //console.log('diff:', diff);
                    
                    network.unselectAll();
                    network.selectNodes(diff2);

                    //for (let j=0; j<sel.length; j++) {
                    //    network.body.nodes[sel[j]].selected = false;
                    //    network.redraw();
                    //}

                    for (let i=0; i<sel.length; i++) {
                        nodes.update({id: sel[i], font: {color: '#777777'}});
                    }

                    // Exibe informa√ß√µes na tela
                    //let n = nodes.getIds().length - comum.length - sel.length
                    
                    //tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes que n√£o s√£o comuns (${diff2.length})`, 3000);
                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes que n√£o s√£o comuns (${network.getSelectedNodes().length})`, 3000);

                }

            } else if (event.key == "J" && network.getSelectedNodes().length < 2) {
                tempAlert(`Tecla ${event.key} - Selecione pelo menos dois n√≥s`, 3000);
            }
        });
        


        // ###############################
        // ALTERNA ENTRE LAYOUTS - TECLA k
        // ###############################

        var toggle_hieraquic = false
        var toggle_hieraquic_2 = false
        var toggle_hieraquic_3 = false

        document.addEventListener('keydown', (event) => {
            
            if (event.key == 'k') {

                if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}})
                }

                

                // GRAFO NA HORIZONTAL (LEFT TO RIGHT)
                // 0 0 0
                if (toggle_hieraquic_3 == false && toggle_hieraquic_2 == false && toggle_hieraquic == false) {
                    network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: true,
                                levelSeparation: 500,
                                nodeSpacing: 100,
                                direction: "LR",
                                sortMethod: "directed",
                                shakeTowards: "leaves"
                                
                            }
                        },

                        
                        physics: {
                            hierarchicalRepulsion: {
                                centralGravity: 0
                            },
                            minVelocity: 0.75,
                            solver: "hierarchicalRepulsion"
                        }
                        

                    });

                    setTimeout(() => {
                        document.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape'}));
                    }, 1000);
                    
                    toggle_hieraquic_3 = false
                    toggle_hieraquic_2 = false
                    toggle_hieraquic = true

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Layout hier√°rquico a partir das folhas (destino das setas)`, 3000);

                    

                // 0 0 1
                } else if (toggle_hieraquic_3 == false && toggle_hieraquic_2 == false && toggle_hieraquic == true) {
                    network.setOptions({
                        layout: {
                            hierarchical: {
                            enabled: true,
                            levelSeparation: 500,
                            nodeSpacing: 100,
                            direction: "LR",
                            sortMethod: "directed",
                            shakeTowards: "roots"
                            }
                        },
                        physics: {
                            hierarchicalRepulsion: {
                            centralGravity: 0
                            },
                            minVelocity: 0.75,
                            solver: "hierarchicalRepulsion",
                        }
                    });

                    setTimeout(() => {
                        document.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape'}));
                    }, 1000);
                    
                    network.setOptions({nodes: {physics: false}});
                    network.setOptions({nodes: {physics: true}});

                    toggle_hieraquic_3 = false
                    toggle_hieraquic_2 = true
                    toggle_hieraquic = false

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Layout hier√°rquico a partir das ra√≠zes (origem das setas)`, 3000);



                // 0 1 0
                } else if (toggle_hieraquic_3 == false && toggle_hieraquic_2 == true && toggle_hieraquic == false) {
                    network.setOptions({
                        layout: {
                            hierarchical: {
                            enabled: false,
                            direction: "LR",
                            sortMethod: "directed",
                            shakeTowards: "leaves"
                            }
                        }
                    });
                    
                    network.setOptions({
                        edges: {
                            smooth: false
                        }
                    });
                    
                    network.setOptions({
                        physics: {
                            solver: 'barnesHut',
                            barnesHut: {
                            gravitationalConstant: -10000,
                            springLength: 200
                            },
                            minVelocity: 0.75
                        }
                    });

                    setTimeout(() => {
                        document.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape'}));
                    }, 1000);

                    network.redraw();
    
                    toggle_hieraquic_3 = false
                    toggle_hieraquic_2 = false
                    toggle_hieraquic = false

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Layout gravitacional`, 3000);
                }
            }
        });




        // #####################################
        // EXIBE NOVOS LAYOUTS CRIADOS - TECLA K
        // #####################################

        // Criado com o aux√≠lio do Chat GPT: criar c√≥digo em Python que posicione n pontos de forma equidistante sobre uma circunfer√™ncia no plano cartesiano
        // Valida√ß√£o realizada no site para plotagem de pontos no plano cartesiano: https://www.desmos.com/calculator?lang=pt-BR
        // O Crit√©rio adotado para ordenar os n√≥s sobre a circunfer√™ncia foi o n√∫mero de conex√µes.
        
        var toggle_K = 0;

        document.addEventListener('keydown', (event) => {

            if (event.key == 'K' && toggle_K == 0) {

                network.physics.physicsEnabled = true;
                network.physics.startSimulation()
                
                let nos2 = nodes.getIds();
                
                // CALCULA PONTOS NA CIRCUNFER√äNCIA
                let n2 = nos2.length;

                // O multiplicador do raio (20) controla a separa√ß√£o entre os n√≥s sobre a circunfer√™ncia
                function pontosCircunferencia(n, R=n2 * 20) {
                    
                    let d = 2 * R * Math.sin(Math.PI / n2);
                    let pontos = [];
                    
                    for (let i = 0; i < n2; i++) {
                        let angulo = 2 * Math.PI * i / n2 - Math.PI / 2;
                        let x = R * Math.cos(angulo);
                        let y = R * Math.sin(angulo);
                        let ponto = [x, y];
                        pontos.push(ponto);
                    }
                    
                    let pontosDistancia = [];
                    
                    for (let i = 0; i < n2; i++) {
                        let pontoAtual = pontos[i];
                        let pontoAnterior = pontos[(i - 1 + n2) % n2];
                        let pontoProximo = pontos[(i + 1) % n2];
                        let distanciaAnterior = Math.sqrt(Math.pow((pontoAtual[0] - pontoAnterior[0]), 2) + Math.pow((pontoAtual[1] - pontoAnterior[1]), 2));
                        let distanciaProxima = Math.sqrt(Math.pow((pontoAtual[0] - pontoProximo[0]), 2) + Math.pow((pontoAtual[1] - pontoProximo[1]), 2));
                        if (Math.abs(distanciaAnterior - d) < 1e-9 && Math.abs(distanciaProxima - d) < 1e-9) {
                            pontosDistancia.push(pontoAtual);
                        }
                    }
                    
                    return pontosDistancia;
                }
                
                let pontos = pontosCircunferencia(n2);


                // Create a new array from the list of nodes
                const nodeArray = nodes.get({
                    fields: ['id']
                });
                
                // Sort the array of nodes based on their degree
                nodeArray.sort((a, b) => {
                const degreeA = edges.get({
                    filter: edge => edge.from === a.id || edge.to === a.id
                }).length;
                const degreeB = edges.get({
                    filter: edge => edge.from === b.id || edge.to === b.id
                }).length;
                return degreeB - degreeA;
                });

                
                // Extrai ids dos n√≥s
                nos3 = [];
                for (let i=0; i<nodeArray.length; i++) {
                    nos3.push(nodeArray[i].id);
                }
                
                
                // ARREDONDA TUPLAS PARA DUAS CASAS DECIMAIS
                function arredondaTuplas(array) {
                let novoArray = [];
                for (let i = 0; i < array.length; i++) {
                    let tupla = [];
                    for (let j = 0; j < array[i].length; j++) {
                    tupla.push(parseFloat(array[i][j].toFixed(2)));
                    }
                    novoArray.push(tupla);
                }
                return novoArray;
                }
                
                lista = arredondaTuplas(pontos);
                
                
                // ALTERA A POSI√á√ÉO DOS N√ìS
                for (let i=0; i<nos3.length; i++) { 
                network.body.nodes[nos3[i]].x = lista[i][0];
                network.body.nodes[nos3[i]].y = lista[i][1];
                }
                
                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();
                
                network.redraw();

                network.fit();

                toggle_K = 1;

                tempAlert(`Tecla ${event.key} - Layout circular`, 3000);
            
            } else if (event.key == 'K' && toggle_K == 1) {

                network.physics.physicsEnabled = true;
                network.physics.startSimulation()

                toggle_K = 0;

                tempAlert(`Tecla ${event.key} - Layout gravitacional`, 3000);
                
            }
        });



        // ###################################
        // OCULTA LABELS DAS ARESTAS - TECLA l
        // ###################################

        var toggle_label = false
        var toggle_label_2 = false
        document.addEventListener('keydown', (event) => {
            if (event.key == 'l') {

                if (toggle_label == false && toggle_label_2 == false) {
                    network.setOptions({'edges': {'font': {'size': 0}}});
                    //console.log('Oculta texto das arestas')
                    //toggle_label = !toggle_label
                    toggle_label = true

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Oculta r√≥tulos das arestas`, 3000);


                } else if (toggle_label == true && toggle_label_2 == false) {
                    network.setOptions({"edges": {"hidden": true}});
                    //console.log('Oculta arestas')
                    //toggle_label_2 = !toggle_label_2
                    toggle_label_2 = true

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Oculta arestas`, 3000);


                } else if (toggle_label == true && toggle_label_2 == true) {
                    //console.log('Reexibe arestas e textos')
                    network.setOptions({'edges': {'font': {'size': 15}}});
                    network.setOptions({"edges": {"hidden": false}});
                    toggle_label = false
                    toggle_label_2 = false

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Reexibe arestas e r√≥tulos`, 3000);

                } 
            }
        });



        // ########################################
        // EXIBE DISTRIBUI√á√ÉO DAS ARESTAS - TECLA L
        // ########################################

        document.addEventListener('keydown', (event) => {
            
            if (event.key == 'L') {

                let ta = edges.getIds();
                let aa = [];
                for (let i=0; i<ta.length; i++) {
                    let temp = network.body.edges[ta[i]].title;
                    aa.push(temp);
                }
                
                
                const counts = {};
                for (const num of aa) {
                counts[num] = counts[num] ? counts[num] + 1 : 1;
                }
                
                
                let tex = `DISTRIBUI√á√ÉO DAS ARESTAS POR TIPO (${ta.length}):\n`;
                Object.keys(counts)
                    .sort()
                    .forEach(function(v, i) {
                        tex = tex + v + ': ' + counts[v] + '\n'
                    });
                
                alert(tex);

                tempAlert(`Tecla ${event.key} - Exibe distribui√ß√£o das aresta por tipo (${ta.length})`, 3000);
            }
        });



        // ######################################################
        // AUMENTA MASSA DE TODOS OS N√ìS EM 0.5 UNIDADE - TECLA m
        // ######################################################

        var massa = 1

        document.addEventListener('keydown', (event) => {

            if (event.key == 'm' && network.physics.options.solver == 'barnesHut') {

                if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}})
                } 

                // AUMENTA MASSA EM 0.5               
                massa = massa + 0.5
                
                // AJUSTA A MASSA DE TODOS OS N√ìS, EXCETO OS QUE J√Å TIVERAM AS MASSAS AJUSTADAS PELAS TECLAS n E N
                network.setOptions({
                    nodes: {
                        mass: massa
                    }
                });

                //network.selectNodes(nodes.getIds());

                network.redraw();

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Aumenta massa dos n√≥s em 0.5 unidade (geral). Fator: ${massa}`, 3000);
            }

        });



        // ######################################################
        // DIMINUI MASSA DE TODOS OS N√ìS EM 0.5 UNIDADE - TECLA M
        // ######################################################

        // Vari√°vel 'massa' foi declarada na tecla anterior

        document.addEventListener('keydown', (event) => {

            if (event.key == 'M' && network.physics.options.solver == 'barnesHut') {

                if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}})
                }

                massa = massa - 0.5

                if (massa <= 1) {
                    massa = 1
                }

                // AJUSTA A MASSA DE TODOS OS N√ìS, EXCETO OS QUE J√Å TIVERAM AS MASSAS AJUSTADAS PELAS TECLAS n E N
                network.setOptions({
                    nodes: {
                        mass: massa
                    }
                });

                network.redraw();

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Reduz massa dos n√≥s em 0.5 unidade (geral). Fator: ${massa}`, 3000);
            }
        });



        // #######################################################
        // AUMENTA MASSA DOS N√ìS COM TAMANHO ACIMA DE 40 - TECLA n
        // #######################################################

        // A partir do momento em que se altera as massas dos n√≥s com as teclas n e N, as teclas m e M passam a n√£o mais atuar sobre esse n√≥s.
        // Enquanto as teclas n e N n√£o forem acionadas, as teclas m e M atuam sobre todos os n√≥s.

        var par_n = 1

        document.addEventListener('keydown', (event) => {

            if (event.key == 'n' && network.physics.options.solver == 'barnesHut') {

                if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}})
                }
                
                let nod = nodes.getIds();

                let sel_e = []

                for (let i=0; i<nod.length; i++) {

                    let size = network.body.nodes[nod[i]].options.size

                    if (size >= t_ref) {
                        sel_e.push(nod[i])
                    }

                    if (size >= t_ref) {

                        // AUMENTA EM 5
                        nodes.update({
                            id: nod[i],
                            mass: par_n + 5
                        });
                    }
                }

                network.selectNodes(sel_e);

                // AUMENTA EM 5
                par_n = par_n + 5

                network.redraw();

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Aumenta massa dos n√≥s com tamanho >= ${t_ref} em 5 unidades. Fator: ${par_n} (${network.getSelectedNodes().length})`, 3000);

            }
        })



        // ##########################################################
        // REDUZ A MASSA DOS N√ìS COM TAMANHO ACIMA DO t_ref - TECLA N
        // ##########################################################

        // A vari√°vel global 'par_n' foi criada na tecla anterior (Tecla n)

        document.addEventListener('keydown', (event) => {

            if (event.key == 'N' && network.physics.options.solver == 'barnesHut') {

                if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}})
                }

                // REDUZ EM 5
                par_n = par_n - 5

                if (par_n <= 1) {
                    par_n = 1;
                }

                let nod = nodes.getIds();

                let sel_e = [];

                for (let i=0; i<nod.length; i++) {

                    let size = network.body.nodes[nod[i]].options.size

                    if (size >= t_ref) {
                        sel_e.push(nod[i])
                    }

                    if (size >= t_ref) {
                        nodes.update({id: nod[i], mass: par_n});
                    }
                }

                network.selectNodes(sel_e);

                network.redraw();
                
                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Reduz massa dos n√≥s com tamanho >= ${t_ref} em 5 unidades. Fator: ${par_n} (${network.getSelectedNodes().length})`, 3000);
            }
        })



        // ###############################################################
        // COPIA N√ìS E N√öMERO DE CAMADAS PARA A √ÅREA DE TRABALHO - TECLA o
        // ###############################################################

        document.addEventListener('keydown', (event) => {

            if (event.key == 'o' && network.getSelectedNodes().length > 0) {

                let get_sel = network.getSelectedNodes();


                let num_cam = prompt("Digite o n√∫mero de camadas adjacentes (ENTER para 1 camada):");

                // INTERROMPE FUN√á√ÉO SE O BOT√ÉO "CANCELA" FOR PRESSIONADO
                if (num_cam == null) {
                    return;
                }


                //let del_te_en_em = ''
                //del_te_en_em = confirm("Deseja excluir Telefones, Endere√ßos e E-mails?");



                let conf_destaca = ''
                if (get_sel.length > 1) {
                    conf_destaca = confirm("Deseja destacar caminhos mais curtos entre os n√≥s?");
                }

                async function copyOperation(num_cam) {
                    await navigator.clipboard.writeText(num_cam)
                };

                let temp = [];
                for (let i = 0; i < get_sel.length; i++) {
                    let j = get_sel[i] + "***" + num_cam + "***" + conf_destaca;
                    temp.push(j);
                }

                setTimeout(() => {copyOperation(temp)}, 500)

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Carrega n√≥s selecionados em nova aba (${temp.length})`, 3000);
            
            } else if (event.key == 'o' && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para abri-los em nova aba`, 3000);
            }
        });



        // ###############################################################
        // CONSULTA PELA EXIST√äNCIA DE FILIAIS DO N√ì SELECIONADO - TECLA O
        // ###############################################################

        document.addEventListener('keydown', (event) => {

            if (event.key == 'O' && network.getSelectedNodes().length == 1) {
                
                let sel = network.getSelectedNodes();
                
                //if (sel.length > 1) {
                //    alert('Selecione apenas uma pessoa jur√≠dica.')
                //    return;
                //}

                let texto = '';
                
                // APENAS PESSOAS JUR√çDICAS
                if (sel.length == 1 && ((sel[0].slice(0, 3) == 'PJ_') || (sel[0].slice(0, 3) == 'PE_'))) {

                    texto = '#_#' + sel[0].slice(3, 11) + '@' + '9999' + '#_#';

                    //console.log(texto);

                    async function copyOperation(num_cam) {
                        await navigator.clipboard.writeText(num_cam);
                    }
                    setTimeout(() => {copyOperation(texto)}, 500);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Carrega todas as filiais do n√≥ selecionado em nova aba`, 3000);
                
                //} else {
                    //alert('Para consulta de filiais, selecione uma - e apenas uma - pessoa juridica.');
                    // Exibe informa√ß√µes na tela
                //    tempAlert(`Tecla ${event.key} - ALERTA: Para consultar filiais, selecione uma - e apenas uma - pessoa jur√≠dica`, 3000);

                }

            } else if (event.key == 'O' && network.getSelectedNodes().length != 1) {
                    tempAlert(`Tecla ${event.key} - Selecione uma pessoa jur√≠dica para abrir suas filiais em nova aba`, 3000);
            }

            //};
        });



        // ###################################
        // ATIVA/DESATIVA PHYSICS - TECLA p
        // ###################################

        document.addEventListener('keydown', (event) => {
            if (event.key == 'p') {

                // Limpa os caches para for√ßar re-leitura dos tamanhos originais
                Object.keys(tamanhosOriginais).forEach(key => delete tamanhosOriginais[key]);
                Object.keys(tamanhosFonteOriginais).forEach(key => delete tamanhosFonteOriginais[key]);
                Object.keys(coresFonteOriginais).forEach(key => delete coresFonteOriginais[key]);

                if (network.physics.physicsEnabled == true) {
                    network.physics.physicsEnabled = false;
                    network.physics.stopSimulation();

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Para a intera√ß√£o gravitacional (congela todos os n√≥s)`, 3000);

                } else if (network.physics.physicsEnabled == false) {
                    network.physics.physicsEnabled = true;
                    network.physics.startSimulation();

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Retoma a intera√ß√£o gravitacional (descongela todos os n√≥s)`, 3000);

                }

            }
        });



        // #########################################
        // CONSULTA LIVRE DOS N√ìS NO GRAFO - TECLA q
        // #########################################

        // Realiza consulta nos textos dos labels e dos ids dos n√≥s e das arestas. Ap√≥s a consulta, usar tecla I para alternar entre os n√≥s selecionados.

        var target_id = [];
        //var nodLista = [];
        var con = [];
        
        document.addEventListener('keydown', (event) => {

            if (event.key == 'q') {

                let a = network.getSelectedNodes();
                let temp = '';
                if (a.length == 1) {
                    temp = `id selecionado: ${network.body.nodes[a[0]].id}\n`
                }

                // ZERA VARI√ÅVEL GLOBAL. EXIGIDO PELO SCRITP SEGUINTE (TECLA I)
                counter = 0

                let text = prompt(temp + "Digite o texo a ser localizado nos r√≥tulos e nos ids dos N√ìS:");
                //console.log('Termo pesquisado:', text);

                // SE FOR FORNECIDO ALGUM PAR√ÇMETRO
                if (text != '') {
                    let a = nodes.getIds();
                    //let target_id = [];
                    //let con = [];
                    for (var i=0; i<a.length; i++) {
                        if (nodes.get(a[i])['label'].toLowerCase().includes(text.toLowerCase()) || a[i].toLowerCase().includes(text.toLowerCase())) {
                            let temp = network.getConnectedNodes(a[i]);
                            con = con.concat(temp);
                            con = con.concat([a[i]])
                            target_id.push(a[i]);
                        }
                    }

                    // Elimina duplicidades
                    con = [...new Set(con)];
                    target_id = [...new Set(target_id)];

                    network.selectNodes(target_id);

                    //console.log('con:', con);
                    //network.fit({nodes: con, maxZoomLevel: 0.7, minZoomLevel: 0.7});

                    if (con.length > 0) {
                        network.fit({nodes: con});
                    }
                    //network.fit({nodes: target_id});

                    //console.log('Itens localizados:', target_id);
                    //alert(target_id.length.toString() + ' itens localizados');

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Pesquisa por "${text}" nos n√≥s (${target_id.length})`, 3000);


                // SE N√ÉO FOR FORNECIDO NENHUM PAR√ÇMETRO
                } else if (text == '') {

                    let a = edges.getIds();
                    let edgLista = [];
                    let param = prompt('Digite o texo a ser localizado nos r√≥tulos das ARESTAS:');

                    if (param == '') {
                        return;
                    }
                    
                    for (let i=0; i<a.length; i++) {
                        if (network.body.edges[a[i]].options.label != undefined) {
                            let temp = network.body.edges[a[i]].options.label;
                            temp = temp.toLowerCase();
                            
                            function removeAccents(str) {
                                const accents = "√Ä√Å√Ç√É√Ñ√Ö√†√°√¢√£√§√•√í√ì√î√ï√ï√ñ√ò√≤√≥√¥√µ√∂√∏√à√â√ä√ã√®√©√™√´√∞√á√ß√ê√å√ç√é√è√¨√≠√Æ√Ø√ô√ö√õ√ú√π√∫√ª√º√ë√±≈†≈°≈∏√ø√Ω≈Ω≈æ";
                                const accentsOut = "AAAAAAaaaaaaOOOOOOooooooEEEEeeeeeCcDIIIIiiiiUUUUuuuuNnSsYyyZz";
                                str = str.split('');
                                str.forEach((letter, index) => {
                                    const i = accents.indexOf(letter);
                                    if (i !== -1) {
                                    str[index] = accentsOut[i];
                                    }
                                });
                                return str.join('');
                            }
                            temp = removeAccents(temp)
                                
                            param = param.toLowerCase();
                            if (temp.includes(param)) {
                                edgLista.push(network.body.edges[a[i]].id);
                            }
                        }
                    }
                    
                    let nodLista = [];
                    for (let i=0; i<edgLista.length;i++) {
                        nodLista.push(network.body.edges[edgLista[i]].fromId);
                        target_id.push(network.body.edges[edgLista[i]].fromId);
                    }
                    
                    for (let i=0; i<nodLista.length; i++) {
                        let temp = network.getConnectedNodes(nodLista[i]);
                        con = con.concat(temp);
                    }

                    con = con.concat(target_id);

                    // Elimina duplicidades
                    con = [...new Set(con)];
                    target_id = [...new Set(target_id)];

                    //network.selectNodes(nodLista);

                    //target_id = target_id.concat(nodLista);

                    network.selectNodes(target_id);

                    if (con.length > 0) {
                        network.fit({nodes: con});
                    }

                    //tempAlert(`Tecla ${event.key} - Pesquisa por "${param}" nas arestas (${nodLista.length})`, 3000);
                    tempAlert(`Tecla ${event.key} - Pesquisa por "${param}" nas arestas (${target_id.length})`, 3000);

                }

                
            }
        });



        // ############################
        // SELECIONA N√ìS-ALVOS - TECLA Q
        // ############################

        document.addEventListener('keydown', (event) => {
            if (event.key == 'Q') {
                let todos = nodes.getIds();
                let nos_sel = []
                for (let i=0; i<todos.length; i++) {
                    let node = network.body.nodes[todos[i]];
                    if (node.shape.options.color.border == 'red') {
                        nos_sel.push(todos[i]);
                    }
                }
                network.selectNodes(nos_sel);

                if (nos_sel.length > 0) {
                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s-alvos (${nos_sel.length})`, 3000);
                } else if (nos_sel.length == 0) {
                    tempAlert(`Tecla ${event.key} - N√£o h√° n√≥s-alvos no grafo`, 3000);
                }
            }
        });



        // ########################################################
        // DELETA TODOS OS N√ìS QUE N√ÉO EST√ÉO SELECIONADOS - TECLA r
        // ########################################################

        document.addEventListener('keydown', (event) => {
    
            if (event.key == "r" && network.getSelectedNodes().length > 0) {

                if (network.getSelectedNodes().length > 0) {

                    let n_1 = network.getSelectedNodes();

                    let tudo_1 = nodes.getIds();

                    let diff_2 = tudo_1.filter(x => !n_1.includes(x));

                    network.selectNodes(diff_2)

                    network.deleteSelected();

                    temp = nodes.getIds();

                    for (let i=0; i<temp.length; i++) {
                        nodes.update({id: temp[i], font: {color: '#777777'}})
                    }

                    network.unselectAll();

                    // VARI√ÅVEL GLOBAL DEFINIDA NA FUN√á√ÉO DA TECLA DEL
                    del_array = del_array.concat(diff_2);

                    // LIMPA n_bag REMOVENDO N√ìS DELETADOS (CORRIGE PROBLEMA COM FIT AP√ìS ESPA√áO)
                    n_bag = n_bag.filter(x => !diff_2.includes(x));

                    // total_n: VARI√ÅVEL GLOBAL DENIFINDA NA FUN√á√ÉO DA TECLA DEL
                    let percentual = (del_array.length / total_n.length) * 100;
                    percentual = percentual.toFixed(1);

                    // INCLUIR AVISO PERMANENTE QUE N√ìS FORAM DELETADOS
                    let el = document.createElement("div");
                    //el.setAttribute("style","position:absolute;top:70px;right:21px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
                    el.setAttribute("style","position:absolute;bottom:6px;right:19px;border:1px solid rgba(255, 255, 123, 1);border-radius: 1px;font-size: 10px;padding: 1;background-color:rgba(255, 255, 123, 1);");

                    el.innerHTML = `N√≥s deletados (${del_array.length}/${total_n.length}) ${percentual}%`;
                    document.body.appendChild(el);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Deleta n√≥s n√£o selecionados (${diff_2.length})`, 3000);
                }

            } else if (event.key == "r" && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione os n√≥s que devem permanecer no grafo`, 3000);
            }
        });



        // ###############################################################################
        // EXIBE APENAS N√ìS E ARESTAS DOS CAMINHOS MAIS CURTOS ENTRE OS N√ìS-ALVOS - TECLA R
        // ###############################################################################

        var e_color = [];
        document.addEventListener('keydown', (event) => {
    
            if (event.key == "R") {

                // EXTRAI ARESTAS COLORIDAS
                //let e = edges.getIds();
                let e = edges.getIds().filter(id => network.body.edges[id] !== undefined);

                //let e_color = [];
                for (let i=0; i<e.length; i++) {
                    let temp = network.body.edges[e[i]].options.width
                    if (temp == 8) {
                        e_color.push(e[i]);
                    }
                }

                if (e_color.length > 0) {
                
                    // EXTRAI N√ìS CONECTADOS √ÄS ARESTAS COLORIDAS
                    let n_color = [];
                    for (let i=0; i<e_color.length; i++) {
                        let temp = network.getConnectedNodes(e_color[i]);
                        for (let k=0; k<temp.length; k++) {
                            n_color.push(temp[k]);
                        }
                    }
                    
                    
                    // ELIMINA DUPLICIDADES
                    n_color = [...new Set(n_color)];
                    

                    // CALCULA DIFEREN√áA E DELETA
                    let n_diff = nodes.getIds().filter(x => !n_color.includes(x));
                    network.setSelection({nodes: n_diff})
                    network.deleteSelected();
                    
                    //let e_diff = edges.getIds().filter(x => !e_color.includes(x));	
                    let e_diff = [];

                    let edgeIds = edges.getIds();

                    for (let i = 0; i < edgeIds.length; i++) {
                        let id = edgeIds[i];

                        // pula arestas que n√£o existem mais no network
                        if (!network.body.edges[id]) continue;

                        // mant√©m apenas as arestas fora de e_color
                        if (!e_color.includes(id)) {
                            e_diff.push(id);
                        }
                    }





                    network.setSelection({edges: e_diff})
                    network.deleteSelected();


                    // VARI√ÅVEL GLOBAL DEFINIDA NA FUN√á√ÉO DA TECLA DEL
                    del_array = del_array.concat(n_diff);

                    // LIMPA n_bag REMOVENDO N√ìS DELETADOS (CORRIGE PROBLEMA COM FIT AP√ìS ESPA√áO)
                    //n_bag = n_bag.filter(x => !diff_2.includes(x));
                    n_bag = n_bag.filter(x => !n_diff.includes(x));

                    // total_n: VARI√ÅVEL GLOBAL DENIFINDA NA FUN√á√ÉO DA TECLA DEL
                    let percentual = (del_array.length / total_n.length) * 100;
                    percentual = percentual.toFixed(1);

                    // INCLUIR AVISO PERMANENTE QUE N√ìS FORAM DELETADOS
                    let el = document.createElement("div");
                    //el.setAttribute("style","position:absolute;top:70px;right:21px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
                    el.setAttribute("style","position:absolute;bottom:6px;right:19px;border:1px solid rgba(255, 255, 123, 1);border-radius: 1px;font-size: 10px;padding: 1;background-color:rgba(255, 255, 123, 1);");


                    //el.innerHTML = `N√≥s deletados (${del_array.length}/${total_n.length}) ${percentual}%`;
                    //document.body.appendChild(el);

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Exibe apenas n√≥s interligados por arestas coloridas (${n_color.length})`, 3000);
                
                } else if (e_color.length == 0) {
                    tempAlert(`Tecla ${event.key} - N√£o h√° n√≥s interligados por arestas coloridas`, 3000);
                }
            }
        })

        


        // ###################################
        // RECEBE CONSULTA LIVRE - TECLA s
        // ###################################

        document.addEventListener('keydown', (event) => {

            let texto = '';
            if (event.key == 's') {

                let a = network.getSelectedNodes();
                let temp = '';
                if (a.length == 1) {
                    temp = `id selecionado: ${network.body.nodes[a[0]].id}\n`
                }
                //console.log(temp)

                let texto = prompt(temp + "Texto para consulta livre (curingas de palavras: * ):");

                //console.log(texto);
                if (texto != null && texto != '') {
                    async function copyOperation(texto) {
                        await navigator.clipboard.writeText(texto)
                    }

                    // Exibe informa√ß√µes na tela
                    tempAlert(`Tecla ${event.key} - Realiza consulta livre por "${texto}"`, 3000);

                    texto = '#_#' + texto + '#_#';
                    setTimeout(() => {copyOperation(texto)}, 1000);
                    //console.log('Texto copiado:', texto);

                }
            }
        });



        //function ajusta_altura() {

        //    // EXTRAI DIMENS√ïES DA JANELA DO NAVEGADOR
        //    var w = window.innerWidth;
        //    let h = window.innerHeight;

        //    // AJUSTA ALTURA DA √ÅREA DO GRAFO √Ä ALTURA DA JANELA
        //    document.querySelector('#mynetwork').style.height = h - 20;
        //};

        //setTimeout(() => {ajusta_altura()}, 0);



        // ###############################################################################
        // CARREGA N√ìS SELECIONADOS EM NOVA ABA (1 CAMADA, SEM DESTAQUE/SEM SOM) - TECLA S
        // ###############################################################################
        document.addEventListener('keydown', (event) => {
 
            // Verifica se a tecla pressionada √© 'S' (mai√∫scula)
            if (event.key == 'S' && network.getSelectedNodes().length > 0) {
                let sel = network.getSelectedNodes();
                let num_cam = 1; // Fixo em 1 camada
 
                // Define explicitamente para desativar o destaque de arestas, o que tamb√©m desativa o beep de conex√£o.
                // O valor 'false' ser√° capturado pelo backend Python para definir destacar_ligacoes = False.
                let conf_destaca = 'false';
 
                // Junta os IDs dos n√≥s selecionados usando ';' como separador
                let selected_ids = sel.join(';');
 
                // Formata a string com delimitadores #_# para acionar a "Consulta Livre"
                // e evitar o destaque das bordas em vermelho.
                let texto_consulta = '#_#' + selected_ids + '#_#';
 
                // A estrutura final inclui o texto_consulta, o n√∫mero de camadas e a instru√ß√£o 'false'
                let parametro_final = texto_consulta + '***' + num_cam + '***' + conf_destaca;
 
                async function copyOperation(param) {
                    await navigator.clipboard.writeText(param) // Comunica com o backend via clipboard
                };
 
                // Copia o par√¢metro para a √°rea de transfer√™ncia
                setTimeout(() => {copyOperation(parametro_final)}, 500);
 
                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Exibe n√≥s selecionados (${sel.length}) em ${num_cam} camada(s) sem destaque`, 3000);
 
            } else if (event.key == 'S' && network.getSelectedNodes().length == 0) {
 
                // Exibe alerta se nenhum n√≥ estiver selecionado
                tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para abri-los em nova aba`, 3000);
            }
        });









        // ########################################
        // EXIBE IMAGENS DOS N√ìS POR TIPO - TECLA t
        // ########################################

        // 15 itens (0 a 14)
        var img_names = ['pf_homem.png',
                        'pf_homem_com_bandeira.png',
                        'pf_mulher.png',
                        'pf_mulher_com_bandeira.png',
                        'pj_brasil_ativa.png',
                        'pj_brasil_ativa_com_bandeira.png', 
                        'pj_brasil_inativa.png',
                        'pj_brasil_inativa_com_bandeira.png',
                        'pj_exterior_ativa.png',
                        'pj_exterior_ativa_com_bandeira.png', 
                        'pj_exterior_inativa.png', 
                        'pj_exterior_inativa_com_bandeira.png', 
                        'endereco.png', 
                        'telefone.png',
                        'email.png'
                        ]

        var cont_t = 0
        var temp_t = nodes.getIds();

        document.addEventListener('keydown', (event) => {
            
            if (event.key == 't' && network.physics.options.solver == 'barnesHut') {
                
                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();
                
                // EXECUTAR APENAS UMA VEZ
                if (cont_t == 0) {
                    network.setOptions({nodes: {opacity: 0.1}, edges: {hidden: true}});
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Ativa modo transpar√™ncia por tipos de n√≥s - oculta rede (${temp_t.length})`, 3000);

                    
                } else if (cont_t == 1) {
                    let temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[0]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe homens (${temp.length}/${nodes.getIds().length})`, 3000);
                    

                    
                } else if (cont_t == 2) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[1]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[0]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe homens com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 3) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[2]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[1]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe mulheres (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 4) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[3]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[2]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe mulheres com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 5) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[4]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[3]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs ativas domiciliadas no Brasil (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 6) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[5]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[4]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs ativas domiciliadas no Brasil com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 7) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[6]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[5]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs inativas domiciliadas no Brasil (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 8) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[7]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[6]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs inativas domiciliadas no Brasil com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);
                

                } else if (cont_t == 9) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[8]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[7]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs ativas domiciliadas no exterior (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 10) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[9]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[8]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs ativas domiciliadas no exterior com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 11) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[10]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[9]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs inativas domiciliadas no exterior (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 12) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[11]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[10]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe PJs inativas domiciliadas no exterior com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 13) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[12]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[11]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe endere√ßos (${temp.length}/${nodes.getIds().length})`, 3000);

                    
                } else if (cont_t == 14) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[13]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[12]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe telefones (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t == 15) {
                    temp = [];
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[14]) {
                            nodes.update({id: temp_t[i], opacity: 1});
                            temp.push(temp_t[i]);
                        } else if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[13]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = cont_t + 1;
                    tempAlert(`Tecla ${event.key} - Exibe e-mails (${temp.length}/${nodes.getIds().length})`, 3000);

                    
                } else if (cont_t == 16) {
                    //window.location.reload();
                    for (var i = 0; i < temp_t.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t[i]].options.image.split('\\').at(-1) == img_names[14]) {
                            nodes.update({id: temp_t[i], opacity: 0.1});
                        }
                    }
                    cont_t = 1;
                    tempAlert(`Tecla ${event.key} - Oculta rede (${temp_t.length})`, 3000);
                }

                //network.physics.physicsEnabled = true;
                //network.physics.startSimulation();
            }
        });



        // ##################################
        // ATIVA MODO TRANSPAR√äNCIA - TECLA T
        // ##################################

        //var toggle_T = true;
        var con_t = [];
        var edg_t = [];
        var con_sel = [];
        var edg_sel = []

        document.addEventListener('keydown', (event) => {

            //  S√ì FUNCIONA NO MODO BARNES-HUT
            if (event.key == 'T' && network.physics.options.solver == 'barnesHut') {

                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                // TORNA TODOS OS N√ìS E ARESTAS TRANSPARENTES
                network.setOptions({nodes: {opacity: 0.1}, edges: {hidden: true}});

                // AO FICAR EM CIMA DO N√ì
                network.on('hoverNode', function f(params) {

                    // EXTRAI N√ìS CONECTADOS AO N√ì HOVER (con_t)
                    let node = params.node;
                    //console.log('hover node:', node);
                    con_t = network.getConnectedNodes(node);
                    con_t = con_t.concat(node);
                    //console.log('con_t:', con_t);

                    // EXTRAI ARESTAS CONECTADAS AO N√ì HOVER (edg_t)
                    edg_t = network.getConnectedEdges(node);
                    //console.log('edg_t:', edg_t);

                    // FAZ APARECER N√ìS CONECTADOS AO N√ì HOVER
                    for (let i=0; i<con_t.length; i++) {
                        nodes.update({id: con_t[i], opacity: 1});
                    }

                    // FAZ APARECER ARESTAS CONECTADAS AO N√ì HOVER
                    for (let i=0; i<edg_t.length; i++) {
                        edges.update({id: edg_t[i], hidden: false});
                    }
                });

                // A SELE√á√ÉO DOS N√ìS OCORRE POR MEIO DE OUTRO SCRIPT (CLICK)
                

                // ######################################################### ACIMA EST√Å OK!

                // AO SAIR DE CIMA DO N√ì
                network.on('blurNode', function f(params) {

                    // OBT√âM N√ì BLUR (APENAS UM)
                    let blur_node = params.node;

                    // OBT√âM ARRAY DE N√ìS CONECTADOS AOS N√ìS SELECIONADOS (PODE SER MAIS DE UM)
                    let sel = network.getSelectedNodes();

                    // SE O N√ì BLUR ESTIVER ENTRE OS N√ìS SELECIONADOS, ADICIONA OS N√ìS E ARESTAS CONECTADOS AOS ARRAYS con_sel E edg_sel
                    for (let i=0; i<sel.length; i++) {                
                        if (blur_node == sel[i]) {
                            
                            //for (let j=0; j<sel.length; j++) {
                            let temp = network.getConnectedNodes(sel[i]);
                            con_sel = con_sel.concat(temp);
                            con_sel = con_sel.concat(sel[i]);
                            //}
                            //console.log('con_sel:', con_sel);
                
                            // OBT√âM ARESTAS CONECTADAS AO N√ì SELECIONADO
                            //for (let k=0; k<con_sel.length; k++) {
                            temp = network.getSelectedEdges(con_sel[i]);
                            edg_sel = edg_sel.concat(temp);
                            //}
                            //console.log('edg_sel:', edg_sel);
                        }
                    }

                    // SE N√ÉO TIVER N√ì SELECIONADO, FAZ OS N√ìS E ARESTAS (con_t e edg_t) VOLTAREM A FICAR TRANSPARENTES
                    if (con_sel.length == 0) {
                        for (let i=0; i<con_t.length; i++) {
                            nodes.update({id: con_t[i], opacity: 0.1});
                        }
                        for (let i=0; i<edg_t.length; i++) {
                            edges.update({id: edg_t[i], hidden: true});
                        }

                    // SE TIVER N√ìS E ARESTAS SELECIONADOS, SUBTRAI N√ìS E ARESTAS SELECIONADOS (con_sel E edg_sel) DOS N√ìS E ARESTAS CONTIDOS EM con_t E OS FAZ TRANSPARENTES
                    } else if (con_sel.length > 0) {
                        let diff_node = con_t.filter(x => !con_sel.includes(x));
                        for (let i=0; i<diff_node.length; i++) {
                            nodes.update({id: diff_node[i], opacity: 0.1});
                        }

                        // FALTA FAZER COM QUE AS ARESTAS DESAPARE√áAM AP√ìS BLUR
                        let diff_edg = edg_t.filter(x => !edg_sel.includes(x));
                        for (let i=0; i<diff_edg.length; i++) {
                            edges.update({id: diff_edg[i], hidden: true});
                        }
                    }
                });
                //toggle_T = false;

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Ativa modo transpar√™ncia por conex√µes - oculta rede`, 3000);
                
            } else if (event.key == 'T' && network.physics.options.solver == 'barnesHut') {
                window.location.reload();               
                //ajusta_altura();
                //toggle_T = true;

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Desativa modo transpar√™ncia`, 3000);
            }
        });



        // ####################################
        // EXIBE CENTRALIDADE DOS N√ìS - TECLA u
        // ####################################

        // Encontrar uma forma de passar a informa√ß√£o apenas uma vez e n√£o em todos os n√≥s PJ
        // Descobrir forma de exibir informa√ß√µes em outro elemento e n√£o mais em alert

        document.addEventListener('keydown', (event) => {
            if (event.key == "u") {

                let n = nodes.getIds();
                for (let i=0; i<n.length; i++) {
                    if (n[i].slice(0, 3) == 'PJ_') {
                        
                        // As informa√ß√µes exibidas est√£o no atributo 'algoritmos' de todos os n√≥s PJ
                        let temp = network.body.nodes[n[i]].options.algoritmos;
                        alert(temp)
                        break;
                    }
                }

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Tecla ${event.key} - Exibe informa√ß√µes sobre as medidas de centralidade`, 3000);
            }
        });



        // ################################################
        // EXIBE DISTRIBUI√á√ÉO DOS N√ìS POR TAMANHO - TECLA U
        // ################################################

        //var a_tudo = nodes.getIds();
        var a_tudo = []

        document.addEventListener('keydown', (event) => {

            a_tudo = nodes.getIds();
            
            if (event.key == "U") {
                
                let a_100 = [];
                let a_95 = [];
                let a_90 = [];
                let a_85 = [];
                let a_80 = [];
                let a_75 = [];
                let a_70 = [];
                let a_65 = [];
                let a_60 = [];
                let a_55 = [];
                let a_50 = [];
                let a_45 = [];
                let a_40 = [];
                let a_35 = [];
                let a_30 = [];
                let a_25 = [];
                let a_20 = [];
                
                for (let i=0; i<a_tudo.length; i++) {

                    if (network.body.nodes[a_tudo[i]].options.size > 99.9999999999 && network.body.nodes[a_tudo[i]].options.size <= 100) {
                        a_100.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 99.9999999999 && network.body.nodes[a_tudo[i]].options.size >= 95) {
                        a_95.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 95 && network.body.nodes[a_tudo[i]].options.size >= 90) {
                        a_90.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 90 && network.body.nodes[a_tudo[i]].options.size >= 85) {
                        a_85.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 85 && network.body.nodes[a_tudo[i]].options.size >= 80) {
                        a_80.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 80 && network.body.nodes[a_tudo[i]].options.size >= 75) {
                        a_75.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 75 && network.body.nodes[a_tudo[i]].options.size >= 70) {
                        a_70.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 70 && network.body.nodes[a_tudo[i]].options.size >= 65) {
                        a_65.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 65 && network.body.nodes[a_tudo[i]].options.size >= 60) {
                        a_60.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 60 && network.body.nodes[a_tudo[i]].options.size >= 55) {
                        a_55.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 55 && network.body.nodes[a_tudo[i]].options.size >= 50) {
                        a_50.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 50 && network.body.nodes[a_tudo[i]].options.size >= 45) {
                        a_45.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 45 && network.body.nodes[a_tudo[i]].options.size >= 40) {
                        a_40.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 40 && network.body.nodes[a_tudo[i]].options.size >= 35) {
                        a_35.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 35 && network.body.nodes[a_tudo[i]].options.size >= 30) {
                        a_30.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 30 && network.body.nodes[a_tudo[i]].options.size >= 25) {
                        a_25.push(a_tudo[i]);
                    }
                    else if (network.body.nodes[a_tudo[i]].options.size < 25 && network.body.nodes[a_tudo[i]].options.size >= 20) {
                        a_20.push(a_tudo[i]);
                    }

                }
                //console.log(a_100);
                //console.log(a_95);
                //console.log(a_90);
                //console.log(a_85);
                //console.log(a_80);
                //console.log(a_75);
                //console.log(a_70);
                //console.log(a_65);
                //console.log(a_60);
                //console.log(a_55);
                //console.log(a_50);
                //console.log(a_45);
                //console.log(a_40);
                //console.log(a_35);
                //console.log(a_30);
                //console.log(a_25);
                //console.log(a_20);
                
                let texto_espaco = `DISTRIBUI√á√ÉO DOS N√ìS POR TAMANHO:
Tamanho      100:   ${a_100.length}
Tamanho 95 - 99:   ${a_95.length}
Tamanho 90 - 94:   ${a_90.length}
Tamanho 85 - 90:   ${a_85.length}
Tamanho 80 - 84:   ${a_80.length}
Tamanho 75 - 79:   ${a_75.length}
Tamanho 70 - 74:   ${a_70.length}
Tamanho 65 - 69:   ${a_65.length}
Tamanho 60 - 64:   ${a_60.length}
Tamanho 55 - 59:   ${a_55.length}
Tamanho 50 - 54:   ${a_50.length}
Tamanho 45 - 49:   ${a_45.length}
Tamanho 40 - 44:   ${a_40.length}
Tamanho 35 - 39:   ${a_35.length}
Tamanho 30 - 34:   ${a_30.length}
Tamanho 25 - 29:   ${a_25.length}
Tamanho 20 - 24:   ${a_20.length}
-----------------------------
TOTAL:                    ${a_tudo.length}`;
                
                texto_espaco = texto_espaco.replaceAll(" 0\n", "  \n");

                tempAlert(`Tecla ${event.key} - Exibe distribui√ß√£o dos n√≥s por tamanho`, 3000);
                
                alert(texto_espaco);
            }
        });



        // ###########################
        // EXIBE COMUNIDADES - TECLA v
        // ###########################

        // Quando os atributos dos n√≥s s√£o alterados por meio de "nodes.update", "network.setOptions" n√£o funciona para retornar ao estado anterior
        // Ao mudar paletar de cores, alterar tamb√©m a vari√°vel 'num_cores' (resolvido: criado mecanismo de varia√ß√£o autom√°tica)

        var toggle_v = true;
        var n_comunidades = 0;

        document.addEventListener('keydown', (event) => {
            if (event.key == "v" && toggle_v == true) {

                //network.physics.physicsEnabled = false;
                //network.physics.stopSimulation();

                let a = nodes.getIds();

                if (a.length > 500) {
                    let conf = confirm('A identificacao de comunidades em mais de 500 n√≥s pode demorar v√°rios minutos. Deseja continuar?')
                    if (!conf) {
                        return;
                    }
                }

                // PALETA DE CORES ALTO CONTRASTE
                // https://www.schemecolor.com/high-contrast.php
                //var hcc = ["#8931EF", "#F2CA19", "#FF00BD", "#0057E9", "#87E911", "#E11845"]
                //var hcc = ["#8931EF", "#F2CA19", "#FF00BD", "#0057E9", "#87E911"]

                // tab10 (tableau 10)
                //var hcc = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"]

                var hcc = ["rgba(137, 49, 239, 0.5)",
                           "rgba(242, 202, 25, 0.5)",
                           "rgba(255, 0, 189, 0.5)",
                           "rgba(0, 87, 233, 0.5)",
                           "rgba(135, 233, 17, 0.5)",
                           "rgba(225, 24, 69, 0.5)",

                           "rgba(0, 255, 0, 0.5)",
                           "rgba(255, 255, 0, 0.5)",
                           "rgba(0, 255, 255, 0.5)",
                           "rgba(255, 0, 255, 0.5)"
                          ]

                //var hcc = ["rgba(0, 255, 0, 1)",
                //           "rgba(255, 255, 0, 1)",
                //           "rgba(0, 255, 255, 1)",
                //           "rgba(255, 0, 255, 1)"
                //          ]

                //var hcc = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"]

                for (let i=0; i<a.length; i++) {
                    
                    let n = network.body.nodes[a[i]].options.z_group

                    if (n > n_comunidades) {
                        n_comunidades = n;
                    }
                    
                    // CALCULA √çNDICE C√çCLICO DO ARRAY
                    //let num_cores = hcc.length
                    index_cir = Math.max(0, n % hcc.length) || 0;

                    // MUDA COR DO FUNDO DO N√ì
                    nodes.update({id: a[i], color: {background: hcc[index_cir]}});

                    //console.log(i)
                }
                toggle_v = false;

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Tecla ${event.key} - Adiciona cores aos n√≥s para destacar comunidades (${n_comunidades})`, 3000);

            } else if (event.key == "v" && toggle_v == false) {
                
                let a = nodes.getIds();
                for (let i=0; i<a.length; i++) {
                    nodes.update({id: a[i], color: {background: 'transparent'}});
                }
                toggle_v = true;

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Tecla ${event.key} - Remove cores dos n√≥s`, 3000);
            }

            //network.physics.physicsEnabled = true;
            //network.physics.startSimulation();

        });



        // #################################
        // EXIBE N√ìS DE CADA GRUPO - TECLA V
        // #################################

        var num_grupos = 1;
        var num_grupos_total = network.body.nodes[nodes.getIds()[0]].options.z_group_total;
        var arr2 = [];

        document.addEventListener('keydown', (event) => {
            
            if (event.key == 'V') {

                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                network.setOptions({nodes: {opacity: 0.0}, edges: {hidden: true}});
                
                let arr1 = nodes.getIds();
                
                if (arr2.length > 0) {
                    for (let i=0; i<arr2.length; i++) {
                        nodes.update({id: arr2[i], opacity: 0.0});
                    }
                }

                arr2 = [];
                
                for (let i=0; i<arr1.length; i++) {
                    let temp = network.body.nodes[arr1[i]].options.z_group;
                    if (temp == num_grupos) {
                        arr2.push(network.body.nodes[arr1[i]].options.id)
                        nodes.update({id: arr1[i], opacity: 1});
                    }
                }

                
                if (num_grupos == num_grupos_total) {
                    tempAlert(`Tecla ${event.key} - 1 Seleciona grupo ${num_grupos}/${num_grupos_total} (${arr2.length})`, 3000);
                    num_grupos = 1;
                
                } else if (num_grupos < num_grupos_total) {
                    tempAlert(`Tecla ${event.key} - 2 Seleciona grupo ${num_grupos}/${num_grupos_total} (${arr2.length})`, 3000);
                    num_grupos = num_grupos + 1
                }
                
                network.physics.physicsEnabled = true;
                network.physics.startSimulation();
            }
        });



        // #############################################################
        // ADICIONA COR AO FUNDO DOS N√ìS ANCESTRAIS DO N√ì-ALVO - TECLA w
        // #############################################################

        // CRIA ARRAY COM N√ìS ANCESTRAIS
        var ancestors = [];
        var nodes_all = nodes.getIds();
        for (let i=0; i<nodes_all.length; i++) {
            if (network.body.nodes[nodes_all[i]].options.z_ancestor == 'true') {
                ancestors.push(nodes_all[i]);
            }
        }

        // INSERE COR NO FUNDO DOS N√ìS ANCESTRAIS
        var toggle_w = true;
        document.addEventListener('keydown', (event) => {

            if (event.key == 'w') {

                if (toggle_w == true) {
                    for (let i=0; i<ancestors.length; i++) {
                        nodes.update({id: ancestors[i], color: {background: 'rgb(0, 0, 255, 0.2)', hover: {background: 'rgb(0, 0, 255, 0.2)'}}});
                        //nodes.update({id: ancestors[i], color: {background: 'rgb(0, 255, 0, 1)', hover: {background: 'rgb(0, 255, 0, 1)'}}});
                    }

                    if (ancestors.length > 0) {
                        tempAlert(`Tecla ${event.key} - Adiciona cores para destacar cadeia de n√≥s origin√°ria do n√≥-alvo (${ancestors.length})`, 3000);
                        toggle_w = false;

                    } else if (ancestors.length == 0) {
                        tempAlert(`Tecla ${event.key} - N√£o h√° n√≥s-alvos para destacar cadeia origin√°ria`, 3000);
                    }
                    
                } else if (toggle_w == false) {
                    for (let i=0; i<ancestors.length; i++) {
                        nodes.update({id: ancestors[i], color: {background: 'transparent', hover: {background: 'transparent'}}});
                    }
                    toggle_w = true;

                    // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                    tempAlert(`Tecla ${event.key} - Remove cores dos n√≥s (${ancestors.length})`, 3000);
                }
            }
        });



        // ##################################
        // SELECIONA N√ìS ANCESTRAIS - TECLA W
        // ##################################

        document.addEventListener('keydown', (event) => {

            if (event.key == 'W') {
                arr1 = nodes.getIds();
                arr2 = ancestors;

                if (arr2.length == 0) {
                    tempAlert(`Tecla ${event.key} - N√£o h√° n√≥-alvo √∫nico para selecionar cadeia origin√°ria`, 3000);
                    return;
                }

                let difference = arr1.filter(x => !arr2.includes(x));
                network.selectNodes(difference);
                network.deleteSelected();


                // VARI√ÅVEL GLOBAL DEFINIDA NA FUN√á√ÉO DA TECLA DEL
                del_array = del_array.concat(difference);

                // LIMPA n_bag REMOVENDO N√ìS DELETADOS (CORRIGE PROBLEMA COM FIT AP√ìS ESPA√áO)
                n_bag = n_bag.filter(x => !diff_2.includes(x));

                // total_n: VARI√ÅVEL GLOBAL DENIFINDA NA FUN√á√ÉO DA TECLA DEL
                let percentual = (del_array.length / total_n.length) * 100;
                percentual = percentual.toFixed(1);

                // INCLUIR AVISO PERMANENTE QUE N√ìS FORAM DELETADOS
                let el = document.createElement("div");
                //el.setAttribute("style","position:absolute;top:70px;right:21px;border:5px solid rgba(255, 255, 123, 1);border-radius: 5px;background-color:rgba(255, 255, 123, 1);");
                el.setAttribute("style","position:absolute;bottom:6px;right:19px;border:1px solid rgba(255, 255, 123, 1);border-radius: 1px;font-size: 10px;padding: 1;background-color:rgba(255, 255, 123, 1);");

                el.innerHTML = `N√≥s deletados (${del_array.length}/${total_n.length}) ${percentual}%`;
                document.body.appendChild(el);

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Tecla ${event.key} - Exclui n√≥s que n√£o pertecem √† cadeia de n√≥s origin√°ria do n√≥-alvo (${ancestors.length})`, 3000);
            }
        });



        // ####################################################
        // ADICIONA COR AO FUNDO DOS N√ìS SELECIONADOS - TECLA x
        // ####################################################

        // Verde, amarelo, azul, lil√°s
        var cores_fundo = ["rgba(0, 255, 0, 1)", "rgba(255, 255, 0, 1)", "rgba(0, 255, 255, 1)", "rgba(255, 0, 255, 1)"];
        var c_color = 0;
        var nos_coloridos = [];

        document.addEventListener('keydown', (event) => {
            if (event.key == 'x' && network.getSelectedNodes().length > 0) {

                let todos = network.getSelectedNodes();
                for (let i=0; i<todos.length; i++) {
                    nodes.update({id: todos[i], color: {background: cores_fundo[c_color], hover: {background: cores_fundo[c_color]}}});
                    nodes.update({id: todos[i], font: {color: '#777777'}});
                    nos_coloridos.push(todos[i]);
                    network.unselectAll();
                }
                
                if (network.getSelectedNodes().length == 0) {
                    c_color = c_color + 1;
                }
                
                if (c_color > cores_fundo.length - 1) {
                    c_color = 0;
                }

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Tecla ${event.key} - Adiciona cores sequenciais aos n√≥s selecionados (verde, amarelo, azul e lil√°s)`, 3000);
            
            } else if (event.key == 'x' && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione n√≥s em sequ√™ncia para adicionar cores (verde, amarelo, azul e lil√°s)`, 3000);
            }
        });



        // ####################################################
        // REMOVE COR AO FUNDO DOS N√ìS SELECIONADOS - TECLA X
        // ####################################################

        document.addEventListener('keydown', (event) => {
            if (event.key == 'X') {
                for (let i=0; i<nos_coloridos.length; i++) {
                    nodes.update({id: nos_coloridos[i], color: {background: 'transparent', hover: {background: 'transparent'}}});
                    nodes.update({id: nos_coloridos[i], font: {color: '#777777'}});
                }
                network.unselectAll();
                nos_coloridos = [];
                c_color = 0;

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Tecla ${event.key} - Remove cores dos n√≥s`, 3000);
            }
        });



        // #################################
        // CONSULTA N√ìS ACUMULADOS - TECLA y
        // #################################

        document.addEventListener('keydown', (event) => {
            
            if (event.key == 'y') {
                
                // COPIA PARA O CLIPBOARD
                async function copyOperation(param) {
                    await navigator.clipboard.writeText(param)    
                }

                // RESTAURA O ARRAY ARMAZENADO EM 'localStorage' E GERADO PELAS TECLAS '+' E '-'
                let temp = JSON.parse(localStorage.getItem("nos_acum"));
                console.log(temp);


                let conf_destaca = ''
                if (temp.length > 1) {
                    conf_destaca = confirm("Deseja destacar caminhos mais curtos entre os n√≥s?");
                }


                let temp2 = [];
                for (let i = 0; i < temp.length; i++) {
                    let j = temp[i] + "***" + 1 + "***" + conf_destaca;
                    temp2.push(j);
                }


                setTimeout(() => {copyOperation(temp2)}, 500)

                tempAlert(`Tecla ${event.key} - Abre lista de n√≥s-alvos em nova aba (${temp.length})`, 3000);
            }
        });



        // ########################################
        // EXIBE TODOS OS N√ìS PF, PJ E PE - TECLA z
        // ########################################

        var controle_z = true;
        var toggle_z = true;
        var last_central_node = '';
        var last_node = '';
        var old_title = '';
        var new_title = '';
        var nod = [];
        var num_nos = 0;
    
        document.addEventListener('keydown', (event) => {
            if (event.key == "z" && toggle_z == true) {

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Ativa modo autom√°tico de visualiza√ß√£o`, 3000);

                toggle_z = false;

                network.physics.physicsEnabled = false;
                network.physics.stopSimulation();

                var pos = network.getPositions();
                var a = nodes.getIds();

                maiores = [];

                // LOOP PARA OBTER APENAS SEQU√äNCIA NUM√âRICA
                for (let i=0; i<a.length; i++) {

                    // LOOP SOBRE IDS DOS N√ìS
                    for (let k=0; k<a.length; k++) {
                        let value_no = network.body.nodes[a[k]].options.value;
                        if (value_no == i) {

                            // APENAS N√ìS COM 2 OU MAIS N√ìS ADJACENTES
                            if (network.getConnectedNodes(a[k]).length > 1) {
                                maiores.push(a[k]);
                            }
                        }
                    }
                }

                // N√ìS ORDENADOS SEGUNDO MAIOR N√öMERO DE ADJAC√äNCIAS
                maiores.reverse();

                // CRIA LISTA FINAL COM N√ìS COM MAIOR GRAU, SEGUIDOS DE SEUS ADJACENTES
                for (let i=0; i<maiores.length; i++) {
                    nod.push([maiores[i], maiores[i]]);
                    let temp = network.getConnectedNodes(maiores[i]);
                    for (let k=0; k<temp.length; k++) {
                        let temp2 = []
                        temp2 = temp2.concat(temp[k]);
                        temp2 = temp2.concat(maiores[i]);
                        nod.push(temp2);
                    }
                }

                //console.log('nod:', nod)

                network.setOptions({'edges': {'font': {'size': 0}}});
                network.setOptions({"edges": {"hidden": false}});

                // IN√çCIO DA FUN√á√ÉO DE LOOP
                var i = 0;              
                function myLoop() {        
                setTimeout(function() {

                    //console.log('nod:', nod)

                    // CONDI√á√ÉO QUE VERIFICA O FINAL DO ARRAY 'nod' E ENCERRA A FUN√á√ÉO
                    if (i == nod.length) {
                        nodes.update({id: last_node, font: {color: '#777777'}});
                        //nodes.update({id: last_central_node, color: {background: 'transparent'}});
                        nodes.update({id: last_central_node, color: {background: 'transparent', hover: {background: 'transparent'}}});
                        nodes.update({id: last_node, label: old_title});
                        //num_nos = 0;
                        network.unselectAll();
                        network.fit({
                            position: {x:0, y:0},
                            scale: 1.0,
                            animation: true
                        });
                        nod = [];
                        network.physics.physicsEnabled = true;
                        network.physics.startSimulation();
                        toggle_z = true;
                        return;
                    }
                    
                    //console.log('nod:', nod);

                    // SAI DO PROGRAMA (SEM ESTA CONDI√á√ÉO, ESTAVA DANDO ERRO NA PR√ìXIMA LINHA)
                    if (nod.length == 0) {
                        return
                    }

                    x = pos[nod[i][0]]['x'];
                    y = pos[nod[i][0]]['y'];

                    last_central_node = nod[i][1];
                    last_node = nod[i][0]

                    nodes.update({id: nod[i][1], color: {background: 'rgb(0, 0, 255, 0.2)', hover: {background: 'rgb(0, 0, 255, 0.2)'}}});
                    
                    if (i >= 1) {
                        if (nod[i][1] != nod[i - 1][1]) {
                            nodes.update({id: nod[i - 1][1], font: {color: '#777777'}});
                            nodes.update({id: nod[i - 1][1], color: {background: 'transparent', hover: {background: 'transparent'}}});
                            setTimeout(function() {
                                network.moveTo({
                                    position: {x:x, y:y},
                                    scale: 0.5,
                                    animation: true
                                });
                            }, 1000);
                        }

                        // ESTOU VENDO ESTE ITEM
                        network.body.nodes[nod[i - 1][0]].options.label = old_title;
                        nodes.update({id: nod[i - 1][0], font: {color: '#777777'}});
                    }

                    // CRIANDO NOVO R√ìTULO
                    let edg1 = network.getConnectedEdges(nod[i][0]);
                    let edg2 = network.getConnectedEdges(nod[i][1]);
                    let common_edg = edg1.filter(value => edg2.includes(value));
                    let edg_title = network.body.edges[common_edg[0]].title;
                    old_title = network.body.nodes[nod[i][0]].options.label;

                    var num_nos_cen = network.body.nodes[nod[i][1]].options.value
                    if (num_nos <= parseInt(num_nos_cen)) {
                        if (num_nos == 0) {
                            num_nos = 0;
                        } 
                    }

                    // PARA OS CASOS DE TE_, EN_, EM_ E PARA O PRIMEIRO ITEM DA LISTA
                    if (edg_title == undefined || i == 0) {
                        edg_title = '';
                    }
                    new_title = old_title + '\n' + edg_title + ' (' + num_nos + ' de ' + num_nos_cen + ')';

                    num_nos = num_nos + 1;
                    if (num_nos > parseInt(num_nos_cen)) {
                        num_nos = 0;
                    }

                    network.body.nodes[nod[i][0]].options.label = new_title;
                    
                    network.moveTo({
                        position: {x:x, y:y},
                        scale: 1.0,
                        animation: true
                    });
                    
                    network.selectNodes([nod[i][0]]);
                    nodes.update({id: nod[i][0], font: {color: 'red'}});
                    if (controle_z == false) {
                        controle_z = true;
                        nodes.update({id: last_node, font: {color: '#777777'}});
                        nodes.update({id: last_central_node, color: {background: 'transparent', hover: {background: 'transparent'}}});
                        network.unselectAll();
                        network.redraw();
                        return;
                    }

                    if (i < nod.length) {        
                        myLoop();            
                        if (i == nod.length - 1) {
                            network.setOptions({'edges': {'font': {'size': 15}}});
                            network.setOptions({"edges": {"hidden": false}});
                        }
                    }

                    i++;               

                }, 3500)
                    
                }
                
                myLoop();

                //nodes.update({id: nod[i][1], color: {background: 'transparent', hover: {background: 'transparent'}}});
                

            
            } else if (event.key == "z" && toggle_z == false) {

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Desativa modo autom√°tico de visualiza√ß√£o`, 3000);

                controle_z = false;
                toggle_z = true;
                network.setOptions({'edges': {'font': {'size': 15}}});
                network.setOptions({"edges": {"hidden": false}});
                nodes.update({id: last_node, font: {color: '#777777'}});
                nodes.update({id: last_central_node, color: {background: 'transparent', hover: {background: 'transparent'}}});
                nodes.update({id: last_node, label: old_title});
                network.unselectAll();
                network.redraw();
                network.fit({
                    position: {x:0, y:0},
                    scale: 1.0,
                    animation: true
                });
                controle_z = true;
                last_central_node = '';
                last_node = '';
                old_title = '';
                new_title = '';
                nod = [];
                num_nos = 0;
                network.physics.physicsEnabled = true;
                network.physics.startSimulation();
            }
        });

        //// EXEMPLO DE LOOP PERI√ìDICO EM JAVASCRIPT
        //let x = 0;
        //function loop () {
        //    console.log("hi");
        //    x++;
        //
        //    if (x<3) {
        //        setTimeout(loop, 5000);
        //    }
        //}
        //loop();



        // ################################################################
        // AJUSTA MASSA DOS N√ìS PROPORCIONALMENTE AO TAMANHO - TECLA ESPA√áO
        // ################################################################

        // Usa vari√°vel global 't_ref'

        var pula_100 = true
        var n_bag = [];

        //var desativa_teclas_m_n = false
        document.addEventListener('keydown', (event) => {
            
            if (event.key == ' ') {

                toggle_c = 0

                //desativa_teclas_m_n = true;

                // EXECUTA APENAS UMA VEZ, FAZENDO t_ref = 100
                if (pula_100 == true) {
                    t_ref = 100
                    pula_100 = false 
                }             

                let all = nodes.getIds();

                let sel_e = []

                for (let i=0; i<all.length; i++) {

                    if (n_bag.includes(all[i])) {
                        continue;
                    }

                    
                    let size = network.body.nodes[all[i]].options.size;

                    // ‚Üê NOVA LINHA: ARREDONDA PARA 100 SE >= 99.99
                    if (size >= 99.99) {
                        size = 100;
                    }

                    // VERIFICA SE O TAMANHO DO N√ì EST√Å NO INTERVALO ENTRE MAIOR OU IGUAL A t_ref E MENOR QUE t_ref + 5
                    if (size >= t_ref && size < (t_ref + 5)) {
                        sel_e.push(all[i])
                    }
                    
                    if (size >= t_ref && size >= 25) {
                        // nodes.update({id: all[i], mass: (size/20) ** 3});
                        nodes.update({id: all[i], mass: network.body.nodes[all[i]].options.value ** 1.5});
                        n_bag.push(all[i]);
                        n_bag = [...new Set(n_bag)];
                    }
                    
                }

                if (t_ref == 20) {
                    sel_e = [];
                }
                network.selectNodes(sel_e);

                // tempAlert(`Tecla Espa√ßo - Aumenta massa dos n√≥s proporcionalmente ao tamanho >= ${t_ref} (${n_bag.length})`, 3000);
                tempAlert(t_ref === 20 ? "Tecla Espa√ßo - Retorna a massa dos n√≥s ao valor inicial (1 unid.)" : `Tecla Espa√ßo - Aumenta a massa dos n√≥s proporcionalmente ao tamanho ${t_ref === 100 ? "=" : ">="} ${t_ref} (${n_bag.length})`, 3000);



                t_ref = t_ref - 5;

                if (t_ref == 15) {
                    // console.log('Reset t_ref e n_bag');
                    //t_ref = 100;
                    t_ref = 40;
                    pula_100 = true;
                    // n_bag = [];
                    // for (let i=0; i<all.length; i++) {
                    //     nodes.update({id: all[i], mass: 1});
                    //     console.log('Reset mass for node id:', all[i]);
                    // }

                    for (let i=0; i<n_bag.length; i++) {
                        nodes.update({id: n_bag[i], mass: 1});
                        // console.log('Reset mass for node id:', n_bag[i]);
                    }
                    n_bag = [];


                }
            }

            // console.log('t_ref:', t_ref);
            // console.log('n_bag:', n_bag);
        });
        











        // #####################################################################
        // ALTERNA SELE√á√ÉO DOS N√ìS ADJACENTES QUE S√ÉO ORIGEM E DESTINO - TECLA ;
        // #####################################################################

        var toggle_pv = 0;
        var no_sel_pv = [];
        var ar_adj = [];
        var temp_to = [];
        var temp_from = [];

        document.addEventListener('keydown', (event) => {

            // O SCRIPT FOI INICIALMENTE CONCEBIDO PARA SER USADO COM MAIS DE UM N√ì SELECIONADO. DEPOIS AJUSTAMOS PARA APENAS UM N√ì SELECIONADO
            if (event.key == ";") {



                if (toggle_pv == 0 && network.getSelectedNodes().length != 1) {
                    tempAlert(`Tecla ${event.key} - Selecione um n√≥ para aplicar a fun√ß√£o`, 3000);
                    return;
                }



                // EXECUTA APENAS NA PRIMEIRA VEZ QUE A TECLA ; √â PRESSIONADA OU QUANDO toggle_pv == 0
                if (toggle_pv == 0 && temp_to.length == 0 && temp_from.length == 0) {
                
                    // EXTRAI ARRAY COM N√ì SELECIONADO
                    no_sel_pv = network.getSelectedNodes();
                    
                    // EXTRAI TODAS AS ARESTAS ADJACENTES AOS N√ìS SELECIONADOS
                    for (let i=0; i<no_sel_pv.length; i++) {
                        ar_adj.push(network.getConnectedEdges(no_sel_pv[i]));
                    }
            
                    // ELIMINA DUPLICIDADES NO ARRAY DE ARESTAS - atentar para o [0]
                    ar_adj = [...new Set(ar_adj[0])];

                    // EXTRAI N√ìS DESTINO
                    for (let i=0; i<ar_adj.length; i++) {
                        if (network.body.edges[ar_adj[i]] != undefined) {
                            temp_to.push(network.body.edges[ar_adj[i]].toId);
                        }
                    }
                    temp_to = [...new Set(temp_to)];
                    temp_to = temp_to.filter(x => !no_sel_pv.includes(x));

                    // EXTRAI N√ìS ORIGEM
                    for (let i=0; i<ar_adj.length; i++) {
                        if (network.body.edges[ar_adj[i]] != undefined) {
                            temp_from.push(network.body.edges[ar_adj[i]].fromId);
                        }
                    }
                    temp_from = [...new Set(temp_from)];
                    temp_from = temp_from.filter(x => !no_sel_pv.includes(x));

                    //console.log('atualiza√ß√£o das vari√°veis');
                    //console.log('temp_from:', temp_from);
                    //console.log('temp_to:', temp_to);
                }

                

                // SELECIONA N√ìS ADJACENTES QUE S√ÉO DESTINO DO N√ì SELECIONADO (PONTA DAS SETAS QUE SAEM -->)
                if (toggle_pv == 0 && no_sel_pv.length == 1 && temp_to.length > 0) {
                
                    network.unselectAll();
                    network.redraw();
                    network.selectNodes(temp_to);

                    let cn = network.getConnectedNodes(no_sel_pv[0]).length

                    // RETORNA COR CINZA PARA OS R√ìTULOS DOS N√ìS SELECIONADOS
                    for (let i=0; i<no_sel_pv.length; i++) {
                        nodes.update({id: no_sel_pv[i], font: {color: '#777777'}});
                    }
                    
                    toggle_pv = 1;

                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes de DESTINO (-->) das arestas do selecionado (${temp_to.length}/${cn})`, 3000);



                } else if (toggle_pv == 0 && no_sel_pv.length == 1 && temp_to.length == 0) {

                    network.unselectAll();
                    network.redraw();
                    toggle_pv = 1;

                    let cn = network.getConnectedNodes(no_sel_pv[0]).length
                    
                    // RETORN COR CINZA PARA OS R√ìTULOS DOS N√ìS SELECIONADOS
                    for (let i=0; i<no_sel_pv.length; i++) {
                        nodes.update({id: no_sel_pv[i], font: {color: '#777777'}});
                    }

                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes de DESTINO (-->) das arestas do selecionado (${temp_to.length}/${cn})`, 3000);

                    
                
                // SELECIONA N√ìS ADJACENTES QUE CHEGAM NO N√ì-ALVO (ORIGEM)
                } else if (toggle_pv == 1 && no_sel_pv.length == 1 && temp_from.length > 0) {

                    // DESSELECIONA TODOS OS N√ìS
                    network.unselectAll();
                    network.redraw();
                    network.selectNodes(temp_from);

                    let cn = network.getConnectedNodes(no_sel_pv[0]).length

                    // RETORN COR CINZA PARA OS R√ìTULOS DOS N√ìS SELECIONADOS
                    for (let i=0; i<no_sel_pv.length; i++) {
                        nodes.update({id: no_sel_pv[i], font: {color: '#777777'}});
                    }
                
                    toggle_pv = 2;
                    
                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes de ORIGEM (<--) das arestas do n√≥ selecionado (${temp_from.length}/${cn})`, 3000);




                } else if (toggle_pv == 1 && no_sel_pv.length == 1 && temp_from.length == 0) {
                    
                    network.unselectAll();
                    network.redraw();
                    toggle_pv = 2;

                    let cn = network.getConnectedNodes(no_sel_pv[0]).length

                    // RETORN COR CINZA PARA OS R√ìTULOS DOS N√ìS SELECIONADOS
                    for (let i=0; i<no_sel_pv.length; i++) {
                        nodes.update({id: no_sel_pv[i], font: {color: '#777777'}});
                    }

                    tempAlert(`Tecla ${event.key} - Seleciona n√≥s adjacentes de ORIGEM (<--) das arestas dos n√≥ selecionado (${temp_from.length}/${cn})`, 3000);


            
                // VOLTA A SELECIONAR OS N√ìS ORIGINAIS
                } else if (toggle_pv == 2 && no_sel_pv.length == 1) {
                
                    network.unselectAll();
                    network.selectNodes(no_sel_pv);
            
                    // REINICIALIZA VARI√ÅVEIS
                    toggle_pv = 0;
                    no_sel_pv = [];
                    ar_adj = [];
                    temp_to = [];
                    temp_from = [];
            
                    tempAlert(`Tecla ${event.key} - Retorna √† sele√ß√£o inicial (${network.getSelectedNodes().length})`, 3000);
                }

            }

            // USADO APENAS PARA TESTES
            //console.log(toggle_pv);
            //console.log(no_sel_pv);
            //console.log(network.getSelectedNodes().length);

        })



        // ##########################################################
        // SELECIONA N√ìS ADICIONADOS NA REQUISI√á√ÉO ANTERIOR - TECLA /
        // ##########################################################

        var toggle_bar = 0;

        document.addEventListener('keydown', (event) => {

            if (event.key == "/" && toggle_bar == 0 && network.getSelectedNodes().length == 0) {

                let nn = nodes.getIds()
                let li = []
                for (let i=0; i<nn.length; i++) {
                    if (network.body.nodes[nn[i]].options.z_novo == '1') {
                        li.push(nn[i])
                    }
                }
                network.selectNodes(li);

                toggle_bar = 1;

                tempAlert(`Tecla ${event.key} - Seleciona n√≥s adicionados na requisi√ß√£o anterior (${li.length}/${nn.length})`, 3000);
            
            } else if (event.key == "/" && toggle_bar == 1) {
                let nn = nodes.getIds()
                network.unselectAll();
                toggle_bar = 0;
                tempAlert(`Tecla ${event.key} - Desseleciona todos os n√≥s (${nn.length})`, 3000);
            }

        });



        // ##################################################
        // SELECIONA N√ìS POR TIPO DE IMAGEM - TECLA . (PONTO)
        // ##################################################

        // 15 itens (0 a 14)
        var img_names2 = ['pf_homem.png',
                        'pf_homem_com_bandeira.png',
                        'pf_mulher.png',
                        'pf_mulher_com_bandeira.png',
                        'pj_brasil_ativa.png',
                        'pj_brasil_ativa_com_bandeira.png', 
                        'pj_brasil_inativa.png',
                        'pj_brasil_inativa_com_bandeira.png',
                        'pj_exterior_ativa.png',
                        'pj_exterior_ativa_com_bandeira.png', 
                        'pj_exterior_inativa.png', 
                        'pj_exterior_inativa_com_bandeira.png', 
                        'endereco.png', 
                        'telefone.png',
                        'email.png'
                        ]

        var cont_t2 = 0
        var temp_t2 = nodes.getIds();

        document.addEventListener('keydown', (event) => {
            
            //if (event.key == '.' && network.physics.options.solver == 'barnesHut') {
            if (event.key == '.') {
                                    
                if (cont_t2 == 0) {
                    network.unselectAll();
                    let temp = [];
                    let nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[0]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona homens (${temp.length}/${nodes.getIds().length})`, 3000);
                    

                    
                } else if (cont_t2 == 1) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[1]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona homens com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 2) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[2]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona mulheres (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 3) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[3]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona mulheres com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 4) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[4]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs ativas domiciliadas no Brasil (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 5) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[5]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs ativas domiciliadas no Brasil com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 6) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[6]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs inativas domiciliadas no Brasil (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 7) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[7]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs inativas domiciliadas no Brasil com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);
                

                } else if (cont_t2 == 8) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[8]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs ativas domiciliadas no exterior (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 9) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[9]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs ativas domiciliadas no exterior com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 10) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[10]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs inativas domiciliadas no exterior (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 11) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[11]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona PJs inativas domiciliadas no exterior com bandeira vermelha (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 12) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[12]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona endere√ßos (${temp.length}/${nodes.getIds().length})`, 3000);

                    
                } else if (cont_t2 == 13) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[13]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona telefones (${temp.length}/${nodes.getIds().length})`, 3000);


                } else if (cont_t2 == 14) {
                    network.unselectAll();
                    temp = [];
                    nos = [];
                    for (var i = 0; i < temp_t2.length; i++) {

                        // CASO O N√ì TENHA SIDO DELETADO
                        if (network.body.nodes[temp_t2[i]] == undefined) {
                            continue
                        }

                        if (network.body.nodes[temp_t2[i]].options.image.split('\\').at(-1) == img_names2[14]) {
                            nos.push(temp_t2[i]);
                            temp.push(temp_t2[i]);
                        }
                    }
                    network.selectNodes(nos);
                    cont_t2 = cont_t2 + 1;
                    tempAlert(`Tecla ${event.key} - Seleciona e-mails (${temp.length}/${nodes.getIds().length})`, 3000);

                    
                } else if (cont_t2 == 15) {
                    network.unselectAll();
                    cont_t2 = 0;
                    tempAlert(`Tecla ${event.key} - Desseleciona todos os n√≥s (${temp_t.length})`, 3000);
                }
            }
        });



        // ###################################################################
        // ABRE POPUP COM R√ìTULOS DAS ARESTAS SELECIONADAS - TECLA , (V√çRGULA)
        // ###################################################################

        var popup;
        var nn;

        // EXECUTA FUN√á√ÉO createPopup SE HOUVER N√ì SELECIONADO, PASSANDO COMO PAR√ÇMETRO O ARRAY DOS N√ìS SELECIONADOS (nn)
        document.addEventListener("keydown", function(event) {
        if (event.key === ",") {
            nn = network.getSelectedNodes();
            if (nn.length > 0) {
                createPopup(nn);
                tempAlert(`Tecla ${event.key} - Abre popup com n√≥s selecionados (${nn.length})`, 3000);
            } else if (nn.length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para abrir popup contendo n√≥s selecionados`, 3000);
            }
        }
        });


        // DECLARA FUN√á√ÉO QUE CRIA POPUP
        function createPopup(nn) {

        let lista_ids = [];

        // EXTRAI ARRAY DE R√ìTULOS (labels)
        let labels = nn.map(function(nodeId) {
            let node = network.body.data.nodes.get(nodeId);
            lista_ids.push(node.id + '_' + node.label);
        });


        // ordena os labels conforme especifica√ß√£o
        lista_ids.sort(function(a, b) {
            let order = ["PF_", "PJ_", "PE_", "EN_", "TE_", "EM_"];
            let aIndex = order.findIndex(function(prefix) {
            return a.startsWith(prefix);
            });
            let bIndex = order.findIndex(function(prefix) {
            return b.startsWith(prefix);
            });
            return aIndex - bIndex;
        });

        let popupText = "";
        let prefix_atual = '';
            
        let lista_pf = [];
        let lista_pj = [];
        let lista_pe = [];
        let lista_en = [];
        let lista_te = [];
        let lista_em = [];
            
        for (let i=0; i<lista_ids.length; i++) {

            if (lista_ids[i].split('_')[0] == 'PF') {
                lista_pf.push(lista_ids[i].split('_')[2]);
            }

            if (lista_ids[i].split('_')[0] == 'PJ') {
                lista_pj.push(lista_ids[i].split('_')[2]);
            }

            if (lista_ids[i].split('_')[0] == 'PE') {
                lista_pe.push(lista_ids[i].split('_')[2]);
            }

            if (lista_ids[i].split('_')[0] == 'EN') {
                lista_en.push(lista_ids[i].split('_')[2]);
            }

            if (lista_ids[i].split('_')[0] == 'TE') {
                lista_te.push(lista_ids[i].split('_')[2]);
            }

            if (lista_ids[i].split('_')[0] == 'EM') {
                lista_em.push(lista_ids[i].split('_')[2]);
            }
        }

        lista_pf.sort();
        lista_pj.sort();
        lista_pe.sort();
        lista_en.sort();
        lista_te.sort();
        lista_em.sort();

        if (lista_pf.length > 0) {
            popupText += `<b>PF (${lista_pf.length})</b><br>${lista_pf.join("<br>")}<br><br>`;
        }

        if (lista_pj.length > 0) {
            popupText += `<b>PJ (${lista_pj.length})</b><br>${lista_pj.join("<br>")}<br><br>`;
        }

        if (lista_pe.length > 0) {
            popupText += `<b>PE (${lista_pe.length})</b><br>${lista_pe.join("<br>")}<br><br>`;
        }

        if (lista_en.length > 0) {
            popupText += `<b>EN (${lista_en.length})</b><br>${lista_en.join("<br>")}<br><br>`;
        }

        if (lista_te.length > 0) {
            popupText += `<b>TE (${lista_te.length})</b><br>${lista_te.join("<br>")}<br><br>`;
        }

        if (lista_em.length > 0) {
            popupText += `<b>EM (${lista_em.length})</b><br>${lista_em.join("<br>")}<br><br>`;
        }
            
        if (!popup || popup.closed) {
            popup = window.open('', target="_blank", windowFeature='left=50,top=50,width=700,height=400,scrollbars=1');

            var link = popup.document.createElement('link');
            link.rel = 'icon';
            link.href = 'favicon.ico';
            popup.document.head.appendChild(link);

            popup.document.write("<html><head><title>SINARC - N√≥s Selecionados</title><style>body{font-family: Arial, sans-serif; font-size: 14px; color: #333; line-height: 1.5; padding: 10px;} b{font-size: 16px; font-weight: bold;}<\/style><\/head><body><\/body><\/html>");
        }

        var popupBody = popup.document.body;
        popupBody.innerHTML = `<b>N√ìS SELECIONADOS (${lista_ids.length}):</b><br><br>` + popupText;
        }

        //network.on("click", function(params) {
        //if (popup) {
        //    popup.close();
        //}
        //});



        // ##############################################
        // AUMENTA A MASSA DOS N√ìS SELECIONADOS - TECLA ]
        // ##############################################

        // var par_n2 = 1

        // document.addEventListener('keydown', (event) => {

        //     if (event.key == ']' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length > 0) {

        //         if (network.physics.adaptiveTimestepEnabled == false) {
        //             network.setOptions({"nodes": {"physics": true}});
        //         }
                
        //         let nod = network.getSelectedNodes();

        //         for (let i=0; i<nod.length; i++) {

        //             let size = network.body.nodes[nod[i]].options.size

        //             // Aumenta a massa em 5 unidades
        //             nodes.update({
        //                 id: nod[i],
        //                 mass: par_n2 + 5
        //             });
        //         }

        //         // Atualiza vari√°vel
        //         par_n2 = par_n2 + 5

        //         network.redraw();
            
        //         // Exibe informa√ß√µes na tela
        //         tempAlert(`Tecla ${event.key} - Aumenta massa dos n√≥s selecionados em 5 unidades. Fator: ${par_n2} (${network.getSelectedNodes().length})`, 3000);
            
        //     } else if (event.key == ']' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 0) {
        //         tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para aumentar suas massas em 5 unidades`, 3000);
        //     }
        // })


        document.addEventListener('keydown', (event) => {

            if (event.key == ']' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length > 0) {

                if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}});
                }
                
                let nod = network.getSelectedNodes();
                let firstNodeMass = 0;

                for (let i=0; i<nod.length; i++) {
                    let currentMass = network.body.nodes[nod[i]].options.mass;
                    let newMass = currentMass + 5;

                    // Aumenta a massa em 5 unidades
                    nodes.update({
                        id: nod[i],
                        mass: newMass
                    });

                    if (i === 0) {
                        firstNodeMass = newMass;
                    }
                }

                network.redraw();
            
                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Aumenta massa dos n√≥s selecionados em 5 unidades (${network.getSelectedNodes().length})`, 3000);
            
            } else if (event.key == ']' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para aumentar suas massas em 5 unidades`, 3000);
            }
        })



        // ###############################################
        // DIMINUI A MASSA DOS N√ìS SELECIONADOS - TECLAS [
        // ###############################################

        // document.addEventListener('keydown', (event) => {

        //     if (event.key == '[' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length > 0) {

        //         if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}});
        //         }

        //         //if ((par_n2 - 5) <= 1) {
        //         //    par_n2 = 1;
        //         //}

        //         par_n2 = par_n2 - 5

        //         if (par_n2 <= 1) {
        //             par_n2 = 1
        //         }
                
        //         let nod = network.getSelectedNodes();

        //         for (let i=0; i<nod.length; i++) {

        //             let size = network.body.nodes[nod[i]].options.size

        //             // Diminui a massa em 5 unidades
        //            nodes.update({
        //                 id: nod[i],
        //                 //mass: par_n2 - 5
        //                 mass: par_n2
        //             });
        //         }

        //         // Atualiza a vari√°vel
        //         //par_n2 = par_n2 - 5

        //         //if (par_n2 <= 1) {
        //         //    par_n2 = 1
        //         //}

        //         // Exibe informa√ß√µes na tela
        //         tempAlert(`Tecla ${event.key} - Diminui massa dos n√≥s selecionados em 5 unidades. Fator: ${par_n2} (${network.getSelectedNodes().length})`, 3000);

        //         network.redraw();

        //     } else if (event.key == '[' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 0) {
        //         tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para diminuir suas massas em 5 unidades`, 3000);
        //     }

        // })


        document.addEventListener('keydown', (event) => {

            if (event.key == '[' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length > 0) {

                if (network.physics.adaptiveTimestepEnabled == false) {
                    network.setOptions({"nodes": {"physics": true}});
                }
                
                let nod = network.getSelectedNodes();
                let firstNodeMass = 0;

                for (let i=0; i<nod.length; i++) {
                    let currentMass = network.body.nodes[nod[i]].options.mass;
                    let newMass = currentMass - 5;

                    if (newMass < 1) {
                        newMass = 1;
                    }

                    // Diminui a massa em 5 unidades
                    nodes.update({
                        id: nod[i],
                        mass: newMass
                    });

                    if (i === 0) {
                        firstNodeMass = newMass;
                    }
                }

                // Exibe informa√ß√µes na tela
                tempAlert(`Tecla ${event.key} - Diminui massa dos n√≥s selecionados em 5 unidades (${network.getSelectedNodes().length})`, 3000);

                network.redraw();

            } else if (event.key == '[' && network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 0) {
                tempAlert(`Tecla ${event.key} - Selecione um ou mais n√≥s para diminuir suas massas em 5 unidades`, 3000);
            }

        })



        // ############################################
        // GERA C√ìPIA DO GRAFO COM ALTERA√á√ïES - TECLA !
        // ############################################

        document.addEventListener('keydown', (event) => {

            if (event.key == '!') {
                
                async function copyOperation(param) {
                    await navigator.clipboard.writeText(param)
                };

                setTimeout(() => {copyOperation('***atualizar_grafo***')}, 0)

                tempAlert(`Tecla ${event.key} - Gera novo arquivo HTML com configura√ß√£o atual do grafo`, 3000);
            }
        });




        // ###############################
        // EXIBE ATALHOS NA TELA - TECLA ?
        // ###############################

        var el_3 = '';
        var toggle_int = 0;

        document.addEventListener('keydown', (event) => {

            if(event.key == "?" && toggle_int == 0){

                let ajuste_tela = "ATALHOS:<br>Ajuste da tela: F11 b<br>";
                let posicao = "Posi√ß√£o dos n√≥s: F5 k K f p Clique+Arrasto Shift+(L/R) ] [ m M Espa√ßo n N Shift+(U/D)<br>";
                let selecao = "Sele√ß√£o dos n√≥s: Clique Ctrl+Clique a A √ß √á I j J q Q . ; /<br>";
                let visualizacao = "Visualiza√ß√£o de n√≥s e arestas: Esc Bot√£oDeRolagem c e l i t T V z<br>";
                let cor = "Cor dos n√≥s: x X w v<br>";
                let sites = "Sites externos: d D g G 1 2 4 5 6 7 8<br>";
                let delecao = "Dele√ß√£o de n√≥s: Del r R W<br>";
                let consulta = "Consulta √† base de dados: o O s y<br>";
                let outras = "Outras fun√ß√µes: h ? L u U + - , |";

                el_3 = document.createElement("div");
                
                el_3.setAttribute("style","position:absolute; top:30px; left:21px; border:5px solid rgba(178, 255, 178, 0); border-radius: 5px; background-color:rgba(178, 255, 178, 0); font-size: 18px; color: rgba(59, 190, 30, 1); font-family: serif; background-color: rgba(59, 190, 30, 0.05); border-radius: 5px");
                
                el_3.innerHTML = ajuste_tela + posicao + selecao + visualizacao + cor + sites + delecao + consulta + outras;
                
                document.body.appendChild(el_3);

                el_3.style.opacity = "1.0";

                toggle_int = 1

                tempAlert(`Tecla ${event.key} - Exibe teclas de atalhos`, 3000);

            } else if (event.key == "?" && toggle_int == 1) {

                el_3.style.display = "none";

                toggle_int = 0

                tempAlert(`Tecla ${event.key} - Oculta teclas de atalhos`, 3000);

            }
        });

        

    
        // ################################
        // DESSELECIONA TODOS OS N√ìS
        // ################################

        network.on('click', (event) => {

            let sel = network.getSelectedNodes();
            //let n = nodes.getIds().length;

            // Quando se clica no fundo, sel.length fica igual a 0 (truque)
            if (sel.length == 0) {
                network.unselectAll();
                
                //con_nodes_a = [];
                sel_anterior = [];
                
                // EXTRA√çDO DA TECLA A
                //temp_a = [];

                // VARI√ÅVEL DECLARADA NO SCRIPT DA TECLA q
                target_id = [];
                con = [];

                // Exibe informa√ß√µes na tela
                //if (sel_anterior.length > 0) {
                tempAlert(`Clique na √°rea do grafo - Desseleciona todos os n√≥s (${nodes.getIds().length} ${nodes.getIds().length === 1 ? "n√≥" : "n√≥s"} em ${n_cam} ${n_cam === 1 ? "camada" : "camadas"})`, 3000);
                //}
            }

            // Exibe informa√ß√µes na tela
            //if (sel.length > 0) {
            //    tempAlert(`Clique na √°rea do grafo - Desseleciona todos os n√≥s`, 3000);
            //}

            // Limpa vari√°vel global 'sel_anterior' do script da TECLA 'a', para n√£o continuar a sequ√™ncia de sele√ß√£o do ponto onde parou
            sel_anterior = [];

            // Limpa vair√°vels globais do script da TECLA ';', para n√£o reiniciar a sequ√™ncia de sele√ß√£o do ponto onde parou
            toggle_pv = 0;
            no_sel_pv = [];
            ar_adj = [];
            temp_to = [];
            temp_from = [];

        });



        // ############################################################
        // DESSELECIONA ARESTAS DE N√ìS DESSELECIONADOS COM CTRL + CLICK
        // ############################################################

        
        // AO SAIR DE CIMA DO N√ì E EVENTUALMENTE TER DESSELECIONADO O RESPECTIVO N√ì
        network.on('blurNode', function f(params) {

            // OBT√âM LISTA DE N√ìS SELECIONADOS (O QUE ACABOU DE SER DESSELECIONADO N√ÉO APARECE NESTA LISTA)
            let ns = network.getSelectedNodes();

            // DESSELECIONA TUDO
            //network.unselectAll();
            //network.redraw();

            // SELECIONA APENAS N√ìS MANTIDOS SELECIONADOS AP√ìS DESS
            //console.log(ns);
            network.selectNodes(ns);

        });
        


        /*
        // Vari√°veis para controle de debounce e batch
        let blurDebounceTimer = null;
        let pendingEdgeUpdates = [];

        // AO SAIR DE CIMA DO N√ì
        network.on('blurNode', function f(params) {
            
            // 1. CANCELA TIMER ANTERIOR (evita ac√∫mulo de updates)
            if (blurDebounceTimer) {
                clearTimeout(blurDebounceTimer);
            }
            
            // 2. COLETA DADOS NECESS√ÅRIOS (opera√ß√£o r√°pida, < 5ms)
            let ns = network.getSelectedNodes();
            let nodeId = params.node;
            
            // 3. OBT√âM ARESTAS CONECTADAS AO N√ì QUE FOI DESSELECIONADO
            // Usa Set para evitar duplicatas automaticamente
            let arestasConectadas = new Set(network.getConnectedEdges(nodeId));
            
            // 4. FILTRA APENAS ARESTAS QUE PRECISAM SER ATUALIZADAS
            // (Evita atualizar arestas que j√° est√£o com a cor correta)
            let arestasParaAtualizar = [];
            
            arestasConectadas.forEach(arestaId => {
                let aresta = edges.get(arestaId);
                if (aresta && aresta.color && aresta.color !== COR_ORIGINAL) {
                    arestasParaAtualizar.push({
                        id: arestaId,
                        color: COR_ORIGINAL  // Ou: { color: COR_ORIGINAL }
                    });
                }
            });
            
            // 5. ACUMULA UPDATES PENDENTES
            pendingEdgeUpdates = [...pendingEdgeUpdates, ...arestasParaAtualizar];
            
            // Remove duplicatas (mant√©m apenas o √∫ltimo update por aresta)
            let updateMap = new Map();
            pendingEdgeUpdates.forEach(update => {
                updateMap.set(update.id, update);
            });
            pendingEdgeUpdates = Array.from(updateMap.values());
            
            // 6. AGENDA PROCESSAMENTO EM BATCH (debounce)
            blurDebounceTimer = setTimeout(() => {
                
                if (pendingEdgeUpdates.length > 0) {
                    // üöÄ UPDATE EM BATCH - APENAS 1 OPERA√á√ÉO!
                    edges.update(pendingEdgeUpdates);
                    
                    // ‚ùå N√ÉO CHAME network.redraw()! 
                    // O Vis.js j√° faz redraw automaticamente ap√≥s edges.update()
                    
                    console.log(`‚úì Batch update: ${pendingEdgeUpdates.length} arestas`);
                    
                    pendingEdgeUpdates = [];
                }
                
                blurDebounceTimer = null;
                
            }, 50);  // 50ms √© suficiente para agrupar blurs r√°pidos sem parecer lento
        });
        */



        // ###############################################################################################
        // AUMENTA E DIMINUI TAMANHO REFERNCIAL DOS N√ìS - TECLAS SHIFT + 'ARROW UP' / SHIFT + 'ARROW DOWN'
        // ###############################################################################################

        var t_ref = 40

        document.addEventListener('keydown', (event) => {

            if ((event.shiftKey && event.key == 'ArrowUp') || event.key === '>') {

                if (t_ref < 100) {
                    t_ref = t_ref + 5
                }

//                if (screen_height == 0) {
//                    let element = document.getElementById("mynetwork");
//                    let canvas = element.querySelector('canvas');
//                    screen_height = parseInt(canvas.getAttribute('height'));
//                }
//                element = document.getElementById("mynetwork");
//                screen_height = screen_height + 10;
//                element.style.height = screen_height.toString() + 'px';
                //console.log(screen_height);

                //alert(`Tamanho referencial do no para ativacao da tecla n: ${t_ref}`)
                //console.log(t_ref)
                network.redraw();

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Teclas Shift + ${event.key} - Aumenta tamanho referencial dos n√≥s em 5 unidades (${t_ref})`, 3000);

            } else if ((event.shiftKey && event.key == 'ArrowDown') || event.key === '<'){
                
                if (t_ref > 20) {
                    t_ref = t_ref - 5
                }
                
//                if (screen_height == 0) {
//                    let element = document.getElementById("mynetwork");
//                    let canvas = element.querySelector('canvas');
//                    screen_height = parseInt(canvas.getAttribute('height'));
//                }
//                element = document.getElementById("mynetwork");
//                screen_height = screen_height - 10;
//                element.style.height = screen_height.toString() + 'px';
                //console.log(screen_height);

                //alert(`Tamanho referencial do no para ativacao da tecla n: ${t_ref}`)
                //console.log(t_ref)
                network.redraw();

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Teclas Shift + ${event.key} - Diminui tamanho referencial dos n√≥s em 5 unidades (${t_ref})`, 3000);

            }
        });



        // ###############################################
        // DESSELECIONA TODOS OS N√ìS - TECLAS 'ARROW DOWN'
        // ###############################################

        //document.addEventListener('keydown', (event) => {

        //    if (event.key == "ArrowDown") {
        //        network.unselectAll();
        //        network.redraw();

        //    }

        //})



        // ###########################################################################################
        // AUMENTA E DIMINUI A TAMANHO DA ARESTA - TECLAS SHIFT + 'ARROW LEFT' / SHIFT + 'ARROW RIGHT'
        // ###########################################################################################

        var tamanho_aresta = 300
        document.addEventListener('keydown', (event) => {

            if (event.shiftKey && event.key == 'ArrowRight'){
                tamanho_aresta += 30;
                network.setOptions({"edges": {"length": tamanho_aresta}});

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Teclas Shift + ${event.key} - Aumenta tamanho das arestas em 30 unidades (${tamanho_aresta})`, 3000);
                
            } else if (event.shiftKey && event.key == 'ArrowLeft') {
                tamanho_aresta -= 30;
                network.setOptions({"edges": {"length": tamanho_aresta}});

                // Exibe informa√ß√µes na tela (n√£o est√° exibindo)
                tempAlert(`Teclas Shift + ${event.key} - Diminui tamanho das arestas em 30 unidades (${tamanho_aresta})`, 3000);
            }
        });



        // ########################################################
        // MUDA COR DO TEXTO DO N√ì PARA VERMELHO QUANDO SELECIONADO
        // ########################################################

        network.on("select", function (params) {

            // Reseta vari√°vel de controle da massa
            // par_n2 = 1;

            let selectedNodeId2 = params.nodes;
            //console.log('selected:', selectedNodeId2);
            for (id in params.nodes) {
                let node = network.body.nodes[params.nodes[id]];
                //console.log('node:', node);
                node.setOptions({
                    font: {
                    color: "#ff0000"
                    }
                });
            }

            // Exibe informa√ß√µes na tela
            let temp = network.getSelectedNodes();

            let tamanho = ''
            let massa2 = ''
            let grupo = ''
            if (network.getSelectedNodes().length == 1) {
                let temp_t = Math.round(network.body.nodes[params.nodes[id]].options.size * 100) / 100
                //tamanho = `. Tamanho: ${network.body.nodes[params.nodes[id]].options.size}`
                tamanho = `. Tamanho: ${temp_t}`
                
                massa2 = `. Massa: ${Math.round(network.body.nodes[params.nodes[id]].options.mass * 100) / 100}`
                //Math.round(num * 100) / 100

                grupo = `. Grupo: ${network.body.nodes[params.nodes[id]].options.z_group}/${network.body.nodes[params.nodes[id]].options.z_group_total}`
            }
            
            tempAlert(`Clique sobre n√≥ - Seleciona n√≥ (${temp.length})${tamanho}${massa2}${grupo}`, 3000);

        });

        /*
        network.on("deselectNode", function (params) {
            let deselectedNodeId2 = params.previousSelection.nodes; // ACRESCENTEI ['id']
            if (deselectedNodeId2.length > 100) { // DESSELECIONA TUDO DE UMA S√ì VEZ A PARTIR DE 100 N√ìS SELECIONADOS
                network.unselectAll();
                return;
            }
            //console.log('deselected:', deselectedNodeId2);
            for (id in params.previousSelection.nodes) {
                let node = network.body.nodes[params.previousSelection.nodes[id]['id']];
                //console.log('node:', node);
                
                // INCLU√çDO POR DAR ERRO 'id' UNDEFINED
                if (node != undefined) { 
                    nodes.update({id: node['id'], // deselectedNodeId
                            font: {
                                color: '#777777'
                            },
                    });
                } 
                // INCLUIDO POR DAR ERRO 'id' UNDEFINED
            }
        });
        */




        network.on("deselectNode", function (params) {
            let deselectedNodes = params.previousSelection.nodes;
            
            // Coleta todas as atualiza√ß√µes em um array
            let updates = [];
            for (let id in deselectedNodes) {
                let nodeId = deselectedNodes[id]['id'];
                if (nodeId != undefined) {
                    updates.push({ id: nodeId, font: { color: '#777777' }});
                }
            }
            
            // Uma √∫nica chamada em lote (funciona para 1, 100 ou 1000 n√≥s)
            if (updates.length > 0) {
                nodes.update(updates);
            }
        });



        // ############################################################
        // APROXIMA N√ì SELECIONADO QUANDO CLICA SOBRE ELE - DUPLO CLICK
        // ############################################################

//        function esconde() {
//            network.setOptions({nodes: {scaling: {label: {enabled: true, drawThreshold: 100}}}, edges: {hidden: true}});
//        }
//        function exibe() {
//            network.setOptions({nodes: {scaling: {label: {enabled: true, drawThreshold: 8}}}, edges: {hidden: false}});
//        }

//        network.on('doubleClick', function() {

            // S√ì FUNCIONA NO LAYOUT BARNES-HUT E COM APENAS UM N√ì SELECIONADO
//            if (network.physics.options.solver == 'barnesHut' && network.getSelectedNodes().length == 1) {

//                // Evita compartamento err√°tico no modo transpar√™ncia (arestas s√£o exibidas)
//                if (toggle_t == false) {
//                    return;
//                }            

//                let ss = network.getSelectedNodes();
//                if (ss.length == 1 ) {
//                    network.setOptions({physics: {enabled: false}});
//                    let p = '';
//                    let num = 0;
//                    num = 700 + nodes.length / 10;
//                    //console.log(num + 'ms');
//                    for (let i=0; i<ss.length; i++) {
//                        esconde();
//                        p = network.getPosition(ss[i]);
//                        network.moveTo({
//                            position: {x: p['x'], y: p['y']},
//                            scale: 1,
//                            offset: {x:0, y:0},
//                            animation: {
//                            duration: 500,
//                            easingFunction: 'linear'
//                            }
//                        });
//                        setTimeout(exibe, num);
//                        network.releaseNode();
//                    }
//                    network.setOptions({physics: {enabled: true}});

                // ###################################

//                let ss = network.getSelectedNodes();
                //if (ss.length == 1 ) {

                // DESABILITA ELEMENTOS PARA EVITAR TRAVAMENTO DA IMAGEM (MELHROA DESEMPENHO)
//                network.physics.physicsEnabled = false;
//                network.physics.stopSimulation();
                //network.setOptions({"edges": {"hidden": true}});
                //network.setOptions({nodes: {scaling: {label: {enabled: true, drawThreshold: 100}}}});
                
                // F√ìRMULA QUE CALCULA O TEMPO DE TRANSI√á√ÉO. USADO TAMB√âM NA FUN√á√ÉO setTimeout
//                let time = 1000;
//                if (1000 + nodes.getIds().length - 500 < 1000) {
//                    time = 1000;
//                } else {
//                    time = 1000 + nodes.getIds().length - 1000;
//                }

                // PARTE PRINCIPAL
//                for (let i=0; i<ss.length; i++) {
//                    p = network.getPosition(ss[i]);
//                    network.moveTo({
//                        position: {x: p['x'], y: p['y']},
//                        scale: 1,
//                        offset: {x:0, y:0}
                        //animation: {
                        //duration: time,
                        //easingFunction: 'linear'
                        //}
//                    });
//                }
                //network.fit({nodes: con_nodes, maxZoomLevel: 1, animation: {duraton: time}});

                // FUN√á√ÉO EXECUTADA AP√ìS A PARTE PRINCIPAL
//                function f2() {

                    // REABILITA RECURSOS AP√ìS PARTE PRINCIPAL
                    //network.setOptions({physics: {enabled: true}});
//                    network.setOptions({"edges": {"hidden": false}});
//                    network.setOptions({nodes: {scaling: {label: {enabled: true, drawThreshold: 8}}}});
//                }
                
                //setTimeout(f2, time + 100);

                //setTimeout(network.physics.stopSimulation, time + 200);





//                }
//            }
//        });



        // ##################################
        // ALTERA FLATICON E T√çTULO DA P√ÅGINA
        // ##################################
        var link = document.querySelector("link[rel~='icon']");
        if (!link) {
            link = document.createElement('link');
            link.rel = 'icon';
            document.getElementsByTagName('head')[0].appendChild(link);
        }
        //link.href = 'https://cdn-icons-png.flaticon.com/512/4803/4803070.png';
        
        // Colocar logo na pasta do arquivo sinarc.py
        link.href = 'logo.png';
        

        // EXTRAI N√öMERO DE CAMADAS SOLICITADAS
        var no_pj = nodes.getIds();
        var n_cam = '';
        for (let i=0; i < no_pj.length; i++) {
            if (no_pj[i].slice(0, 3) == 'PJ_') {
                n_cam = network.body.nodes[no_pj[i]].options.camadas_solicitadas;
                //console.log(n_cam);
                break;
            };
        };



        // EXTRAI N√öMERO DE N√ìS E FORMATA PARA STRING
        // https://stackoverflow.com/questions/9461621/format-a-number-as-2-5k-if-a-thousand-or-more-otherwise-900
        function nFormatter(num, digits) {
            const lookup = [
                { value: 1, symbol: "" },
                { value: 1e3, symbol: "k" },
                { value: 1e6, symbol: "M" },
                { value: 1e9, symbol: "G" },
                { value: 1e12, symbol: "T" },
                { value: 1e15, symbol: "P" },
                { value: 1e18, symbol: "E" }
            ];
            const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
            var item = lookup.slice().reverse().find(function(item) {
                return num >= item.value;
            });
            return item ? (num / item.value).toFixed(digits).replace(rx, "$1") + item.symbol : "0";
        }

        let temp = ''
        temp = nFormatter(nodes.getIds().length, 1);

        //let datt = new Date();
        //let hora = datt.getHours();
        //let minuto = datt.getMinutes();
        //document.title = n_cam + '/' + temp + ' SINARC ' + hora + ':' + minuto;

        document.title = n_cam + '/' + temp + ' SINARC';



        // ##############################################
        // AJUSTA ALTURA DA √ÅREA DO GRAFO AUTOMATICAMENTE
        // ##############################################

        // Existe outra forma de ajustar a altura √°rea do grafo: TECLA b

        /*
        function ajusta_altura() {

            // EXTRAI DIMENS√ïES DA JANELA DO NAVEGADOR
            var w = window.innerWidth;
            let h = window.innerHeight;

            // AJUSTA ALTURA DA √ÅREA DO GRAFO √Ä ALTURA DA JANELA
            document.querySelector('#mynetwork').style.height = h - 20;

        };

        setTimeout(() => {ajusta_altura()}, 0);
        */


        function ajusta_altura() {

            // DIMENS√ïES DA VIEWPORT
            let h = window.innerHeight;

            // AJUSTA O CONTAINER
            const container = document.querySelector('#mynetwork');
            container.style.height = (h - 20) + 'px';

            // AVISA O VIS.JS
            if (typeof network !== 'undefined') {
                network.redraw();
                network.fit({
                    animation: {
                        duration: 300,
                        easingFunction: "easeInOutQuad"
                    }
                });
            }
        }

        window.addEventListener('resize', () => {
            setTimeout(ajusta_altura, 200);
        });

        window.addEventListener('orientationchange', () => {
            setTimeout(ajusta_altura, 200);
        });

        setTimeout(() => { ajusta_altura(); }, 0);










        // ##########################
        // CENTRALIZA GRAFO NO IN√çCIO
        // ##########################

        //setTimeout(() => {
        //            document.dispatchEvent(new KeyboardEvent('keydown', {key: 'Escape'}));
        //        }, 1000);



    
</script>
    




<!-- PARA TESTE NO CELULAR - IN√çCIO -->

    <!-- Bot√£o fixado no rodap√© -->
    <div id="keyboard-toggle"></div>

    <!-- Campo de entrada invis√≠vel, mas funcional -->
    <input 
    type="text" 
    id="hidden-input" 
    style="
        position: fixed; 
        bottom: 60px; 
        left: 50%; 
        transform: translateX(-50%);
        opacity: 0; <!-- Estava em 0.01 -->
        height: 0; <!-- Estava em 20 -->
        width: 0;  <!-- Estava em 120 -->
        border: none; 
        background: transparent;
        z-index: -1; <!-- Estava em 9999 -->
        pointer-events: none;
    "
    autocomplete="off"
    autocorrect="off"
    autocapitalize="off"
    spellcheck="false"
    tabindex="-1"
    />

    <style>
    #keyboard-toggle {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 15px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(89, 201, 67, 0.6);
        border-radius: 4px;
        cursor: pointer;
        z-index: 9998;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        user-select: none;
    }

    #keyboard-toggle:hover {
        background: rgba(89, 201, 67, 0.15);
        border-color: rgba(89, 201, 67, 0.9);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    #keyboard-toggle:active {
        background: rgba(89, 201, 67, 0.3);
    }
    </style>





    <script>
    const toggle = document.getElementById('keyboard-toggle');
    const hiddenInput = document.getElementById('hidden-input');

    toggle.addEventListener('click', () => {
        hiddenInput.focus();
    });
    </script>




    <!-- PARA TESTE NO CELULAR - FIM -->











    <!-- ===================================================== -->
    <!-- AUMENTA TAMANHO DOS N√ìS COM HOVER                     -->
    <!-- ===================================================== -->
    
    <script>
        const tamanhosOriginais = {};
        const tamanhosFonteOriginais = {};
        const coresFonteOriginais = {};

        function animarTamanho(nodeId, inicio, fim, duracao = 200) {
            const node = network.body.nodes[nodeId];
            if (!node) return;

            if (node._animacaoId) {
                cancelAnimationFrame(node._animacaoId);
            }

            const inicioTempo = performance.now();
            const diferenca = fim - inicio;

            function frame(tempo) {
                const progresso = Math.min((tempo - inicioTempo) / duracao, 1);
                node.options.size = inicio + (diferenca * progresso);
                network.redraw();
                if (progresso < 1) {
                    node._animacaoId = requestAnimationFrame(frame);
                }
            }
            requestAnimationFrame(frame);
        }

        network.on("hoverNode", e => {
            if (network.physics.physicsEnabled === false) {
                const nodeId = e.node;
                const node = network.body.nodes[nodeId];
                if (!node || tecla_e_ativada) return;

                if (!tamanhosOriginais[nodeId]) {
                    tamanhosOriginais[nodeId] = node.options.size;
                }
                if (!tamanhosFonteOriginais[nodeId]) {
                    tamanhosFonteOriginais[nodeId] = (node.options.font && node.options.font.size) || (node.labelModule && node.labelModule.fontOptions.size) || 14;
                }
                if (!coresFonteOriginais[nodeId]) {
                    coresFonteOriginais[nodeId] = (node.options.font && node.options.font.color) || (node.labelModule && node.labelModule.fontOptions.color) || '#343434';
                }

                const tamanhoAlvo = tamanhosOriginais[nodeId] * 2;
                const fonteAlvo = tamanhosFonteOriginais[nodeId] * 2;

                const newOptions = {
                    font: {
                        size: fonteAlvo,
                        color: 'red'
                    }
                };
                node.setOptions(newOptions);
                animarTamanho(nodeId, node.options.size, tamanhoAlvo);
            }
        });

        network.on("blurNode", e => {
            if (network.physics.physicsEnabled === false) {
                const nodeId = e.node;
                const node = network.body.nodes[nodeId];
                if (!node || !tamanhosOriginais[nodeId] || tecla_e_ativada) return;

                const fonteOriginal = tamanhosFonteOriginais[nodeId];
                const corOriginal = coresFonteOriginais[nodeId];

                const newOptions = {
                    font: {
                        size: fonteOriginal,
                        color: corOriginal
                    }
                };
                node.setOptions(newOptions);
                animarTamanho(nodeId, node.options.size, tamanhosOriginais[nodeId]);
            }
        });

        // Restaura os n√≥s para o estado original se a f√≠sica for reativada
        // network.on("startStabilizing", () => {
        //     Object.keys(network.body.nodes).forEach(nodeId => {
        //         const node = network.body.nodes[nodeId];
        //         if (node._animacaoId) cancelAnimationFrame(node._animacaoId);
                
        //         if (tamanhosOriginais[nodeId]) {
        //             const newOptions = {
        //                 size: tamanhosOriginais[nodeId],
        //                 font: {
        //                     size: tamanhosFonteOriginais[nodeId],
        //                     color: coresFonteOriginais[nodeId]
        //                 }
        //             };
        //             node.setOptions(newOptions);
        //         }
        //     });
        //     network.redraw();
        // });
    </script>




    


    <!-- ===================================================== -->
    <!-- MARCA D'√ÅGUA SINARC                                   -->
    <!-- ===================================================== -->
    <div id="sinarc-watermark">SINARC</div>

    <style>
    #sinarc-watermark {
        position: fixed;
        top: 40px;
        left: 65px;
        font-size: 15px;
        // font-weight: bold;
        font-family: Arial, sans-serif;
        color: rgba(204, 204, 204, 0.5); /* Cinza claro com 50% de opacidade */
        z-index: 9990; /* Abaixo do menu, mas acima do grafo */
        pointer-events: none; /* Permite clicar atrav√©s da marca d'√°gua */
        user-select: none; /* Impede que o texto seja selecionado */
    }
    </style>
    <!-- ===================================================== -->


    <!-- ===================================================== -->
    <!-- MENU SUSPENSO SINARC - COMANDOS DE TECLADO            -->
    <!-- Vers√£o 2.0 com hover autom√°tico e simula√ß√£o de teclas -->
    <!-- ===================================================== -->
    <!-- Este c√≥digo deve ser inserido no arquivo sinarc.py    -->
    <!-- LOCALIZA√á√ÉO: Ap√≥s a linha 8733 (antes de 






    <script>
    // ========================================
    // FUN√á√ÉO DE OTIMIZA√á√ÉO AUTOM√ÅTICA DO GRAFO
    // ========================================

    function otimizarGrafoAutomaticamente() {
        //console.log("üéØ OTIMIZA√á√ÉO AUTOM√ÅTICA - INICIANDO...");


        // ========================================
        // FOR√áAR OPERA√á√ÉO COMO GRAFO DE 2 CAMADAS
        // ========================================
        
        

        // 0. RESETAR MASSA DOS N√ìS ALTERADOS
        for (let i=0; i<n_bag.length; i++) {
            nodes.update({id: n_bag[i], mass: 1});
            // console.log('Reset mass for node id:', n_bag[i]);
        }
        // Limpa o array de n√≥s j√° processados
        n_bag = [];
        
        // Reseta a refer√™ncia de tamanho e o controle de primeira execu√ß√£o
        t_ref = 40;
        pula_100 = true;

        console.log("‚úì Sistema de ajuste de massa resetado (todas as massas = 1)");



        // ========================================
        // ARMAZENA TAMANHOS ORIGINAIS (PRIMEIRA VEZ)
        // ========================================
        let nosIds = nodes.getIds();
        for (let i = 0; i < nosIds.length; i++) {
            let nodeId = nosIds[i];
            // S√≥ armazena se ainda n√£o existe (primeira vez)
            if (!tamanhosOriginais[nodeId]) {
                tamanhosOriginais[nodeId] = network.body.nodes[nodeId].options.size;
            }
        }

    
        // ========================================
        // VERIFICA SE √â GRAFO DE 1 CAMADA
        // ========================================
        if (typeof n_cam !== 'undefined' && n_cam === 1) {
            console.log("‚úì Grafo de 1 camada detectado - Pressionando K...");
            
            const evtK = new KeyboardEvent('keydown', {
                key: 'k', code: 'KeyK', keyCode: 75, which: 75,
                bubbles: true, cancelable: true, view: window
            });
            document.dispatchEvent(evtK);
            
            tempAlert('Grafo de 1 camada: aplicando layout hier√°rquico...', 2000);

            return;
        } else if (typeof n_cam === 'undefined' || n_cam > 1) {
            n_cam = 2;
        }

        
        // 1. CALCULAR DISTRIBUI√á√ÉO PRIMEIRO (antes de deletar n√≥s)
        let todosNos = nodes.getIds();
        let distribuicao = {100:[], 95:[], 90:[], 85:[], 80:[], 75:[], 70:[], 65:[], 60:[], 55:[], 50:[], 45:[], 40:[], 35:[], 30:[], 25:[], 20:[]};
        
        for (let i = 0; i < todosNos.length; i++) {
            let nodeId = todosNos[i];
            let nodeIdStr = String(nodeId);
            
            // Ignora n√≥s TE/EN/EM no c√°lculo (ser√£o deletados)
            if (nodeIdStr.slice(0, 3) === "TE_" || nodeIdStr.slice(0, 3) === "EN_" || nodeIdStr.slice(0, 3) === "EM_") {
                continue;
            }
            
            // Usa tamanho original se existir, sen√£o usa o atual
            let tamanho = tamanhosOriginais[nodeId] || network.body.nodes[nodeId].options.size;
            
            if (tamanho >= 99.99) distribuicao[100].push(nodeId);
            else if (tamanho >= 95) distribuicao[95].push(nodeId);
            else if (tamanho >= 90) distribuicao[90].push(nodeId);
            else if (tamanho >= 85) distribuicao[85].push(nodeId);
            else if (tamanho >= 80) distribuicao[80].push(nodeId);
            else if (tamanho >= 75) distribuicao[75].push(nodeId);
            else if (tamanho >= 70) distribuicao[70].push(nodeId);
            else if (tamanho >= 65) distribuicao[65].push(nodeId);
            else if (tamanho >= 60) distribuicao[60].push(nodeId);
            else if (tamanho >= 55) distribuicao[55].push(nodeId);
            else if (tamanho >= 50) distribuicao[50].push(nodeId);
            else if (tamanho >= 45) distribuicao[45].push(nodeId);
            else if (tamanho >= 40) distribuicao[40].push(nodeId);
            else if (tamanho >= 35) distribuicao[35].push(nodeId);
            else if (tamanho >= 30) distribuicao[30].push(nodeId);
            else if (tamanho >= 25) distribuicao[25].push(nodeId);
            else if (tamanho >= 20) distribuicao[20].push(nodeId);
        }
        
        console.log("DISTRIBUI√á√ÉO:", distribuicao);


        // 2. DELETAR N√ìS TE, EN, EM (depois do c√°lculo)
        let nodosParaDeletar = [];
        
        for (let i = 0; i < todosNos.length; i++) {
            let nodeIdStr = String(todosNos[i]);

            if (nodeIdStr.slice(0, 3) === "TE_" || nodeIdStr.slice(0, 3) === "EN_" || nodeIdStr.slice(0, 3) === "EM_") {
                nodosParaDeletar.push(todosNos[i]);
            }
        }
        
        
        if (nodosParaDeletar.length > 0) {
            nodes.remove(nodosParaDeletar);
            console.log(`‚úì ${nodosParaDeletar.length} n√≥s deletados (TE/EN/EM)`);

            tempAlert(`Otimiza√ß√£o: ${nodosParaDeletar.length} n√≥s deletados`, 2000);
        }

        
        // 3. CALCULAR N√öMERO IDEAL DE PRESSIONAMENTOS
        // Conta apenas os n√≥s que realmente entraram na distribui√ß√£o (exclui TE/EN/EM)
        let totalNos = 0;
        for (let faixa in distribuicao) {
            totalNos += distribuicao[faixa].length;
        }
        let nosAcumulados = 0;
        let pressionamentosIdeal = 0;



        
        let faixas = [100, 95, 90, 85, 80, 75, 70, 65, 60, 55, 50, 45, 40, 35, 30, 25, 20];
        
        // =========================================================================
        // CONFIGURA√á√ïES - AJUST√ÅVEIS
        // =========================================================================
        // ESTRAT√âGIA: 3 crit√©rios independentes para detectar saltos
        // M√≠nimo relativo adapta-se ao tamanho do grafo
        // =========================================================================
        
        const LIMIAR_SALTO_PERCENTUAL = 0.15;      // 10% do total (salto absoluto)
        const LIMIAR_SALTO_RELATIVO = 2.0;         // 3.5x a m√©dia (salto moderado)
        const LIMIAR_MINIMO_RELATIVO = 0.05;       // 5% do total (m√≠nimo para salto moderado)
        const LIMIAR_SALTO_GIGANTE = 9.0;          // 9x a m√©dia (salto gigante)
        const MINIMO = 2;                          // M√≠nimo 2 pressionamentos
        const MAXIMO = 16;                         // M√°ximo 16 pressionamentos
        
        // Calcula m√≠nimo absoluto baseado no tamanho do grafo (m√≠nimo: 10 n√≥s)
        let minimoAbsoluto = Math.max(3, Math.floor(totalNos * LIMIAR_MINIMO_RELATIVO));
        console.log(`\nM√≠nimo absoluto calculado: ${minimoAbsoluto} n√≥s (${LIMIAR_MINIMO_RELATIVO*100}% de ${totalNos})`);
        
        // Calcula m√©dia m√≥vel das √∫ltimas faixas processadas (janela de 3)
        let historicoFaixas = [];
        
        console.log("\n=== AN√ÅLISE FAIXA POR FAIXA ===");
        
        for (let i = 0; i < faixas.length - 1; i++) {
            let faixaAtual = faixas[i];
            let faixaProxima = faixas[i + 1];
            let nosNaFaixaAtual = distribuicao[faixaAtual].length;
            let nosNaProximaFaixa = distribuicao[faixaProxima].length;
            
            // Adiciona faixa atual ao acumulado
            nosAcumulados += nosNaFaixaAtual;
            pressionamentosIdeal++;
            
            let porcentagemFaixaAtual = nosNaFaixaAtual / totalNos;
            let porcentagemProximaFaixa = nosNaProximaFaixa / totalNos;
            
            // Atualiza hist√≥rico (mant√©m √∫ltimas 3 faixas n√£o-vazias)
            if (nosNaFaixaAtual > 0) {
                historicoFaixas.push(nosNaFaixaAtual);
                if (historicoFaixas.length > 3) {
                    historicoFaixas.shift();
                }
            }
            
            // Calcula m√©dia das faixas recentes
            let mediaRecente = historicoFaixas.length > 0 
                ? historicoFaixas.reduce((a, b) => a + b, 0) / historicoFaixas.length 
                : nosNaFaixaAtual;
            
            console.log(`Faixa ${faixaAtual}: ${nosNaFaixaAtual} n√≥s (${(porcentagemFaixaAtual*100).toFixed(1)}%)`);
            console.log(`  ‚Üí Pr√≥xima faixa ${faixaProxima}: ${nosNaProximaFaixa} n√≥s (${(porcentagemProximaFaixa*100).toFixed(1)}%)`);
            console.log(`  ‚Üí M√©dia recente: ${mediaRecente.toFixed(1)} n√≥s`);
            
            // =====================================================================
            // CRIT√âRIOS DE DETEC√á√ÉO DE SALTO (3 crit√©rios independentes)
            // =====================================================================
            
            if (pressionamentosIdeal >= MINIMO) {
                
                // CRIT√âRIO 1: SALTO ABSOLUTO (% do total)
                // Para se pr√≥xima faixa tem muitos n√≥s em rela√ß√£o ao total
                if (porcentagemProximaFaixa >= LIMIAR_SALTO_PERCENTUAL) {
                    console.log(`‚úì CRIT√âRIO 1 - SALTO ABSOLUTO detectado!`);
                    console.log(`  Pr√≥xima faixa ${faixaProxima} tem ${(porcentagemProximaFaixa*100).toFixed(1)}% dos n√≥s (limiar: ${(LIMIAR_SALTO_PERCENTUAL*100).toFixed(0)}%)`);
                    console.log(`  ‚Üí PARA AQUI para evitar espalhar grafo`);
                    break;
                }
                
                // CRIT√âRIO 2: SALTO GIGANTE (independente do valor absoluto)
                // Para se pr√≥xima faixa tem MUITAS vezes mais n√≥s que a m√©dia
                if (mediaRecente > 0 && nosNaProximaFaixa > mediaRecente * LIMIAR_SALTO_GIGANTE) {
                    console.log(`‚úì CRIT√âRIO 2 - SALTO GIGANTE detectado!`);
                    console.log(`  Pr√≥xima faixa ${faixaProxima} tem ${nosNaProximaFaixa} n√≥s`);
                    console.log(`  M√©dia recente: ${mediaRecente.toFixed(1)} n√≥s`);
                    console.log(`  Propor√ß√£o: ${(nosNaProximaFaixa / mediaRecente).toFixed(1)}x (limiar: ${LIMIAR_SALTO_GIGANTE}x)`);
                    console.log(`  ‚Üí PARA AQUI para evitar espalhar grafo`);
                    break;
                }
                
                // CRIT√âRIO 3: SALTO MODERADO + MUITOS N√ìS (relativo ao total)
                // Para se pr√≥xima faixa √© maior que a m√©dia E tem muitos n√≥s proporcionalmente
                if (mediaRecente > 0 && 
                    nosNaProximaFaixa > mediaRecente * LIMIAR_SALTO_RELATIVO &&
                    nosNaProximaFaixa >= minimoAbsoluto) {
                    console.log(`‚úì CRIT√âRIO 3 - SALTO MODERADO + MUITOS N√ìS detectado!`);
                    console.log(`  Pr√≥xima faixa ${faixaProxima} tem ${nosNaProximaFaixa} n√≥s`);
                    console.log(`  M√©dia recente: ${mediaRecente.toFixed(1)} n√≥s`);
                    console.log(`  Propor√ß√£o: ${(nosNaProximaFaixa / mediaRecente).toFixed(1)}x (limiar: ${LIMIAR_SALTO_RELATIVO}x)`);
                    console.log(`  E tem ‚â•${minimoAbsoluto} n√≥s (${LIMIAR_MINIMO_RELATIVO*100}% do total)`);
                    console.log(`  ‚Üí PARA AQUI para evitar espalhar grafo`);
                    break;
                }
            }
            
            // Limite m√°ximo de seguran√ßa
            if (pressionamentosIdeal >= MAXIMO) {
                console.log(`‚úì Limite m√°ximo de seguran√ßa atingido (${MAXIMO})`);
                break;
            }
        }
        
        // Garante m√≠nimo de seguran√ßa
        if (pressionamentosIdeal < MINIMO) {
            pressionamentosIdeal = MINIMO;
            console.log(`‚úì Aplicando m√≠nimo de seguran√ßa: ${MINIMO} pressionamentos`);
        }

        console.log(`\n>>> RESULTADO: ${pressionamentosIdeal} pressionamentos`);
        console.log(`>>> Cobertura: ${(nosAcumulados/totalNos*100).toFixed(1)}%`);
        
        // 4. PRESSIONAR TECLA ESPA√áO
        tempAlert(`Otimiza√ß√£o: Aplicando ${pressionamentosIdeal} ajustes...`, 2000);
        
        function simularEspaco() {
            const evt = new KeyboardEvent('keydown', {
                key: ' ', code: 'Space', keyCode: 32, which: 32,
                bubbles: true, cancelable: true, view: window
            });
            document.dispatchEvent(evt);
        }
        
        let contador = 0;
        const intervalo = setInterval(() => {
            simularEspaco();
            contador++;
            console.log(`  Pressionamento ${contador}/${pressionamentosIdeal}`);
            
            if (contador >= pressionamentosIdeal) {
                clearInterval(intervalo);
                
                // 5. CENTRALIZAR (ESC)
                setTimeout(() => {
                    const evtEsc = new KeyboardEvent('keydown', {
                        key: 'Escape', code: 'Escape', keyCode: 27, which: 27,
                        bubbles: true, cancelable: true, view: window
                    });
                    document.dispatchEvent(evtEsc);

                    // ‚úÖ DESSELECIONA TODOS OS N√ìS AP√ìS CADA PRESSIONAMENTO
                    network.unselectAll();
                    
                    console.log("‚úì OTIMIZA√á√ÉO CONCLU√çDA!");
                    tempAlert(`‚úì Grafo otimizado! (${pressionamentosIdeal} ajustes aplicados)`, 3000);
                }, 1000);
            }
        }, 200);
    }

    // Torna fun√ß√£o global
    window.otimizarGrafoAutomaticamente = otimizarGrafoAutomaticamente;

    </script>


    


    <script>
    // Event listener para o bot√£o de otimiza√ß√£o
    document.getElementById('sinarc-otimizar-button').addEventListener('click', function() {
        // Feedback visual
        this.style.background = 'rgba(89, 201, 67, 0.4)';
        setTimeout(() => {
            this.style.background = '';
        }, 300);
        
        // Chama a fun√ß√£o de otimiza√ß√£o
        if (typeof otimizarGrafoAutomaticamente === 'function') {
            otimizarGrafoAutomaticamente();
        } else {
            console.error('Fun√ß√£o otimizarGrafoAutomaticamente n√£o encontrada!');
            alert('Erro: Fun√ß√£o de otimiza√ß√£o n√£o est√° dispon√≠vel.');
        }
    });
    </script>





    <script>
    // ========================================
    // DUPLO CLIQUE NO FUNDO = ESC
    // ========================================

    function ativarDuploCliqueESC() {
        let container = document.getElementById('mynetwork') || 
                        document.querySelector('#network') || 
                        document.querySelector('[id*="network"]');
        
        if (!container) {
            console.error('‚ùå Container do grafo n√£o encontrado!');
            return;
        }
        
        if (typeof network === 'undefined') {
            console.error('‚ùå Objeto network n√£o encontrado!');
            return;
        }
        
        // Listener para duplo clique
        network.on('doubleClick', function(params) {
            // Verificar se clicou no fundo (n√£o em n√≥ ou aresta)
            if (params.nodes.length === 0 && params.edges.length === 0) {
                //console.log('‚ö° Duplo clique no fundo - simulando ESC');
                
                // Simular pressionamento da tecla ESC
                const eventESC = new KeyboardEvent('keydown', {
                    key: 'Escape',
                    code: 'Escape',
                    keyCode: 27,
                    which: 27,
                    bubbles: true,
                    cancelable: true
                });
                
                document.dispatchEvent(eventESC);
                
                // Tamb√©m disparar keyup para completar o ciclo
                const eventESCUp = new KeyboardEvent('keyup', {
                    key: 'Escape',
                    code: 'Escape',
                    keyCode: 27,
                    which: 27,
                    bubbles: true,
                    cancelable: true
                });
                
                document.dispatchEvent(eventESCUp);
            }
        });
        
        //console.log('‚úÖ Duplo clique no fundo = ESC ativado');
    }

    // Ativar quando o network estiver pronto
    if (typeof network !== 'undefined') {
        ativarDuploCliqueESC();
    } else {
        // Tentar ap√≥s um pequeno delay se network ainda n√£o existe
        setTimeout(function() {
            if (typeof network !== 'undefined') {
                ativarDuploCliqueESC();
            }
        }, 1000);
    }
    </script>






    











<script>

// ======================================
// FUN√á√ïES PARA MAPA GEOGR√ÅFICO DO SINARC
// ======================================

// ==============
// DADOS DE TESTE
// ==============
const empresasTeste = [
    {
        razao_social: "EMPRESA TESTE LTDA",
        endereco_completo: "Av. Paulista, 1000 - Bela Vista, S√£o Paulo - SP, 01310-100",
        cidade: "S√£o Paulo",
        uf: "SP"
    },
    {
        razao_social: "CONSULTORIA ABC S/A",
        endereco_completo: "Rua da Candel√°ria, 65 - Centro, Rio de Janeiro - RJ, 20091-020",
        cidade: "Rio de Janeiro",
        uf: "RJ"
    },
    {
        razao_social: "TECH SOLUTIONS ME",
        endereco_completo: "Rua Sete de Setembro, 500 - Centro, Fortaleza - CE, 60060-000",
        cidade: "Fortaleza",
        uf: "CE"
    },
    {
        razao_social: "COM√âRCIO XYZ EIRELI",
        endereco_completo: "Av. Expedito Garcia, 83 - Campo Grande, Cariacica - ES, 29146-201",
        cidade: "Cariacica",
        uf: "ES"
    },
    {
        razao_social: "IND√öSTRIA BETA LTDA",
        endereco_completo: "Sunset Boulevard, 1000 - Hollywood, Los Angeles - CA, USA",
        cidade: "Los Angeles",
        uf: "CA"
    }
];

// ===============================
// FUN√á√ÉO PARA EXTRAIR DADOS DO GRAFO E GERAR MAPA (VERS√ÉO CORRIGIDA)
// ===============================
function extrairDadosGrafoParaMapa() {
    
    // Array para armazenar os dados das empresas
    const empresas = [];
    
    // Acessa os n√≥s do grafo via vis.js
    // ===============================
    // USAR APENAS N√ìS SELECIONADOS
    // ===============================
    const idsSelecionados = network.getSelectedNodes();

    if (!idsSelecionados || idsSelecionados.length === 0) {
        // Exibe informa√ß√µes na tela
        tempAlert(`Exibe endere√ßos no mapa - Nenhum n√≥ selecionado no grafo.`, 3000);
        //alert('Nenhum n√≥ selecionado no grafo.');
        return [];
    }

    // Recupera apenas os n√≥s selecionados
    const nosDoGrafo = idsSelecionados
    .map(id => nodes.get(id))
    .filter(no => no); // seguran√ßa

    
    console.log(`Total de n√≥s no grafo: ${nosDoGrafo.length}`);
    
    /*
    // Filtra apenas n√≥s do tipo PJ_ (pessoas jur√≠dicas)
    const empresasPJ = nosDoGrafo.filter(no => no.id && no.id.startsWith('PJ_'));
    
    console.log(`Total de empresas (PJ) no grafo: ${empresasPJ.length}`);
    */
    
    // Filtra n√≥s do tipo PJ_ (pessoas jur√≠dicas) e PE_ (pessoas estrangeiras)
    const empresasPJ = nosDoGrafo.filter(no => no.id && (no.id.startsWith('PJ_') || no.id.startsWith('PE_')));
    
    //console.log(`Total de empresas (PJ/PE) no grafo: ${empresasPJ.length}`);
    
    // Itera sobre cada empresa
    empresasPJ.forEach(no => {
        try {
            //const title = no.title || '';
            const title = (typeof no.title === 'string' && no.title.trim() !== '')
            ? no.title
            : (typeof no._tooltip_html === 'string' ? no._tooltip_html : '');


            const razaoSocial = no.label || 'Empresa n√£o identificada';
            
            const linhas = title.split('\n');

		

// ===============================
// EXTRAIR SITUA√á√ÉO DA EMPRESA (PELA IMAGEM DO N√ì)
// ===============================
let situacao = 'Desconhecida';

if (typeof no.image === 'string') {
    const nomeImagem = no.image.toLowerCase();

    if (nomeImagem.includes('_inativa')) {
        situacao = 'Baixada';
    } else if (nomeImagem.includes('_ativa')) {
        situacao = 'Ativa';
    }
}




            
            if (linhas.length < 2) {
                console.warn(`Empresa ${razaoSocial}: informa√ß√µes insuficientes no title`);
                return;
            }
            
            // CORRE√á√ÉO: Procura a linha que cont√©m o endere√ßo
            // O endere√ßo sempre termina com " - UF" ou "-UF" (2 letras mai√∫sculas)
            let enderecoLinha = '';
            
            // ATEN√á√ÉO: O MAPA EXIBE OS ENDERE√áOS DE TODAS AS PJ/ES, MESMO QUANDO N√ÉO COMPARTILHADOS COM OUTRAS PJ/PE NA BASE DE DADOS
            for (let i = 1; i < linhas.length && i < 5; i++) {
                const linha = linhas[i].trim();
                
                // Verifica se a linha termina com UF (padr√£o: - UF ou -UF)
                if (/-[A-Z]{2}\s*$/.test(linha) || /\s+-\s+[A-Z]{2}\s*$/.test(linha)) {
                //if (/-\sEX\s/.test(linha) || /[A-Z]{2}\s-/.test(linha)) {
                    enderecoLinha = linha;
                    break;
                }
            }
            
            if (!enderecoLinha) {
                console.warn(`Empresa ${razaoSocial}: endere√ßo n√£o encontrado no title`);
                return;
            }
            
            let municipio = '';
            let uf = '';
            
            // Divide o endere√ßo por " - "
            const partesEndereco = enderecoLinha.split(' - ');
            
            if (partesEndereco.length >= 2) {
                const ultimaParte = partesEndereco[partesEndereco.length - 1].trim();
                
                // CASO 1: √öltima parte √© s√≥ a UF (2 letras)
                // Exemplo: "... - S√£o Paulo - SP"
                if (/^[A-Z]{2}$/.test(ultimaParte)) {
                    uf = ultimaParte;
                    municipio = partesEndereco[partesEndereco.length - 2].trim();
                }
                // CASO 2: √öltima parte √© MUNIC√çPIO-UF (h√≠fen grudado, sem espa√ßos)
                // Exemplo: "... - FEIRA DE SANTANA-BA"
                else if (/^(.+)-([A-Z]{2})$/.test(ultimaParte)) {
                    const match = ultimaParte.match(/^(.+)-([A-Z]{2})$/);
                    municipio = match[1].trim();
                    uf = match[2].trim();
                }
                // CASO 3: √öltima parte √© MUNIC√çPIO - UF (com espa√ßos ao redor do h√≠fen)
                else {
                    const match = ultimaParte.match(/^(.+?)\s+-\s+([A-Z]{2})$/);
                    if (match) {
                        municipio = match[1].trim();
                        uf = match[2].trim();
                    }
                }
            }
            
            // Se ainda n√£o encontrou, tenta extrair diretamente da linha completa
            if (!municipio || !uf) {
                // Busca padr√£o: qualquer coisa seguida de h√≠fen e 2 letras mai√∫sculas no final
                const match = enderecoLinha.match(/([A-Z√Ä-≈∏][A-Za-z√Ä-√ø\s]+)-([A-Z]{2})\s*$/);
                if (match) {
                    municipio = match[1].trim();
                    uf = match[2].trim();
                }
            }


            
            // Valida√ß√µes
            if (!municipio || municipio === '' || municipio.length < 2) {
                // Para exterior (EX), usa o endere√ßo completo como "cidade"
                if (uf === 'EX') {
                    municipio = enderecoLinha.split(' - ')[0].trim();  // Pega primeira parte do endere√ßo
                    console.log(`‚ö† Empresa exterior ${razaoSocial}: usando endere√ßo como cidade: "${municipio}"`);
                } else {
                    console.warn(`Empresa ${razaoSocial}: munic√≠pio inv√°lido. Endere√ßo: "${enderecoLinha}"`);
                    return;
                }
            }

            if (!uf || !/^[A-Z]{2}$/.test(uf)) {
                console.warn(`Empresa ${razaoSocial}: UF inv√°lida "${uf}". Endere√ßo: "${enderecoLinha}"`);
                return;
            }



            
            // Pula empresas do exterior
            //if (uf === 'EX') {
            //    console.log(`Empresa ${razaoSocial}: localizada no exterior, ignorada`);
            //    return;
            //}
            
            console.log(`‚úì ${razaoSocial}: ${municipio} - ${uf}`);
            
            // Adiciona ao array
            empresas.push({
                razao_social: razaoSocial,
                situacao: situacao, // <-- NOVO CAMPO
                endereco_completo: enderecoLinha,
                cidade: municipio,
                uf: uf
            });

            
        } catch (erro) {
            console.error(`Erro ao processar empresa ${no.label}:`, erro);
        }
    });
    
    console.log(`Total de empresas v√°lidas para o mapa: ${empresas.length}`);
    
    return empresas;
}

// ===============================
// FUN√á√ÉO PARA GERAR E ABRIR MAPA A PARTIR DO GRAFO
// ===============================
function gerarMapaDoGrafo() {
    
    console.log('Extraindo dados do grafo...');
    
    // Extrai dados das empresas do grafo
    const empresas = extrairDadosGrafoParaMapa();
    
    if (empresas.length === 0) {
        //tempAlert(`Nenhuma empresa com localiza√ß√£o v√°lida encontrada no grafo.`, 3000);
        //alert('Nenhuma empresa com localiza√ß√£o v√°lida encontrada no grafo.');
        return;
    }
    
    console.log(`Abrindo mapa com ${empresas.length} empresas...`);
    
    // Abre o mapa em nova janela
    abrirMapaEmpresas(empresas);
}

// ===============================
// FUN√á√ÉO PARA ABRIR MAPA EM NOVA JANELA
// ===============================
function abrirMapaEmpresas(empresas) {
    
    // Gerar HTML do mapa
    const htmlMapa = gerarHTMLMapa(empresas);
    
    // Abrir nova janela
    const janela = window.open(
    'about:blank',
    '_blank',
    'width=1200,height=800,scrollbars=yes,resizable=yes'
);

    
    // Escrever HTML na janela
    janela.document.open();
    janela.document.write(htmlMapa);
    janela.document.close();
}

// ===============================
// FUN√á√ÉO PARA GERAR HTML DO MAPA
// ===============================
function gerarHTMLMapa(empresas) {
    
    // Converter array completo para string JavaScript
    const empresasArray = JSON.stringify(empresas);
    
    let html = '<!DOCTYPE html>';
    html += '<html lang="pt-BR">';
    html += '<head>';
    html += '<meta charset="utf-8">';
    html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
    html += '<title>Mapa SINARC ‚Äì Agrupamento por Cidade</title>';
    html += '<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />';
    html += '<style>';
    html += 'html, body { margin: 0; height: 100%; }';
    html += '#map { height: 100vh; width: 100%; }';
    html += '#status { position: fixed; bottom: 10px; left: 10px; background: white; padding: 6px 10px; border: 1px solid #ccc; z-index: 1000; font-family: "Helvetica Neue", Arial, Helvetica, sans-serif; font-size: 12px; line-height: 1.4; }';
    html += '.marker-label { background: white; border: 1px solid #444; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: bold; text-align: center; }';
    html += '.empresa-link { color: #2c5f8d; text-decoration: none; font-weight: 500; transition: color 0.2s; }';
    html += '.empresa-link:hover { color: #1e4163; text-decoration: underline; }';

    html += '.leaflet-popup-content-wrapper { width: auto !important; min-width: 300px; max-width: none !important; }';
    html += '.leaflet-popup-content { width: auto !important; min-width: 280px; max-height: 400px; overflow-y: auto; white-space: nowrap; }';

    html += '.empresa-link { white-space: nowrap; }';

    html += '#btn-fit { position: fixed; top: 10px; right: 10px; z-index: 1000; ';
    html += 'background: white; ';
    html += 'border: 2px solid rgba(0,0,0,0.2); ';
    html += 'background-clip: padding-box; ';  
    html += 'border-radius: 4px; ';
    html += 'box-shadow: none; ';
    html += 'width: 34px; height: 34px; ';
    html += 'cursor: pointer; ';
    html += 'display: flex; align-items: center; justify-content: center; ';
    html += 'font-size: 26px; ';  
    html += 'line-height: 30px; ';
    html += 'text-align: center; ';
    html += 'text-decoration: none; ';
    html += 'color: black; ';
    html += '-webkit-text-fill-color: black; ';
    html += 'font-weight: bold; ';  
    html += 'transition: background 0.2s; }';  
    html += '#btn-fit:hover { background: #f4f4f4; }';
    html += '#btn-fit:active { transform: scale(0.98); }';

    html += '#btn-toggle-labels { position: fixed; top: 50px; right: 10px; z-index: 1000; ';
    html += 'background: white; ';
    html += 'border: 2px solid rgba(0,0,0,0.2); ';
    html += 'background-clip: padding-box; ';
    html += 'border-radius: 4px; ';
    html += 'box-shadow: none; ';
    html += 'width: 34px; height: 34px; ';
    html += 'cursor: pointer; ';
    html += 'display: flex; align-items: center; justify-content: center; ';
    html += 'font-size: 20px; ';
    html += 'line-height: 30px; ';
    html += 'text-align: center; ';
    html += 'text-decoration: none; ';
    html += 'color: black; ';
    html += '-webkit-text-fill-color: black; ';
    html += 'font-weight: bold; ';
    html += 'transition: background 0.2s; }';
    html += '#btn-toggle-labels:hover { background: #f4f4f4; }';
    html += '#btn-toggle-labels:active { transform: scale(0.98); }';
    html += '.tooltip-quantidade.hidden { display: none !important; }';

    html += '</style>';
    html += '</head>';
    html += '<body>';
    html += '<button id="btn-fit" title="Enquadrar todos os pontos">‚åÇ</button>';
    html += '<button id="btn-toggle-labels" title="Mostrar/Ocultar r√≥tulos das cidades">üëÅÔ∏è</button>';
    html += '<div id="map"></div>';
    html += '<div id="status">Carregando mapa e cidades...</div>';
    html += '<script src="https://unpkg.com/leaflet/dist/leaflet.js"><\/script>';
    html += '<script>';
    
    // Dados das empresas
    html += 'const empresas = ' + empresasArray + ';';
    
    // Fun√ß√£o de geocodifica√ß√£o
    html += 'async function geocodificarCidade(nomeCidade, uf) {';
    html += '  const countryParam = (uf === "EX") ? "" : "&countrycodes=br";';
    html += '  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=pt-BR&addressdetails=1" + countryParam + "&q=" + encodeURIComponent(nomeCidade);';
    html += '  const resposta = await fetch(url, { headers: { "User-Agent": "sinarc-mapa-teste/1.0" } });';
    html += '  const dados = await resposta.json();';
    html += '  if (dados.length === 0) { console.warn("Cidade n√£o encontrada:", nomeCidade); return null; }';
    html += '  return { lat: parseFloat(dados[0].lat), lng: parseFloat(dados[0].lon), nome: nomeCidade, pais: dados[0].address?.country_code || "" };';
    html += '}';
    
    // √çcones
    html += 'const iconeBrasil = L.icon({ iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });';
    html += 'const iconeExterior = L.icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png", shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });';
    
    // Fun√ß√£o principal do mapa
    html += 'async function carregarMapaPorCidade() {';
    html += '  const status = document.getElementById("status");';
    html += '  window.mapaSinarc = L.map("map");';  // ‚Üê GLOBAL
    html += '  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap contributors" }).addTo(window.mapaSinarc);';  // ‚Üê CORRIGIDO
    
    // Agrupar empresas por cidade+UF (chave √∫nica)
    html += '  const empresasPorCidade = {};';
    html += '  empresas.forEach(emp => {';
    html += '    const chave = `${emp.cidade} - ${emp.uf}`;';
    html += '    if (!empresasPorCidade[chave]) { ';
    html += '      empresasPorCidade[chave] = { cidade: emp.cidade, uf: emp.uf, empresas: [] };';
    html += '    }';
    html += '    empresasPorCidade[chave].empresas.push(emp);';
    html += '  });';
    
    html += '  console.log("Empresas por cidade:", empresasPorCidade);';
    html += '  window.limitesSinarc = L.latLngBounds([]);';  // ‚Üê GLOBAL
    html += '  let processadas = 0;';
    html += '  const total = Object.keys(empresasPorCidade).length;';

    // Array para coletar falhas
    html += '  const empresasNaoLocalizadas = [];';
    
    html += '  for (const chave in empresasPorCidade) {';
    html += '    const dadosCidade = empresasPorCidade[chave];';
    html += '    const cidadeNome = dadosCidade.cidade;';
    html += '    const uf = dadosCidade.uf;';
    html += '    const cidadeUF = (uf === "EX") ? cidadeNome : `${cidadeNome} - ${uf}`;';

    html += '    status.textContent = `Geocodificando: ${cidadeUF} (${++processadas}/${total})`;';
    html += '    const ponto = await geocodificarCidade(cidadeUF, uf);';
    html += '    if (ponto) {';
    html += '      const ehBrasil = ponto.pais.toLowerCase() === "br";';
    html += '      const marcador = L.marker([ponto.lat, ponto.lng], { icon: ehBrasil ? iconeBrasil : iconeExterior }).addTo(window.mapaSinarc);';  // ‚Üê CORRIGIDO
    
    // Tooltip mostra cidade - UF e quantidade
    html += '      const qtd = dadosCidade.empresas.length;';
    html += '      marcador.bindTooltip(`${cidadeUF} (${qtd})`, { permanent: true, direction: "top", offset: [0, -45], className: "tooltip-quantidade" });';
    
    // Popup mostra cidade - UF e lista de empresas (ORDENADAS ALFABETICAMENTE)
    html += '      let popupHTML = `<b>${cidadeUF} (${qtd})</b><br>`;';
    html += '      const empresasOrdenadas = dadosCidade.empresas.sort((a, b) => a.razao_social.localeCompare(b.razao_social));';
    html += '      empresasOrdenadas.forEach(emp => {';
    html += '        const enderecoEncoded = encodeURIComponent(emp.endereco_completo);';
    html += '        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${enderecoEncoded}`;';
    html += '        popupHTML += `‚Ä¢ <a href="${googleMapsUrl}" target="_blank" class="empresa-link" title="Ver localiza√ß√£o no Google Maps">${emp.razao_social} <span style="color:#555;">(${emp.situacao})</span></a><br>`;';
    html += '      });';
    html += '      marcador.bindPopup(popupHTML);';
    
    // Sistema de delay para fechar o popup
    html += '      let timeoutFecharPopup = null;';
    html += '      marcador.on("mouseover", function () {';
    html += '        if (timeoutFecharPopup) { clearTimeout(timeoutFecharPopup); timeoutFecharPopup = null; }';
    html += '        this.openPopup();';
    html += '      });';
    
    html += '      marcador.on("mouseout", function () {';
    html += '        const popup = this.getPopup();';
    html += '        timeoutFecharPopup = setTimeout(() => { this.closePopup(); }, 500);';
    html += '        const popupElement = popup.getElement();';
    html += '        if (popupElement) {';
    html += '          popupElement.addEventListener("mouseenter", () => {';
    html += '            if (timeoutFecharPopup) { clearTimeout(timeoutFecharPopup); timeoutFecharPopup = null; }';
    html += '          });';
    html += '          popupElement.addEventListener("mouseleave", () => {';
    html += '            this.closePopup();';
    html += '          });';
    html += '        }';
    html += '      });';
    
    html += '      window.limitesSinarc.extend([ponto.lat, ponto.lng]);';  // ‚Üê CORRIGIDO

    // Se n√£o localizou, adiciona √† lista de falhas
    html += '    } else {';
    html += '      dadosCidade.empresas.forEach(emp => {';
    html += '        empresasNaoLocalizadas.push({ razao: emp.razao_social, endereco: emp.endereco_completo });';
    html += '      });';
    html += '    }';

    html += '    await new Promise(r => setTimeout(r, 800));';
    html += '  }';
    
    html += '  if (window.limitesSinarc.isValid()) { window.mapaSinarc.fitBounds(window.limitesSinarc, { padding: [50, 50], maxZoom: 11 }); }';  // ‚Üê CORRIGIDO
    html += '  status.textContent = `Mapa carregado (${empresas.length} PJ/PE).`;';

    // Exibir popup com empresas n√£o localizadas
    html += '  if (empresasNaoLocalizadas.length > 0) {';
    html += '    let mensagem = `‚ö†Ô∏è ${empresasNaoLocalizadas.length} empresa(s) n√£o localizada(s):\n\n`;';
    html += '    empresasNaoLocalizadas.forEach(emp => {';
    html += '      mensagem += `‚Ä¢ ${emp.razao}\n  ${emp.endereco}\n\n`;';
    html += '    });';
    html += '    alert(mensagem);';
    html += '    console.warn("Empresas n√£o localizadas:", empresasNaoLocalizadas);';
    html += '  }';

    html += '}';
    html += 'carregarMapaPorCidade();';

    // Fun√ß√£o para enquadrar todos os pontos
    html += 'function enquadrarTudo() {';
    html += '  if (window.limitesSinarc && window.limitesSinarc.isValid()) {';  // ‚Üê CORRIGIDO
    html += '    window.mapaSinarc.fitBounds(window.limitesSinarc, { padding: [50, 50], maxZoom: 11 });';  // ‚Üê CORRIGIDO
    html += '  }';
    html += '}';

    // Vari√°vel para controlar estado dos r√≥tulos
    html += 'let tooltipsVisiveis = true;';
    
    // Fun√ß√£o para alternar visibilidade dos tooltips
    html += 'function alternarTooltips() {';
    html += '  tooltipsVisiveis = !tooltipsVisiveis;';
    html += '  const tooltips = document.querySelectorAll(".tooltip-quantidade");';
    html += '  tooltips.forEach(tooltip => {';
    html += '    if (tooltipsVisiveis) {';
    html += '      tooltip.classList.remove("hidden");';
    html += '    } else {';
    html += '      tooltip.classList.add("hidden");';
    html += '    }';
    html += '  });';
    html += '  const btn = document.getElementById("btn-toggle-labels");';
    html += '  btn.textContent = tooltipsVisiveis ? "üëÅÔ∏è" : "üëÅÔ∏è‚Äçüó®Ô∏è";';
    html += '  btn.title = tooltipsVisiveis ? "Ocultar r√≥tulos das cidades (Tecla L)" : "Mostrar r√≥tulos das cidades (Tecla L)";';
    html += '}';
    
    // Event listeners para bot√£o e tecla Home
    html += 'document.getElementById("btn-fit").addEventListener("click", enquadrarTudo);';
    html += 'document.getElementById("btn-toggle-labels").addEventListener("click", alternarTooltips);';
    //html += 'document.addEventListener("keydown", (e) => {';
    //html += '  if (e.key === "Home") { e.preventDefault(); enquadrarTudo(); }';
    //html += '});';

    html += '<\/script>';
    html += '</body>';
    html += '</html>';
    
    return html;
}

// ===============================
// FUN√á√ÉO DE TESTE COM DADOS FICT√çCIOS
// ===============================
function testarMapaComDadosTeste() {
    console.log('Testando mapa com dados de teste...');
    abrirMapaEmpresas(empresasTeste);
}

// ===============================
// FIM DAS FUN√á√ïES PARA MAPA GEOGR√ÅFICO
// ===============================

// Torna fun√ß√£o global
window.gerarMapaDoGrafo = gerarMapaDoGrafo;

</script>

















<div id="sinarc-tooltip-node"
     style="
        position: fixed;
        display: none;
        max-height: 295px;
        max-width: min(600px, calc(100vw - 24px));
        overflow-y: auto;
        overflow-x: auto;
        background: rgba(255,255,216,0.98);
        border: 1px solid #999;
        border-radius: 3px;
        font-size: 11px;
        padding: 6px 60px 6px 6px;
        z-index: 99999;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        white-space: pre;
        pointer-events: auto;
     ">
</div>

<style>
    .tooltip-buttons {
        display: flex;
        flex-direction: column;
        padding: 0px;
        margin-bottom: 10px;
    }

    .buttons-label {
        font-size: 11px;
        text-align: center;
        margin-bottom: 5px;
        font-weight: normal;
        align-self: left;
        width: 330px;
    }

    .buttons-row {
        display: flex;
        gap: 20px;
        justify-content: left;
        align-items: left;
    }

    .tooltip-buttons button {
        min-width: 50px;
        padding: 1px 18px;
        background: #52a0fa;
        color: #FFFFFF;
        border: 1px solid #0b66cf;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .tooltip-buttons button:hover {
        background: #2b8ef7;
        border-color: #1f7fe0;
    }

    .tooltip-buttons button:active {
        background: #095cc0;
        border-color: #074b9e;
    }


    
    
    
    .tooltip-close-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #f0f0f0;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 12px;
        color: #666;
        z-index: 10;
        transition: background 0.2s;
    }

    
    .tooltip-close-button:hover {
        background: #e0e0e0;
    }
</style>

<script>
(function () {
    const tooltip = document.getElementById("sinarc-tooltip-node");
    if (!tooltip) return;

    // --- SISTEMA GLOBAL DE RASTREIO DE MOUSE ---
    let globalMouseX = 0;
    let globalMouseY = 0;
    
    // Atualiza posi√ß√£o do mouse em qualquer movimento na tela
    document.addEventListener('mousemove', (e) => {
        globalMouseX = e.clientX;
        globalMouseY = e.clientY;
    });
    // -------------------------------------------------

    // --- VARI√ÅVEIS DO LOOP DE PARADA ---
    let stillnessInterval = null;
    let hoverStartTime = 0;
    let hoverStartX = 0;
    let hoverStartY = 0;
    let currentHoveredNodeId = null;

    function closeTooltip() {
        tooltip.style.display = "none";
        tooltip.scrollTop = 0;
        hoveredNodeId = null;
        isMouseOverNode = false;
        isMouseOverTooltip = false;
        stopStillnessCheck();
    }

    const STILLNESS_DELAY = 1500; // 1.5s
    const MOVEMENT_THRESHOLD = 3; // Toler√¢ncia de 3px (movimentos menores que isso n√£o resetam)
    // ---------------------------------

    let hideTimer = null;
    let isMouseOverNode = false;
    let isMouseOverTooltip = false;

    // Fun√ß√£o que verifica periodicamente se o mouse parou
    function startStillnessCheck(nodeId) {
        stopStillnessCheck(); // Para verifica√ß√£o anterior se houver

        currentHoveredNodeId = nodeId;
        hoverStartTime = Date.now(); // Registra in√≠cio da contagem
        hoverStartX = globalMouseX;  // Marca posi√ß√£o inicial
        hoverStartY = globalMouseY;

        // Inicia loop de verifica√ß√£o (a cada 50ms)
        stillnessInterval = setInterval(() => {
            // Calcula dist√¢ncia Euclidiana da posi√ß√£o atual para a posi√ß√£o de "in√≠cio da contagem"
            const dist = Math.hypot(globalMouseX - hoverStartX, globalMouseY - hoverStartY);

            if (dist > MOVEMENT_THRESHOLD) {
                // O mouse se moveu! Reinicia a contagem.
                // A nova posi√ß√£o se torna a posi√ß√£o base.
                hoverStartTime = Date.now();
                hoverStartX = globalMouseX;
                hoverStartY = globalMouseY;
                // console.log("Mouse moveu, resetando timer...");
            } 
            else if (Date.now() - hoverStartTime >= STILLNESS_DELAY) {
                // O tempo passou E o mouse est√° parado (dentro do threshold).
                stopStillnessCheck(); // Para o loop
                const node = nodes.get(nodeId);
                if (node) {
                    // Passa a posi√ß√£o atual do mouse para posicionar o tooltip exatamente onde parou
                    mostrarTooltip(node, {event: {clientX: globalMouseX, clientY: globalMouseY}});
                }
            }
        }, 50); // Checa 20 vezes por segundo
    }

    function stopStillnessCheck() {
        if (stillnessInterval) {
            clearInterval(stillnessInterval);
            stillnessInterval = null;
        }
        currentHoveredNodeId = null;
    }

    // --- FUN√á√ÉO DE EXIBI√á√ÉO ---
    function mostrarTooltip(node, params) {
        if (!node || !node._tooltip_html) return;

        const lines = node._tooltip_html.split(/\n/);
        
        const primeiraLinhaTexto = lines[0]
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        
        /*
        const textoPesquisa = `Realize uma pesquisa profunda e detalhada sobre o hist√≥rico de conformidade e integridade da pessoa a seguir. 
            O objetivo √© identificar riscos reputacionais por meio de uma an√°lise forense com foco no controle externo da Administra√ß√£o P√∫blica e na produ√ß√£o de insights para a defesa do interesse p√∫blico. 
            Utilize intelig√™ncia com fontes abertas (OSINT) para coletar dados relevantes dispon√≠veis na internet, incluindo not√≠cias, registros p√∫blicos, listas de san√ß√µes, portais de transpar√™ncia, redes sociais e outras fontes confi√°veis. 
            Concentre-se em aspectos que possam indicar envolvimento em pr√°ticas il√≠citas, m√° conduta empresarial ou qualquer outro fator que possa comprometer a integridade e a reputa√ß√£o da pessoa investigada.
            O n√∫mero do CPF de pessoas f√≠sicas est√° no formato PF_***NNNNNN** e o n√∫mero do CNPJ de pessoas jur√≠dicas est√° no formato PJ_NNNNNNNNNNNNNN.
            Por favor, forne√ßa as informa√ß√µes estruturadas da seguinte forma: 
            1. Not√≠cias e Irregularidades: Liste men√ß√µes em investiga√ß√µes, processos judiciais e administrativos p√∫blicos, inqu√©ritos ou not√≠cias sobre fraudes, corrup√ß√£o e irregularidades envolvendo a Administra√ß√£o P√∫blica e o interesse coletivo. 
            2. Rede de Liga√ß√µes: Identifique s√≥cios, empresas coligadas ou parceiros de neg√≥cios frequentemente citados em conjunto com o alvo. 
            3. Presen√ßa em Listas: Verifique se h√° men√ß√µes em portais de transpar√™ncia, listas de san√ß√µes ou registros de empresas e pessoas suspensas ou impedidas de contratar com a Administra√ß√£o P√∫blica (CEIS, CNEP, CEPIM, CEAF, CNIA, Acordo de Leni√™ncia, PEP).
            4. Atividades Comerciais: Descreva o setor de atua√ß√£o, principais atividades comerciais e qualquer hist√≥rico de contratos com o setor p√∫blico. 
            5. Reputa√ß√£o Online: Analise avalia√ß√µes, coment√°rios e discuss√µes em redes sociais, f√≥runs e sites especializados. 
            6. Hist√≥rico Financeiro: Investigue fal√™ncias, recupera√ß√µes judiciais ou outras quest√µes financeiras relevantes. 
            7. Conformidade Legal: Verifique o cumprimento de obriga√ß√µes legais, fiscais e regulat√≥rias. 
            8. Outras Informa√ß√µes Relevantes: Inclua quaisquer outras informa√ß√µes que possam impactar a avalia√ß√£o de risco reputacional do alvo.
            9. Insights para Pesquisa: Forne√ßa 5 insights ou pontos de aten√ß√£o que possam guiar uma investiga√ß√£o mais aprofundada sobre o alvo. 
            10. Prompts para Aprofundamento: Ao final de cada resposta, apresente 6 novas sugest√µes de prompts para IA (de 1 a 6), distintas das sugest√µes j√° apresentadas na conversa, sendo a sexta op√ß√£o espec√≠fica para gerar novos prompts contendo sugest√µes de pontos de auditoria ainda n√£o abordados nesta converesa, visando aprofundar ainda mais a investiga√ß√£o por meio de dados p√∫blicos dispon√≠veis na internet, de modo que o usu√°rio precise apenas digitar o n√∫mero do prompt desejado para a IA realizar a pesquisa correspondente. Pe√ßa para o usu√°rio digitar um n√∫mero.
            ATEN√á√ÉO: Se o alvo for um telefone (11 12345678), um endere√ßo (DEPUTADO EDUARDO KM LUIS MAGALHAES 529-FEIRA DE SANTANA-BA) ou um e-mail, realize uma pesquisa profunda sobre o alvo, objetivando encontrar men√ß√µes em bases p√∫blicas, redes sociais, listas de spam, vazamentos de dados e outras fontes abertas na internet.
            `;
        */
        
        const textoPesquisaFormatado = encodeURIComponent(window.textoPesquisa);
        const url = 'https://www.google.com/search?q=' + textoPesquisaFormatado + '+Entidade:+' + lines[0] + '&udm=50';
        
        const firstLine = '<strong><a href="\#" style="color: #0066cc; text-decoration: none; cursor: pointer;" onclick="window.open(\'' + url + '\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + primeiraLinhaTexto + '<\/a> üîç<\/strong>';
        
        const otherLines = lines.slice(1)
            .map(line => line
                .trim()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
            )
            .join("<br>");
        
        const botoesSection = `<div class="tooltip-buttons">
                <div class="buttons-label">Abrir n√≥ em camadas</div>
                <div class="buttons-row">
                    <button onclick="abrirGrafo(1)">1</button>
                    <button onclick="abrirGrafo(2)">2</button>
                    <button onclick="abrirGrafo(3)">3</button>
                    <button onclick="abrirGrafo(4)">4</button>
                    <button onclick="abrirGrafo(5)">5</button>
                </div>
            </div>`;
        
        
        //const html = botoesSection + firstLine + (otherLines ? "<br>" + otherLines : "");
        const closeButton = `<button class="tooltip-close-button">X</button>`;
        const html = closeButton + botoesSection + firstLine + (otherLines ? "<br>" + otherLines : "");

        tooltip.innerHTML = html;

        // ADICIONAR EVENTO PROGRAMATICAMENTE (DENTRO DO SCOP)
        const closeButtonElement = tooltip.querySelector('.tooltip-close-button');
        if (closeButtonElement) {
            closeButtonElement.addEventListener('click', closeTooltip);
        }

        
        
        // Posicionamento usando o evento de mouse (que agora √© garantido)
        const evt = params && params.event ? params.event : window.event;
        if (!evt) return;
        
        let x = evt.clientX + 12;
        let y = evt.clientY + 12;

        tooltip.style.visibility = "hidden";
        tooltip.style.display = "block";
        const w = tooltip.offsetWidth;
        const h = tooltip.offsetHeight;

        const maxX = window.innerWidth - w - 12;
        const maxY = window.innerHeight - h - 12;

        if (x > maxX) x = Math.max(12, maxX);
        if (x < 12) x = 12;
        if (y > maxY) y = Math.max(12, maxY);
        if (y < 12) y = 12;

        tooltip.style.left = x + "px";
        tooltip.style.top  = y + "px";
        tooltip.style.visibility = "visible";
        
        hoveredNodeId = node.id;
        isMouseOverNode = true;
    }

    function checkHideTooltip() {
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
            if (!isMouseOverNode && !isMouseOverTooltip) {
                tooltip.style.display = "none";
                tooltip.scrollTop = 0;
                if (typeof hoveredNodeId !== 'undefined') hoveredNodeId = null;
            }
        }, 100); 
    }

    network.on("hoverNode", function (params) {
        const nodeId = params.node;
        const node = nodes.get(nodeId);
        if (!node) return;
        
        if (!node._tooltip_html && node.title) {
            node._tooltip_html = node.title;
            //nodes.update({ id: nodeId, title: undefined });
        }
        if (!node._tooltip_html) return;
        
        isMouseOverNode = true;
        if (hideTimer) clearTimeout(hideTimer);
        
        // Inicia a verifica√ß√£o de parada (coordenadas)
        startStillnessCheck(nodeId);
    });
    
    network.on("blurNode", function () {
        isMouseOverNode = false;
        stopStillnessCheck(); // Para o timer de verifica√ß√£o imediatamente
        checkHideTooltip();
    });

    tooltip.addEventListener("mouseenter", () => {
        isMouseOverTooltip = true;
        if (hideTimer) clearTimeout(hideTimer);
    });

    tooltip.addEventListener("mouseleave", () => {
        isMouseOverTooltip = false;
        checkHideTooltip();
    });

})();

function closeTooltip() {
        tooltip.style.display = "none";
        tooltip.scrollTop = 0;
        hoveredNodeId = null;
        isMouseOverNode = false;
        isMouseOverTooltip = false;
        stopStillnessCheck();
    }


let hoveredNodeId = null;

function abrirGrafo(camadasSelecionada) {
    if (!hoveredNodeId) {
        tempAlert("Nenhum n√≥ em foco para abrir em camadas", 3000);
        return;
    }

    const cnpj = hoveredNodeId;
    const conf_destaca = false;

    if (location.protocol === "https:") {
        const url = `https://sinarc.app/?cnpj=${cnpj}&camada=${camadasSelecionada}`;
        window.open(url, "_blank");
        tempAlert(`Bot√£o ${camadasSelecionada} - Abrindo n√≥ ${cnpj} em nova aba`, 3000);
        return;
    }

    const textoCopiar = cnpj + "***" + camadasSelecionada + "***" + conf_destaca;
    async function copyOperation(texto) {
        await navigator.clipboard.writeText(texto);
    }
    setTimeout(() => {
        copyOperation(textoCopiar);
    }, 200);

    tempAlert(
        `Bot√£o ${camadasSelecionada} - N√≥ ${cnpj} copiado (${camadasSelecionada} camada${camadasSelecionada > 1 ? 's' : ''})`,
        3000
    );
}
</script>



    

        <style>
            #info-base-dados {
                position: fixed;
                bottom: 7px;  /* Dist√¢ncia do fundo - ajust√°vel */
                left: 11px;    /* Dist√¢ncia da esquerda - ajust√°vel */
                font-family: Arial, sans-serif;
                font-size: 10px;  /* Tamanho da fonte - ajust√°vel */
                color: #666;      /* Cor do texto - ajust√°vel */
                background-color: rgba(255, 255, 255, 0.0);  /* Fundo semi-transparente - ajust√°vel */
                padding: 5px 10px;  /* Espa√ßamento interno - ajust√°vel */
                border-radius: 3px;  /* Cantos arredondados - ajust√°vel */
                z-index: 999;
                pointer-events: none;  /* N√£o interfere com cliques */
                opacity: 0.5;  /* Transpar√™ncia do elemento - ajust√°vel */
            }
            
            #info-base-dados:hover {
                opacity: 1;  /* Fica mais vis√≠vel ao passar o mouse */
            }

        </style>

        <div id="info-base-dados">
            Base de dados: 13/12/2025
        </div>

    

<script>


    function gerarRelatorio() {

        const selectedNodes = network.getSelectedNodes();
        const totalSelecionados = selectedNodes.length;
        const textoNos = totalSelecionados === 1 ? 'N√ì SELECIONADO' : 'N√ìS SELECIONADOS';

        if (selectedNodes.length == 0){
                tempAlert('Selecione pelo menos um n√≥ para gerar o relat√≥rio. Pressione SHIFT + a para selecionar todos os n√≥s.', 3000);
                return;
        }

        const textoPesquisa = window.textoPesquisa


        // CALCULA TOTAL E EXTRAI DADOS DE PJ (apenas Brasil) e PE (exterior + estrangeiros)
        const pessoasJuridicas = [];
        const pessoasEstrangeiras = [];
        
        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string') return;
            
            const node = network.body.data.nodes.get(id);
            const title = node.title || '';
            const image = node.image || '';
            const conexoes = network.getConnectedEdges(id).length;
            
            // Situa√ß√£o baseada na imagem
            let situacao = 'ATIVA';
            if (image.includes('_inativa')) {
                situacao = 'BAIXADA';
            }
            
            // Restri√ß√£o (procura "Situa√ß√£o Fiscal:")
            let restricao = '';
            const matchFiscal = title.match(/Situa√ß√£o Fiscal:\s*(\w+)/i);
            if (matchFiscal) {
                restricao = matchFiscal[1].toUpperCase();
            }
            
            // PROCESSA PE_ (Pessoa Estrangeira)
            if (id.startsWith('PE_')) {
                const nome = id.substring(3);
                
                // Pa√≠s e endere√ßo - percorre todas as linhas buscando "- EX"
                let pais = '';
                let endereco = '';
                const linhas = title.split('\n').slice(1);
                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    if (linha === 'nan' || linha === '' || linha.startsWith('(EMPRESA')) continue;
                    if (linha.startsWith('N√ì -') || linha.startsWith('GRAFO -') || linha.includes('N√≥s Adjacentes')) break;
                    
                    /*
                    // Verifica se termina com "- EX" (endere√ßo estrangeiro)
                    if (linha.endsWith('- EX') || linha.endsWith('- EX ')) {
                        const partes = linha.split(' - ');
                        if (partes.length >= 2 && partes[0].trim() !== 'nan') {
                            pais = partes[0].trim();
                            // Endere√ßo √© tudo entre o pa√≠s e o "- EX" final
                            endereco = partes.slice(1, -1).join(' - ').trim();
                            if (endereco === '') {
                                endereco = partes.slice(1).join(' - ').replace(/\s*-\s*EX\s*$/i, '').trim();
                            }
                        }
                        break;
                    }
                    */

                    // 1. Verifica se a linha cont√©m "- EX" ou "- EX " em qualquer posi√ß√£o
                    if (linha.endsWith('- EX') || linha.includes('- EX ')) {
                        
                        // 2. O endere√ßo agora √© a linha completa (sem espa√ßos extras nas pontas)
                        endereco = linha.trim();
                        
                        // 3. (Opcional) Se ainda precisar extrair o pa√≠s separadamente:
                        const partes = linha.split(' - ');
                        if (partes.length >= 1 && partes[0].trim().toLowerCase() !== 'nan') {
                            pais = partes[0].trim();
                        }

                        // Como √© a "primeira linha que cont√©m", interrompemos o loop
                        break;
                    }

                }
                
                pessoasEstrangeiras.push({
                    id: id,
                    nome: nome,
                    cnpj: '',
                    pais: pais,
                    endereco: endereco,
                    situacao: situacao,
                    restricao: restricao,
                    conexoes: conexoes
                });
                return;
            }
            
            // PROCESSA PJ_
            if (id.startsWith('PJ_')) {
                const cnpj = id.substring(3);
                
                // Extrai nome (primeira linha do title, antes do "(PJ_")
                const primeiraLinha = title.split('\n')[0] || '';
                const nome = primeiraLinha.split('(PJ_')[0].trim();
                
                // Percorre todas as linhas para encontrar endere√ßo e verificar se √© exterior
                const linhas = title.split('\n');
                let linhaEndereco = '';
                let linhaEnderecoExterior = '';
                let isExterior = false;
                
                for (let i = 1; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    if (linha === '' || linha === nome) continue;
                    if (linha.startsWith('N√ì -') || linha.startsWith('GRAFO -') || linha.includes('N√≥s Adjacentes')) break;
                    
                    // Verifica se esta linha termina com "- EX"
                    if (linha.endsWith('- EX') || linha.includes('- EX ')) {
                        linhaEnderecoExterior = linha;
                        isExterior = true;
                    }
                    
                    // Guarda a primeira linha como endere√ßo padr√£o (para PJ nacional)
                    if (linhaEndereco === '') {
                        linhaEndereco = linha;
                    }
                }
                
                // Se for exterior, usa a linha com "- EX" como endere√ßo
                if (isExterior) {
                    linhaEndereco = linhaEnderecoExterior;
                }
                
                if (isExterior) {
                    // PJ no exterior vai para o array de PE
                    let pais = '';
                    let endereco = '';
                    const partes = linhaEndereco.split(' - ');
                    if (partes.length >= 2) {
                        pais = partes[0].trim();
                        // Remove o pa√≠s do in√≠cio e "EX" do final
                        endereco = partes.slice(1, -1).join(' - ').trim();
                        if (endereco === '') {
                            endereco = partes.slice(1).join(' - ').replace(/\s*-\s*EX\s*$/i, '').trim();
                        }
                    }
                    
                    pessoasEstrangeiras.push({
                        id: id,
                        nome: nome,
                        cnpj: cnpj,
                        pais: pais,
                        endereco: endereco,
                        situacao: situacao,
                        restricao: restricao,
                        conexoes: conexoes
                    });
                } else {
                    // PJ nacional
                    pessoasJuridicas.push({
                        id: id,
                        nome: nome,
                        cnpj: cnpj,
                        endereco: linhaEndereco,
                        situacao: situacao,
                        restricao: restricao,
                        conexoes: conexoes
                    });
                }
                return;
            }
        });
        
        const totalPJ = pessoasJuridicas.length;
        const textoPJ = totalPJ === 1 ? 'PESSOA JUR√çDICA (PJ) SEDIADA NO BRASIL' : 'PESSOAS JUR√çDICAS (PJ) SEDIADAS NO BRASIL';
        
        const totalPE = pessoasEstrangeiras.length;
        const textoPE = totalPE === 1 ? 'PESSOA JUR√çDICA (PJ) SEDIADA NO EXTERIOR OU PESSOA ESTRANGEIRA (PE)' : 'PESSOAS JUR√çDICAS (PJ) SEDIADAS NO EXTERIOR OU PESSOAS ESTRANGEIRAS (PE)';
        

        // CALCULA TOTAL E EXTRAI DADOS DE EN (Endere√ßo)
        const enderecos = [];

        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('EN_')) return;

            const node = network.body.data.nodes.get(id);
            if (!node || !node.title) return;

            // Primeira linha do title
            const primeiraLinha = node.title.split('\n')[0].trim();

            const conexoes = network.getConnectedEdges(id).length;

            enderecos.push({
                id: id,
                endereco: primeiraLinha,
                conexoes: conexoes
            });
        });


        const totalEN = enderecos.length;
        const textoEN = totalEN === 1 ? 'ENDERE√áO (EN)' : 'ENDERE√áOS (EN)';

        // CALCULA TOTAL E EXTRAI DADOS DE TE (Telefone)
        const telefones = [];
        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('TE_')) return;
            
            const telefone = id.substring(3);
            const conexoes = network.getConnectedEdges(id).length;
            
            telefones.push({
                id: id,
                telefone: telefone,
                conexoes: conexoes
            });
        });
        const totalTE = telefones.length;
        const textoTE = totalTE === 1 ? 'TELEFONE (TE)' : 'TELEFONES (TE)';

        // CALCULA TOTAL E EXTRAI DADOS DE EM (E-mail)
        const emails = [];
        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('EM_')) return;
            
            const email = id.substring(3);
            const conexoes = network.getConnectedEdges(id).length;
            
            emails.push({
                id: id,
                email: email,
                conexoes: conexoes
            });
        });
        const totalEM = emails.length;
        const textoEM = totalEM === 1 ? 'E-MAIL (EM)' : 'E-MAILS (EM)';


        // CALCULA TOTAL PF
        let totalPF = 0;
        selectedNodes.forEach(function (id) {
            if (typeof id === 'string' && id.startsWith('PF_')) {
                totalPF++;
            }
        });
        const textoNosPF = totalPF === 1 ? 'PESSOA F√çSICA (PF)' : 'PESSOAS F√çSICAS (PF)';

        // GERA LINHAS DE PJ
        let linhasPJ = '';
        pessoasJuridicas.forEach(function (pj) {
            const badgeSituacao = pj.situacao === 'ATIVA' 
                ? '<span class="badge badge-success">ATIVA</span>' 
                : '<span class="badge badge-danger">BAIXADA</span>';
            const badgeRestricao = pj.restricao 
                ? '<span class="badge badge-danger">' + pj.restricao + '</span>' 
                : '';
            
            linhasPJ += '<tr>';
            linhasPJ += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Abrir dados da pessoa jur√≠dica" onclick="window.opener.consultarCNPJ(\'' + pj.cnpj + '\'); return false;">' + pj.nome + '</a> üîç</div></td>';
            linhasPJ += '<td><a href="#" onclick="window.open(\'https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj=' + pj.cnpj + '\', \'popupCNPJ\', \'left=50,top=50,width=800,height=600,scrollbars=yes,resizable=yes\'); return false;" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Consultar CNPJ na Receita Federal">' + pj.cnpj + '</a> üîç</td>';
            linhasPJ += '<td><span class="connections">üîó ' + pj.conexoes + '</span></td>';
            linhasPJ += '<td>' + badgeSituacao + '</td>';
            linhasPJ += '<td></td>';
            linhasPJ += '<td><div class="restrictions">' + badgeRestricao + '</div></td>';
            linhasPJ += '</tr>';
        });


        // GERA LINHAS DE PE
        let linhasPE = '';
        pessoasEstrangeiras.forEach(function (pe) {
            const badgeSituacao = pe.situacao === 'ATIVA' 
                ? '<span class="badge badge-success">ATIVA</span>' 
                : '<span class="badge badge-danger">BAIXADA</span>';
            const badgeRestricao = pe.restricao 
                ? '<span class="badge badge-danger">' + pe.restricao + '</span>' 
                : '';
            const badgePais = pe.pais 
                ? '<span class="badge badge-info">' + pe.pais + '</span>' 
                : '';
            const coluna2 = pe.cnpj ? pe.cnpj : pe.endereco;
            
            linhasPE += '<tr>';
            linhasPE += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: ' + pe.nome + (pe.cnpj ? ' (CNPJ: ' + pe.cnpj + ')' : ' (Pessoa Estrangeira)')) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + pe.nome + '</a> üîç</div></td>';
            linhasPE += '<td>' + (pe.cnpj ? '<a href="#" onclick="window.open(\'https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj=' + pe.cnpj + '\', \'popupCNPJ\', \'left=50,top=50,width=800,height=600,scrollbars=yes,resizable=yes\'); return false;" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Consultar CNPJ na Receita Federal">' + pe.cnpj + '</a> üîç</td>' : coluna2) + '</td>';
            linhasPE += '<td><span class="connections">üîó ' + pe.conexoes + '</span></td>';
            linhasPE += '<td>' + badgeSituacao + '</td>';
            linhasPE += '<td>' + badgePais + '</td>';
            linhasPE += '<td><div class="restrictions">' + badgeRestricao + '</div></td>';
            linhasPE += '</tr>';
        });



        // GERA LINHAS DE EN
        let linhasEN = '';
        enderecos.forEach(function (en) {
            linhasEN += '<tr>';
            linhasEN += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: Endere√ßo ' + en.endereco) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + en.endereco + '</a> üîç</div></td>';
            linhasEN += '<td></td>';
            linhasEN += '<td><span class="connections">üîó ' + en.conexoes + '</span></td>';
            linhasEN += '<td></td>';
            linhasEN += '<td></td>';
            linhasEN += '<td></td>';
            linhasEN += '</tr>';
        });



        // GERA LINHAS DE TE
        let linhasTE = '';
        telefones.forEach(function (te) {
            linhasTE += '<tr>';
            linhasTE += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: Telefone ' + te.telefone) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + te.telefone + '</a> üîç</div></td>';
            linhasTE += '<td></td>';
            linhasTE += '<td><span class="connections">üîó ' + te.conexoes + '</span></td>';
            linhasTE += '<td></td>';
            linhasTE += '<td></td>';
            linhasTE += '<td></td>';
            linhasTE += '</tr>';
        });



        // GERA LINHAS DE EM
        let linhasEM = '';
        emails.forEach(function (em) {
            linhasEM += '<tr>';
            linhasEM += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: E-mail ' + em.email) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + em.email + '</a> üîç</div></td>';
            linhasEM += '<td></td>';
            linhasEM += '<td><span class="connections">üîó ' + em.conexoes + '</span></td>';
            linhasEM += '<td></td>';
            linhasEM += '<td></td>';
            linhasEM += '<td></td>';
            linhasEM += '</tr>';
        });


        // EXTRAI NOME, CEP E CONEX√ïES
        const pessoasFisicas = [];

        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('PF_')) return;

            // Remove o prefixo "PF_"
            const dados = id.substring(3);

            // CPF √© o primeiro bloco, nome vem depois
            const primeiroEspaco = dados.indexOf('-');
            if (primeiroEspaco === -1) return;

            const cpf = dados.substring(0, primeiroEspaco).trim();
            const nome = dados.substring(primeiroEspaco + 1).trim();

            // Conta conex√µes adjacentes
            const conexoes = network.getConnectedEdges(id).length;

            pessoasFisicas.push({
                id: id,
                nome: nome,
                cpf: cpf,
                conexoes: conexoes
            });
        });


        let linhasPF = '';
        pessoasFisicas.forEach(function (pf) {
            linhasPF += '<tr>';
            linhasPF += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: ' + pf.nome + ' (CPF: ' + pf.cpf + ')') + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + pf.nome + '</a> üîç</div></td>';
            linhasPF += '<td>' + pf.cpf + '</td>';
            linhasPF += '<td><span class="connections">üîó ' + pf.conexoes + '</span></td>';
            linhasPF += '<td></td>';
            linhasPF += '<td></td>';
            linhasPF += '<td></td>';
            linhasPF += '</tr>';
        });



        let html = "";

        html += '<!DOCTYPE html>';
        html += '<html lang="pt-BR">';
        html += '<head>';
        html += '    <meta charset="UTF-8">';
        html += '    <meta name="viewport" content="width=device-width, initial-scale=1.0">';
        html += '    <title>SINARC - N√≥s Selecionados</title>';
        html += '    <style>';
        html += '    * {';
        html += '    margin: 0;';
        html += '    padding: 0;';
        html += '    box-sizing: border-box;';
        html += '    }';
        html += '    body {';
        html += '        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;';
        html += '        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);';
        html += '        padding: 20px;';
        html += '        color: #2c3e50;';
        html += '    }';
        html += '    .container {';
        html += '        max-width: 1200px;';
        html += '        margin: 0 auto;';
        html += '        background: white;';
        html += '        border-radius: 12px;';
        html += '            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);';
        html += '            overflow: hidden;';
        html += '        }';
        html += '        .header {';
        html += '            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
        html += '            color: white;';
        html += '            padding: 20px 30px;';
        html += '        }';
        html += '        .header h1 {';
        html += '            font-size: 24px;';
        html += '            margin-bottom: 0px;';
        html += '        }';
        html += '        .toolbar {';
        html += '            padding: 20px 30px;';
        html += '            background: transparent;';
        html += '            border-bottom: none;';
        html += '            display: flex;';
        html += '            gap: 15px;';
        html += '            flex-wrap: wrap;';
        html += '            align-items: center;';
        html += '        }';
        html += '        .search-box {';
        html += '            flex: 1;';
        html += '            min-width: 250px;';
        html += '            position: relative;';
        html += '        }';
        html += '        .search-box input {';
        html += '            width: 100%;';
        html += '            padding: 10px 40px 10px 15px;';
        html += '            border: 2px solid #e9ecef;';
        html += '            border-radius: 8px;';
        html += '            font-size: 14px;';
        html += '            transition: all 0.3s;';
        html += '        }';
        html += '        .search-box input:focus {';
        html += '            outline: none;';
        html += '            border-color: #667eea;';
        html += '        }';
        html += '        .search-icon {';
        html += '            position: absolute;';
        html += '            right: 12px;';
        html += '            top: 50%;';
        html += '            transform: translateY(-50%);';
        html += '            color: #adb5bd;';
        html += '        }';
        html += '        .btn {';
        html += '        padding: 10px 20px;';
        html += '            border: none;';
        html += '            border-radius: 8px;';
        html += '            cursor: pointer;';
        html += '            font-size: 14px;';
        html += '            font-weight: 600;';
        html += '            transition: all 0.3s;';
        html += '            display: inline-flex;';
        html += '            align-items: center;';
        html += '            gap: 8px;';
        html += '        }';
        html += '        .btn-primary {';
        html += '            background: #667eea;';
        html += '            color: white;';
        html += '        }';
        html += '        .btn-primary:hover {';
        html += '            background: #5568d3;';
        html += '            transform: translateY(-2px);';
        html += '            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);';
        html += '        }';
        html += '        .btn-secondary {';
        html += '            background: #28a745;';
        html += '            color: white;';
        html += '        }';
        html += '        .btn-secondary:hover {';
        html += '            background: #218838;';
        html += '            transform: translateY(-2px);';
        html += '            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);';
        html += '        }';
        html += '        .content {';
        html += '            padding: 30px;';
        html += '        }';
        html += '        .node-section {';
        html += '            margin-bottom: 30px;';
        html += '        }';
        html += '        .table-wrapper {';
        html += '            overflow-x: auto;';
        html += '            -webkit-overflow-scrolling: touch;';
        html += '        }';
        html += '        .section-header {';
        html += '            display: flex;';
        html += '            align-items: center;';
        html += '            gap: 15px;';
        html += '            margin-bottom: 15px;';
        html += '            padding: 15px;';
        html += '            border-radius: 8px;';
        html += '            cursor: pointer;';
        html += '            transition: all 0.3s;';
        html += '            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);';
        html += '            border-left: 4px solid #667eea;';
        html += '        }';
        html += '        .section-header:hover {';
        html += '            transform: translateX(5px);';
        html += '        }';
        html += '        .section-header .icon {';
        html += '            width: 32px;';
        html += '            height: 32px;';
        html += '            object-fit: contain;';
        html += '            flex-shrink: 0;';
        html += '        }';
        html += '        @media (max-width: 768px) {';
        html += '            .section-header .icon {';
        html += '                width: 28px;';
        html += '                height: 28px;';
        html += '            }';
        html += '        }';
        html += '        .section-header .title {';
        html += '            flex: 1;';
        html += '        }';
        html += '        .section-header .title h2 {';
        html += '            font-size: 18px;';
        html += '            margin-bottom: 3px;';
        html += '        }';
        html += '        .section-header .title .count {';
        html += '            font-size: 12px;';
        html += '            opacity: 0.7;';
        html += '        }';
        html += '        .node-table {';
        html += '            width: 100%;';
        html += '            border-collapse: collapse;';
        html += '            margin-bottom: 20px;';
        html += '            display: none;';
        html += '            min-width: 1000px;';
        html += '        }';
        html += '        .node-table.show {';
        html += '            display: table;';
        html += '        }';
        html += '        .node-table {';
        html += '            table-layout: fixed;';
        html += '        }';
        html += '        .node-table th:nth-child(1),';
        html += '        .node-table td:nth-child(1) {';
        html += '            width: 40%;';
        html += '        }';
        html += '        .node-table th:nth-child(2),';
        html += '        .node-table td:nth-child(2) {';
        html += '            width: 15%;';
        html += '        }';
        html += '        .node-table th:nth-child(3),';
        html += '        .node-table td:nth-child(3) {';
        html += '            width: 10%;';
        html += '        }';
        html += '        .node-table th:nth-child(4),';
        html += '        .node-table td:nth-child(4) {';
        html += '            width: 10%;';
        html += '        }';
        html += '        .node-table th:nth-child(5),';
        html += '        .node-table td:nth-child(5) {';
        html += '            width: 15%;';
        html += '        }';
        html += '        .node-table th:nth-child(6),';
        html += '        .node-table td:nth-child(6) {';
        html += '            width: 10%;';
        html += '        }';
        html += '        .node-table thead {';
        html += '            background: #f8f9fa;';
        html += '        }';
        html += '        .node-table th {';
        html += '            padding: 12px;';
        html += '            text-align: left;';
        html += '            font-size: 12px;';
        html += '            font-weight: 600;';
        html += '            color: #6c757d;';
        html += '            text-transform: uppercase;';
        html += '            border-bottom: 2px solid #dee2e6;';
        html += '        }';
        html += '        .node-table th {';
        html += '            padding: 12px;';
        html += '            text-align: left;';
        html += '            font-size: 12px;';
        html += '            font-weight: 600;';
        html += '            color: #6c757d;';
        html += '            text-transform: uppercase;';
        html += '            border-bottom: 2px solid #dee2e6;';
        html += '        }';
        html += '        .node-table th.sortable {';
        html += '            cursor: pointer;';
        html += '            user-select: none;';
        html += '            position: relative;';
        html += '            padding-right: 25px;';
        html += '        }';
        html += '        .node-table th.sortable:hover {';
        html += '            background: #e9ecef;';
        html += '        }';
        html += '        .node-table th.sortable::after {';
        html += '            content: "‚áÖ";';
        html += '            position: absolute;';
        html += '            right: 8px;';
        html += '            opacity: 0.3;';
        html += '            font-size: 14px;';
        html += '        }';
        html += '        .node-table th.sortable.asc::after {';
        html += '            content: "‚ñ≤";';
        html += '            opacity: 1;';
        html += '            color: #667eea;';
        html += '        }';
        html += '        .node-table th.sortable.desc::after {';
        html += '            content: "‚ñº";';
        html += '            opacity: 1;';
        html += '            color: #667eea;';
        html += '        }';
        html += '        .node-table td {';
        html += '            padding: 12px;';
        html += '            border-bottom: 1px solid #f1f3f5;';
        html += '            font-size: 14px;';
        html += '        }';
        html += '        .node-table tbody tr:hover {';
        html += '            background: #f8f9fa;';
        html += '        }';
        html += '        .node-table tbody tr:nth-child(even) {';
        html += '            background: #fafbfc;';
        html += '        }';
        html += '        .badge {';
        html += '            display: inline-block;';
        html += '            padding: 4px 8px;';
        html += '            border-radius: 4px;';
        html += '            font-size: 11px;';
        html += '            font-weight: 600;';
        html += '            margin-right: 5px;';
        html += '            margin-bottom: 3px;';
        html += '        }';
        html += '        .badge-success {';
        html += '            background: #d4edda;';
        html += '            color: #155724;';
        html += '        }';
        html += '        .badge-danger {';
        html += '            background: #f8d7da;';
        html += '            color: #721c24;';
        html += '        }';
        html += '        .badge-warning {';
        html += '            background: #fff3cd;';
        html += '            color: #856404;';
        html += '        }';
        html += '        .badge-info {';
        html += '            background: #d1ecf1;';
        html += '            color: #0c5460;';
        html += '        }';
        html += '        .badge-secondary {';
        html += '            background: #e2e3e5;';
        html += '            color: #383d41;';
        html += '        }';
        html += '        .node-name {';
        html += '            font-weight: 600;';
        html += '            color: #2c3e50;';
        html += '        }';
        html += '        .node-id {';
        html += '            font-size: 11px;';
        html += '            color: #6c757d;';
        html += '            font-family: "Courier New", monospace;';
        html += '        }';
        html += '        .connections {';
        html += '            display: inline-flex;';
        html += '            align-items: center;';
        html += '            gap: 5px;';
        html += '            padding: 4px 10px;';
        html += '            background: #e7f3ff;';
        html += '            border-radius: 12px;';
        html += '            font-size: 12px;';
        html += '            color: #0066cc;';
        html += '            font-weight: 600;';
        html += '        }';
        html += '        .restrictions {';
        html += '            display: flex;';
        html += '            flex-wrap: wrap;';
        html += '            gap: 5px;';
        html += '        }';
        html += '        .collapse-icon {';
        html += '            transition: transform 0.3s;';
        html += '        }';
        html += '        .collapse-icon.rotated {';
        html += '            transform: rotate(180deg);';
        html += '        }';
        html += '</style>';
        html += '</head>';

        html += '<body>';
        html += '<div class="container">';
        html += '<div class="header">';
        html += '<h1>üîç ' + totalSelecionados + ' ' + textoNos + '</h1>';
        html += '</div>';
        html += '<div class="toolbar">';
        html += '            <div class="search-box">';
        html += '                <input type="text" id="searchInput" placeholder="üîé Buscar por nome, CPF, CNPJ...">';
        html += '                <span class="search-icon">‚åï</span>';
        html += '            </div>';
        html += '            <button class="btn btn-secondary" onclick="salvarArquivo()">';
        html += '                üíæ Salvar Relat√≥rio';
        html += '            </button>';
        html += '        </div>';
        html += '<div class="content">';
        
        html += '    <div class="node-section">';
        html += '        <div class="section-header" onclick="toggleSection(\'pf\')">';
        html += '            <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/pf_homem.png" alt="Pessoa F√≠sica" class="icon">';
        html += '            <div class="title">';
        html += '                <h2>' + totalPF +  ' ' + textoNosPF + '</h2>';
        html += '            </div>';
        html += '            <span class="collapse-icon" id="icon-pf">‚ñº</span>';
        html += '        </div>';
        html += '        <div class="table-wrapper">';
        html += '            <table class="node-table show" id="table-pf">';
        html += '                <thead>';
        html += '                    <tr>';
        html += '                        <th>Nome</th>';
        html += '                        <th>CPF</th>';
        html += '                        <th>Conex√µes</th>';
        html += '                        <th></th>';
        html += '                        <th></th>';
        html += '                        <th></th>';
        html += '                    </tr>';
        html += '                </thead>';
        html += '                <tbody>';
        html +=                      linhasPF;
        html += '                </tbody>';
        html += '            </table>';
        html += '        </div>';
        html += '    </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'pj\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/pj_brasil_ativa.png" alt="Pessoa Jur√≠dica" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalPJ + ' ' + textoPJ + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-pj">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-pj">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Raz√£o Social</th>';
        html += '                                <th>CNPJ</th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th>Situa√ß√£o</th>';
        html += '                                <th>Pa√≠s</th>';
        html += '                                <th>Restri√ß√µes</th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasPJ;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'pe\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/pj_exterior_ativa.png" alt="Pessoa Estrangeira" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalPE + ' ' + textoPE + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-pe">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-pe">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Raz√£o Social</th>';
        html += '                                <th>CNPJ</th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th>Situa√ß√£o</th>';
        html += '                                <th>Pa√≠s</th>';
        html += '                                <th>Restri√ß√µes</th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasPE;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'en\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/endereco.png" alt="Endere√ßo" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalEN + ' ' + textoEN + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-en">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-en">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Endere√ßo</th>';
        html += '                                <th></th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasEN;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'te\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/telefone.png" alt="Telefone" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalTE + ' ' + textoTE + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-te">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-te">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Telefone</th>';
        html += '                                <th></th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasTE;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'em\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/email.png" alt="E-mail" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalEM + ' ' + textoEM + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-em">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-em">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>E-mail</th>';
        html += '                                <th></th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasEM;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        html += '        </div>';
        html += '    </div>';

        html += '<scr' + 'ipt>';
        html += '        function toggleSection(type) {';
        html += '            const table = document.getElementById(`table-${type}`);';
        html += '            const icon = document.getElementById(`icon-${type}`);';
        html += '            table.classList.toggle("show");';
        html += '            icon.classList.toggle("rotated");';    
        html += '        }';
        html += '        function salvarArquivo() {';
        html += '            const conteudoHTML = document.documentElement.outerHTML;';
        html += '            const blob = new Blob([conteudoHTML], { type: "text/html;charset=utf-8" });';
        html += '            const url = URL.createObjectURL(blob);';
        html += '            const link = document.createElement("a");';
        html += '            link.href = url;';
        html += '            const agora = new Date();';
        html += '            const dataHora = agora.getFullYear() + "-" + String(agora.getMonth() + 1).padStart(2, "0") + "-" + String(agora.getDate()).padStart(2, "0") + "_" + String(agora.getHours()).padStart(2, "0") + "-" + String(agora.getMinutes()).padStart(2, "0");';
        html += '            link.download = "SINARC_Relatorio_" + dataHora + ".html";';
        html += '            document.body.appendChild(link);';
        html += '            link.click();';
        html += '            document.body.removeChild(link);';
        html += '            URL.revokeObjectURL(url);';
        html += '        }';
        html += '        document.getElementById("searchInput").addEventListener("input", function(e) {';
        html += '            const searchTerm = e.target.value.toLowerCase();';
        html += '            const tables = document.querySelectorAll(".node-table");';
        html += '            tables.forEach(table => {';
        html += '                const rows = table.querySelectorAll("tbody tr");';
        html += '                rows.forEach(row => {';
        html += '                    const text = row.textContent.toLowerCase();';
        html += '                    row.style.display = text.includes(searchTerm) ? "" : "none";';
        html += '                });';
        html += '            });';
        html += '        });';
        html += '        function tornarColunasOrdenaveis() {';
        html += '            const tabelas = document.querySelectorAll(".node-table");';
        html += '            tabelas.forEach(tabela => {';
        html += '                const cabecalhos = tabela.querySelectorAll("thead th");';
        html += '                cabecalhos.forEach((th, index) => {';
        html += '                    if (th.textContent.trim() !== "") {';
        html += '                        th.classList.add("sortable");';
        html += '                        th.addEventListener("click", function() {';
        html += '                            ordenarTabela(tabela, index);';
        html += '                        });';
        html += '                    }';
        html += '                });';
        html += '            });';
        html += '        }';
        html += '        function ordenarTabela(tabela, colunaIndex) {';
        html += '            const tbody = tabela.querySelector("tbody");';
        html += '            const linhas = Array.from(tbody.querySelectorAll("tr"));';
        html += '            const cabecalhos = tabela.querySelectorAll("thead th");';
        html += '            const cabecalhoAtual = cabecalhos[colunaIndex];';
        html += '            let ordemAtual = "none";';
        html += '            if (cabecalhoAtual.classList.contains("asc")) ordemAtual = "asc";';
        html += '            if (cabecalhoAtual.classList.contains("desc")) ordemAtual = "desc";';
        html += '            cabecalhos.forEach(th => th.classList.remove("asc", "desc"));';
        html += '            let novaOrdem = ordemAtual === "asc" ? "desc" : "asc";';
        html += '            cabecalhoAtual.classList.add(novaOrdem);';
        html += '            linhas.sort(function(a, b) {';
        html += '                const celulaA = a.cells[colunaIndex];';
        html += '                const celulaB = b.cells[colunaIndex];';
        html += '                if (!celulaA || !celulaB) return 0;';
        html += '                let valorA = celulaA.querySelector(".node-name")';
        html += '                    ? celulaA.querySelector(".node-name").textContent';
        html += '                    : celulaA.querySelector(".connections")';
        html += '                        ? celulaA.querySelector(".connections").textContent';
        html += '                        : celulaA.textContent;';
        html += '                let valorB = celulaB.querySelector(".node-name")';
        html += '                    ? celulaB.querySelector(".node-name").textContent';
        html += '                    : celulaB.querySelector(".connections")';
        html += '                        ? celulaB.querySelector(".connections").textContent';
        html += '                        : celulaB.textContent;';
        html += '                valorA = valorA.trim();';
        html += '                valorB = valorB.trim();';
        html += '                const numA = parseFloat(valorA.replace(/[^\\d.-]/g, ""));';
        html += '                const numB = parseFloat(valorB.replace(/[^\\d.-]/g, ""));';
        html += '                let resultado;';
        html += '                if (!isNaN(numA) && !isNaN(numB)) {';
        html += '                    resultado = numA - numB;';
        html += '                } else {';
        html += '                    resultado = valorA.localeCompare(valorB, "pt-BR", { sensitivity: "base" });';
        html += '                }';
        html += '                return novaOrdem === "asc" ? resultado : -resultado;';
        html += '            });';
        html += '            linhas.forEach(function(linha) { tbody.appendChild(linha); });';
        html += '        }';
        html += '        function ordenarTabelas() {';
        html += '            const tabelas = document.querySelectorAll(".node-table tbody");';
        html += '            tabelas.forEach(tbody => {';
        html += '                const linhas = Array.from(tbody.querySelectorAll("tr"));';
        html += '                if (linhas.length === 0) return;';
        html += '                linhas.sort((a, b) => {';
        html += '                    const aNomeEl = a.querySelector(".node-name");';
        html += '                    const bNomeEl = b.querySelector(".node-name");';
        html += '                    if (!aNomeEl || !bNomeEl) return 0;';
        html += '                    const nomeA = aNomeEl.textContent.trim().toUpperCase();';
        html += '                    const nomeB = bNomeEl.textContent.trim().toUpperCase();';
        html += '                    return nomeA.localeCompare(nomeB, "pt-BR");';
        html += '                });';
        html += '                linhas.forEach(linha => tbody.appendChild(linha));';
        html += '            });';
        html += '        }';
        html += '        window.addEventListener("DOMContentLoaded", function() {';
        html += '            ordenarTabelas();';
        html += '            tornarColunasOrdenaveis();';
        html += '        });';
        html += '</scr' + 'ipt>';
        html += '</body>';
        html += '</html>'

        const janela = window.open(
            'about:blank',
            '_blank',
            'width=1200,height=800,scrollbars=yes,resizable=yes'
        );

        //console.log(html);

        // Escrever HTML na janela
        janela.document.open();
        janela.document.write(html);
        janela.document.close();
    }

    window.gerarRelatorio = gerarRelatorio;

    const selectedNodes_2 = network.getSelectedNodes();
    const totalSelecionados = selectedNodes_2.length;
    const textoNos = totalSelecionados === 1 ? 'N√ì SELECIONADO' : 'N√ìS SELECIONADOS';

</script>







</body>)     -->
    <!-- ===================================================== -->

    <style>
    /* Estilos do Menu Suspenso SINARC */
    #sinarc-menu-container {
        position: fixed;
        top: 30px;
        left: 21px;
        z-index: 10000;
        font-family: Arial, sans-serif;
    }

    #sinarc-menu-toggle {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(89, 201, 67, 0.6);
        border-radius: 4px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        font-size: 20px;
        color: #555;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #sinarc-menu-toggle:hover {
        background: rgba(89, 201, 67, 0.15);
        border-color: rgba(89, 201, 67, 0.9);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    #sinarc-menu-dropdown {
        display: none;
        position: fixed;
        top: 70px !important;
        left: 21px !important;
        background: rgba(255, 255, 255, 0.97);
        border: 2px solid rgba(89, 201, 67, 1);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        min-width: 300px;
        max-height: calc(100vh - 85px) !important;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #sinarc-menu-dropdown.show {
        display: block;
    }

    .menu-category {
        border-bottom: 1px solid rgba(200, 200, 200, 0.5);
    }

    .menu-category:last-child {
        border-bottom: none;
    }

    .category-header {
        background: linear-gradient(to right, rgba(89, 201, 67, 0.15), rgba(89, 201, 67, 0.05));
        padding: 10px 15px;
        font-weight: bold;
        font-size: 13px;
        color: #2c5f2d;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s ease;
    }

    .category-header:hover {
        background: linear-gradient(to right, rgba(89, 201, 67, 0.25), rgba(89, 201, 67, 0.1));
    }

    .category-header .arrow {
        font-size: 12px;
        transition: transform 0.3s ease;
    }

    .category-header.expanded .arrow {
        transform: rotate(90deg);
    }

    .category-items {
        display: none;
        background: rgba(255, 255, 255, 0.5);
    }

    .category-items.show {
        display: block;
    }

    .menu-item {
        padding: 8px 15px 8px 30px;
        font-size: 12px;
        border-bottom: 1px solid rgba(230, 230, 230, 0.5);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .menu-item:last-child {
        border-bottom: none;
    }

    .menu-item:hover {
        background: rgba(89, 201, 67, 0.1);
        padding-left: 35px;
    }

    .menu-item:active {
        background: rgba(89, 201, 67, 0.3);
    }

    .menu-item .key {
        display: inline-block;
        background: rgba(89, 201, 67, 0.3);
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 11px;
        min-width: 70px;
        text-align: center;
        margin-right: 10px;
        color: #2c5f2d;
        font-family: 'Consolas', 'Courier New', monospace; /* <-- FONTE DAS LETRAS DO BOT√ÉO */
    }

    .menu-item .description {
        color: #555;
        font-size: 11px;
    }

    .menu-search {
        padding: 10px;
        border-bottom: 2px solid rgba(89, 201, 67, 0.3);
    }

    .menu-search input {
        width: 100%;
        padding: 8px;
        border: 1px solid rgba(200, 200, 200, 0.8);
        border-radius: 5px;
        font-size: 12px;
        box-sizing: border-box;
    }

    .menu-search input:focus {
        outline: none;
        border-color: rgba(89, 201, 67, 1);
    }

    /* Scrollbar personalizada */
    #sinarc-menu-dropdown::-webkit-scrollbar {
        width: 8px;
    }

    #sinarc-menu-dropdown::-webkit-scrollbar-track {
        background: rgba(240, 240, 240, 0.5);
        border-radius: 4px;
    }

    #sinarc-menu-dropdown::-webkit-scrollbar-thumb {
        background: rgba(89, 201, 67, 0.5);
        border-radius: 4px;
    }

    #sinarc-menu-dropdown::-webkit-scrollbar-thumb:hover {
        background: rgba(89, 201, 67, 0.8);
    }

    .menu-item.hidden {
        display: none;
    }

    .menu-note {
        padding: 8px 15px;
        font-size: 10px;
        color: #777;
        font-style: italic;
        background: rgba(255, 255, 200, 0.3);
    }

    /* Oculta campo de busca */
    .menu-search {
        display: none !important;
    }

    </style>

    <div id="sinarc-menu-container">
        <div id="sinarc-menu-toggle" title="Comandos do SINARC">‚å®</div>
        <div id="sinarc-menu-dropdown">
            
            <!-- Campo de Busca -->
            <div class="menu-search">
                <input type="text" id="menu-search-input" placeholder="üîç Buscar comando..." autocomplete="off">
            </div>

            <!-- 1. CONTROLES B√ÅSICOS E NAVEGA√á√ÉO -->
            <div class="menu-category">
                <div class="category-header" data-category="basicos">
                    <span>üéÆ Controles B√°sicos</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="basicos">
            
                    <div class="menu-item" data-key="s" title="Consulta livre por CNPJ, raz√£o social, nome de fantasia ou CPF (n√£o gera alvo com destaque em vermelho)">
                        <span class="key">s</span>
                        <span class="description">Consulta na base de dados</span>
                    </div>
                    <div class="menu-item" data-key="o" title="Abre n√≥s selecionados (n√≥s-alvos) em n camadas">
                        <span class="key">o</span>
                        <span class="description">Abre n√≥s selecionados (alvos)</span>
                    </div>
                    <div class="menu-item" data-key="O" title="Abre matriz e filiais da PJ selecionada">
                        <span class="key">Shift + o</span>
                        <span class="description">Abre matriz e filiais</span>
                    </div>
                    <div class="menu-item" data-key="p" title="Pausa/retoma intera√ß√£o gravitacional entre os n√≥s">
                        <span class="key">p</span>
                        <span class="description">Pausa movimentos dos n√≥s</span>
                    </div>              
                    <div class="menu-item" data-key="A" title="Seleciona todos os n√≥s">
                        <span class="key">Shift + a</span>
                        <span class="description">Seleciona todos os n√≥s</span>
                    </div>
                     <div class="menu-item" data-key="Q" title="Seleciona apenas n√≥s-alvos (bordas vermelhas)">
                        <span class="key">Shift + q</span>
                        <span class="description">Seleciona n√≥s-alvos</span>
                    </div>
                    <div class="menu-item" data-function="selecionaAreaLivre" title="Desenha uma √°rea livre para selecionar n√≥s">
                        <span class="key">‚úèÔ∏è</span>
                        <span class="description">Seleciona √°rea livre</span>
                    </div>
                    <div class="menu-item" data-function="gerarRelatorio" title="Gera relat√≥rio dos n√≥s selecionados">
                        <span class="key">üìã</span>
                        <span class="description">Abre relat√≥rio n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-function="gerarMapaDoGrafo" title="Exibe no mapa os endere√ßos das PJ selecionadas (n√£o inclui PE)">
                        <span class="key">üìå</span>
                        <span class="description">Exibe no mapa endere√ßos PJ </span>
                    </div>
                    <div class="menu-item" data-function="exportarGrafoParaPDF" title="Exporta estrutura de dados JSON do grafo (n√≥s e arestas) em formato PDF para an√°lise com IA">
                        <span class="key">‚¨ÜÔ∏è</span>
                        <span class="description">Exporta estrutura em PDF</span>
                    </div>
                    <div class="menu-item" data-function="exibirSistemasIA" title="Sistemas de Intelig√™ncia Artificial para an√°lise de grafos">
                        <span class="key">ü§ñ</span>
                        <span class="description">Sistemas de IA</span>
                    </div>
                    <div class="menu-item" data-key="h" title="Abre manual do SINARC no navegador">
                        <span class="key">h</span>
                        <span class="description">Abre manual SINARC</span>
                    </div>
                    <div class="menu-item" data-key="f" title="Fixa/libera n√≥s selecionados">
                        <span class="key">f</span>
                        <span class="description">Fixa n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="|" title="Ativa/desativa o modo de captura">
                        <span class="key">|</span>
                        <span class="description">Modo de captura</span>
                    </div>
                    <div class="menu-item" data-key="F5" title="Recarrega grafo em uma posi√ß√£o aleat√≥ria (apenas tecla f√≠sica)">
                        <span class="key">F5</span>
                        <span class="description">Recarrega grafo (tecla f√≠sica)</span>
                    </div>
                    <div class="menu-item" data-key="F11" title="Ativa/desativa modo tela cheia (apenas tecla f√≠sica)">
                        <span class="key">F11</span>
                        <span class="description">Modo tela cheia (tecla f√≠sica)</span>
                    </div>
                    <div class="menu-item" data-key="Escape" title="Centraliza grafo na tela (mesmo que duplo clique na √°rea vazia do grafo)">
                        <span class="key">ESC</span>
                        <span class="description">Centraliza grafo</span>
                    </div>        
                </div>
            </div>

            <!-- 2. LAYOUTS E VISUALIZA√á√ÉO -->
            <div class="menu-category">
                <div class="category-header" data-category="layout">
                    <span>üëÅ Layouts e Visualiza√ß√£o</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="layout">
                    <div class="menu-item" data-key="k" title="Alterna layouts: gravitacional ‚Üí hier√°rquico folhas ‚Üí hier√°rquico ra√≠zes (3 op√ß√µes c√≠clicas)">
                        <span class="key">k</span>
                        <span class="description">Alterna layouts</span>
                    </div>
                    <div class="menu-item" data-key="K" title="Ativa/desativa layout circular (2 op√ß√µes c√≠clicas)">
                        <span class="key">Shift + k</span>
                        <span class="description">Layout circular</span>
                    </div>
                    <div class="menu-item" data-key="e" title="Alterna tamanho dos n√≥s e exibi√ß√£o de seus r√≥tulos (7 op√ß√µes c√≠clicas)">
                        <span class="key">e</span>
                        <span class="description">Tamanho e r√≥tulos dos n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="l" title="Alterna exibi√ß√£o das arestas e de seus r√≥tulos (3 op√ß√µes c√≠clicas)">
                        <span class="key">l</span>
                        <span class="description">R√≥tulos das arestas</span>
                    </div>
                    <div class="menu-item" data-key="t" title="Modo transpar√™ncia por tipos de n√≥s (15 op√ß√µes c√≠clicas, F5 para reset)">
                        <span class="key">t</span>
                        <span class="description">Transpar√™ncia por tipos de n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="T" title="Modo transpar√™ncia por conex√µes (hover mostra adjacentes, F5 para reset)">
                        <span class="key">Shift + t</span>
                        <span class="description">Transpar√™ncia por conex√µes</span>
                    </div>
                    <div class="menu-item" data-key="z" title="Ativa modo de navega√ß√£o autom√°tica pelos n√≥s">
                        <span class="key">z</span>
                        <span class="description">Visualiza√ß√£o autom√°tica</span>
                    </div>
                    <div class="menu-item" data-key="b" title="Ajusta altura da janela de visualiza√ß√£o (elimina barra de rolagem vertical)">
                        <span class="key">b</span>
                        <span class="description">Ajusta altura da janela</span>
                    </div>
                </div>
            </div>

            <!-- 3. SELE√á√ÉO DE N√ìS -->
            <div class="menu-category">
                <div class="category-header" data-category="selecao">
                    <span>üéØ Sele√ß√£o de N√≥s</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="selecao">
                    <div class="menu-item" data-key="a" title="Amplia sele√ß√£o para n√≥s adjacentes">
                        <span class="key">a</span>
                        <span class="description">N√≥s adjacentes</span>
                    </div>
                    <div class="menu-item" data-key="A" title="Seleciona todos os n√≥s">
                        <span class="key">Shift + a</span>
                        <span class="description">Todos os n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="c" title="Centraliza n√≥s selecionados e adjacentes">
                        <span class="key">c</span>
                        <span class="description">Centraliza sele√ß√£o</span>
                    </div>
                    <div class="menu-item" data-key="i" title="Alterna entre n√≥s selecionados">
                        <span class="key">i</span>
                        <span class="description">Alterna entre n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="I" title="Inverte sele√ß√£o dos n√≥s">
                        <span class="key">Shift + i</span>
                        <span class="description">Inverte sele√ß√£o</span>
                    </div>
                    <div class="menu-item" data-key="j" title="Seleciona n√≥s adjacentes comuns aos n√≥s selecionados (m√≠nimo 2 n√≥s)">
                        <span class="key">j</span>
                        <span class="description">N√≥s comuns</span>
                    </div>
                    <div class="menu-item" data-key="J" title="Seleciona n√≥s n√£o comuns (m√≠nimo 2 n√≥s)">
                        <span class="key">Shift + j</span>
                        <span class="description">N√≥s n√£o comuns</span>
                    </div>
                    <div class="menu-item" data-key="q" title="Localiza n√≥s no grafo pelos r√≥tulos e IDs (ENTER para localizar por arestas)">
                        <span class="key">q</span>
                        <span class="description">Localiza n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="Q" title="Seleciona apenas n√≥s-alvos (bordas vermelhas)">
                        <span class="key">Shift + q</span>
                        <span class="description">Seleciona n√≥s-alvos</span>
                    </div>
                    <div class="menu-item" data-key="√ß" title="Seleciona endere√ßos (EN), telefones (TE) e e-mails (EM) de forma cumulativa pelo n¬∫ de conex√µes">
                        <span class="key">√ß</span>
                        <span class="description">EN/TE/EM por conex√µes</span>
                    </div>
                    <div class="menu-item" data-key="Shift + √ß" title="Seleciona n√≥s por n√∫mero de conex√µes">
                        <span class="key">Shift + √ß</span>
                        <span class="description">N√≥s por n¬∫ de conex√µes</span>
                    </div>
                    <div class="menu-item" data-key="." title="Alterna sele√ß√£o por tipo de imagem (15 op√ß√µes c√≠clicas)">
                        <span class="key">.</span>
                        <span class="description">N√≥s por tipo de imagem</span>
                    </div>
                    <div class="menu-item" data-key=";" title="Alterna sele√ß√£o dos n√≥s adjacentes por origem/destino das arestas (3 op√ß√µes c√≠clicas)">
                        <span class="key">;</span>
                        <span class="description">N√≥s por origem/destino</span>
                    </div>
                    <div class="menu-item" data-key="/" title="Seleciona n√≥s acrescidos na √∫ltima consulta ao banco de dados">
                        <span class="key">/</span>
                        <span class="description">N√≥s da √∫ltima consulta</span>
                    </div>
                    <div class="menu-item" data-key="," title="Exibe rela√ß√£o de n√≥s selecionados em nova janela do navegador">
                        <span class="key">,</span>
                        <span class="description">Exibe n√≥s selecionados</span>
                    </div>
                </div>
            </div>

            <!-- 4. MASSA E TAMANHO DOS N√ìS -->
            <div class="menu-category">
                <div class="category-header" data-category="massa">
                    <span>‚öñ Massa e Tamanho</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="massa">
                    <div class="menu-item" data-key="m" title="Aumenta massa de todos os n√≥s (+0.5)">
                        <span class="key">m</span>
                        <span class="description">+ massa todos n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="M" title="Diminui massa de todos os n√≥s (-0.5)">
                        <span class="key">Shift + m</span>
                        <span class="description">- massa todos n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="n" title="Aumenta massa dos n√≥s ‚â• tamanho ref (+5) - padr√£o 40">
                        <span class="key">n</span>
                        <span class="description">+ massa n√≥s grandes</span>
                    </div>
                    <div class="menu-item" data-key="N" title="Diminui massa dos n√≥s ‚â• tamanho ref (-5) - padr√£o 40">
                        <span class="key">Shift + n</span>
                        <span class="description">- massa n√≥s grandes</span>
                    </div>
                    <div class="menu-item" data-key=" " title="Aumenta massa dos n√≥s de forma proporcional ao seu tamanho (c√≠clico) - do maior para o menor tamanho">
                        <span class="key">ESPA√áO</span>
                        <span class="description">+ massa n√≥s proporcional</span>
                    </div>
                    <div class="menu-item" data-key="]" title="Aumenta massa dos n√≥s selecionados (+5)">
                        <span class="key">]</span>
                        <span class="description">+ massa n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="[" title="Diminui massa dos n√≥s selecionados (-5)">
                        <span class="key">[</span>
                        <span class="description">- massa n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="Shift + ArrowUp" title="Aumenta tamanho de refer√™ncia dos n√≥s (+5) - padr√£o 40">
                        <span class="key">Shift + Seta ‚Üë</span>
                        <span class="description">+ tamanho refer√™ncia n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="Shift + ArrowDown" title="Diminui tamanho de refer√™ncia dos n√≥s (-5) - padr√£o 40">
                        <span class="key">Shift + Seta ‚Üì</span>
                        <span class="description">- tamanho refer√™ncia n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="Shift + ArrowRight" title="Aumenta comprimento das arestas (+30) - padr√£o 300">
                        <span class="key">Shift + Seta ‚Üí</span>
                        <span class="description">+ comprimento arestas</span>
                    </div>
                    <div class="menu-item" data-key="Shift + ArrowLeft" title="Aumenta comprimento das arestas (-30) - padr√£o 300">
                        <span class="key">Shift + Seta ‚Üê</span>
                        <span class="description">- comprimento arestas</span>
                    </div>
                </div>
            </div>

            <!-- 5. AN√ÅLISE E COMUNIDADES -->
            <div class="menu-category">
                <div class="category-header" data-category="analise">
                    <span>üîó An√°lise e Comunidades</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="analise">
                    <div class="menu-item" data-key="u" title="Medidas de centralidade do grafo">
                        <span class="key">u</span>
                        <span class="description">Medidas de centralidade</span>
                    </div>
                    <div class="menu-item" data-key="U" title="Distribui√ß√£o de n√≥s por tamanho">
                        <span class="key">Shift + u</span>
                        <span class="description">Distribui√ß√£o n√≥s por tamanhos</span>
                    </div>
                    <div class="menu-item" data-key="L" title="Distribui√ß√£o de arestas por tipo">
                        <span class="key">Shift + l</span>
                        <span class="description">Distribui√ß√£o arestas por tipo</span>
                    </div>
                    <div class="menu-item" data-key="v" title="Destaca comunidades com cores">
                        <span class="key">v</span>
                        <span class="description">Destaca comunidades</span>
                    </div>
                    <div class="menu-item" data-key="V" title="Exibe n√≥s por comunidade (F5 para reset)">
                        <span class="key">Shift + v</span>
                        <span class="description">Exibe n√≥s por comunidade</span>
                    </div>
                    <div class="menu-item" data-key="w" title="Colore n√≥s da cadeia hier√°rquica">
                        <span class="key">w</span>
                        <span class="description">Destaca cadeia hier√°rquica</span>
                    </div>
                    <div class="menu-item" data-key="W" title="Deleta n√≥s fora da cadeia hier√°rquica (F5 para reset)">
                        <span class="key">Shift + w</span>
                        <span class="description">Isola cadeia hier√°rquica</span>
                    </div>
                    <div class="menu-item" data-key="x" title="Adiciona cores sequenciais aos n√≥s selecionados (4 cores)">
                        <span class="key">x</span>
                        <span class="description">Adiciona cores n√≥s</span>
                    </div>
                    <div class="menu-item" data-key="X" title="Remove cores de todos os n√≥s">
                        <span class="key">Shift + x</span>
                        <span class="description">Remove cores n√≥s</span>
                    </div>
                </div>
            </div>

            <!-- 6. EXCLUS√ÉO E FILTRAGEM -->
            <div class="menu-category">
                <div class="category-header" data-category="exclusao">
                    <span>‚úÇ Exclus√£o e Filtragem</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="exclusao">
                    <div class="menu-item" data-key="Delete" title="Deleta n√≥s selecionados (F5 para reset)">
                        <span class="key">Delete</span>
                        <span class="description">Deleta n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="Backspace" title="Mesmo que Delete (para celular)">
                        <span class="key">Backspace</span>
                        <span class="description">Deleta n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="r" title="Deleta n√≥s N√ÉO selecionados (F5 para reset)">
                        <span class="key">r</span>
                        <span class="description">Deleta n√≥s n√£o selecionados</span>
                    </div>
                    <div class="menu-item" data-key="R" title="Isola n√≥s com arestas coloridas (F5 para reset)">
                        <span class="key">Shift + r</span>
                        <span class="description">Isola n√≥s com arestas coloridas</span>
                    </div>
                </div>
            </div>

            <!-- 7. CONSULTAS E PESQUISAS -->
            <div class="menu-category">
                <div class="category-header" data-category="consultas">
                    <span>üîç Consultas e Pesquisas</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="consultas">
                    <div class="menu-item" data-key="d" title="Detalhes sobre os n√≥s em sites externos (exceto TE)">
                        <span class="key">d</span>
                        <span class="description">Sites externos</span>
                    </div>
                    <div class="menu-item" data-key="D" title="Pesquisa em DOU, DIO-ES, DOM-ES, etc">
                        <span class="key">Shift + d</span>
                        <span class="description">Pesquisa di√°rios</span>
                    </div>
                    <div class="menu-item" data-key="g" title="Pesquisa geral no Google (exceto TE)">
                        <span class="key">g</span>
                        <span class="description">Pesquisa geral Google</span>
                    </div>
                    <div class="menu-item" data-key="G" title="Pesquisa avan√ßada no Google (dom√≠nios oficiais)">
                        <span class="key">Shift + g</span>
                        <span class="description">Pesquisa avan√ßada Google</span>
                    </div>
                    <div class="menu-item" data-key="1" title="Comprovante de inscri√ß√£o no CNPJ (RFB)">
                        <span class="key">1</span>
                        <span class="description">Comprovante CNPJ</span>
                    </div>
                    <div class="menu-item" data-key="2" title="San√ß√µes CGU (CEIS, CNEP, CEPIM, Acordos de Leni√™ncia)">
                        <span class="key">2</span>
                        <span class="description">San√ß√µes CGU</span>
                    </div>
                    <div class="menu-item" data-key="5" title="Abre site do Rede CNPJ">
                        <span class="key">5</span>
                        <span class="description">Site Rede CNPJ</span>
                    </div>
                    <div class="menu-item" data-key="6" title="Bases de dados prim√°rias (CNPJ, San√ß√µes, D√≠vida Ativa Uni√£o, PEP)">
                        <span class="key">6</span>
                        <span class="description">Bases prim√°rias</span>
                    </div>
                    <div class="menu-item" data-key="7" title="Detalhes JSON do CNPJ">
                        <span class="key">7</span>
                        <span class="description">CNPJ no formato JSON</span>
                    </div>
                    <div class="menu-item" data-key="8" title="API Compras Governamentais">
                        <span class="key">8</span>
                        <span class="description">Compras Gov Federal</span>
                    </div>
                    <div class="menu-note">‚ö†Ô∏è Comandos 1, 2, 5, 7 e 8 requerem n√≥ selecionado</div>
                </div>
            </div>

            <!-- 8. BANCO DE DADOS (consultas ao vivo) -->
            <div class="menu-category">
                <div class="category-header" data-category="bd">
                    <span>üíæ Banco de Dados</span>
                    <span class="arrow">‚ñ∂</span>
                </div>
                <div class="category-items" data-category="bd">
                    <div class="menu-item" data-key="s" title="Consulta livre por CNPJ, raz√£o social, nome de fantasia ou CPF (sem destaque vermelho)">
                        <span class="key">s</span>
                        <span class="description">Consulta livre</span>
                    </div>
                    <div class="menu-item" data-key="S" title="Abre n√≥s selecionados em 1 camada (sem destaque vermelho)">
                        <span class="key">Shift + s</span>
                        <span class="description">Abre n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="o" title="Abre n√≥s selecionados (n√≥s-alvos) em n camadas">
                        <span class="key">o</span>
                        <span class="description">Abre n√≥s selecionados</span>
                    </div>
                    <div class="menu-item" data-key="O" title="Abre matriz e filiais do n√≥ selecionado (apenas PJ)">
                        <span class="key">Shift + o</span>
                        <span class="description">Abre matriz e filiais</span>
                    </div>
                    <div class="menu-item" data-key="+" title="Adiciona n√≥s selecionados √† lista de alvos ou exibe os n√≥s armazenados">
                        <span class="key">+</span>
                        <span class="description">Inclui n√≥s √† lista de alvos</span>
                    </div>
                    <div class="menu-item" data-key="-" title="Remove √∫ltimo n√≥ da lista de alvos">
                        <span class="key">-</span>
                        <span class="description">Exclui n√≥s da lista de alvos</span>
                    </div>
                    <div class="menu-item" data-key="y" title="Abre lista de alvos acumulados">
                        <span class="key">y</span>
                        <span class="description">Abre lista de alvos</span>
                    </div>
                    <div class="menu-item" data-key="4" title="Gera arquivo Excel com n√≥s e arestas">
                        <span class="key">4</span>
                        <span class="description">Gera arquivo Excel</span>
                    </div>
                    <div class="menu-item" data-key="|" title="Ativa/desativa o modo de captura">
                        <span class="key">|</span>
                        <span class="description">Modo de captura</span>
                    </div>
                    <div class="menu-item" data-key="9" title="Baixa objetos JSON do vis.js (nodes.json e edges.json) contendo exclus√µes e altera√ß√µes de massa dos n√≥s. Salve-os na pasta 'sinarc-main'">
                        <span class="key">9</span>
                        <span class="description">Baixa arquivos JSON</span>
                    </div>
                    <div class="menu-item" data-key="!" title="Gera novo arquivo HTML (grafo_final_atualizado.html) a partir dos arquivos JSON (nodes.json e edges.json).">
                        <span class="key">!</span>
                        <span class="description">Gera arquivo HTML atualizado</span>
                    </div>
                    <div class="menu-note">‚ö†Ô∏è Requer SINARC em execu√ß√£o no computador</div>
                </div>
            </div>

        </div>
    </div>




    <script>
    // JavaScript para controlar o menu suspenso com HOVER autom√°tico e simula√ß√£o de teclas
    (function() {
        const menuToggle = document.getElementById('sinarc-menu-toggle');
        const menuDropdown = document.getElementById('sinarc-menu-dropdown');
        const categoryHeaders = document.querySelectorAll('.category-header');
        const searchInput = document.getElementById('menu-search-input');
        const menuItems = document.querySelectorAll('.menu-item');

        // Toggle do menu principal
        menuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            menuDropdown.classList.toggle('show');
        });

        // // Fecha o menu ao clicar fora (funcionalidade desativada)
        // document.addEventListener('click', function(e) {
        //     if (!document.getElementById('sinarc-menu-container').contains(e.target)) {
        //         menuDropdown.classList.remove('show');
        //     }
        // });

        // Toggle das categorias (apenas CLICK)
        categoryHeaders.forEach(header => {
            header.addEventListener('click', function(e) {
                e.stopPropagation();
                const category = this.getAttribute('data-category');
                const items = document.querySelector(`.category-items[data-category="${category}"]`);
                
                this.classList.toggle('expanded');
                items.classList.toggle('show');
            });
        });

        // Expande primeira categoria por padr√£o
        // if (categoryHeaders.length > 0) {
        //     categoryHeaders[0].click();
        // }

        // Fun√ß√£o para simular pressionamento de tecla
        function simulateKeyPress(keyData) {
            const hiddenInput = document.getElementById('hidden-input');
            const target = hiddenInput || document;
            
            if (hiddenInput) hiddenInput.focus();
            
            // Determina as propriedades da tecla
            let key, code, keyCode;
            let shiftKey = false;
            let mainKey = keyData.trim(); // Remove espa√ßos extras
            
            // console.log('SHIFT:', shiftKey, 'TECLA:', mainKey)
            // Verifica se tem Shift (aceita "Shift +" ou "Shift+")
            if (mainKey.startsWith('Shift +') || mainKey.startsWith('Shift+')) {
                shiftKey = true;
                mainKey = mainKey.replace(/^Shift\s*\+\s*/, '').trim();
            }
            // console.log('SHIFT:', shiftKey, 'TECLA:', mainKey)

            // --- TRATAMENTO ESPECIAL PARA √á (TECLADO ABNT2) ---
            if (mainKey === '√ß') {
                key = shiftKey ? '√á' : '√ß';  // Mai√∫scula se Shift ativo
                code = 'Semicolon';           // Code f√≠sico comum para √á
                keyCode = 186;                // KeyCode padr√£o
                
                const eventInitDict = {
                    key: key,
                    code: code,
                    keyCode: keyCode,
                    which: keyCode,
                    shiftKey: shiftKey,
                    bubbles: true,
                    cancelable: true,
                    view: window
                };

                target.dispatchEvent(new KeyboardEvent('keydown', eventInitDict));
                target.dispatchEvent(new KeyboardEvent('keypress', eventInitDict));
                target.dispatchEvent(new KeyboardEvent('keyup', eventInitDict));
                
                // console.log(`Tecla √á enviada: ${key} (Code: ${code}, Shift: ${shiftKey})`);
                return; // Retorna aqui para √á
            }
            
            // --- OUTRAS TECLAS ---
            
            // Setas
            if (mainKey.includes('‚Üë') || mainKey === 'ArrowUp') {
                key = 'ArrowUp';
                code = 'ArrowUp';
                keyCode = 38;
            } else if (mainKey.includes('‚Üì') || mainKey === 'ArrowDown') {
                key = 'ArrowDown';
                code = 'ArrowDown';
                keyCode = 40;
            } else if (mainKey.includes('‚Üí') || mainKey === 'ArrowRight') {
                key = 'ArrowRight';
                code = 'ArrowRight';
                keyCode = 39;
            } else if (mainKey.includes('‚Üê') || mainKey === 'ArrowLeft') {
                key = 'ArrowLeft';
                code = 'ArrowLeft';
                keyCode = 37;
            }
            // [NOVO] Corre√ß√£o Pontual para o "c" (min√∫scula)
            else if (mainKey === 'c') { 
                key = 'c'; 
                code = 'KeyC'; 
                keyCode = 67; 
            }

            // [NOVO] Adiciona o bloco de despacho de eventos para setas

            if (['ArrowUp', 'ArrowDown', 'ArrowRight', 'ArrowLeft'].includes(key)) {
                    const eventInitDict = {
                    key: key,
                    code: code,
                    keyCode: keyCode,
                    which: keyCode,
                    shiftKey: shiftKey,
                    bubbles: true,
                    cancelable: true,
                    view: window
                };

                target.dispatchEvent(new KeyboardEvent('keydown', eventInitDict));
                // Teclas n√£o imprim√≠veis (setas) geralmente s√≥ disparam keydown/keyup
                // target.dispatchEvent(new KeyboardEvent('keypress', eventInitDict)); // Opcional para setas
                target.dispatchEvent(new KeyboardEvent('keyup', eventInitDict));

                // console.log(`Tecla Seta enviada: ${key} (Code: ${code}, Shift: ${shiftKey})`);
                return; // Adiciona return para setas
            }

            // Teclas de Controle
            else if (mainKey === 'ESC' || mainKey === 'Escape') {
                key = 'Escape';
                code = 'Escape';
                keyCode = 27;
            } else if (mainKey === 'ESPA√áO' || mainKey === ' ') {
                key = ' ';
                code = 'Space';
                keyCode = 32;
            } else if (mainKey === 'Delete') {
                key = 'Delete';
                code = 'Delete';
                keyCode = 46;
            } else if (mainKey === 'Backspace') {
                key = 'Backspace';
                code = 'Backspace';
                keyCode = 8;
            } else if (mainKey === 'F5') {
                key = 'F5';
                code = 'F5';
                keyCode = 116;
            } else if (mainKey === 'F11') {
                key = 'F11';
                code = 'F11';
                keyCode = 122;
            }
            // Padr√£o (Letras, N√∫meros e S√≠mbolos)
            else {
                key = mainKey;
                code = mainKey.length === 1 ? 'Key' + mainKey.toUpperCase() : mainKey;
                keyCode = mainKey.toUpperCase().charCodeAt(0);
            }

            // Define o valor final da tecla (mai√∫scula se Shift ativo)
            const finalKey = shiftKey ? key.toUpperCase() : key;

            // Cria eventos de teclado
            const eventInitDict = {
                key: finalKey,
                code: code,
                keyCode: keyCode,
                which: keyCode,
                shiftKey: shiftKey,
                ctrlKey: false,
                altKey: false,
                metaKey: false,
                bubbles: true,
                cancelable: true,
                view: window
            };

            // Dispara eventos keydown, keypress e keyup
            target.dispatchEvent(new KeyboardEvent('keydown', eventInitDict));
            target.dispatchEvent(new KeyboardEvent('keypress', eventInitDict));
            target.dispatchEvent(new KeyboardEvent('keyup', eventInitDict));
            
            // console.log(`Comando enviado: ${finalKey} (Code: ${code}, Shift: ${shiftKey})`);
        }

        // Adiciona evento de clique aos itens do menu para simular tecla
        menuItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                
                const keyData = this.getAttribute('data-key');
                const functionData = this.getAttribute('data-function');
                
                if (keyData) {
                    // Feedback visual
                    this.style.background = 'rgba(89, 201, 67, 0.4)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 300);
                    
                    // Simula o pressionamento da tecla
                    simulateKeyPress(keyData);
                    
                    // Opcional: fecha o menu ap√≥s clicar
                    // menuDropdown.classList.remove('show');
                } else if (functionData) {
                    // Feedback visual
                    this.style.background = 'rgba(89, 201, 67, 0.4)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 300);
                    
                    // Chama a fun√ß√£o diretamente
                    if (typeof window[functionData] === 'function') {
                        window[functionData]();
                    } else {
                        console.error(`Fun√ß√£o '${functionData}' n√£o encontrada.`);
                    }
                }
            });
        });

        // Fun√ß√£o de busca
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Mostra todos os itens e fecha todas as categorias
                menuItems.forEach(item => item.classList.remove('hidden'));
                categoryHeaders.forEach(header => {
                    header.classList.remove('expanded');
                    const category = header.getAttribute('data-category');
                    const items = document.querySelector(`.category-items[data-category="${category}"]`);
                    items.classList.remove('show');
                });
            } else {
                // Filtra itens
                categoryHeaders.forEach(header => {
                    const category = header.getAttribute('data-category');
                    const categoryItems = document.querySelectorAll(`.category-items[data-category="${category}"] .menu-item`);
                    let categoryHasResults = false;
                    
                    categoryItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.classList.remove('hidden');
                            categoryHasResults = true;
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                    
                    // Expande categorias com resultados
                    const items = document.querySelector(`.category-items[data-category="${category}"]`);
                    if (categoryHasResults) {
                        header.classList.add('expanded');
                        items.classList.add('show');
                    } else {
                        header.classList.remove('expanded');
                        items.classList.remove('show');
                    }
                });
            }
        });

        // Previne que cliques nos itens fechem o menu
        menuDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Previne que busca feche o menu
        searchInput.addEventListener('click', function(e) {
            e.stopPropagation();
        });

    })();
    </script>



    
    
    
    <script>

    // =================================================== 
    // EXIBE LINKS PARA SISTEMAS DE IA 
    // =================================================== 

    function exibirSistemasIA() {
        // Cria overlay escuro
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 99999; display: flex; align-items: center; justify-content: center;';

        // Cria modal
        const modal = document.createElement('div');
        modal.style.cssText = 'background: white; border: 3px solid rgba(89, 201, 67, 1); border-radius: 12px; padding: 30px; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); font-family: Arial, sans-serif;';

        // Header
        const header = document.createElement('div');
        header.style.cssText = 'text-align: center; margin-bottom: 25px;';
        header.innerHTML = '<h2 style="color: #2c5f2d; margin: 0 0 10px 0; font-size: 24px;">ü§ñ Sistemas de Intelig√™ncia Artificial</h2><p style="color: #666; font-size: 14px; margin: 0;">Analise os grafos gerados pelo SINARC com assistentes de IA</p>';
        modal.appendChild(header);

        // Dica
        const dica = document.createElement('div');
        dica.style.cssText = 'background: rgba(89, 201, 67, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid rgba(89, 201, 67, 1);';
        dica.innerHTML = '<p style="margin: 0; font-size: 13px; color: #555; line-height: 1.6;"><strong>üí° Dica:</strong> Exporte a estrutura do grafo em PDF usando o bot√£o <strong>‚¨ÜÔ∏è</strong> do menu de comandos e fa√ßa upload do arquivo nos sistemas abaixo para an√°lise detalhada.</p>';
        modal.appendChild(dica);

        // Container de IAs
        const container = document.createElement('div');
        container.style.cssText = 'display: grid; gap: 12px;';

        // Lista de IAs
        const ias = [
            { nome: 'NotebookLM (Google)', url: 'https://notebooklm.google.com', cor: '#ea4335', dominio: 'notebooklm.google.com' },
            { nome: 'Gemini (Google)', url: 'https://gemini.google.com', cor: '#4285f4', dominio: 'gemini.google.com' },
            { nome: 'Claude (Anthropic)', url: 'https://claude.ai', cor: '#d4a574', dominio: 'claude.ai' },
            { nome: 'ChatGPT (OpenAI)', url: 'https://chat.openai.com', cor: '#10a37f', dominio: 'chat.openai.com' },
            { nome: 'Perplexity AI', url: 'https://www.perplexity.ai', cor: '#20808d', dominio: 'perplexity.ai' },
            { nome: 'DeepSeek', url: 'https://chat.deepseek.com/', cor: '#1e40af', dominio: 'chat.deepseek.com' },
            { nome: 'Z.ai', url: 'https://chat.z.ai/', cor: '#8b5cf6', dominio: 'chat.z.ai' },
            { nome: 'Qwen (Alibaba)', url: 'https://chat.qwen.ai/', cor: '#f97316', dominio: 'chat.qwen.ai' }
        ];

        // Cria cards
        ias.forEach(function(ia) {
            const card = document.createElement('div');
            card.className = 'ia-card';
            card.style.cssText = 'border: 2px solid ' + ia.cor + '; border-radius: 8px; padding: 12px; transition: all 0.3s ease; cursor: pointer;';
            card.innerHTML = '<h3 style="margin: 0; color: ' + ia.cor + '; font-size: 15px;">' + ia.nome + '</h3><span style="font-size: 11px; color: #999;">' + ia.dominio + '</span>';
            card.onclick = function() {
                window.open(ia.url, '_blank');
            };
            container.appendChild(card);
        });

        modal.appendChild(container);

        // Bot√£o fechar
        const footer = document.createElement('div');
        footer.style.cssText = 'margin-top: 25px; padding-top: 20px; border-top: 2px solid rgba(200, 200, 200, 0.3); text-align: center;';
        
        const btnFechar = document.createElement('button');
        btnFechar.textContent = '‚úì Fechar';
        btnFechar.style.cssText = 'background: rgba(89, 201, 67, 0.9); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2);';
        btnFechar.onmouseover = function() {
            this.style.background = 'rgba(89, 201, 67, 1)';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
        };
        btnFechar.onmouseout = function() {
            this.style.background = 'rgba(89, 201, 67, 0.9)';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
        };
        btnFechar.onclick = function() {
            overlay.remove();
        };
        
        footer.appendChild(btnFechar);
        modal.appendChild(footer);

        // Adiciona hover aos cards
        const style = document.createElement('style');
        style.textContent = '.ia-card:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15) !important; } .ia-card:active { transform: scale(0.98); }';
        document.head.appendChild(style);

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Fecha ao clicar fora do modal
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                overlay.remove();
            }
        });

        // Fecha com ESC
        const handleEscape = function(e) {
            if (e.key === 'Escape') {
                overlay.remove();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    }

    // Torna a fun√ß√£o global
    window.exibirSistemasIA = exibirSistemasIA;

    </script>

    


    <script>

    // 1. A FUN√á√ÉO DE DESENHO
    function selecionaAreaLivre() {
        //console.log("üîµ Sele√ß√£o por forma livre iniciando...");
        
        // Verifica se j√° existe um overlay para evitar duplica√ß√£o
        const overlayExistente = document.getElementById('free-select-overlay');
        if (overlayExistente) overlayExistente.remove();

        let isDrawing = false;
        let points = [];
        let polygonPath = [];
        let overlay = null;
        let canvas = null;
        let ctx = null;
        
        // Cria overlay com ID √∫nico
        overlay = document.createElement('div');
        overlay.id = 'free-select-overlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;cursor:crosshair;touch-action:none;background:rgba(0,0,0,0.05)';
        
        // Cria canvas
        canvas = document.createElement('canvas');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;';
        ctx = canvas.getContext('2d');
        
        overlay.appendChild(canvas);
        document.body.appendChild(overlay);
        
        // Fun√ß√£o para obter posi√ß√£o
        function getPos(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            if (e.changedTouches && e.changedTouches.length > 0) {
                return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }
        
        // In√≠cio do desenho
        function start(e) {
            e.preventDefault();
            isDrawing = true;
            points = [];
            polygonPath = [];
            
            const p = getPos(e);
            points.push(p);
            polygonPath.push(p);
            
            ctx.strokeStyle = '#59C943';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        
        // Movimento de desenho
        function move(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const p = getPos(e);
            points.push(p);
            polygonPath.push(p);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.stroke();
        }
        
        // Fim do desenho
        function end(e) {
            if (!isDrawing) return;
            isDrawing = false;
            
            if (points.length > 2) {
                // Desenha √°rea preenchida
                ctx.fillStyle = 'rgba(89, 201, 67, 0.2)';
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // Executa sele√ß√£o ap√≥s pequeno atraso
                setTimeout(function() {
                    selecionarNos();
                    if(overlay) overlay.remove();
                }, 200);
            } else {
                if(overlay) overlay.remove();
                console.log("Forma muito pequena");
            }
        }
        
        // Algoritmo Point in Polygon (Ray Casting)
        function isPointInPolygon(point, vs) {
            let x = point.x, y = point.y;
            let inside = false;
            
            for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                let xi = vs[i].x, yi = vs[i].y;
                let xj = vs[j].x, yj = vs[j].y;
                
                let intersect = ((yi > y) !== (yj > y)) &&
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                
                if (intersect) inside = !inside;
            }
            return inside;
        }
        
        // Seleciona n√≥s dentro do pol√≠gono
        function selecionarNos() {
            const network = window.network;
            if (!network) {
                console.log("‚ùå Rede n√£o encontrada");
                return;
            }
            
            const nosSelecionados = [];
            const todosNos = network.body.nodes;
            
            // Itera sobre todos os n√≥s
            for (let nodeId in todosNos) {
                const no = todosNos[nodeId];
                
                if (no.x !== undefined && no.y !== undefined) {
                    try {
                        // Converte posi√ß√£o do n√≥ para coordenadas de tela
                        const posicaoTela = network.canvas.canvasToDOM({ x: no.x, y: no.y });
                        
                        // Verifica se est√° dentro do pol√≠gono
                        if (isPointInPolygon(posicaoTela, polygonPath)) {
                            nosSelecionados.push(nodeId);
                        }
                    } catch (erro) {
                        // Ignora erros individuais de n√≥
                    }
                }
            }
            
            if (nosSelecionados.length > 0) {
                network.selectNodes(nosSelecionados, false);
                //console.log("‚úÖ " + nosSelecionados.length + " n√≥(s) selecionado(s):", nosSelecionados);
            } else {
                //console.log("Nenhum n√≥ encontrado na √°rea");
            }
        }
        
        // Adiciona eventos
        overlay.addEventListener('mousedown', start);
        overlay.addEventListener('mousemove', move);
        overlay.addEventListener('mouseup', end);
        overlay.addEventListener('mouseleave', end);
        
        overlay.addEventListener('touchstart', start, { passive: false });
        overlay.addEventListener('touchmove', move, { passive: false });
        overlay.addEventListener('touchend', end);
    }

    // Torna a fun√ß√£o global
    window.selecionaAreaLivre = selecionaAreaLivre;

    </script>
  







    
    <!-- ======================================================== -->
    <!-- BOT√ÉO DE OTIMIZA√á√ÉO AUTOM√ÅTICA - CANTO INFERIOR ESQUERDO -->
    <!-- ======================================================== -->

    <style>
    #sinarc-otimizar-container {
        position: fixed;
        bottom: 33px;
        left: 21px;  /* Alinhado com o menu suspenso */
        z-index: 10000;
        font-family: Arial, sans-serif;
    }

    #sinarc-otimizar-button {
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(89, 201, 67, 0.6);
        border-radius: 4px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        font-size: 20px;
        color: #555;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #sinarc-otimizar-button:hover {
        background: rgba(89, 201, 67, 0.15);
        border-color: rgba(89, 201, 67, 0.9);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }

    #sinarc-otimizar-button:active {
        background: rgba(89, 201, 67, 0.3);
        transform: scale(0.95);
    }

    /* Tooltip ao passar o mouse */
    #sinarc-otimizar-button::after {
        content: 'Otimizar grafo automaticamente (Bot√£o Fireworks)';
        position: absolute;
        bottom: 50px;
        left: 0;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    /* ‚úÖ OCULTA O TOOLTIP */
    #sinarc-otimizar-button::after {
        display: none !important;
    }

    #sinarc-otimizar-button:hover::after {
        opacity: 1;
    }
    </style>


    <div id="sinarc-otimizar-container">
        <div id="sinarc-otimizar-button" title="Otimizar grafo automaticamente (Bot√£o Fireworks)">ü™Ñ</div>
    </div>

    



    <script>


    <!-- =================================================== -->
    <!-- EXPORTA DADOS ESTRUTURADOS DO GRAFO PARA USO COM IA -->
    <!-- =================================================== -->

    async function exportarGrafoParaPDF() {

      // 1) Garantir jsPDF dispon√≠vel
      if (typeof window.jspdf === "undefined") {
          await new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
          });
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      // 2) Recuperar nodes e edges
      let nodesJSON = null;
      let edgesJSON = null;

      if (window.nodes && typeof window.nodes.get === "function") {
          nodesJSON = window.nodes.get();
      } else if (network && network.body && network.body.data && network.body.data.nodes) {
        nodesJSON = network.body.data.nodes.get();
      }

      if (window.edges && typeof window.edges.get === "function") {
        edgesJSON = window.edges.get();
      } else if (network && network.body && network.body.data && network.body.data.edges) {
        edgesJSON = network.body.data.edges.get();
      }

      const grafoExport = {
        exportado_em: new Date().toISOString(),
        total_nodes: nodesJSON ? nodesJSON.length : 0,
        total_edges: edgesJSON ? edgesJSON.length : 0,
        nodes: nodesJSON || [],
        edges: edgesJSON || []
      };

      const textoJSON = JSON.stringify(grafoExport, null, 2);

      // 2.1) Preparar legenda do grafo


      const legendaGrafo = `
{
  "nome": "Legenda de Grafos SINARC",
  "versao": "1.0",
  "descricao": "Documenta√ß√£o estruturada para interpreta√ß√£o de grafos de redes complexas gerados pelo SINARC (Sistema Integrado de An√°lise de Redes Complexas)",
  "estrutura_geral": {
    "metadados_raiz": {
      "exportado_em": {
        "tipo": "string",
        "formato": "ISO 8601 datetime",
        "descricao": "Data e hora da exporta√ß√£o do grafo"
      },
      "total_nodes": {
        "tipo": "integer",
        "descricao": "N√∫mero total de n√≥s no grafo"
      },
      "total_edges": {
        "tipo": "integer",
        "descricao": "N√∫mero total de arestas/conex√µes no grafo"
      },
      "nodes": {
        "tipo": "array",
        "descricao": "Lista de todos os n√≥s do grafo"
      },
      "edges": {
        "tipo": "array",
        "descricao": "Lista de todas as arestas do grafo"
      }
    }
  },
  "resumo_prefixos": {
    "descricao": "Todos os prefixos usados no SINARC para identificar tipos de entidades",
    "prefixos": {
      "PF_": "Pessoa F√≠sica (CPF mascarado)",
      "PJ_": "Pessoa Jur√≠dica COM CNPJ brasileiro (brasileira ou estrangeira com CNPJ no Brasil)",
      "PE_": "Pessoa Estrangeira SEM CNPJ brasileiro (empresa estrangeira sem registro na Receita Federal)",
      "EM_": "Email",
      "TE_": "Telefone",
      "EN_": "Endere√ßo"
    },
    "regex_validacao": {
      "PF_": "^PF_\\*\\*\\*\\d{6}\\*\\*-",
      "PJ_": "^PJ_\\d{14}$",
      "PE_": "^PE_",
      "EM_": "^EM_",
      "TE_": "^TE_",
      "EN_": "^EN_"
    },
    "observacao_cnpj": "A presen√ßa do CNPJ √© o que diferencia PJ_ de PE_ para empresas estrangeiras: PJ_ tem CNPJ, PE_ n√£o tem CNPJ"
  },
  "guia_identificacao_empresas_estrangeiras": {
    "objetivo": "Distinguir corretamente empresas estrangeiras entre PJ_ e PE_",
    "arvore_decisao": {
      "passo_1": {
        "pergunta": "A entidade est√° domiciliada no exterior?",
        "como_verificar": [
          "Verificar se UF = 'EX' (para PJ_)",
          "Verificar se prefixo √© PE_",
          "Verificar se imagem cont√©m 'exterior'"
        ]
      },
      "passo_2": {
        "pergunta": "A entidade possui CNPJ brasileiro?",
        "como_verificar": [
          "Se ID come√ßa com PJ_ seguido de 14 d√≠gitos ‚Üí TEM CNPJ",
          "Se ID come√ßa com PE_ ‚Üí N√ÉO TEM CNPJ"
        ],
        "resultado": {
          "tem_cnpj": "√â uma PJ_ com UF='EX' - Empresa estrangeira COM CNPJ brasileiro",
          "nao_tem_cnpj": "√â uma PE_ - Pessoa Estrangeira SEM CNPJ brasileiro"
        }
      }
    },
    "tabela_comparativa": {
      "caracteristica": {
        "cnpj_brasileiro": {
          "PJ_exterior": "SIM (14 d√≠gitos)",
          "PE_": "N√ÉO (identificador pr√≥prio)"
        },
        "situacao_cadastral": {
          "PJ_exterior": "SIM (ativa ou baixada)",
          "PE_": "N√ÉO (sem informa√ß√£o)"
        },
        "operacao_brasil": {
          "PJ_exterior": "Geralmente SIM (filial, representa√ß√£o, opera√ß√µes)",
          "PE_": "Geralmente N√ÉO (apenas como s√≥cia/investidora)"
        },
        "formato_id": {
          "PJ_exterior": "PJ_00000000000000 (14 d√≠gitos)",
          "PE_": "PE_[identificador]"
        },
        "tamanho_no": {
          "PJ_exterior": "30",
          "PE_": "30"
        },
        "icone": {
          "PJ_exterior": "pj_exterior_ativa.png ou pj_exterior_inativa.png",
          "PE_": "pj_exterior_ativa.png (sempre)"
        }
      }
    },
    "exemplos_praticos": {
      "pj_exterior": {
        "descricao": "NESTLE S.A (Su√≠√ßa) com CNPJ no Brasil",
        "id_exemplo": "PJ_05497900000100",
        "uf": "EX",
        "tem_cnpj": true,
        "motivo": "Tem opera√ß√µes e subsidi√°rias no Brasil, precisa de CNPJ"
      },
      "pe_": {
        "descricao": "Holding estrangeira que apenas investe em empresa brasileira",
        "id_exemplo": "PE_[identificador]",
        "tem_cnpj": false,
        "motivo": "Apenas s√≥cia, sem filial ou opera√ß√£o direta no Brasil"
      }
    }
  },
  "tipos_entidades": {
    "PF": {
      "nome": "Pessoa F√≠sica",
      "prefixo_id": "PF_",
      "formato_id": "PF_***XXXXXX**-NOME COMPLETO",
      "descricao": "Representa pessoas f√≠sicas (CPF mascarado)",
      "icone_padrao": "images\\pf_homem.png ou images\\pf_mulher.png",
      "exemplos": [
        "PF_***151678**-GUSTAVO CHIARINI BASTOS",
        "PF_***125258**-MARTHA DELIA URIBE DE LUNA"
      ]
    },
    "PJ": {
      "nome": "Pessoa Jur√≠dica",
      "prefixo_id": "PJ_",
      "formato_id": "PJ_CNPJ (14 d√≠gitos)",
      "descricao": "Representa empresas e organiza√ß√µes que POSSUEM CNPJ brasileiro - tanto empresas brasileiras quanto empresas estrangeiras domiciliadas no exterior que possuem CNPJ no Brasil",
      "subtipos": {
        "brasil_ativa": {
          "icone": "images\\pj_brasil_ativa.png",
          "descricao": "Empresa brasileira com situa√ß√£o cadastral ativa",
          "identificacao": "UF diferente de 'EX' e situacao_ativa = True",
          "tamanho": 20
        },
        "brasil_inativa": {
          "icone": "images\\pj_brasil_inativa.png",
          "descricao": "Empresa brasileira baixada/inativa",
          "identificacao": "UF diferente de 'EX' e situacao_ativa = False",
          "tamanho": 20
        },
        "exterior_ativa": {
          "icone": "images\\pj_exterior_ativa.png",
          "descricao": "Empresa estrangeira domiciliada no exterior que POSSUI CNPJ brasileiro com situa√ß√£o cadastral ativa",
          "identificacao": "UF = 'EX' e situacao_ativa = True",
          "tamanho": 30,
          "observacao": "Empresa estrangeira cadastrada na Receita Federal brasileira (ex: filial, representa√ß√£o, opera√ß√µes no Brasil)"
        },
        "exterior_inativa": {
          "icone": "images\\pj_exterior_inativa.png",
          "descricao": "Empresa estrangeira domiciliada no exterior que POSSUI CNPJ brasileiro baixado/inativo",
          "identificacao": "UF = 'EX' e situacao_ativa = False",
          "tamanho": 30,
          "observacao": "CNPJ da empresa estrangeira foi baixado na Receita Federal"
        }
      },
      "exemplos": [
        "PJ_60409075000152",
        "PJ_28053619000183",
        "PJ_05497900000100"
      ]
    },
    "PE": {
      "nome": "Pessoa Estrangeira",
      "prefixo_id": "PE_",
      "formato_id": "PE_IDENTIFICADOR",
      "descricao": "Representa empresas estrangeiras domiciliadas no exterior que N√ÉO POSSUEM CNPJ brasileiro. Diferente de PJ_ com UF='EX', que s√£o empresas estrangeiras COM CNPJ no Brasil",
      "icone_padrao": "images\\pj_exterior_ativa.png",
      "tamanho_padrao": 30,
      "observacoes": [
        "Pessoa estrangeira N√ÉO possui CNPJ brasileiro - apenas identificador pr√≥prio",
        "N√£o possui informa√ß√£o de situa√ß√£o cadastral (ativa/inativa) na Receita Federal brasileira",
        "A imagem √© sempre de empresa domiciliada no exterior ativa (por padr√£o)",
        "Tipicamente s√£o s√≥cias estrangeiras de empresas brasileiras, sem opera√ß√£o direta no Brasil",
        "Aparecem nos registros da Receita Federal apenas como vinculadas a empresas brasileiras (ex: como s√≥cias)"
      ],
      "exemplos": [
        "PE_[identificador]"
      ],
      "casos_uso": [
        "Empresa matriz estrangeira que √© s√≥cia de subsidi√°ria brasileira",
        "Holding internacional sem CNPJ no Brasil",
        "Pessoa jur√≠dica estrangeira que apenas investe em empresa brasileira sem ter filial/representa√ß√£o no Brasil"
      ]
    },
    "EM": {
      "nome": "Email",
      "prefixo_id": "EM_",
      "formato_id": "EM_endereco@email.com",
      "descricao": "Representa endere√ßos de email",
      "icone_padrao": "images\\email.png",
      "tamanho_padrao": 15,
      "exemplos": [
        "EM_atendimento.fiscalizacao@br.nestle.com",
        "EM_fiscal@puravida.com.br"
      ]
    },
    "TE": {
      "nome": "Telefone",
      "prefixo_id": "TE_",
      "formato_id": "TE_DD NUMERO",
      "descricao": "Representa n√∫meros de telefone",
      "icone_padrao": "images\\telefone.png",
      "tamanho_padrao": 15,
      "exemplos": [
        "TE_11 55084400",
        "TE_71 33139467"
      ]
    },
    "EN": {
      "nome": "Endere√ßo",
      "prefixo_id": "EN_",
      "formato_id": "EN_LOGRADOURO-CIDADE-UF",
      "descricao": "Representa endere√ßos f√≠sicos",
      "icone_padrao": "images\\endereco.png",
      "tamanho_padrao": 15,
      "exemplos": [
        "EN_MEYERFREUND 1-VILA VELHA-ES",
        "EN_DEPUTADO EDUARDO KM LUIS MAGALHAES 529-FEIRA DE SANTANA-BA"
      ]
    }
  },
  "estrutura_nodes": {
    "propriedades_obrigatorias": {
      "id": {
        "tipo": "string",
        "descricao": "Identificador √∫nico do n√≥, inclui prefixo do tipo de entidade"
      },
      "label": {
        "tipo": "string",
        "descricao": "R√≥tulo de exibi√ß√£o do n√≥ (nome simplificado)"
      },
      "shape": {
        "tipo": "string",
        "valores_possiveis": ["image", "dot", "circle"],
        "descricao": "Forma visual do n√≥"
      },
      "image": {
        "tipo": "string",
        "descricao": "Caminho para o √≠cone do n√≥"
      },
      "size": {
        "tipo": "integer",
        "descricao": "Tamanho do n√≥ (geralmente 15, 20 ou 30)"
      },
      "title": {
        "tipo": "string",
        "descricao": "Tooltip com informa√ß√µes detalhadas do n√≥ (endere√ßo, dist√¢ncia, adjac√™ncias)"
      },
      "value": {
        "tipo": "integer",
        "descricao": "Grau do n√≥ (n√∫mero de conex√µes diretas)"
      }
    },
    "propriedades_opcionais": {
      "font": {
        "tipo": "object",
        "descricao": "Configura√ß√µes de fonte",
        "propriedades": {
          "color": {
            "tipo": "string",
            "padrao": "#777777",
            "descricao": "Cor do texto do r√≥tulo"
          }
        }
      },
      "color": {
        "tipo": "object",
        "descricao": "Configura√ß√µes de cor do n√≥",
        "propriedades": {
          "border": {
            "tipo": "string",
            "descricao": "Cor da borda (ex: 'red' para n√≥ alvo)"
          },
          "background": {
            "tipo": "string",
            "padrao": "transparent",
            "descricao": "Cor de fundo do n√≥"
          },
          "hover": {
            "tipo": "object",
            "descricao": "Cores ao passar o mouse"
          },
          "highlight": {
            "tipo": "object",
            "descricao": "Cores ao selecionar"
          }
        }
      },
      "borderWidth": {
        "tipo": "integer",
        "descricao": "Largura da borda do n√≥"
      },
      "borderWidthSelected": {
        "tipo": "integer",
        "descricao": "Largura da borda quando selecionado"
      },
      "shapeProperties": {
        "tipo": "object",
        "descricao": "Propriedades especiais da forma",
        "propriedades": {
          "useBorderWithImage": {
            "tipo": "boolean",
            "descricao": "Se deve usar borda com imagem"
          },
          "borderDashes": {
            "tipo": "array",
            "descricao": "Padr√£o de tracejado [comprimento_tra√ßo, comprimento_espa√ßo]"
          }
        }
      },
      "camadas_solicitadas": {
        "tipo": "integer",
        "descricao": "N√∫mero de camadas de profundidade solicitadas na pesquisa"
      },
      "algoritmos": {
        "tipo": "string",
        "descricao": "Resultados de algoritmos de centralidade executados no grafo"
      },
      "z_ancestor": {
        "tipo": "string",
        "valores_possiveis": ["true", "false"],
        "descricao": "Indica se o n√≥ √© ancestral (estava na pesquisa original)"
      },
      "z_novo": {
        "tipo": "integer",
        "valores_possiveis": [1],
        "descricao": "Indica se √© um n√≥ novo na pesquisa atual"
      },
      "z_group": {
        "tipo": "integer",
        "descricao": "Identificador do grupo ao qual o n√≥ pertence"
      },
      "z_group_total": {
        "tipo": "integer",
        "descricao": "Total de grupos no grafo"
      }
    },
    "marcadores_visuais_especiais": {
      "no_alvo": {
        "caracteristicas": {
          "color.border": "red",
          "borderWidth": 4,
          "titulo_contem": "Dist√¢ncia Alvo: 0"
        },
        "descricao": "N√≥ principal da pesquisa"
      },
      "no_conectado_diretamente": {
        "caracteristicas": {
          "titulo_contem": "Dist√¢ncia Alvo: 1"
        },
        "descricao": "N√≥s a 1 conex√£o do alvo"
      },
      "empresa_tracejada": {
        "caracteristicas": {
          "shapeProperties.borderDashes": [15, 5]
        },
        "descricao": "Empresas com caracter√≠sticas especiais (ex: matriz)"
      }
    }
  },
  "estrutura_edges": {
    "propriedades": {
      "id": {
        "tipo": "string",
        "formato": "UUID",
        "descricao": "Identificador √∫nico da aresta"
      },
      "from": {
        "tipo": "string",
        "descricao": "ID do n√≥ de origem"
      },
      "to": {
        "tipo": "string",
        "descricao": "ID do n√≥ de destino"
      },
      "label": {
        "tipo": "string",
        "descricao": "R√≥tulo da rela√ß√£o (tipo de v√≠nculo)",
        "exemplos": [
          "Administrador",
          "S√≥cio",
          "Diretor",
          "Presidente",
          "rep-s√≥cio-Administrador",
          "rep-s√≥cio-Procurador",
          "Sociedade Consorciada",
          "S√≥cio Pessoa Jur√≠dica Domiciliado no Exterior"
        ]
      },
      "title": {
        "tipo": "string",
        "descricao": "Tooltip da aresta (geralmente igual ao label)"
      },
      "arrows": {
        "tipo": "string",
        "valores_possiveis": ["to", "from", "to;from"],
        "descricao": "Dire√ß√£o das setas na aresta"
      },
      "width": {
        "tipo": "integer",
        "padrao": 1,
        "descricao": "Largura da linha da aresta"
      },
      "arrowStrikethrough": {
        "tipo": "boolean",
        "padrao": false,
        "descricao": "Se a linha atravessa a seta"
      }
    },
    "interpretacao_direcao": {
      "arrows_to": {
        "descricao": "A seta aponta de FROM para TO",
        "interpretacao": "FROM tem o papel/v√≠nculo em rela√ß√£o a TO",
        "exemplo": "PF_GUSTAVO --> Administrador --> PJ_EMPRESA significa que Gustavo √© administrador da empresa"
      },
      "arrows_from": {
        "descricao": "A seta aponta de TO para FROM",
        "interpretacao": "TO tem o papel/v√≠nculo em rela√ß√£o a FROM"
      }
    }
  },
  "tipos_relacionamentos": {
    "vinculos_pessoas_empresas": [
      "Administrador",
      "S√≥cio",
      "Diretor",
      "Presidente",
      "rep-s√≥cio-Administrador",
      "rep-s√≥cio-Procurador",
      "Procurador"
    ],
    "vinculos_empresas": [
      "S√≥cio",
      "Sociedade Consorciada",
      "S√≥cio Pessoa Jur√≠dica Domiciliado no Exterior"
    ],
    "vinculos_dados": {
      "descricao": "Conex√µes sem label espec√≠fico, indicam posse/uso",
      "exemplos": [
        "Empresa --> Email",
        "Empresa --> Telefone",
        "Empresa --> Endere√ßo"
      ]
    }
  },
  "metricas_centralidade": {
    "descricao": "M√©tricas calculadas e armazenadas no campo 'algoritmos' de alguns n√≥s",
    "metricas": {
      "Betweenness Centrality": {
        "descricao": "Mede quantas vezes um n√≥ aparece no caminho mais curto entre outros n√≥s",
        "interpretacao": "N√≥s com alta betweenness s√£o pontes/intermedi√°rios importantes na rede"
      },
      "Closeness Centrality": {
        "descricao": "Mede a proximidade m√©dia de um n√≥ a todos os outros",
        "interpretacao": "N√≥s com alta closeness podem alcan√ßar outros n√≥s rapidamente",
        "escala": "0 a 1"
      },
      "Eigenvector Centrality": {
        "descricao": "Mede a influ√™ncia de um n√≥ baseado na qualidade de suas conex√µes",
        "interpretacao": "N√≥s conectados a n√≥s importantes t√™m alta eigenvector centrality",
        "escala": "0 a 1"
      },
      "Degree Centrality": {
        "descricao": "N√∫mero de conex√µes diretas de um n√≥",
        "interpretacao": "N√≥s com muitas conex√µes t√™m alta degree centrality"
      },
      "PageRank": {
        "descricao": "Adapta√ß√£o do algoritmo do Google para redes bidirecionais",
        "interpretacao": "Probabilidade de chegar a um n√≥ seguindo arestas aleatoriamente"
      }
    }
  },
  "campos_title": {
    "descricao": "O campo 'title' dos n√≥s cont√©m informa√ß√µes estruturadas em texto",
    "estrutura_tipica": {
      "linha_1": "Nome completo (ID)",
      "linha_2": "Endere√ßo completo (para empresas)",
      "linha_3": "N√ì - Dist√¢ncia Alvo: X",
      "linha_4": "GRAFO - N√≥s: X, Arestas: Y, Camadas Solicitadas: Z, Conectado: Sim/N√£o",
      "linha_5": "Mensagem: [vazio ou mensagem espec√≠fica]",
      "linha_6+": "N√≥s Adjacentes (Grau N): lista de vizinhos com tipo de rela√ß√£o"
    },
    "padrao_adjacentes": {
      "formato": "--> ou <--",
      "interpretacao": {
        "-->": "Este n√≥ aponta para (tem rela√ß√£o com)",
        "<--": "Este n√≥ recebe de (√© alvo da rela√ß√£o de)"
      },
      "exemplo": "--> PJ_EMPRESA - Ativa - (Administrador) significa que este n√≥ √© administrador da empresa"
    }
  },
  "padroes_analise": {
    "identificar_no_principal": {
      "metodo": "Procurar n√≥ com color.border='red' ou t√≠tulo contendo 'Dist√¢ncia Alvo: 0'"
    },
    "calcular_distancias": {
      "metodo": "Extrair 'Dist√¢ncia Alvo: X' do campo title",
      "descricao": "Indica quantos saltos o n√≥ est√° do n√≥ principal"
    },
    "identificar_hubs": {
      "metodo": "Ordenar n√≥s por 'value' (grau) decrescente",
      "descricao": "N√≥s com alto grau s√£o hubs/concentradores"
    },
    "identificar_entidades_centrais": {
      "metodo": "Verificar campo 'algoritmos' e extrair rankings de centralidade",
      "descricao": "Entidades que aparecem em m√∫ltiplos rankings s√£o estruturalmente importantes"
    },
    "mapear_grupos_corporativos": {
      "metodo": "Seguir arestas com label 'S√≥cio' entre PJs",
      "descricao": "Identifica estruturas de holdings e subsidi√°rias"
    },
    "identificar_controladores": {
      "metodo": "Procurar PFs com m√∫ltiplas arestas 'Administrador' ou 'S√≥cio' para diferentes PJs",
      "descricao": "Pessoas que controlam m√∫ltiplas empresas"
    },
    "analisar_internacionalizacao": {
      "metodo": "Contar: (1) PJs com 'images\\pj_exterior_ativa.png' ou 'images\\pj_exterior_inativa.png', (2) n√≥s com prefixo 'PE_', e (3) arestas com label 'S√≥cio Pessoa Jur√≠dica Domiciliado no Exterior'",
      "descricao": "Identifica estruturas internacionais. PJ_ com UF='EX' s√£o empresas estrangeiras com CNPJ. PE_ s√£o empresas estrangeiras sem informa√ß√£o de situa√ß√£o cadastral"
    }
  },
  "exemplos_queries_analise": {
    "listar_administradores_empresa_alvo": {
      "descricao": "Encontrar todas as pessoas que administram a empresa alvo",
      "logica": "Filtrar edges onde to=id_empresa_alvo e label cont√©m 'Administrador'"
    },
    "encontrar_empresas_pessoa": {
      "descricao": "Listar todas as empresas vinculadas a uma pessoa",
      "logica": "Filtrar edges onde from=id_pessoa e to come√ßa com 'PJ_' ou 'PE_'"
    },
    "mapear_grupo_economico": {
      "descricao": "Identificar todas as empresas de um mesmo grupo",
      "logica": "Seguir recursivamente arestas 'S√≥cio' entre PJs e PEs a partir de uma empresa"
    },
    "identificar_pessoas_chave": {
      "descricao": "Pessoas com v√≠nculos em m√∫ltiplas empresas do grafo",
      "logica": "Contar edges onde from √© PF e agrupar por from, ordenar por contagem"
    },
    "analisar_sobreposicao_gestores": {
      "descricao": "Empresas que compartilham administradores",
      "logica": "Encontrar PFs que aparecem como administradores de m√∫ltiplas PJs/PEs"
    },
    "identificar_estruturas_offshore": {
      "descricao": "Mapear empresas estrangeiras e suas conex√µes locais",
      "logica": "Filtrar nodes onde id come√ßa com 'PE_' ou (id come√ßa com 'PJ_' e image cont√©m 'exterior'), depois mapear suas conex√µes com PFs e PJs brasileiras"
    }
  },
  "icones_especiais": {
    "com_dividas": {
      "descricao": "Quando uma entidade possui d√≠vidas registradas, o √≠cone recebe sufixo '_com_bandeira'",
      "variantes": [
        "images\\pj_brasil_ativa_com_bandeira.png",
        "images\\pj_brasil_inativa_com_bandeira.png",
        "images\\pj_exterior_ativa_com_bandeira.png",
        "images\\pj_exterior_inativa_com_bandeira.png"
      ],
      "identificacao": "Verificar se o nome do arquivo de imagem cont√©m '_com_bandeira'",
      "significado": "A entidade possui d√≠vidas ou pend√™ncias cadastradas"
    }
  },
  "interpretacao_situacao_cadastral": {
    "ativa": {
      "indicadores": ["- Ativa -", "images\\pj_brasil_ativa.png", "images\\pj_exterior_ativa.png"],
      "descricao": "Empresa com situa√ß√£o cadastral regular na Receita Federal",
      "aplica_se_a": ["PJ_ brasileira", "PJ_ estrangeira com CNPJ (UF='EX')"]
    },
    "baixada": {
      "indicadores": ["- Baixada -", "images\\pj_brasil_inativa.png", "images\\pj_exterior_inativa.png"],
      "descricao": "Empresa encerrada/baixada na Receita Federal",
      "aplica_se_a": ["PJ_ brasileira", "PJ_ estrangeira com CNPJ (UF='EX')"]
    },
    "estrangeira_sem_info": {
      "indicadores": ["PE_", "images\\pj_exterior_ativa.png"],
      "descricao": "Pessoa Estrangeira SEM CNPJ brasileiro - n√£o h√° informa√ß√£o de situa√ß√£o cadastral na Receita Federal (sempre exibida como 'ativa' por padr√£o visual)",
      "aplica_se_a": ["PE_ somente"],
      "observacao": "PE_ n√£o tem situa√ß√£o cadastral porque n√£o est√° cadastrada na Receita Federal brasileira. Aparece apenas como vinculada a empresas brasileiras."
    }
  },
  "notas_importantes": {
    "privacidade": "CPFs s√£o mascarados com asteriscos (***XXXXXX**) para prote√ß√£o de dados",
    "cnpj": "CNPJs s√£o exibidos completos pois s√£o dados p√∫blicos",
    "diferencas_pj_pe": {
      "titulo": "DIFEREN√áA CR√çTICA ENTRE PJ_ E PE_ PARA EMPRESAS ESTRANGEIRAS",
      "PJ_com_UF_EX": {
        "descricao": "Pessoa Jur√≠dica estrangeira domiciliada no exterior que POSSUI CNPJ brasileiro",
        "caracteristicas": [
          "Tem CNPJ de 14 d√≠gitos registrado na Receita Federal",
          "Possui informa√ß√£o de situa√ß√£o cadastral (ativa/baixada)",
          "Geralmente tem filial, representa√ß√£o ou opera√ß√µes no Brasil",
          "ID no formato: PJ_00000000000000 (14 d√≠gitos)"
        ],
        "exemplos_uso": "Filial brasileira de multinacional, escrit√≥rio de representa√ß√£o, empresa estrangeira com opera√ß√µes no Brasil"
      },
      "PE_": {
        "descricao": "Pessoa Estrangeira domiciliada no exterior que N√ÉO possui CNPJ brasileiro",
        "caracteristicas": [
          "N√ÉO tem CNPJ brasileiro - usa identificador pr√≥prio",
          "N√ÉO possui informa√ß√£o de situa√ß√£o cadastral na Receita Federal",
          "Aparece apenas como vinculada a empresas brasileiras (ex: s√≥cia)",
          "N√£o tem opera√ß√£o direta no Brasil",
          "ID no formato: PE_[identificador]"
        ],
        "exemplos_uso": "Holding internacional s√≥cia de empresa brasileira, matriz estrangeira sem filial no Brasil, investidor estrangeiro em empresa brasileira"
      },
      "regra_pratica": "Se tem CNPJ ‚Üí PJ_. Se n√£o tem CNPJ ‚Üí PE_. Ambas podem ser estrangeiras, a diferen√ßa est√° na presen√ßa ou n√£o de CNPJ brasileiro"
    },
    "direcionalidade": "A dire√ß√£o das setas √© crucial para interpretar quem tem qual papel",
    "recursividade": "Grafos podem ter m√∫ltiplos n√≠veis (camadas) de profundidade a partir do n√≥ alvo",
    "conectividade": "Campo 'Conectado: Sim' indica que o componente do grafo est√° conectado",
    "encoding": "Alguns caracteres podem aparecer com encoding especial (ex: \\ em caminhos)",
    "bandeiras": "√çcones com '_com_bandeira' indicam que a entidade possui d√≠vidas registradas",
    "tamanho_nos": "N√≥s de empresas estrangeiras (PJ_ com UF='EX' e PE_) t√™m tamanho padr√£o 30, enquanto entidades nacionais t√™m tamanho 20 e dados de contato t√™m tamanho 15"
  },
  "casos_uso_ia": {
    "deteccao_conflito_interesse": {
      "descricao": "Identificar pessoas que administram empresas que se relacionam entre si",
      "aplicacao": "An√°lise de licita√ß√µes, contratos p√∫blicos"
    },
    "mapeamento_grupos_economicos": {
      "descricao": "Reconstruir estruturas societ√°rias complexas",
      "aplicacao": "Auditoria, compliance, investiga√ß√µes"
    },
    "analise_concentracao_poder": {
      "descricao": "Identificar indiv√≠duos que controlam m√∫ltiplas entidades",
      "aplicacao": "An√°lise antitruste, governan√ßa corporativa"
    },
    "rastreamento_vinculacoes": {
      "descricao": "Seguir cadeias de relacionamentos entre entidades",
      "aplicacao": "Due diligence, investiga√ß√µes de fraude"
    },
    "identificacao_estruturas_offshore": {
      "descricao": "Detectar empresas estrangeiras e suas conex√µes locais",
      "aplicacao": "An√°lise de evas√£o fiscal, compliance internacional",
      "diferenciacao": {
        "pj_exterior": "Buscar PJ_ com UF='EX' - empresas com CNPJ e opera√ß√µes formais no Brasil",
        "pe_": "Buscar PE_ - empresas sem CNPJ que aparecem apenas como s√≥cias/controladoras",
        "interpretacao": "PJ_ exterior indica presen√ßa formal no Brasil. PE_ indica estrutura puramente de participa√ß√£o societ√°ria."
      }
    },
    "mapeamento_estruturas_internacionais": {
      "descricao": "Distinguir tipos de presen√ßa estrangeira no Brasil",
      "aplicacao": "Due diligence, an√°lise de investimento estrangeiro direto (IED)",
      "metodo": [
        "PJ_ com UF='EX': Investimento estrangeiro com estrutura local (filial/subsidi√°ria)",
        "PE_: Investimento estrangeiro sem estrutura local (apenas participa√ß√£o acion√°ria)",
        "Analisar cadeia: PE_ ‚Üí PJ_brasil indica matriz estrangeira sem CNPJ controlando subsidi√°ria brasileira",
        "Analisar cadeia: PJ_exterior ‚Üí PJ_brasil indica grupo multinacional com presen√ßa formal no Brasil"
      ]
    }
  },
  "dicas_processamento": {
    "parsing_title": {
      "recomendacao": "Fazer split por \\n e parsear cada se√ß√£o separadamente",
      "cuidado": "Formato pode variar entre tipos de entidade"
    },
    "normalizacao_nomes": {
      "recomendacao": "Remover acentos e converter para mai√∫sculas para compara√ß√µes",
      "exemplo": "NESTLE vs NESTL√â"
    },
    "identificacao_tipo": {
      "recomendacao": "Usar prefixo do ID (PF_, PJ_, PE_, EM_, TE_, EN_)",
      "alternativa": "Verificar padr√£o do campo image",
      "observacao": "PE_ e PJ_ com UF='EX' s√£o ambos entidades estrangeiras, mas PE_ n√£o possui informa√ß√£o de situa√ß√£o cadastral"
    },
    "construcao_matriz_adjacencia": {
      "recomendacao": "Usar edges para construir matriz de adjac√™ncias direcionada",
      "nota": "Manter labels das arestas para an√°lise qualitativa"
    },
    "cache_metricas": {
      "recomendacao": "Extrair e cachear m√©tricas do campo 'algoritmos' quando dispon√≠vel",
      "beneficio": "Evita rec√°lculo de m√©tricas computacionalmente caras"
    }
  }
}

`;

let textoLegenda = legendaGrafo;
      

      // 3) Configura√ß√µes de layout
      const margemEsq = 15;
      const margemTopo = 15;
      const larguraMax = 180;
      const alturaPagina = 280;
      const linhaAvanco = 3.5;

      doc.setFont("courier");
      doc.setFontSize(8);

      // 4) Adicionar JSON do grafo
      const linhas = doc.splitTextToSize(textoJSON, larguraMax);
      let y = margemTopo;

      for (let i = 0; i < linhas.length; i++) {
        if (y > alturaPagina) {
          doc.addPage();
          y = margemTopo;
        }
        doc.text(linhas[i], margemEsq, y);
        y += linhaAvanco;
      }

      // 5) Adicionar separador
      if (y > alturaPagina - 20) {
        doc.addPage();
        y = margemTopo;
      } else {
        y += linhaAvanco * 3;
      }
      
      doc.setFontSize(10);
      doc.text("=".repeat(60), margemEsq, y);
      y += linhaAvanco * 2;
      doc.text("LEGENDA DE INTERPRETA√á√ÉO DO GRAFO", margemEsq, y);
      y += linhaAvanco;
      doc.text("=".repeat(60), margemEsq, y);
      y += linhaAvanco * 2;
      
      doc.setFontSize(8);

      // 6) Adicionar JSON da legenda
      const linhasLegenda = doc.splitTextToSize(textoLegenda, larguraMax);

      for (let i = 0; i < linhasLegenda.length; i++) {
        if (y > alturaPagina) {
          doc.addPage();
          y = margemTopo;
        }
        doc.text(linhasLegenda[i], margemEsq, y);
        y += linhaAvanco;
      }

      // 7) Salvar arquivo
      doc.save("grafo_json.pdf");

      //console.log("PDF gerado com m√∫ltiplas p√°ginas:", grafoExport);
    }


    // Torna a fun√ß√£o global para que o menu possa cham√°-la
    window.exportarGrafoParaPDF = exportarGrafoParaPDF;
    









    
    </script>


     











    <script>
    // ========================================
    // FUN√á√ÉO DE OTIMIZA√á√ÉO AUTOM√ÅTICA DO GRAFO
    // ========================================

    function otimizarGrafoAutomaticamente() {
        //console.log("üéØ OTIMIZA√á√ÉO AUTOM√ÅTICA - INICIANDO...");


        // ========================================
        // FOR√áAR OPERA√á√ÉO COMO GRAFO DE 2 CAMADAS
        // ========================================
        
        

        // 0. RESETAR MASSA DOS N√ìS ALTERADOS
        for (let i=0; i<n_bag.length; i++) {
            nodes.update({id: n_bag[i], mass: 1});
            // console.log('Reset mass for node id:', n_bag[i]);
        }
        // Limpa o array de n√≥s j√° processados
        n_bag = [];
        
        // Reseta a refer√™ncia de tamanho e o controle de primeira execu√ß√£o
        t_ref = 40;
        pula_100 = true;

        console.log("‚úì Sistema de ajuste de massa resetado (todas as massas = 1)");



        // ========================================
        // ARMAZENA TAMANHOS ORIGINAIS (PRIMEIRA VEZ)
        // ========================================
        let nosIds = nodes.getIds();
        for (let i = 0; i < nosIds.length; i++) {
            let nodeId = nosIds[i];
            // S√≥ armazena se ainda n√£o existe (primeira vez)
            if (!tamanhosOriginais[nodeId]) {
                tamanhosOriginais[nodeId] = network.body.nodes[nodeId].options.size;
            }
        }

    
        // ========================================
        // VERIFICA SE √â GRAFO DE 1 CAMADA
        // ========================================
        if (typeof n_cam !== 'undefined' && n_cam === 1) {
            console.log("‚úì Grafo de 1 camada detectado - Pressionando K...");
            
            const evtK = new KeyboardEvent('keydown', {
                key: 'k', code: 'KeyK', keyCode: 75, which: 75,
                bubbles: true, cancelable: true, view: window
            });
            document.dispatchEvent(evtK);
            
            tempAlert('Grafo de 1 camada: aplicando layout hier√°rquico...', 2000);

            return;
        } else if (typeof n_cam === 'undefined' || n_cam > 1) {
            n_cam = 2;
        }

        
        // 1. CALCULAR DISTRIBUI√á√ÉO PRIMEIRO (antes de deletar n√≥s)
        let todosNos = nodes.getIds();
        let distribuicao = {100:[], 95:[], 90:[], 85:[], 80:[], 75:[], 70:[], 65:[], 60:[], 55:[], 50:[], 45:[], 40:[], 35:[], 30:[], 25:[], 20:[]};
        
        for (let i = 0; i < todosNos.length; i++) {
            let nodeId = todosNos[i];
            let nodeIdStr = String(nodeId);
            
            // Ignora n√≥s TE/EN/EM no c√°lculo (ser√£o deletados)
            if (nodeIdStr.slice(0, 3) === "TE_" || nodeIdStr.slice(0, 3) === "EN_" || nodeIdStr.slice(0, 3) === "EM_") {
                continue;
            }
            
            // Usa tamanho original se existir, sen√£o usa o atual
            let tamanho = tamanhosOriginais[nodeId] || network.body.nodes[nodeId].options.size;
            
            if (tamanho >= 99.99) distribuicao[100].push(nodeId);
            else if (tamanho >= 95) distribuicao[95].push(nodeId);
            else if (tamanho >= 90) distribuicao[90].push(nodeId);
            else if (tamanho >= 85) distribuicao[85].push(nodeId);
            else if (tamanho >= 80) distribuicao[80].push(nodeId);
            else if (tamanho >= 75) distribuicao[75].push(nodeId);
            else if (tamanho >= 70) distribuicao[70].push(nodeId);
            else if (tamanho >= 65) distribuicao[65].push(nodeId);
            else if (tamanho >= 60) distribuicao[60].push(nodeId);
            else if (tamanho >= 55) distribuicao[55].push(nodeId);
            else if (tamanho >= 50) distribuicao[50].push(nodeId);
            else if (tamanho >= 45) distribuicao[45].push(nodeId);
            else if (tamanho >= 40) distribuicao[40].push(nodeId);
            else if (tamanho >= 35) distribuicao[35].push(nodeId);
            else if (tamanho >= 30) distribuicao[30].push(nodeId);
            else if (tamanho >= 25) distribuicao[25].push(nodeId);
            else if (tamanho >= 20) distribuicao[20].push(nodeId);
        }
        
        console.log("DISTRIBUI√á√ÉO:", distribuicao);


        // 2. DELETAR N√ìS TE, EN, EM (depois do c√°lculo)
        let nodosParaDeletar = [];
        
        for (let i = 0; i < todosNos.length; i++) {
            let nodeIdStr = String(todosNos[i]);

            if (nodeIdStr.slice(0, 3) === "TE_" || nodeIdStr.slice(0, 3) === "EN_" || nodeIdStr.slice(0, 3) === "EM_") {
                nodosParaDeletar.push(todosNos[i]);
            }
        }
        
        
        if (nodosParaDeletar.length > 0) {
            nodes.remove(nodosParaDeletar);
            console.log(`‚úì ${nodosParaDeletar.length} n√≥s deletados (TE/EN/EM)`);

            tempAlert(`Otimiza√ß√£o: ${nodosParaDeletar.length} n√≥s deletados`, 2000);
        }

        
        // 3. CALCULAR N√öMERO IDEAL DE PRESSIONAMENTOS
        // Conta apenas os n√≥s que realmente entraram na distribui√ß√£o (exclui TE/EN/EM)
        let totalNos = 0;
        for (let faixa in distribuicao) {
            totalNos += distribuicao[faixa].length;
        }
        let nosAcumulados = 0;
        let pressionamentosIdeal = 0;



        
        let faixas = [100, 95, 90, 85, 80, 75, 70, 65, 60, 55, 50, 45, 40, 35, 30, 25, 20];
        
        // =========================================================================
        // CONFIGURA√á√ïES - AJUST√ÅVEIS
        // =========================================================================
        // ESTRAT√âGIA: 3 crit√©rios independentes para detectar saltos
        // M√≠nimo relativo adapta-se ao tamanho do grafo
        // =========================================================================
        
        const LIMIAR_SALTO_PERCENTUAL = 0.15;      // 10% do total (salto absoluto)
        const LIMIAR_SALTO_RELATIVO = 2.0;         // 3.5x a m√©dia (salto moderado)
        const LIMIAR_MINIMO_RELATIVO = 0.05;       // 5% do total (m√≠nimo para salto moderado)
        const LIMIAR_SALTO_GIGANTE = 9.0;          // 9x a m√©dia (salto gigante)
        const MINIMO = 2;                          // M√≠nimo 2 pressionamentos
        const MAXIMO = 16;                         // M√°ximo 16 pressionamentos
        
        // Calcula m√≠nimo absoluto baseado no tamanho do grafo (m√≠nimo: 10 n√≥s)
        let minimoAbsoluto = Math.max(3, Math.floor(totalNos * LIMIAR_MINIMO_RELATIVO));
        console.log(`\nM√≠nimo absoluto calculado: ${minimoAbsoluto} n√≥s (${LIMIAR_MINIMO_RELATIVO*100}% de ${totalNos})`);
        
        // Calcula m√©dia m√≥vel das √∫ltimas faixas processadas (janela de 3)
        let historicoFaixas = [];
        
        console.log("\n=== AN√ÅLISE FAIXA POR FAIXA ===");
        
        for (let i = 0; i < faixas.length - 1; i++) {
            let faixaAtual = faixas[i];
            let faixaProxima = faixas[i + 1];
            let nosNaFaixaAtual = distribuicao[faixaAtual].length;
            let nosNaProximaFaixa = distribuicao[faixaProxima].length;
            
            // Adiciona faixa atual ao acumulado
            nosAcumulados += nosNaFaixaAtual;
            pressionamentosIdeal++;
            
            let porcentagemFaixaAtual = nosNaFaixaAtual / totalNos;
            let porcentagemProximaFaixa = nosNaProximaFaixa / totalNos;
            
            // Atualiza hist√≥rico (mant√©m √∫ltimas 3 faixas n√£o-vazias)
            if (nosNaFaixaAtual > 0) {
                historicoFaixas.push(nosNaFaixaAtual);
                if (historicoFaixas.length > 3) {
                    historicoFaixas.shift();
                }
            }
            
            // Calcula m√©dia das faixas recentes
            let mediaRecente = historicoFaixas.length > 0 
                ? historicoFaixas.reduce((a, b) => a + b, 0) / historicoFaixas.length 
                : nosNaFaixaAtual;
            
            console.log(`Faixa ${faixaAtual}: ${nosNaFaixaAtual} n√≥s (${(porcentagemFaixaAtual*100).toFixed(1)}%)`);
            console.log(`  ‚Üí Pr√≥xima faixa ${faixaProxima}: ${nosNaProximaFaixa} n√≥s (${(porcentagemProximaFaixa*100).toFixed(1)}%)`);
            console.log(`  ‚Üí M√©dia recente: ${mediaRecente.toFixed(1)} n√≥s`);
            
            // =====================================================================
            // CRIT√âRIOS DE DETEC√á√ÉO DE SALTO (3 crit√©rios independentes)
            // =====================================================================
            
            if (pressionamentosIdeal >= MINIMO) {
                
                // CRIT√âRIO 1: SALTO ABSOLUTO (% do total)
                // Para se pr√≥xima faixa tem muitos n√≥s em rela√ß√£o ao total
                if (porcentagemProximaFaixa >= LIMIAR_SALTO_PERCENTUAL) {
                    console.log(`‚úì CRIT√âRIO 1 - SALTO ABSOLUTO detectado!`);
                    console.log(`  Pr√≥xima faixa ${faixaProxima} tem ${(porcentagemProximaFaixa*100).toFixed(1)}% dos n√≥s (limiar: ${(LIMIAR_SALTO_PERCENTUAL*100).toFixed(0)}%)`);
                    console.log(`  ‚Üí PARA AQUI para evitar espalhar grafo`);
                    break;
                }
                
                // CRIT√âRIO 2: SALTO GIGANTE (independente do valor absoluto)
                // Para se pr√≥xima faixa tem MUITAS vezes mais n√≥s que a m√©dia
                if (mediaRecente > 0 && nosNaProximaFaixa > mediaRecente * LIMIAR_SALTO_GIGANTE) {
                    console.log(`‚úì CRIT√âRIO 2 - SALTO GIGANTE detectado!`);
                    console.log(`  Pr√≥xima faixa ${faixaProxima} tem ${nosNaProximaFaixa} n√≥s`);
                    console.log(`  M√©dia recente: ${mediaRecente.toFixed(1)} n√≥s`);
                    console.log(`  Propor√ß√£o: ${(nosNaProximaFaixa / mediaRecente).toFixed(1)}x (limiar: ${LIMIAR_SALTO_GIGANTE}x)`);
                    console.log(`  ‚Üí PARA AQUI para evitar espalhar grafo`);
                    break;
                }
                
                // CRIT√âRIO 3: SALTO MODERADO + MUITOS N√ìS (relativo ao total)
                // Para se pr√≥xima faixa √© maior que a m√©dia E tem muitos n√≥s proporcionalmente
                if (mediaRecente > 0 && 
                    nosNaProximaFaixa > mediaRecente * LIMIAR_SALTO_RELATIVO &&
                    nosNaProximaFaixa >= minimoAbsoluto) {
                    console.log(`‚úì CRIT√âRIO 3 - SALTO MODERADO + MUITOS N√ìS detectado!`);
                    console.log(`  Pr√≥xima faixa ${faixaProxima} tem ${nosNaProximaFaixa} n√≥s`);
                    console.log(`  M√©dia recente: ${mediaRecente.toFixed(1)} n√≥s`);
                    console.log(`  Propor√ß√£o: ${(nosNaProximaFaixa / mediaRecente).toFixed(1)}x (limiar: ${LIMIAR_SALTO_RELATIVO}x)`);
                    console.log(`  E tem ‚â•${minimoAbsoluto} n√≥s (${LIMIAR_MINIMO_RELATIVO*100}% do total)`);
                    console.log(`  ‚Üí PARA AQUI para evitar espalhar grafo`);
                    break;
                }
            }
            
            // Limite m√°ximo de seguran√ßa
            if (pressionamentosIdeal >= MAXIMO) {
                console.log(`‚úì Limite m√°ximo de seguran√ßa atingido (${MAXIMO})`);
                break;
            }
        }
        
        // Garante m√≠nimo de seguran√ßa
        if (pressionamentosIdeal < MINIMO) {
            pressionamentosIdeal = MINIMO;
            console.log(`‚úì Aplicando m√≠nimo de seguran√ßa: ${MINIMO} pressionamentos`);
        }

        console.log(`\n>>> RESULTADO: ${pressionamentosIdeal} pressionamentos`);
        console.log(`>>> Cobertura: ${(nosAcumulados/totalNos*100).toFixed(1)}%`);
        
        // 4. PRESSIONAR TECLA ESPA√áO
        tempAlert(`Otimiza√ß√£o: Aplicando ${pressionamentosIdeal} ajustes...`, 2000);
        
        function simularEspaco() {
            const evt = new KeyboardEvent('keydown', {
                key: ' ', code: 'Space', keyCode: 32, which: 32,
                bubbles: true, cancelable: true, view: window
            });
            document.dispatchEvent(evt);
        }
        
        let contador = 0;
        const intervalo = setInterval(() => {
            simularEspaco();
            contador++;
            console.log(`  Pressionamento ${contador}/${pressionamentosIdeal}`);
            
            if (contador >= pressionamentosIdeal) {
                clearInterval(intervalo);
                
                // 5. CENTRALIZAR (ESC)
                setTimeout(() => {
                    const evtEsc = new KeyboardEvent('keydown', {
                        key: 'Escape', code: 'Escape', keyCode: 27, which: 27,
                        bubbles: true, cancelable: true, view: window
                    });
                    document.dispatchEvent(evtEsc);

                    // ‚úÖ DESSELECIONA TODOS OS N√ìS AP√ìS CADA PRESSIONAMENTO
                    network.unselectAll();
                    
                    console.log("‚úì OTIMIZA√á√ÉO CONCLU√çDA!");
                    tempAlert(`‚úì Grafo otimizado! (${pressionamentosIdeal} ajustes aplicados)`, 3000);
                }, 1000);
            }
        }, 200);
    }

    // Torna fun√ß√£o global
    window.otimizarGrafoAutomaticamente = otimizarGrafoAutomaticamente;

    </script>


    


    <script>
    // Event listener para o bot√£o de otimiza√ß√£o
    document.getElementById('sinarc-otimizar-button').addEventListener('click', function() {
        // Feedback visual
        this.style.background = 'rgba(89, 201, 67, 0.4)';
        setTimeout(() => {
            this.style.background = '';
        }, 300);
        
        // Chama a fun√ß√£o de otimiza√ß√£o
        if (typeof otimizarGrafoAutomaticamente === 'function') {
            otimizarGrafoAutomaticamente();
        } else {
            console.error('Fun√ß√£o otimizarGrafoAutomaticamente n√£o encontrada!');
            alert('Erro: Fun√ß√£o de otimiza√ß√£o n√£o est√° dispon√≠vel.');
        }
    });
    </script>





    <script>
    // ========================================
    // DUPLO CLIQUE NO FUNDO = ESC
    // ========================================

    function ativarDuploCliqueESC() {
        let container = document.getElementById('mynetwork') || 
                        document.querySelector('#network') || 
                        document.querySelector('[id*="network"]');
        
        if (!container) {
            console.error('‚ùå Container do grafo n√£o encontrado!');
            return;
        }
        
        if (typeof network === 'undefined') {
            console.error('‚ùå Objeto network n√£o encontrado!');
            return;
        }
        
        // Listener para duplo clique
        network.on('doubleClick', function(params) {
            // Verificar se clicou no fundo (n√£o em n√≥ ou aresta)
            if (params.nodes.length === 0 && params.edges.length === 0) {
                //console.log('‚ö° Duplo clique no fundo - simulando ESC');
                
                // Simular pressionamento da tecla ESC
                const eventESC = new KeyboardEvent('keydown', {
                    key: 'Escape',
                    code: 'Escape',
                    keyCode: 27,
                    which: 27,
                    bubbles: true,
                    cancelable: true
                });
                
                document.dispatchEvent(eventESC);
                
                // Tamb√©m disparar keyup para completar o ciclo
                const eventESCUp = new KeyboardEvent('keyup', {
                    key: 'Escape',
                    code: 'Escape',
                    keyCode: 27,
                    which: 27,
                    bubbles: true,
                    cancelable: true
                });
                
                document.dispatchEvent(eventESCUp);
            }
        });
        
        //console.log('‚úÖ Duplo clique no fundo = ESC ativado');
    }

    // Ativar quando o network estiver pronto
    if (typeof network !== 'undefined') {
        ativarDuploCliqueESC();
    } else {
        // Tentar ap√≥s um pequeno delay se network ainda n√£o existe
        setTimeout(function() {
            if (typeof network !== 'undefined') {
                ativarDuploCliqueESC();
            }
        }, 1000);
    }
    </script>






    











<script>

// ======================================
// FUN√á√ïES PARA MAPA GEOGR√ÅFICO DO SINARC
// ======================================

// ==============
// DADOS DE TESTE
// ==============
const empresasTeste = [
    {
        razao_social: "EMPRESA TESTE LTDA",
        endereco_completo: "Av. Paulista, 1000 - Bela Vista, S√£o Paulo - SP, 01310-100",
        cidade: "S√£o Paulo",
        uf: "SP"
    },
    {
        razao_social: "CONSULTORIA ABC S/A",
        endereco_completo: "Rua da Candel√°ria, 65 - Centro, Rio de Janeiro - RJ, 20091-020",
        cidade: "Rio de Janeiro",
        uf: "RJ"
    },
    {
        razao_social: "TECH SOLUTIONS ME",
        endereco_completo: "Rua Sete de Setembro, 500 - Centro, Fortaleza - CE, 60060-000",
        cidade: "Fortaleza",
        uf: "CE"
    },
    {
        razao_social: "COM√âRCIO XYZ EIRELI",
        endereco_completo: "Av. Expedito Garcia, 83 - Campo Grande, Cariacica - ES, 29146-201",
        cidade: "Cariacica",
        uf: "ES"
    },
    {
        razao_social: "IND√öSTRIA BETA LTDA",
        endereco_completo: "Sunset Boulevard, 1000 - Hollywood, Los Angeles - CA, USA",
        cidade: "Los Angeles",
        uf: "CA"
    }
];

// ===============================
// FUN√á√ÉO PARA EXTRAIR DADOS DO GRAFO E GERAR MAPA (VERS√ÉO CORRIGIDA)
// ===============================
function extrairDadosGrafoParaMapa() {
    
    // Array para armazenar os dados das empresas
    const empresas = [];
    
    // Acessa os n√≥s do grafo via vis.js
    // ===============================
    // USAR APENAS N√ìS SELECIONADOS
    // ===============================
    const idsSelecionados = network.getSelectedNodes();

    if (!idsSelecionados || idsSelecionados.length === 0) {
        // Exibe informa√ß√µes na tela
        tempAlert(`Exibe endere√ßos no mapa - Nenhum n√≥ selecionado no grafo.`, 3000);
        //alert('Nenhum n√≥ selecionado no grafo.');
        return [];
    }

    // Recupera apenas os n√≥s selecionados
    const nosDoGrafo = idsSelecionados
    .map(id => nodes.get(id))
    .filter(no => no); // seguran√ßa

    
    console.log(`Total de n√≥s no grafo: ${nosDoGrafo.length}`);
    
    /*
    // Filtra apenas n√≥s do tipo PJ_ (pessoas jur√≠dicas)
    const empresasPJ = nosDoGrafo.filter(no => no.id && no.id.startsWith('PJ_'));
    
    console.log(`Total de empresas (PJ) no grafo: ${empresasPJ.length}`);
    */
    
    // Filtra n√≥s do tipo PJ_ (pessoas jur√≠dicas) e PE_ (pessoas estrangeiras)
    const empresasPJ = nosDoGrafo.filter(no => no.id && (no.id.startsWith('PJ_') || no.id.startsWith('PE_')));
    
    //console.log(`Total de empresas (PJ/PE) no grafo: ${empresasPJ.length}`);
    
    // Itera sobre cada empresa
    empresasPJ.forEach(no => {
        try {
            //const title = no.title || '';
            const title = (typeof no.title === 'string' && no.title.trim() !== '')
            ? no.title
            : (typeof no._tooltip_html === 'string' ? no._tooltip_html : '');


            const razaoSocial = no.label || 'Empresa n√£o identificada';
            
            const linhas = title.split('\n');

		

// ===============================
// EXTRAIR SITUA√á√ÉO DA EMPRESA (PELA IMAGEM DO N√ì)
// ===============================
let situacao = 'Desconhecida';

if (typeof no.image === 'string') {
    const nomeImagem = no.image.toLowerCase();

    if (nomeImagem.includes('_inativa')) {
        situacao = 'Baixada';
    } else if (nomeImagem.includes('_ativa')) {
        situacao = 'Ativa';
    }
}




            
            if (linhas.length < 2) {
                console.warn(`Empresa ${razaoSocial}: informa√ß√µes insuficientes no title`);
                return;
            }
            
            // CORRE√á√ÉO: Procura a linha que cont√©m o endere√ßo
            // O endere√ßo sempre termina com " - UF" ou "-UF" (2 letras mai√∫sculas)
            let enderecoLinha = '';
            
            // ATEN√á√ÉO: O MAPA EXIBE OS ENDERE√áOS DE TODAS AS PJ/ES, MESMO QUANDO N√ÉO COMPARTILHADOS COM OUTRAS PJ/PE NA BASE DE DADOS
            for (let i = 1; i < linhas.length && i < 5; i++) {
                const linha = linhas[i].trim();
                
                // Verifica se a linha termina com UF (padr√£o: - UF ou -UF)
                if (/-[A-Z]{2}\s*$/.test(linha) || /\s+-\s+[A-Z]{2}\s*$/.test(linha)) {
                //if (/-\sEX\s/.test(linha) || /[A-Z]{2}\s-/.test(linha)) {
                    enderecoLinha = linha;
                    break;
                }
            }
            
            if (!enderecoLinha) {
                console.warn(`Empresa ${razaoSocial}: endere√ßo n√£o encontrado no title`);
                return;
            }
            
            let municipio = '';
            let uf = '';
            
            // Divide o endere√ßo por " - "
            const partesEndereco = enderecoLinha.split(' - ');
            
            if (partesEndereco.length >= 2) {
                const ultimaParte = partesEndereco[partesEndereco.length - 1].trim();
                
                // CASO 1: √öltima parte √© s√≥ a UF (2 letras)
                // Exemplo: "... - S√£o Paulo - SP"
                if (/^[A-Z]{2}$/.test(ultimaParte)) {
                    uf = ultimaParte;
                    municipio = partesEndereco[partesEndereco.length - 2].trim();
                }
                // CASO 2: √öltima parte √© MUNIC√çPIO-UF (h√≠fen grudado, sem espa√ßos)
                // Exemplo: "... - FEIRA DE SANTANA-BA"
                else if (/^(.+)-([A-Z]{2})$/.test(ultimaParte)) {
                    const match = ultimaParte.match(/^(.+)-([A-Z]{2})$/);
                    municipio = match[1].trim();
                    uf = match[2].trim();
                }
                // CASO 3: √öltima parte √© MUNIC√çPIO - UF (com espa√ßos ao redor do h√≠fen)
                else {
                    const match = ultimaParte.match(/^(.+?)\s+-\s+([A-Z]{2})$/);
                    if (match) {
                        municipio = match[1].trim();
                        uf = match[2].trim();
                    }
                }
            }
            
            // Se ainda n√£o encontrou, tenta extrair diretamente da linha completa
            if (!municipio || !uf) {
                // Busca padr√£o: qualquer coisa seguida de h√≠fen e 2 letras mai√∫sculas no final
                const match = enderecoLinha.match(/([A-Z√Ä-≈∏][A-Za-z√Ä-√ø\s]+)-([A-Z]{2})\s*$/);
                if (match) {
                    municipio = match[1].trim();
                    uf = match[2].trim();
                }
            }


            
            // Valida√ß√µes
            if (!municipio || municipio === '' || municipio.length < 2) {
                // Para exterior (EX), usa o endere√ßo completo como "cidade"
                if (uf === 'EX') {
                    municipio = enderecoLinha.split(' - ')[0].trim();  // Pega primeira parte do endere√ßo
                    console.log(`‚ö† Empresa exterior ${razaoSocial}: usando endere√ßo como cidade: "${municipio}"`);
                } else {
                    console.warn(`Empresa ${razaoSocial}: munic√≠pio inv√°lido. Endere√ßo: "${enderecoLinha}"`);
                    return;
                }
            }

            if (!uf || !/^[A-Z]{2}$/.test(uf)) {
                console.warn(`Empresa ${razaoSocial}: UF inv√°lida "${uf}". Endere√ßo: "${enderecoLinha}"`);
                return;
            }



            
            // Pula empresas do exterior
            //if (uf === 'EX') {
            //    console.log(`Empresa ${razaoSocial}: localizada no exterior, ignorada`);
            //    return;
            //}
            
            console.log(`‚úì ${razaoSocial}: ${municipio} - ${uf}`);
            
            // Adiciona ao array
            empresas.push({
                razao_social: razaoSocial,
                situacao: situacao, // <-- NOVO CAMPO
                endereco_completo: enderecoLinha,
                cidade: municipio,
                uf: uf
            });

            
        } catch (erro) {
            console.error(`Erro ao processar empresa ${no.label}:`, erro);
        }
    });
    
    console.log(`Total de empresas v√°lidas para o mapa: ${empresas.length}`);
    
    return empresas;
}

// ===============================
// FUN√á√ÉO PARA GERAR E ABRIR MAPA A PARTIR DO GRAFO
// ===============================
function gerarMapaDoGrafo() {
    
    console.log('Extraindo dados do grafo...');
    
    // Extrai dados das empresas do grafo
    const empresas = extrairDadosGrafoParaMapa();
    
    if (empresas.length === 0) {
        //tempAlert(`Nenhuma empresa com localiza√ß√£o v√°lida encontrada no grafo.`, 3000);
        //alert('Nenhuma empresa com localiza√ß√£o v√°lida encontrada no grafo.');
        return;
    }
    
    console.log(`Abrindo mapa com ${empresas.length} empresas...`);
    
    // Abre o mapa em nova janela
    abrirMapaEmpresas(empresas);
}

// ===============================
// FUN√á√ÉO PARA ABRIR MAPA EM NOVA JANELA
// ===============================
function abrirMapaEmpresas(empresas) {
    
    // Gerar HTML do mapa
    const htmlMapa = gerarHTMLMapa(empresas);
    
    // Abrir nova janela
    const janela = window.open(
    'about:blank',
    '_blank',
    'width=1200,height=800,scrollbars=yes,resizable=yes'
);

    
    // Escrever HTML na janela
    janela.document.open();
    janela.document.write(htmlMapa);
    janela.document.close();
}

// ===============================
// FUN√á√ÉO PARA GERAR HTML DO MAPA
// ===============================
function gerarHTMLMapa(empresas) {
    
    // Converter array completo para string JavaScript
    const empresasArray = JSON.stringify(empresas);
    
    let html = '<!DOCTYPE html>';
    html += '<html lang="pt-BR">';
    html += '<head>';
    html += '<meta charset="utf-8">';
    html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
    html += '<title>Mapa SINARC ‚Äì Agrupamento por Cidade</title>';
    html += '<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />';
    html += '<style>';
    html += 'html, body { margin: 0; height: 100%; }';
    html += '#map { height: 100vh; width: 100%; }';
    html += '#status { position: fixed; bottom: 10px; left: 10px; background: white; padding: 6px 10px; border: 1px solid #ccc; z-index: 1000; font-family: "Helvetica Neue", Arial, Helvetica, sans-serif; font-size: 12px; line-height: 1.4; }';
    html += '.marker-label { background: white; border: 1px solid #444; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: bold; text-align: center; }';
    html += '.empresa-link { color: #2c5f8d; text-decoration: none; font-weight: 500; transition: color 0.2s; }';
    html += '.empresa-link:hover { color: #1e4163; text-decoration: underline; }';

    html += '.leaflet-popup-content-wrapper { width: auto !important; min-width: 300px; max-width: none !important; }';
    html += '.leaflet-popup-content { width: auto !important; min-width: 280px; max-height: 400px; overflow-y: auto; white-space: nowrap; }';

    html += '.empresa-link { white-space: nowrap; }';

    html += '#btn-fit { position: fixed; top: 10px; right: 10px; z-index: 1000; ';
    html += 'background: white; ';
    html += 'border: 2px solid rgba(0,0,0,0.2); ';
    html += 'background-clip: padding-box; ';  
    html += 'border-radius: 4px; ';
    html += 'box-shadow: none; ';
    html += 'width: 34px; height: 34px; ';
    html += 'cursor: pointer; ';
    html += 'display: flex; align-items: center; justify-content: center; ';
    html += 'font-size: 26px; ';  
    html += 'line-height: 30px; ';
    html += 'text-align: center; ';
    html += 'text-decoration: none; ';
    html += 'color: black; ';
    html += '-webkit-text-fill-color: black; ';
    html += 'font-weight: bold; ';  
    html += 'transition: background 0.2s; }';  
    html += '#btn-fit:hover { background: #f4f4f4; }';
    html += '#btn-fit:active { transform: scale(0.98); }';

    html += '#btn-toggle-labels { position: fixed; top: 50px; right: 10px; z-index: 1000; ';
    html += 'background: white; ';
    html += 'border: 2px solid rgba(0,0,0,0.2); ';
    html += 'background-clip: padding-box; ';
    html += 'border-radius: 4px; ';
    html += 'box-shadow: none; ';
    html += 'width: 34px; height: 34px; ';
    html += 'cursor: pointer; ';
    html += 'display: flex; align-items: center; justify-content: center; ';
    html += 'font-size: 20px; ';
    html += 'line-height: 30px; ';
    html += 'text-align: center; ';
    html += 'text-decoration: none; ';
    html += 'color: black; ';
    html += '-webkit-text-fill-color: black; ';
    html += 'font-weight: bold; ';
    html += 'transition: background 0.2s; }';
    html += '#btn-toggle-labels:hover { background: #f4f4f4; }';
    html += '#btn-toggle-labels:active { transform: scale(0.98); }';
    html += '.tooltip-quantidade.hidden { display: none !important; }';

    html += '</style>';
    html += '</head>';
    html += '<body>';
    html += '<button id="btn-fit" title="Enquadrar todos os pontos">‚åÇ</button>';
    html += '<button id="btn-toggle-labels" title="Mostrar/Ocultar r√≥tulos das cidades">üëÅÔ∏è</button>';
    html += '<div id="map"></div>';
    html += '<div id="status">Carregando mapa e cidades...</div>';
    html += '<script src="https://unpkg.com/leaflet/dist/leaflet.js"><\/script>';
    html += '<script>';
    
    // Dados das empresas
    html += 'const empresas = ' + empresasArray + ';';
    
    // Fun√ß√£o de geocodifica√ß√£o
    html += 'async function geocodificarCidade(nomeCidade, uf) {';
    html += '  const countryParam = (uf === "EX") ? "" : "&countrycodes=br";';
    html += '  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=pt-BR&addressdetails=1" + countryParam + "&q=" + encodeURIComponent(nomeCidade);';
    html += '  const resposta = await fetch(url, { headers: { "User-Agent": "sinarc-mapa-teste/1.0" } });';
    html += '  const dados = await resposta.json();';
    html += '  if (dados.length === 0) { console.warn("Cidade n√£o encontrada:", nomeCidade); return null; }';
    html += '  return { lat: parseFloat(dados[0].lat), lng: parseFloat(dados[0].lon), nome: nomeCidade, pais: dados[0].address?.country_code || "" };';
    html += '}';
    
    // √çcones
    html += 'const iconeBrasil = L.icon({ iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });';
    html += 'const iconeExterior = L.icon({ iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png", shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });';
    
    // Fun√ß√£o principal do mapa
    html += 'async function carregarMapaPorCidade() {';
    html += '  const status = document.getElementById("status");';
    html += '  window.mapaSinarc = L.map("map");';  // ‚Üê GLOBAL
    html += '  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap contributors" }).addTo(window.mapaSinarc);';  // ‚Üê CORRIGIDO
    
    // Agrupar empresas por cidade+UF (chave √∫nica)
    html += '  const empresasPorCidade = {};';
    html += '  empresas.forEach(emp => {';
    html += '    const chave = `${emp.cidade} - ${emp.uf}`;';
    html += '    if (!empresasPorCidade[chave]) { ';
    html += '      empresasPorCidade[chave] = { cidade: emp.cidade, uf: emp.uf, empresas: [] };';
    html += '    }';
    html += '    empresasPorCidade[chave].empresas.push(emp);';
    html += '  });';
    
    html += '  console.log("Empresas por cidade:", empresasPorCidade);';
    html += '  window.limitesSinarc = L.latLngBounds([]);';  // ‚Üê GLOBAL
    html += '  let processadas = 0;';
    html += '  const total = Object.keys(empresasPorCidade).length;';

    // Array para coletar falhas
    html += '  const empresasNaoLocalizadas = [];';
    
    html += '  for (const chave in empresasPorCidade) {';
    html += '    const dadosCidade = empresasPorCidade[chave];';
    html += '    const cidadeNome = dadosCidade.cidade;';
    html += '    const uf = dadosCidade.uf;';
    html += '    const cidadeUF = (uf === "EX") ? cidadeNome : `${cidadeNome} - ${uf}`;';

    html += '    status.textContent = `Geocodificando: ${cidadeUF} (${++processadas}/${total})`;';
    html += '    const ponto = await geocodificarCidade(cidadeUF, uf);';
    html += '    if (ponto) {';
    html += '      const ehBrasil = ponto.pais.toLowerCase() === "br";';
    html += '      const marcador = L.marker([ponto.lat, ponto.lng], { icon: ehBrasil ? iconeBrasil : iconeExterior }).addTo(window.mapaSinarc);';  // ‚Üê CORRIGIDO
    
    // Tooltip mostra cidade - UF e quantidade
    html += '      const qtd = dadosCidade.empresas.length;';
    html += '      marcador.bindTooltip(`${cidadeUF} (${qtd})`, { permanent: true, direction: "top", offset: [0, -45], className: "tooltip-quantidade" });';
    
    // Popup mostra cidade - UF e lista de empresas (ORDENADAS ALFABETICAMENTE)
    html += '      let popupHTML = `<b>${cidadeUF} (${qtd})</b><br>`;';
    html += '      const empresasOrdenadas = dadosCidade.empresas.sort((a, b) => a.razao_social.localeCompare(b.razao_social));';
    html += '      empresasOrdenadas.forEach(emp => {';
    html += '        const enderecoEncoded = encodeURIComponent(emp.endereco_completo);';
    html += '        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${enderecoEncoded}`;';
    html += '        popupHTML += `‚Ä¢ <a href="${googleMapsUrl}" target="_blank" class="empresa-link" title="Ver localiza√ß√£o no Google Maps">${emp.razao_social} <span style="color:#555;">(${emp.situacao})</span></a><br>`;';
    html += '      });';
    html += '      marcador.bindPopup(popupHTML);';
    
    // Sistema de delay para fechar o popup
    html += '      let timeoutFecharPopup = null;';
    html += '      marcador.on("mouseover", function () {';
    html += '        if (timeoutFecharPopup) { clearTimeout(timeoutFecharPopup); timeoutFecharPopup = null; }';
    html += '        this.openPopup();';
    html += '      });';
    
    html += '      marcador.on("mouseout", function () {';
    html += '        const popup = this.getPopup();';
    html += '        timeoutFecharPopup = setTimeout(() => { this.closePopup(); }, 500);';
    html += '        const popupElement = popup.getElement();';
    html += '        if (popupElement) {';
    html += '          popupElement.addEventListener("mouseenter", () => {';
    html += '            if (timeoutFecharPopup) { clearTimeout(timeoutFecharPopup); timeoutFecharPopup = null; }';
    html += '          });';
    html += '          popupElement.addEventListener("mouseleave", () => {';
    html += '            this.closePopup();';
    html += '          });';
    html += '        }';
    html += '      });';
    
    html += '      window.limitesSinarc.extend([ponto.lat, ponto.lng]);';  // ‚Üê CORRIGIDO

    // Se n√£o localizou, adiciona √† lista de falhas
    html += '    } else {';
    html += '      dadosCidade.empresas.forEach(emp => {';
    html += '        empresasNaoLocalizadas.push({ razao: emp.razao_social, endereco: emp.endereco_completo });';
    html += '      });';
    html += '    }';

    html += '    await new Promise(r => setTimeout(r, 800));';
    html += '  }';
    
    html += '  if (window.limitesSinarc.isValid()) { window.mapaSinarc.fitBounds(window.limitesSinarc, { padding: [50, 50], maxZoom: 11 }); }';  // ‚Üê CORRIGIDO
    html += '  status.textContent = `Mapa carregado (${empresas.length} PJ/PE).`;';

    // Exibir popup com empresas n√£o localizadas
    html += '  if (empresasNaoLocalizadas.length > 0) {';
    html += '    let mensagem = `‚ö†Ô∏è ${empresasNaoLocalizadas.length} empresa(s) n√£o localizada(s):\n\n`;';
    html += '    empresasNaoLocalizadas.forEach(emp => {';
    html += '      mensagem += `‚Ä¢ ${emp.razao}\n  ${emp.endereco}\n\n`;';
    html += '    });';
    html += '    alert(mensagem);';
    html += '    console.warn("Empresas n√£o localizadas:", empresasNaoLocalizadas);';
    html += '  }';

    html += '}';
    html += 'carregarMapaPorCidade();';

    // Fun√ß√£o para enquadrar todos os pontos
    html += 'function enquadrarTudo() {';
    html += '  if (window.limitesSinarc && window.limitesSinarc.isValid()) {';  // ‚Üê CORRIGIDO
    html += '    window.mapaSinarc.fitBounds(window.limitesSinarc, { padding: [50, 50], maxZoom: 11 });';  // ‚Üê CORRIGIDO
    html += '  }';
    html += '}';

    // Vari√°vel para controlar estado dos r√≥tulos
    html += 'let tooltipsVisiveis = true;';
    
    // Fun√ß√£o para alternar visibilidade dos tooltips
    html += 'function alternarTooltips() {';
    html += '  tooltipsVisiveis = !tooltipsVisiveis;';
    html += '  const tooltips = document.querySelectorAll(".tooltip-quantidade");';
    html += '  tooltips.forEach(tooltip => {';
    html += '    if (tooltipsVisiveis) {';
    html += '      tooltip.classList.remove("hidden");';
    html += '    } else {';
    html += '      tooltip.classList.add("hidden");';
    html += '    }';
    html += '  });';
    html += '  const btn = document.getElementById("btn-toggle-labels");';
    html += '  btn.textContent = tooltipsVisiveis ? "üëÅÔ∏è" : "üëÅÔ∏è‚Äçüó®Ô∏è";';
    html += '  btn.title = tooltipsVisiveis ? "Ocultar r√≥tulos das cidades (Tecla L)" : "Mostrar r√≥tulos das cidades (Tecla L)";';
    html += '}';
    
    // Event listeners para bot√£o e tecla Home
    html += 'document.getElementById("btn-fit").addEventListener("click", enquadrarTudo);';
    html += 'document.getElementById("btn-toggle-labels").addEventListener("click", alternarTooltips);';
    //html += 'document.addEventListener("keydown", (e) => {';
    //html += '  if (e.key === "Home") { e.preventDefault(); enquadrarTudo(); }';
    //html += '});';

    html += '<\/script>';
    html += '</body>';
    html += '</html>';
    
    return html;
}

// ===============================
// FUN√á√ÉO DE TESTE COM DADOS FICT√çCIOS
// ===============================
function testarMapaComDadosTeste() {
    console.log('Testando mapa com dados de teste...');
    abrirMapaEmpresas(empresasTeste);
}

// ===============================
// FIM DAS FUN√á√ïES PARA MAPA GEOGR√ÅFICO
// ===============================

// Torna fun√ß√£o global
window.gerarMapaDoGrafo = gerarMapaDoGrafo;

</script>

















<div id="sinarc-tooltip-node"
     style="
        position: fixed;
        display: none;
        max-height: 295px;
        max-width: min(600px, calc(100vw - 24px));
        overflow-y: auto;
        overflow-x: auto;
        background: rgba(255,255,216,0.98);
        border: 1px solid #999;
        border-radius: 3px;
        font-size: 11px;
        padding: 6px 60px 6px 6px;
        z-index: 99999;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        white-space: pre;
        pointer-events: auto;
     ">
</div>

<style>
    .tooltip-buttons {
        display: flex;
        flex-direction: column;
        padding: 0px;
        margin-bottom: 10px;
    }

    .buttons-label {
        font-size: 11px;
        text-align: center;
        margin-bottom: 5px;
        font-weight: normal;
        align-self: left;
        width: 330px;
    }

    .buttons-row {
        display: flex;
        gap: 20px;
        justify-content: left;
        align-items: left;
    }

    .tooltip-buttons button {
        min-width: 50px;
        padding: 1px 18px;
        background: #52a0fa;
        color: #FFFFFF;
        border: 1px solid #0b66cf;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .tooltip-buttons button:hover {
        background: #2b8ef7;
        border-color: #1f7fe0;
    }

    .tooltip-buttons button:active {
        background: #095cc0;
        border-color: #074b9e;
    }


    
    
    
    .tooltip-close-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #f0f0f0;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 12px;
        color: #666;
        z-index: 10;
        transition: background 0.2s;
    }

    
    .tooltip-close-button:hover {
        background: #e0e0e0;
    }
</style>

<script>
(function () {
    const tooltip = document.getElementById("sinarc-tooltip-node");
    if (!tooltip) return;

    // --- SISTEMA GLOBAL DE RASTREIO DE MOUSE ---
    let globalMouseX = 0;
    let globalMouseY = 0;
    
    // Atualiza posi√ß√£o do mouse em qualquer movimento na tela
    document.addEventListener('mousemove', (e) => {
        globalMouseX = e.clientX;
        globalMouseY = e.clientY;
    });
    // -------------------------------------------------

    // --- VARI√ÅVEIS DO LOOP DE PARADA ---
    let stillnessInterval = null;
    let hoverStartTime = 0;
    let hoverStartX = 0;
    let hoverStartY = 0;
    let currentHoveredNodeId = null;

    function closeTooltip() {
        tooltip.style.display = "none";
        tooltip.scrollTop = 0;
        hoveredNodeId = null;
        isMouseOverNode = false;
        isMouseOverTooltip = false;
        stopStillnessCheck();
    }

    const STILLNESS_DELAY = 1500; // 1.5s
    const MOVEMENT_THRESHOLD = 3; // Toler√¢ncia de 3px (movimentos menores que isso n√£o resetam)
    // ---------------------------------

    let hideTimer = null;
    let isMouseOverNode = false;
    let isMouseOverTooltip = false;

    // Fun√ß√£o que verifica periodicamente se o mouse parou
    function startStillnessCheck(nodeId) {
        stopStillnessCheck(); // Para verifica√ß√£o anterior se houver

        currentHoveredNodeId = nodeId;
        hoverStartTime = Date.now(); // Registra in√≠cio da contagem
        hoverStartX = globalMouseX;  // Marca posi√ß√£o inicial
        hoverStartY = globalMouseY;

        // Inicia loop de verifica√ß√£o (a cada 50ms)
        stillnessInterval = setInterval(() => {
            // Calcula dist√¢ncia Euclidiana da posi√ß√£o atual para a posi√ß√£o de "in√≠cio da contagem"
            const dist = Math.hypot(globalMouseX - hoverStartX, globalMouseY - hoverStartY);

            if (dist > MOVEMENT_THRESHOLD) {
                // O mouse se moveu! Reinicia a contagem.
                // A nova posi√ß√£o se torna a posi√ß√£o base.
                hoverStartTime = Date.now();
                hoverStartX = globalMouseX;
                hoverStartY = globalMouseY;
                // console.log("Mouse moveu, resetando timer...");
            } 
            else if (Date.now() - hoverStartTime >= STILLNESS_DELAY) {
                // O tempo passou E o mouse est√° parado (dentro do threshold).
                stopStillnessCheck(); // Para o loop
                const node = nodes.get(nodeId);
                if (node) {
                    // Passa a posi√ß√£o atual do mouse para posicionar o tooltip exatamente onde parou
                    mostrarTooltip(node, {event: {clientX: globalMouseX, clientY: globalMouseY}});
                }
            }
        }, 50); // Checa 20 vezes por segundo
    }

    function stopStillnessCheck() {
        if (stillnessInterval) {
            clearInterval(stillnessInterval);
            stillnessInterval = null;
        }
        currentHoveredNodeId = null;
    }

    // --- FUN√á√ÉO DE EXIBI√á√ÉO ---
    function mostrarTooltip(node, params) {
        if (!node || !node._tooltip_html) return;

        const lines = node._tooltip_html.split(/\n/);
        
        const primeiraLinhaTexto = lines[0]
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        
        /*
        const textoPesquisa = `Realize uma pesquisa profunda e detalhada sobre o hist√≥rico de conformidade e integridade da pessoa a seguir. 
            O objetivo √© identificar riscos reputacionais por meio de uma an√°lise forense com foco no controle externo da Administra√ß√£o P√∫blica e na produ√ß√£o de insights para a defesa do interesse p√∫blico. 
            Utilize intelig√™ncia com fontes abertas (OSINT) para coletar dados relevantes dispon√≠veis na internet, incluindo not√≠cias, registros p√∫blicos, listas de san√ß√µes, portais de transpar√™ncia, redes sociais e outras fontes confi√°veis. 
            Concentre-se em aspectos que possam indicar envolvimento em pr√°ticas il√≠citas, m√° conduta empresarial ou qualquer outro fator que possa comprometer a integridade e a reputa√ß√£o da pessoa investigada.
            O n√∫mero do CPF de pessoas f√≠sicas est√° no formato PF_***NNNNNN** e o n√∫mero do CNPJ de pessoas jur√≠dicas est√° no formato PJ_NNNNNNNNNNNNNN.
            Por favor, forne√ßa as informa√ß√µes estruturadas da seguinte forma: 
            1. Not√≠cias e Irregularidades: Liste men√ß√µes em investiga√ß√µes, processos judiciais e administrativos p√∫blicos, inqu√©ritos ou not√≠cias sobre fraudes, corrup√ß√£o e irregularidades envolvendo a Administra√ß√£o P√∫blica e o interesse coletivo. 
            2. Rede de Liga√ß√µes: Identifique s√≥cios, empresas coligadas ou parceiros de neg√≥cios frequentemente citados em conjunto com o alvo. 
            3. Presen√ßa em Listas: Verifique se h√° men√ß√µes em portais de transpar√™ncia, listas de san√ß√µes ou registros de empresas e pessoas suspensas ou impedidas de contratar com a Administra√ß√£o P√∫blica (CEIS, CNEP, CEPIM, CEAF, CNIA, Acordo de Leni√™ncia, PEP).
            4. Atividades Comerciais: Descreva o setor de atua√ß√£o, principais atividades comerciais e qualquer hist√≥rico de contratos com o setor p√∫blico. 
            5. Reputa√ß√£o Online: Analise avalia√ß√µes, coment√°rios e discuss√µes em redes sociais, f√≥runs e sites especializados. 
            6. Hist√≥rico Financeiro: Investigue fal√™ncias, recupera√ß√µes judiciais ou outras quest√µes financeiras relevantes. 
            7. Conformidade Legal: Verifique o cumprimento de obriga√ß√µes legais, fiscais e regulat√≥rias. 
            8. Outras Informa√ß√µes Relevantes: Inclua quaisquer outras informa√ß√µes que possam impactar a avalia√ß√£o de risco reputacional do alvo.
            9. Insights para Pesquisa: Forne√ßa 5 insights ou pontos de aten√ß√£o que possam guiar uma investiga√ß√£o mais aprofundada sobre o alvo. 
            10. Prompts para Aprofundamento: Ao final de cada resposta, apresente 6 novas sugest√µes de prompts para IA (de 1 a 6), distintas das sugest√µes j√° apresentadas na conversa, sendo a sexta op√ß√£o espec√≠fica para gerar novos prompts contendo sugest√µes de pontos de auditoria ainda n√£o abordados nesta converesa, visando aprofundar ainda mais a investiga√ß√£o por meio de dados p√∫blicos dispon√≠veis na internet, de modo que o usu√°rio precise apenas digitar o n√∫mero do prompt desejado para a IA realizar a pesquisa correspondente. Pe√ßa para o usu√°rio digitar um n√∫mero.
            ATEN√á√ÉO: Se o alvo for um telefone (11 12345678), um endere√ßo (DEPUTADO EDUARDO KM LUIS MAGALHAES 529-FEIRA DE SANTANA-BA) ou um e-mail, realize uma pesquisa profunda sobre o alvo, objetivando encontrar men√ß√µes em bases p√∫blicas, redes sociais, listas de spam, vazamentos de dados e outras fontes abertas na internet.
            `;
        */
        
        const textoPesquisaFormatado = encodeURIComponent(window.textoPesquisa);
        const url = 'https://www.google.com/search?q=' + textoPesquisaFormatado + '+Entidade:+' + lines[0] + '&udm=50';
        
        const firstLine = '<strong><a href="\#" style="color: #0066cc; text-decoration: none; cursor: pointer;" onclick="window.open(\'' + url + '\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + primeiraLinhaTexto + '<\/a> üîç<\/strong>';
        
        const otherLines = lines.slice(1)
            .map(line => line
                .trim()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
            )
            .join("<br>");
        
        const botoesSection = `<div class="tooltip-buttons">
                <div class="buttons-label">Abrir n√≥ em camadas</div>
                <div class="buttons-row">
                    <button onclick="abrirGrafo(1)">1</button>
                    <button onclick="abrirGrafo(2)">2</button>
                    <button onclick="abrirGrafo(3)">3</button>
                    <button onclick="abrirGrafo(4)">4</button>
                    <button onclick="abrirGrafo(5)">5</button>
                </div>
            </div>`;
        
        
        //const html = botoesSection + firstLine + (otherLines ? "<br>" + otherLines : "");
        const closeButton = `<button class="tooltip-close-button">X</button>`;
        const html = closeButton + botoesSection + firstLine + (otherLines ? "<br>" + otherLines : "");

        tooltip.innerHTML = html;

        // ADICIONAR EVENTO PROGRAMATICAMENTE (DENTRO DO SCOP)
        const closeButtonElement = tooltip.querySelector('.tooltip-close-button');
        if (closeButtonElement) {
            closeButtonElement.addEventListener('click', closeTooltip);
        }

        
        
        // Posicionamento usando o evento de mouse (que agora √© garantido)
        const evt = params && params.event ? params.event : window.event;
        if (!evt) return;
        
        let x = evt.clientX + 12;
        let y = evt.clientY + 12;

        tooltip.style.visibility = "hidden";
        tooltip.style.display = "block";
        const w = tooltip.offsetWidth;
        const h = tooltip.offsetHeight;

        const maxX = window.innerWidth - w - 12;
        const maxY = window.innerHeight - h - 12;

        if (x > maxX) x = Math.max(12, maxX);
        if (x < 12) x = 12;
        if (y > maxY) y = Math.max(12, maxY);
        if (y < 12) y = 12;

        tooltip.style.left = x + "px";
        tooltip.style.top  = y + "px";
        tooltip.style.visibility = "visible";
        
        hoveredNodeId = node.id;
        isMouseOverNode = true;
    }

    function checkHideTooltip() {
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
            if (!isMouseOverNode && !isMouseOverTooltip) {
                tooltip.style.display = "none";
                tooltip.scrollTop = 0;
                if (typeof hoveredNodeId !== 'undefined') hoveredNodeId = null;
            }
        }, 100); 
    }

    network.on("hoverNode", function (params) {
        const nodeId = params.node;
        const node = nodes.get(nodeId);
        if (!node) return;
        
        if (!node._tooltip_html && node.title) {
            node._tooltip_html = node.title;
            //nodes.update({ id: nodeId, title: undefined });
        }
        if (!node._tooltip_html) return;
        
        isMouseOverNode = true;
        if (hideTimer) clearTimeout(hideTimer);
        
        // Inicia a verifica√ß√£o de parada (coordenadas)
        startStillnessCheck(nodeId);
    });
    
    network.on("blurNode", function () {
        isMouseOverNode = false;
        stopStillnessCheck(); // Para o timer de verifica√ß√£o imediatamente
        checkHideTooltip();
    });

    tooltip.addEventListener("mouseenter", () => {
        isMouseOverTooltip = true;
        if (hideTimer) clearTimeout(hideTimer);
    });

    tooltip.addEventListener("mouseleave", () => {
        isMouseOverTooltip = false;
        checkHideTooltip();
    });

})();

function closeTooltip() {
        tooltip.style.display = "none";
        tooltip.scrollTop = 0;
        hoveredNodeId = null;
        isMouseOverNode = false;
        isMouseOverTooltip = false;
        stopStillnessCheck();
    }


let hoveredNodeId = null;

function abrirGrafo(camadasSelecionada) {
    if (!hoveredNodeId) {
        tempAlert("Nenhum n√≥ em foco para abrir em camadas", 3000);
        return;
    }

    const cnpj = hoveredNodeId;
    const conf_destaca = false;

    if (location.protocol === "https:") {
        const url = `https://sinarc.app/?cnpj=${cnpj}&camada=${camadasSelecionada}`;
        window.open(url, "_blank");
        tempAlert(`Bot√£o ${camadasSelecionada} - Abrindo n√≥ ${cnpj} em nova aba`, 3000);
        return;
    }

    const textoCopiar = cnpj + "***" + camadasSelecionada + "***" + conf_destaca;
    async function copyOperation(texto) {
        await navigator.clipboard.writeText(texto);
    }
    setTimeout(() => {
        copyOperation(textoCopiar);
    }, 200);

    tempAlert(
        `Bot√£o ${camadasSelecionada} - N√≥ ${cnpj} copiado (${camadasSelecionada} camada${camadasSelecionada > 1 ? 's' : ''})`,
        3000
    );
}
</script>



    

        <style>
            #info-base-dados {
                position: fixed;
                bottom: 7px;  /* Dist√¢ncia do fundo - ajust√°vel */
                left: 11px;    /* Dist√¢ncia da esquerda - ajust√°vel */
                font-family: Arial, sans-serif;
                font-size: 10px;  /* Tamanho da fonte - ajust√°vel */
                color: #666;      /* Cor do texto - ajust√°vel */
                background-color: rgba(255, 255, 255, 0.0);  /* Fundo semi-transparente - ajust√°vel */
                padding: 5px 10px;  /* Espa√ßamento interno - ajust√°vel */
                border-radius: 3px;  /* Cantos arredondados - ajust√°vel */
                z-index: 999;
                pointer-events: none;  /* N√£o interfere com cliques */
                opacity: 0.5;  /* Transpar√™ncia do elemento - ajust√°vel */
            }
            
            #info-base-dados:hover {
                opacity: 1;  /* Fica mais vis√≠vel ao passar o mouse */
            }

        </style>

        <div id="info-base-dados">
            Base de dados: 13/12/2025
        </div>

    

<script>


    function gerarRelatorio() {

        const selectedNodes = network.getSelectedNodes();
        const totalSelecionados = selectedNodes.length;
        const textoNos = totalSelecionados === 1 ? 'N√ì SELECIONADO' : 'N√ìS SELECIONADOS';

        if (selectedNodes.length == 0){
                tempAlert('Selecione pelo menos um n√≥ para gerar o relat√≥rio. Pressione SHIFT + a para selecionar todos os n√≥s.', 3000);
                return;
        }

        const textoPesquisa = window.textoPesquisa


        // CALCULA TOTAL E EXTRAI DADOS DE PJ (apenas Brasil) e PE (exterior + estrangeiros)
        const pessoasJuridicas = [];
        const pessoasEstrangeiras = [];
        
        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string') return;
            
            const node = network.body.data.nodes.get(id);
            const title = node.title || '';
            const image = node.image || '';
            const conexoes = network.getConnectedEdges(id).length;
            
            // Situa√ß√£o baseada na imagem
            let situacao = 'ATIVA';
            if (image.includes('_inativa')) {
                situacao = 'BAIXADA';
            }
            
            // Restri√ß√£o (procura "Situa√ß√£o Fiscal:")
            let restricao = '';
            const matchFiscal = title.match(/Situa√ß√£o Fiscal:\s*(\w+)/i);
            if (matchFiscal) {
                restricao = matchFiscal[1].toUpperCase();
            }
            
            // PROCESSA PE_ (Pessoa Estrangeira)
            if (id.startsWith('PE_')) {
                const nome = id.substring(3);
                
                // Pa√≠s e endere√ßo - percorre todas as linhas buscando "- EX"
                let pais = '';
                let endereco = '';
                const linhas = title.split('\n').slice(1);
                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    if (linha === 'nan' || linha === '' || linha.startsWith('(EMPRESA')) continue;
                    if (linha.startsWith('N√ì -') || linha.startsWith('GRAFO -') || linha.includes('N√≥s Adjacentes')) break;
                    
                    /*
                    // Verifica se termina com "- EX" (endere√ßo estrangeiro)
                    if (linha.endsWith('- EX') || linha.endsWith('- EX ')) {
                        const partes = linha.split(' - ');
                        if (partes.length >= 2 && partes[0].trim() !== 'nan') {
                            pais = partes[0].trim();
                            // Endere√ßo √© tudo entre o pa√≠s e o "- EX" final
                            endereco = partes.slice(1, -1).join(' - ').trim();
                            if (endereco === '') {
                                endereco = partes.slice(1).join(' - ').replace(/\s*-\s*EX\s*$/i, '').trim();
                            }
                        }
                        break;
                    }
                    */

                    // 1. Verifica se a linha cont√©m "- EX" ou "- EX " em qualquer posi√ß√£o
                    if (linha.endsWith('- EX') || linha.includes('- EX ')) {
                        
                        // 2. O endere√ßo agora √© a linha completa (sem espa√ßos extras nas pontas)
                        endereco = linha.trim();
                        
                        // 3. (Opcional) Se ainda precisar extrair o pa√≠s separadamente:
                        const partes = linha.split(' - ');
                        if (partes.length >= 1 && partes[0].trim().toLowerCase() !== 'nan') {
                            pais = partes[0].trim();
                        }

                        // Como √© a "primeira linha que cont√©m", interrompemos o loop
                        break;
                    }

                }
                
                pessoasEstrangeiras.push({
                    id: id,
                    nome: nome,
                    cnpj: '',
                    pais: pais,
                    endereco: endereco,
                    situacao: situacao,
                    restricao: restricao,
                    conexoes: conexoes
                });
                return;
            }
            
            // PROCESSA PJ_
            if (id.startsWith('PJ_')) {
                const cnpj = id.substring(3);
                
                // Extrai nome (primeira linha do title, antes do "(PJ_")
                const primeiraLinha = title.split('\n')[0] || '';
                const nome = primeiraLinha.split('(PJ_')[0].trim();
                
                // Percorre todas as linhas para encontrar endere√ßo e verificar se √© exterior
                const linhas = title.split('\n');
                let linhaEndereco = '';
                let linhaEnderecoExterior = '';
                let isExterior = false;
                
                for (let i = 1; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    if (linha === '' || linha === nome) continue;
                    if (linha.startsWith('N√ì -') || linha.startsWith('GRAFO -') || linha.includes('N√≥s Adjacentes')) break;
                    
                    // Verifica se esta linha termina com "- EX"
                    if (linha.endsWith('- EX') || linha.includes('- EX ')) {
                        linhaEnderecoExterior = linha;
                        isExterior = true;
                    }
                    
                    // Guarda a primeira linha como endere√ßo padr√£o (para PJ nacional)
                    if (linhaEndereco === '') {
                        linhaEndereco = linha;
                    }
                }
                
                // Se for exterior, usa a linha com "- EX" como endere√ßo
                if (isExterior) {
                    linhaEndereco = linhaEnderecoExterior;
                }
                
                if (isExterior) {
                    // PJ no exterior vai para o array de PE
                    let pais = '';
                    let endereco = '';
                    const partes = linhaEndereco.split(' - ');
                    if (partes.length >= 2) {
                        pais = partes[0].trim();
                        // Remove o pa√≠s do in√≠cio e "EX" do final
                        endereco = partes.slice(1, -1).join(' - ').trim();
                        if (endereco === '') {
                            endereco = partes.slice(1).join(' - ').replace(/\s*-\s*EX\s*$/i, '').trim();
                        }
                    }
                    
                    pessoasEstrangeiras.push({
                        id: id,
                        nome: nome,
                        cnpj: cnpj,
                        pais: pais,
                        endereco: endereco,
                        situacao: situacao,
                        restricao: restricao,
                        conexoes: conexoes
                    });
                } else {
                    // PJ nacional
                    pessoasJuridicas.push({
                        id: id,
                        nome: nome,
                        cnpj: cnpj,
                        endereco: linhaEndereco,
                        situacao: situacao,
                        restricao: restricao,
                        conexoes: conexoes
                    });
                }
                return;
            }
        });
        
        const totalPJ = pessoasJuridicas.length;
        const textoPJ = totalPJ === 1 ? 'PESSOA JUR√çDICA (PJ) SEDIADA NO BRASIL' : 'PESSOAS JUR√çDICAS (PJ) SEDIADAS NO BRASIL';
        
        const totalPE = pessoasEstrangeiras.length;
        const textoPE = totalPE === 1 ? 'PESSOA JUR√çDICA (PJ) SEDIADA NO EXTERIOR OU PESSOA ESTRANGEIRA (PE)' : 'PESSOAS JUR√çDICAS (PJ) SEDIADAS NO EXTERIOR OU PESSOAS ESTRANGEIRAS (PE)';
        

        // CALCULA TOTAL E EXTRAI DADOS DE EN (Endere√ßo)
        const enderecos = [];

        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('EN_')) return;

            const node = network.body.data.nodes.get(id);
            if (!node || !node.title) return;

            // Primeira linha do title
            const primeiraLinha = node.title.split('\n')[0].trim();

            const conexoes = network.getConnectedEdges(id).length;

            enderecos.push({
                id: id,
                endereco: primeiraLinha,
                conexoes: conexoes
            });
        });


        const totalEN = enderecos.length;
        const textoEN = totalEN === 1 ? 'ENDERE√áO (EN)' : 'ENDERE√áOS (EN)';

        // CALCULA TOTAL E EXTRAI DADOS DE TE (Telefone)
        const telefones = [];
        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('TE_')) return;
            
            const telefone = id.substring(3);
            const conexoes = network.getConnectedEdges(id).length;
            
            telefones.push({
                id: id,
                telefone: telefone,
                conexoes: conexoes
            });
        });
        const totalTE = telefones.length;
        const textoTE = totalTE === 1 ? 'TELEFONE (TE)' : 'TELEFONES (TE)';

        // CALCULA TOTAL E EXTRAI DADOS DE EM (E-mail)
        const emails = [];
        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('EM_')) return;
            
            const email = id.substring(3);
            const conexoes = network.getConnectedEdges(id).length;
            
            emails.push({
                id: id,
                email: email,
                conexoes: conexoes
            });
        });
        const totalEM = emails.length;
        const textoEM = totalEM === 1 ? 'E-MAIL (EM)' : 'E-MAILS (EM)';


        // CALCULA TOTAL PF
        let totalPF = 0;
        selectedNodes.forEach(function (id) {
            if (typeof id === 'string' && id.startsWith('PF_')) {
                totalPF++;
            }
        });
        const textoNosPF = totalPF === 1 ? 'PESSOA F√çSICA (PF)' : 'PESSOAS F√çSICAS (PF)';

        // GERA LINHAS DE PJ
        let linhasPJ = '';
        pessoasJuridicas.forEach(function (pj) {
            const badgeSituacao = pj.situacao === 'ATIVA' 
                ? '<span class="badge badge-success">ATIVA</span>' 
                : '<span class="badge badge-danger">BAIXADA</span>';
            const badgeRestricao = pj.restricao 
                ? '<span class="badge badge-danger">' + pj.restricao + '</span>' 
                : '';
            
            linhasPJ += '<tr>';
            linhasPJ += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Abrir dados da pessoa jur√≠dica" onclick="window.opener.consultarCNPJ(\'' + pj.cnpj + '\'); return false;">' + pj.nome + '</a> üîç</div></td>';
            linhasPJ += '<td><a href="#" onclick="window.open(\'https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj=' + pj.cnpj + '\', \'popupCNPJ\', \'left=50,top=50,width=800,height=600,scrollbars=yes,resizable=yes\'); return false;" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Consultar CNPJ na Receita Federal">' + pj.cnpj + '</a> üîç</td>';
            linhasPJ += '<td><span class="connections">üîó ' + pj.conexoes + '</span></td>';
            linhasPJ += '<td>' + badgeSituacao + '</td>';
            linhasPJ += '<td></td>';
            linhasPJ += '<td><div class="restrictions">' + badgeRestricao + '</div></td>';
            linhasPJ += '</tr>';
        });


        // GERA LINHAS DE PE
        let linhasPE = '';
        pessoasEstrangeiras.forEach(function (pe) {
            const badgeSituacao = pe.situacao === 'ATIVA' 
                ? '<span class="badge badge-success">ATIVA</span>' 
                : '<span class="badge badge-danger">BAIXADA</span>';
            const badgeRestricao = pe.restricao 
                ? '<span class="badge badge-danger">' + pe.restricao + '</span>' 
                : '';
            const badgePais = pe.pais 
                ? '<span class="badge badge-info">' + pe.pais + '</span>' 
                : '';
            const coluna2 = pe.cnpj ? pe.cnpj : pe.endereco;
            
            linhasPE += '<tr>';
            linhasPE += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: ' + pe.nome + (pe.cnpj ? ' (CNPJ: ' + pe.cnpj + ')' : ' (Pessoa Estrangeira)')) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + pe.nome + '</a> üîç</div></td>';
            linhasPE += '<td>' + (pe.cnpj ? '<a href="#" onclick="window.open(\'https://solucoes.receita.fazenda.gov.br/servicos/cnpjreva/Cnpjreva_Solicitacao.asp?cnpj=' + pe.cnpj + '\', \'popupCNPJ\', \'left=50,top=50,width=800,height=600,scrollbars=yes,resizable=yes\'); return false;" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Consultar CNPJ na Receita Federal">' + pe.cnpj + '</a> üîç</td>' : coluna2) + '</td>';
            linhasPE += '<td><span class="connections">üîó ' + pe.conexoes + '</span></td>';
            linhasPE += '<td>' + badgeSituacao + '</td>';
            linhasPE += '<td>' + badgePais + '</td>';
            linhasPE += '<td><div class="restrictions">' + badgeRestricao + '</div></td>';
            linhasPE += '</tr>';
        });



        // GERA LINHAS DE EN
        let linhasEN = '';
        enderecos.forEach(function (en) {
            linhasEN += '<tr>';
            linhasEN += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: Endere√ßo ' + en.endereco) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + en.endereco + '</a> üîç</div></td>';
            linhasEN += '<td></td>';
            linhasEN += '<td><span class="connections">üîó ' + en.conexoes + '</span></td>';
            linhasEN += '<td></td>';
            linhasEN += '<td></td>';
            linhasEN += '<td></td>';
            linhasEN += '</tr>';
        });



        // GERA LINHAS DE TE
        let linhasTE = '';
        telefones.forEach(function (te) {
            linhasTE += '<tr>';
            linhasTE += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: Telefone ' + te.telefone) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + te.telefone + '</a> üîç</div></td>';
            linhasTE += '<td></td>';
            linhasTE += '<td><span class="connections">üîó ' + te.conexoes + '</span></td>';
            linhasTE += '<td></td>';
            linhasTE += '<td></td>';
            linhasTE += '<td></td>';
            linhasTE += '</tr>';
        });



        // GERA LINHAS DE EM
        let linhasEM = '';
        emails.forEach(function (em) {
            linhasEM += '<tr>';
            linhasEM += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: E-mail ' + em.email) + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + em.email + '</a> üîç</div></td>';
            linhasEM += '<td></td>';
            linhasEM += '<td><span class="connections">üîó ' + em.conexoes + '</span></td>';
            linhasEM += '<td></td>';
            linhasEM += '<td></td>';
            linhasEM += '<td></td>';
            linhasEM += '</tr>';
        });


        // EXTRAI NOME, CEP E CONEX√ïES
        const pessoasFisicas = [];

        selectedNodes.forEach(function (id) {
            if (typeof id !== 'string' || !id.startsWith('PF_')) return;

            // Remove o prefixo "PF_"
            const dados = id.substring(3);

            // CPF √© o primeiro bloco, nome vem depois
            const primeiroEspaco = dados.indexOf('-');
            if (primeiroEspaco === -1) return;

            const cpf = dados.substring(0, primeiroEspaco).trim();
            const nome = dados.substring(primeiroEspaco + 1).trim();

            // Conta conex√µes adjacentes
            const conexoes = network.getConnectedEdges(id).length;

            pessoasFisicas.push({
                id: id,
                nome: nome,
                cpf: cpf,
                conexoes: conexoes
            });
        });


        let linhasPF = '';
        pessoasFisicas.forEach(function (pf) {
            linhasPF += '<tr>';
            linhasPF += '<td><div class="node-name"><a href="#" style="color: #0066cc; text-decoration: none; cursor: pointer;" title="Pesquisar no Google com IA" onclick="window.open(\'https://www.google.com/search?q=' + encodeURIComponent(textoPesquisa + ' Entidade: ' + pf.nome + ' (CPF: ' + pf.cpf + ')') + '&udm=50\', \'\', \'left=50,top=100,width=800,height=800,scrollbars=yes,resizable=yes\'); return false;">' + pf.nome + '</a> üîç</div></td>';
            linhasPF += '<td>' + pf.cpf + '</td>';
            linhasPF += '<td><span class="connections">üîó ' + pf.conexoes + '</span></td>';
            linhasPF += '<td></td>';
            linhasPF += '<td></td>';
            linhasPF += '<td></td>';
            linhasPF += '</tr>';
        });



        let html = "";

        html += '<!DOCTYPE html>';
        html += '<html lang="pt-BR">';
        html += '<head>';
        html += '    <meta charset="UTF-8">';
        html += '    <meta name="viewport" content="width=device-width, initial-scale=1.0">';
        html += '    <title>SINARC - N√≥s Selecionados</title>';
        html += '    <style>';
        html += '    * {';
        html += '    margin: 0;';
        html += '    padding: 0;';
        html += '    box-sizing: border-box;';
        html += '    }';
        html += '    body {';
        html += '        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;';
        html += '        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);';
        html += '        padding: 20px;';
        html += '        color: #2c3e50;';
        html += '    }';
        html += '    .container {';
        html += '        max-width: 1200px;';
        html += '        margin: 0 auto;';
        html += '        background: white;';
        html += '        border-radius: 12px;';
        html += '            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);';
        html += '            overflow: hidden;';
        html += '        }';
        html += '        .header {';
        html += '            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
        html += '            color: white;';
        html += '            padding: 20px 30px;';
        html += '        }';
        html += '        .header h1 {';
        html += '            font-size: 24px;';
        html += '            margin-bottom: 0px;';
        html += '        }';
        html += '        .toolbar {';
        html += '            padding: 20px 30px;';
        html += '            background: transparent;';
        html += '            border-bottom: none;';
        html += '            display: flex;';
        html += '            gap: 15px;';
        html += '            flex-wrap: wrap;';
        html += '            align-items: center;';
        html += '        }';
        html += '        .search-box {';
        html += '            flex: 1;';
        html += '            min-width: 250px;';
        html += '            position: relative;';
        html += '        }';
        html += '        .search-box input {';
        html += '            width: 100%;';
        html += '            padding: 10px 40px 10px 15px;';
        html += '            border: 2px solid #e9ecef;';
        html += '            border-radius: 8px;';
        html += '            font-size: 14px;';
        html += '            transition: all 0.3s;';
        html += '        }';
        html += '        .search-box input:focus {';
        html += '            outline: none;';
        html += '            border-color: #667eea;';
        html += '        }';
        html += '        .search-icon {';
        html += '            position: absolute;';
        html += '            right: 12px;';
        html += '            top: 50%;';
        html += '            transform: translateY(-50%);';
        html += '            color: #adb5bd;';
        html += '        }';
        html += '        .btn {';
        html += '        padding: 10px 20px;';
        html += '            border: none;';
        html += '            border-radius: 8px;';
        html += '            cursor: pointer;';
        html += '            font-size: 14px;';
        html += '            font-weight: 600;';
        html += '            transition: all 0.3s;';
        html += '            display: inline-flex;';
        html += '            align-items: center;';
        html += '            gap: 8px;';
        html += '        }';
        html += '        .btn-primary {';
        html += '            background: #667eea;';
        html += '            color: white;';
        html += '        }';
        html += '        .btn-primary:hover {';
        html += '            background: #5568d3;';
        html += '            transform: translateY(-2px);';
        html += '            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);';
        html += '        }';
        html += '        .btn-secondary {';
        html += '            background: #28a745;';
        html += '            color: white;';
        html += '        }';
        html += '        .btn-secondary:hover {';
        html += '            background: #218838;';
        html += '            transform: translateY(-2px);';
        html += '            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);';
        html += '        }';
        html += '        .content {';
        html += '            padding: 30px;';
        html += '        }';
        html += '        .node-section {';
        html += '            margin-bottom: 30px;';
        html += '        }';
        html += '        .table-wrapper {';
        html += '            overflow-x: auto;';
        html += '            -webkit-overflow-scrolling: touch;';
        html += '        }';
        html += '        .section-header {';
        html += '            display: flex;';
        html += '            align-items: center;';
        html += '            gap: 15px;';
        html += '            margin-bottom: 15px;';
        html += '            padding: 15px;';
        html += '            border-radius: 8px;';
        html += '            cursor: pointer;';
        html += '            transition: all 0.3s;';
        html += '            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);';
        html += '            border-left: 4px solid #667eea;';
        html += '        }';
        html += '        .section-header:hover {';
        html += '            transform: translateX(5px);';
        html += '        }';
        html += '        .section-header .icon {';
        html += '            width: 32px;';
        html += '            height: 32px;';
        html += '            object-fit: contain;';
        html += '            flex-shrink: 0;';
        html += '        }';
        html += '        @media (max-width: 768px) {';
        html += '            .section-header .icon {';
        html += '                width: 28px;';
        html += '                height: 28px;';
        html += '            }';
        html += '        }';
        html += '        .section-header .title {';
        html += '            flex: 1;';
        html += '        }';
        html += '        .section-header .title h2 {';
        html += '            font-size: 18px;';
        html += '            margin-bottom: 3px;';
        html += '        }';
        html += '        .section-header .title .count {';
        html += '            font-size: 12px;';
        html += '            opacity: 0.7;';
        html += '        }';
        html += '        .node-table {';
        html += '            width: 100%;';
        html += '            border-collapse: collapse;';
        html += '            margin-bottom: 20px;';
        html += '            display: none;';
        html += '            min-width: 1000px;';
        html += '        }';
        html += '        .node-table.show {';
        html += '            display: table;';
        html += '        }';
        html += '        .node-table {';
        html += '            table-layout: fixed;';
        html += '        }';
        html += '        .node-table th:nth-child(1),';
        html += '        .node-table td:nth-child(1) {';
        html += '            width: 40%;';
        html += '        }';
        html += '        .node-table th:nth-child(2),';
        html += '        .node-table td:nth-child(2) {';
        html += '            width: 15%;';
        html += '        }';
        html += '        .node-table th:nth-child(3),';
        html += '        .node-table td:nth-child(3) {';
        html += '            width: 10%;';
        html += '        }';
        html += '        .node-table th:nth-child(4),';
        html += '        .node-table td:nth-child(4) {';
        html += '            width: 10%;';
        html += '        }';
        html += '        .node-table th:nth-child(5),';
        html += '        .node-table td:nth-child(5) {';
        html += '            width: 15%;';
        html += '        }';
        html += '        .node-table th:nth-child(6),';
        html += '        .node-table td:nth-child(6) {';
        html += '            width: 10%;';
        html += '        }';
        html += '        .node-table thead {';
        html += '            background: #f8f9fa;';
        html += '        }';
        html += '        .node-table th {';
        html += '            padding: 12px;';
        html += '            text-align: left;';
        html += '            font-size: 12px;';
        html += '            font-weight: 600;';
        html += '            color: #6c757d;';
        html += '            text-transform: uppercase;';
        html += '            border-bottom: 2px solid #dee2e6;';
        html += '        }';
        html += '        .node-table th {';
        html += '            padding: 12px;';
        html += '            text-align: left;';
        html += '            font-size: 12px;';
        html += '            font-weight: 600;';
        html += '            color: #6c757d;';
        html += '            text-transform: uppercase;';
        html += '            border-bottom: 2px solid #dee2e6;';
        html += '        }';
        html += '        .node-table th.sortable {';
        html += '            cursor: pointer;';
        html += '            user-select: none;';
        html += '            position: relative;';
        html += '            padding-right: 25px;';
        html += '        }';
        html += '        .node-table th.sortable:hover {';
        html += '            background: #e9ecef;';
        html += '        }';
        html += '        .node-table th.sortable::after {';
        html += '            content: "‚áÖ";';
        html += '            position: absolute;';
        html += '            right: 8px;';
        html += '            opacity: 0.3;';
        html += '            font-size: 14px;';
        html += '        }';
        html += '        .node-table th.sortable.asc::after {';
        html += '            content: "‚ñ≤";';
        html += '            opacity: 1;';
        html += '            color: #667eea;';
        html += '        }';
        html += '        .node-table th.sortable.desc::after {';
        html += '            content: "‚ñº";';
        html += '            opacity: 1;';
        html += '            color: #667eea;';
        html += '        }';
        html += '        .node-table td {';
        html += '            padding: 12px;';
        html += '            border-bottom: 1px solid #f1f3f5;';
        html += '            font-size: 14px;';
        html += '        }';
        html += '        .node-table tbody tr:hover {';
        html += '            background: #f8f9fa;';
        html += '        }';
        html += '        .node-table tbody tr:nth-child(even) {';
        html += '            background: #fafbfc;';
        html += '        }';
        html += '        .badge {';
        html += '            display: inline-block;';
        html += '            padding: 4px 8px;';
        html += '            border-radius: 4px;';
        html += '            font-size: 11px;';
        html += '            font-weight: 600;';
        html += '            margin-right: 5px;';
        html += '            margin-bottom: 3px;';
        html += '        }';
        html += '        .badge-success {';
        html += '            background: #d4edda;';
        html += '            color: #155724;';
        html += '        }';
        html += '        .badge-danger {';
        html += '            background: #f8d7da;';
        html += '            color: #721c24;';
        html += '        }';
        html += '        .badge-warning {';
        html += '            background: #fff3cd;';
        html += '            color: #856404;';
        html += '        }';
        html += '        .badge-info {';
        html += '            background: #d1ecf1;';
        html += '            color: #0c5460;';
        html += '        }';
        html += '        .badge-secondary {';
        html += '            background: #e2e3e5;';
        html += '            color: #383d41;';
        html += '        }';
        html += '        .node-name {';
        html += '            font-weight: 600;';
        html += '            color: #2c3e50;';
        html += '        }';
        html += '        .node-id {';
        html += '            font-size: 11px;';
        html += '            color: #6c757d;';
        html += '            font-family: "Courier New", monospace;';
        html += '        }';
        html += '        .connections {';
        html += '            display: inline-flex;';
        html += '            align-items: center;';
        html += '            gap: 5px;';
        html += '            padding: 4px 10px;';
        html += '            background: #e7f3ff;';
        html += '            border-radius: 12px;';
        html += '            font-size: 12px;';
        html += '            color: #0066cc;';
        html += '            font-weight: 600;';
        html += '        }';
        html += '        .restrictions {';
        html += '            display: flex;';
        html += '            flex-wrap: wrap;';
        html += '            gap: 5px;';
        html += '        }';
        html += '        .collapse-icon {';
        html += '            transition: transform 0.3s;';
        html += '        }';
        html += '        .collapse-icon.rotated {';
        html += '            transform: rotate(180deg);';
        html += '        }';
        html += '</style>';
        html += '</head>';

        html += '<body>';
        html += '<div class="container">';
        html += '<div class="header">';
        html += '<h1>üîç ' + totalSelecionados + ' ' + textoNos + '</h1>';
        html += '</div>';
        html += '<div class="toolbar">';
        html += '            <div class="search-box">';
        html += '                <input type="text" id="searchInput" placeholder="üîé Buscar por nome, CPF, CNPJ...">';
        html += '                <span class="search-icon">‚åï</span>';
        html += '            </div>';
        html += '            <button class="btn btn-secondary" onclick="salvarArquivo()">';
        html += '                üíæ Salvar Relat√≥rio';
        html += '            </button>';
        html += '        </div>';
        html += '<div class="content">';
        
        html += '    <div class="node-section">';
        html += '        <div class="section-header" onclick="toggleSection(\'pf\')">';
        html += '            <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/pf_homem.png" alt="Pessoa F√≠sica" class="icon">';
        html += '            <div class="title">';
        html += '                <h2>' + totalPF +  ' ' + textoNosPF + '</h2>';
        html += '            </div>';
        html += '            <span class="collapse-icon" id="icon-pf">‚ñº</span>';
        html += '        </div>';
        html += '        <div class="table-wrapper">';
        html += '            <table class="node-table show" id="table-pf">';
        html += '                <thead>';
        html += '                    <tr>';
        html += '                        <th>Nome</th>';
        html += '                        <th>CPF</th>';
        html += '                        <th>Conex√µes</th>';
        html += '                        <th></th>';
        html += '                        <th></th>';
        html += '                        <th></th>';
        html += '                    </tr>';
        html += '                </thead>';
        html += '                <tbody>';
        html +=                      linhasPF;
        html += '                </tbody>';
        html += '            </table>';
        html += '        </div>';
        html += '    </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'pj\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/pj_brasil_ativa.png" alt="Pessoa Jur√≠dica" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalPJ + ' ' + textoPJ + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-pj">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-pj">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Raz√£o Social</th>';
        html += '                                <th>CNPJ</th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th>Situa√ß√£o</th>';
        html += '                                <th>Pa√≠s</th>';
        html += '                                <th>Restri√ß√µes</th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasPJ;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'pe\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/pj_exterior_ativa.png" alt="Pessoa Estrangeira" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalPE + ' ' + textoPE + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-pe">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-pe">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Raz√£o Social</th>';
        html += '                                <th>CNPJ</th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th>Situa√ß√£o</th>';
        html += '                                <th>Pa√≠s</th>';
        html += '                                <th>Restri√ß√µes</th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasPE;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'en\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/endereco.png" alt="Endere√ßo" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalEN + ' ' + textoEN + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-en">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-en">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Endere√ßo</th>';
        html += '                                <th></th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasEN;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'te\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/telefone.png" alt="Telefone" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalTE + ' ' + textoTE + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-te">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-te">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>Telefone</th>';
        html += '                                <th></th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasTE;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        
        html += '            <div class="node-section">';
        html += '                <div class="section-header" onclick="toggleSection(\'em\')">';
        html += '                    <img src="https://raw.githubusercontent.com/controlecidadao/sinarc/refs/heads/main/images/email.png" alt="E-mail" class="icon">';
        html += '                    <div class="title">';
        html += '                        <h2>' + totalEM + ' ' + textoEM + '</h2>';
        html += '                    </div>';
        html += '                    <span class="collapse-icon" id="icon-em">‚ñº</span>';
        html += '                </div>';
        html += '                <div class="table-wrapper">';
        html += '                    <table class="node-table show" id="table-em">';
        html += '                        <thead>';
        html += '                            <tr>';
        html += '                                <th>E-mail</th>';
        html += '                                <th></th>';
        html += '                                <th>Conex√µes</th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                                <th></th>';
        html += '                            </tr>';
        html += '                        </thead>';
        html += '                        <tbody>';
        html +=                              linhasEM;
        html += '                        </tbody>';
        html += '                    </table>';
        html += '                </div>';
        html += '            </div>';
        html += '        </div>';
        html += '    </div>';

        html += '<scr' + 'ipt>';
        html += '        function toggleSection(type) {';
        html += '            const table = document.getElementById(`table-${type}`);';
        html += '            const icon = document.getElementById(`icon-${type}`);';
        html += '            table.classList.toggle("show");';
        html += '            icon.classList.toggle("rotated");';    
        html += '        }';
        html += '        function salvarArquivo() {';
        html += '            const conteudoHTML = document.documentElement.outerHTML;';
        html += '            const blob = new Blob([conteudoHTML], { type: "text/html;charset=utf-8" });';
        html += '            const url = URL.createObjectURL(blob);';
        html += '            const link = document.createElement("a");';
        html += '            link.href = url;';
        html += '            const agora = new Date();';
        html += '            const dataHora = agora.getFullYear() + "-" + String(agora.getMonth() + 1).padStart(2, "0") + "-" + String(agora.getDate()).padStart(2, "0") + "_" + String(agora.getHours()).padStart(2, "0") + "-" + String(agora.getMinutes()).padStart(2, "0");';
        html += '            link.download = "SINARC_Relatorio_" + dataHora + ".html";';
        html += '            document.body.appendChild(link);';
        html += '            link.click();';
        html += '            document.body.removeChild(link);';
        html += '            URL.revokeObjectURL(url);';
        html += '        }';
        html += '        document.getElementById("searchInput").addEventListener("input", function(e) {';
        html += '            const searchTerm = e.target.value.toLowerCase();';
        html += '            const tables = document.querySelectorAll(".node-table");';
        html += '            tables.forEach(table => {';
        html += '                const rows = table.querySelectorAll("tbody tr");';
        html += '                rows.forEach(row => {';
        html += '                    const text = row.textContent.toLowerCase();';
        html += '                    row.style.display = text.includes(searchTerm) ? "" : "none";';
        html += '                });';
        html += '            });';
        html += '        });';
        html += '        function tornarColunasOrdenaveis() {';
        html += '            const tabelas = document.querySelectorAll(".node-table");';
        html += '            tabelas.forEach(tabela => {';
        html += '                const cabecalhos = tabela.querySelectorAll("thead th");';
        html += '                cabecalhos.forEach((th, index) => {';
        html += '                    if (th.textContent.trim() !== "") {';
        html += '                        th.classList.add("sortable");';
        html += '                        th.addEventListener("click", function() {';
        html += '                            ordenarTabela(tabela, index);';
        html += '                        });';
        html += '                    }';
        html += '                });';
        html += '            });';
        html += '        }';
        html += '        function ordenarTabela(tabela, colunaIndex) {';
        html += '            const tbody = tabela.querySelector("tbody");';
        html += '            const linhas = Array.from(tbody.querySelectorAll("tr"));';
        html += '            const cabecalhos = tabela.querySelectorAll("thead th");';
        html += '            const cabecalhoAtual = cabecalhos[colunaIndex];';
        html += '            let ordemAtual = "none";';
        html += '            if (cabecalhoAtual.classList.contains("asc")) ordemAtual = "asc";';
        html += '            if (cabecalhoAtual.classList.contains("desc")) ordemAtual = "desc";';
        html += '            cabecalhos.forEach(th => th.classList.remove("asc", "desc"));';
        html += '            let novaOrdem = ordemAtual === "asc" ? "desc" : "asc";';
        html += '            cabecalhoAtual.classList.add(novaOrdem);';
        html += '            linhas.sort(function(a, b) {';
        html += '                const celulaA = a.cells[colunaIndex];';
        html += '                const celulaB = b.cells[colunaIndex];';
        html += '                if (!celulaA || !celulaB) return 0;';
        html += '                let valorA = celulaA.querySelector(".node-name")';
        html += '                    ? celulaA.querySelector(".node-name").textContent';
        html += '                    : celulaA.querySelector(".connections")';
        html += '                        ? celulaA.querySelector(".connections").textContent';
        html += '                        : celulaA.textContent;';
        html += '                let valorB = celulaB.querySelector(".node-name")';
        html += '                    ? celulaB.querySelector(".node-name").textContent';
        html += '                    : celulaB.querySelector(".connections")';
        html += '                        ? celulaB.querySelector(".connections").textContent';
        html += '                        : celulaB.textContent;';
        html += '                valorA = valorA.trim();';
        html += '                valorB = valorB.trim();';
        html += '                const numA = parseFloat(valorA.replace(/[^\\d.-]/g, ""));';
        html += '                const numB = parseFloat(valorB.replace(/[^\\d.-]/g, ""));';
        html += '                let resultado;';
        html += '                if (!isNaN(numA) && !isNaN(numB)) {';
        html += '                    resultado = numA - numB;';
        html += '                } else {';
        html += '                    resultado = valorA.localeCompare(valorB, "pt-BR", { sensitivity: "base" });';
        html += '                }';
        html += '                return novaOrdem === "asc" ? resultado : -resultado;';
        html += '            });';
        html += '            linhas.forEach(function(linha) { tbody.appendChild(linha); });';
        html += '        }';
        html += '        function ordenarTabelas() {';
        html += '            const tabelas = document.querySelectorAll(".node-table tbody");';
        html += '            tabelas.forEach(tbody => {';
        html += '                const linhas = Array.from(tbody.querySelectorAll("tr"));';
        html += '                if (linhas.length === 0) return;';
        html += '                linhas.sort((a, b) => {';
        html += '                    const aNomeEl = a.querySelector(".node-name");';
        html += '                    const bNomeEl = b.querySelector(".node-name");';
        html += '                    if (!aNomeEl || !bNomeEl) return 0;';
        html += '                    const nomeA = aNomeEl.textContent.trim().toUpperCase();';
        html += '                    const nomeB = bNomeEl.textContent.trim().toUpperCase();';
        html += '                    return nomeA.localeCompare(nomeB, "pt-BR");';
        html += '                });';
        html += '                linhas.forEach(linha => tbody.appendChild(linha));';
        html += '            });';
        html += '        }';
        html += '        window.addEventListener("DOMContentLoaded", function() {';
        html += '            ordenarTabelas();';
        html += '            tornarColunasOrdenaveis();';
        html += '        });';
        html += '</scr' + 'ipt>';
        html += '</body>';
        html += '</html>'

        const janela = window.open(
            'about:blank',
            '_blank',
            'width=1200,height=800,scrollbars=yes,resizable=yes'
        );

        //console.log(html);

        // Escrever HTML na janela
        janela.document.open();
        janela.document.write(html);
        janela.document.close();
    }

    window.gerarRelatorio = gerarRelatorio;

    const selectedNodes_2 = network.getSelectedNodes();
    const totalSelecionados = selectedNodes_2.length;
    const textoNos = totalSelecionados === 1 ? 'N√ì SELECIONADO' : 'N√ìS SELECIONADOS';

</script>







</body>
</html>